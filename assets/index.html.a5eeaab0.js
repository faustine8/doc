import{_ as p,r as t,o,a as l,b as n,d as c,F as r,c as s,e as a}from"./app.40df414d.js";var u="/doc/assets/README-1642227655228.eba072bd.png";const i={},k=s(`<h2 id="\u7B2C\u516D\u90E8\u5206-hql-dql\u547D\u4EE4\u3010\u91CD\u70B9\u3011" tabindex="-1"><a class="header-anchor" href="#\u7B2C\u516D\u90E8\u5206-hql-dql\u547D\u4EE4\u3010\u91CD\u70B9\u3011" aria-hidden="true">#</a> \u7B2C\u516D\u90E8\u5206 HQL DQL\u547D\u4EE4\u3010\u91CD\u70B9\u3011</h2><blockquote><p>DQL (Data Query Language) \u6570\u636E\u67E5\u8BE2\u8BED\u8A00</p></blockquote><p>select\u8BED\u6CD5:</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">[</span><span class="token keyword">ALL</span> <span class="token operator">|</span> <span class="token keyword">DISTINCT</span><span class="token punctuation">]</span> select_expr<span class="token punctuation">,</span> select_expr<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">FROM</span> table_reference
<span class="token punctuation">[</span><span class="token keyword">WHERE</span> where_condition<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token keyword">GROUP</span> <span class="token keyword">BY</span> col_list<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> col_list<span class="token punctuation">]</span>
<span class="token punctuation">[</span>CLUSTER <span class="token keyword">BY</span> col_list <span class="token operator">|</span> <span class="token punctuation">[</span>DISTRIBUTE <span class="token keyword">BY</span> col_list<span class="token punctuation">]</span> <span class="token punctuation">[</span>SORT <span class="token keyword">BY</span> col_list<span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token keyword">LIMIT</span> <span class="token punctuation">[</span><span class="token keyword">offset</span><span class="token punctuation">,</span><span class="token punctuation">]</span> <span class="token keyword">rows</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>SQL\u8BED\u53E5\u4E66\u5199\u6CE8\u610F\u4E8B\u9879:</p><ul><li>SQL\u8BED\u53E5\u5BF9\u5927\u5C0F\u5199\u4E0D\u654F\u611F</li><li>SQL\u8BED\u53E5\u53EF\u4EE5\u5199\u4E00\u884C(\u7B80\u5355SQL)\u4E5F\u53EF\u4EE5\u5199\u591A\u884C(\u590D\u6742SQL)</li><li>\u5173\u952E\u5B57\u4E0D\u80FD\u7F29\u5199\uFF0C\u4E5F\u4E0D\u80FD\u5206\u884C</li><li>\u5404\u5B50\u53E5\u4E00\u822C\u8981\u5206\u884C</li><li>\u4F7F\u7528\u7F29\u8FDB\u683C\u5F0F\uFF0C\u63D0\u9AD8SQL\u8BED\u53E5\u7684\u53EF\u8BFB\u6027(\u91CD\u8981)</li></ul><p>\u521B\u5EFA\u8868\uFF0C\u52A0\u8F7D\u6570\u636E</p><p>\u6D4B\u8BD5\u6570\u636E <code>/home/hadoop/data/emp.dat</code></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>7369,SMITH,CLERK,7902,2010-12-17,800,,20
7499,ALLEN,SALESMAN,7698,2011-02-20,1600,300,30
7521,WARD,SALESMAN,7698,2011-02-22,1250,500,30
7566,JONES,MANAGER,7839,2011-04-02,2975,,20
7654,MARTIN,SALESMAN,7698,2011-09-28,1250,1400,30
7698,BLAKE,MANAGER,7839,2011-05-01,2850,,30
7782,CLARK,MANAGER,7839,2011-06-09,2450,,10
7788,SCOTT,ANALYST,7566,2017-07-13,3000,,20
7839,KING,PRESIDENT,,2011-11-07,5000,,10
7844,TURNER,SALESMAN,7698,2011-09-08,1500,0,30
7876,ADAMS,CLERK,7788,2017-07-13,1100,,20
7900,JAMES,CLERK,7698,2011-12-03,950,,30
7902,FORD,ANALYST,7566,2011-12-03,3000,,20
7934,MILLER,CLERK,7782,2012-01-23,1300,,10
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u5EFA\u8868\u5E76\u52A0\u8F7D\u6570\u636E</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> emp <span class="token punctuation">(</span>
    empno <span class="token keyword">int</span><span class="token punctuation">,</span>
    ename string<span class="token punctuation">,</span>
    job string<span class="token punctuation">,</span>
    mgr <span class="token keyword">int</span><span class="token punctuation">,</span>
    hiredate <span class="token keyword">DATE</span><span class="token punctuation">,</span>
    sal <span class="token keyword">int</span><span class="token punctuation">,</span>
    comm <span class="token keyword">int</span><span class="token punctuation">,</span>
    deptno <span class="token keyword">int</span>
<span class="token punctuation">)</span><span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">;</span>

<span class="token comment">-- \u52A0\u8F7D\u6570\u636E</span>
<span class="token keyword">LOAD</span> <span class="token keyword">DATA</span> <span class="token keyword">LOCAL</span> INPATH <span class="token string">&#39;/home/hadoop/data/emp.dat&#39;</span> <span class="token keyword">INTO</span> <span class="token keyword">TABLE</span> emp<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="\u7B2C-1-\u8282-\u57FA\u672C\u67E5\u8BE2" tabindex="-1"><a class="header-anchor" href="#\u7B2C-1-\u8282-\u57FA\u672C\u67E5\u8BE2" aria-hidden="true">#</a> \u7B2C 1 \u8282 \u57FA\u672C\u67E5\u8BE2</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u7701\u7565from\u5B50\u53E5\u7684\u67E5\u8BE2</span>
hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token number">8</span>*888<span class="token punctuation">;</span>
OK
_c0
<span class="token number">7104</span>
Time taken: <span class="token number">0.132</span> seconds, Fetched: <span class="token number">1</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> current_date<span class="token punctuation">;</span>
OK
_c0
<span class="token number">2022</span>-02-16
Time taken: <span class="token number">0.111</span> seconds, Fetched: <span class="token number">1</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>


<span class="token comment"># \u4F7F\u7528\u5217\u522B\u540D</span>
hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token number">8</span>*888 product<span class="token punctuation">;</span>
OK
product
<span class="token number">7104</span>
Time taken: <span class="token number">0.121</span> seconds, Fetched: <span class="token number">1</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> current_date as currdate<span class="token punctuation">;</span>
OK
currdate
<span class="token number">2022</span>-02-16
Time taken: <span class="token number">0.1</span> seconds, Fetched: <span class="token number">1</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u5168\u8868\u67E5\u8BE2</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- \u9009\u62E9\u7279\u5B9A\u5217\u67E5\u8BE2</span>
<span class="token keyword">select</span> ename<span class="token punctuation">,</span> sal<span class="token punctuation">,</span> comm <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- \u4F7F\u7528\u51FD\u6570</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
<span class="token comment">-- count(colname) \u6309\u5B57\u6BB5\u8FDB\u884Ccount\uFF0C\u4E0D\u7EDF\u8BA1column\u4E3ANULL\u7684\u6570\u636E</span>

<span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token function">min</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token function">avg</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- \u4F7F\u7528limit\u5B50\u53E5\u9650\u5236\u8FD4\u56DE\u7684\u884C\u6570</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">limit</span> <span class="token number">3</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="\u7B2C-2-\u8282-where\u5B50\u53E5" tabindex="-1"><a class="header-anchor" href="#\u7B2C-2-\u8282-where\u5B50\u53E5" aria-hidden="true">#</a> \u7B2C 2 \u8282 where\u5B50\u53E5</h3><p>WHERE\u5B50\u53E5\u7D27\u968FFROM\u5B50\u53E5\uFF0C\u4F7F\u7528WHERE\u5B50\u53E5\uFF0C\u8FC7\u6EE4\u4E0D\u6EE1\u8DB3\u6761\u4EF6\u7684\u6570\u636E;</p><p><em>WHERE \u5B50\u53E5\u4E2D\u4E0D\u80FD\u4F7F\u7528\u5217\u7684\u522B\u540D</em></p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> sal <span class="token operator">&gt;</span> <span class="token number">2000</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>WHERE \u5B50\u53E5\u4E2D\u4F1A\u6D89\u53CA\u5230\u8F83\u591A\u7684\u6BD4\u8F83\u8FD0\u7B97\u548C\u903B\u8F91\u8FD0\u7B97;</p><h4 id="\u6BD4\u8F83\u8FD0\u7B97\u7B26" tabindex="-1"><a class="header-anchor" href="#\u6BD4\u8F83\u8FD0\u7B97\u7B26" aria-hidden="true">#</a> \u6BD4\u8F83\u8FD0\u7B97\u7B26</h4><blockquote><p>\u5B98\u65B9\u6587\u6863: https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF</p></blockquote><table><thead><tr><th>\u6BD4\u8F83\u8FD0\u7B97\u7B26</th><th>\u63CF\u8FF0</th></tr></thead><tbody><tr><td><code>=\u3001==\u3001&lt;=&gt;</code></td><td>\u7B49\u4E8E</td></tr><tr><td><code>&lt;&gt;\u3001!=</code></td><td>\u4E0D\u7B49\u4E8E</td></tr><tr><td><code>&lt;\u3001&lt;=\u3001 &gt;\u3001&gt;=</code></td><td>\u5927\u4E8E\u7B49\u4E8E\u3001\u5C0F\u4E8E\u7B49\u4E8E</td></tr><tr><td><code>is [not] null</code></td><td>\u5982\u679CA\u7B49\u4E8ENULL\uFF0C\u5219\u8FD4\u56DETRUE\uFF0C\u53CD\u4E4B\u8FD4\u56DEFALSE\u3002\u4F7F\u7528NOT\u5173\u952E\u5B57\u7ED3\u679C\u76F8\u53CD\u3002</td></tr><tr><td><code>in (value1, value2, ... ...)</code></td><td>\u5339\u914D\u5217\u8868\u4E2D\u7684\u503C</td></tr><tr><td><code>LIKE</code></td><td>\u7B80\u5355\u6B63\u5219\u8868\u8FBE\u5F0F\uFF0C\u4E5F\u79F0\u901A\u914D\u7B26\u6A21\u5F0F\u3002&#39;x%&#39; \u8868\u793A\u5FC5\u987B\u4EE5\u5B57\u6BCD &#39;x&#39; \u5F00 \u5934;&#39;%x&#39;\u8868\u793A\u5FC5\u987B\u4EE5\u5B57\u6BCD&#39;x&#39;\u7ED3\u5C3E;&#39;%x%&#39;\u8868\u793A\u5305\u542B\u6709\u5B57\u6BCD&#39;x&#39;\uFF0C\u53EF\u4EE5\u4F4D\u4E8E\u5B57\u7B26\u4E32\u4EFB\u610F\u4F4D\u7F6E\u3002\u4F7F\u7528NOT\u5173\u952E\u5B57\u7ED3\u679C\u76F8\u53CD\u3002<br>% \u4EE3\u8868\u5339\u914D\u96F6\u4E2A\u6216\u591A\u4E2A\u5B57\u7B26(\u4EFB\u610F\u4E2A\u5B57\u7B26);_ \u4EE3\u8868\u5339\u914D\u4E00\u4E2A\u5B57\u7B26\u3002</td></tr><tr><td><code>[NOT] BETWEEN ... AND ...</code></td><td>\u8303\u56F4\u7684\u5224\u65AD\uFF0C\u4F7F\u7528NOT\u5173\u952E\u5B57\u7ED3\u679C\u76F8\u53CD\u3002</td></tr><tr><td><code>RLIKE\u3001 REGEXP</code></td><td>\u57FA\u4E8Ejava\u7684\u6B63\u5219\u8868\u8FBE\u5F0F\uFF0C\u5339\u914D\u8FD4\u56DETRUE\uFF0C\u53CD\u4E4B\u8FD4\u56DEFALSE\u3002\u5339\u914D\u4F7F\u7528\u7684\u662FJDK\u4E2D\u7684\u6B63\u5219\u8868\u8FBE\u5F0F\u63A5\u53E3\u5B9E\u73B0\u7684\uFF0C\u56E0\u4E3A\u6B63\u5219\u4E5F\u4F9D\u636E\u5176\u4E2D\u7684\u89C4\u5219\u3002\u4F8B\u5982\uFF0C\u6B63\u5219\u8868\u8FBE\u5F0F\u5FC5\u987B\u548C\u6574\u4E2A\u5B57\u7B26\u4E32A\u76F8\u5339\u914D\uFF0C\u800C\u4E0D\u662F\u53EA\u9700\u4E0E\u5176\u5B57\u7B26\u4E32\u5339\u914D\u3002</td></tr></tbody></table><blockquote><p>\u5907\u6CE8: \u901A\u5E38\u60C5\u51B5\u4E0BNULL\u53C2\u4E0E\u8FD0\u7B97\uFF0C\u8FD4\u56DE\u503C\u4E3ANULL; <code>NULL&lt;=&gt;NULL</code> \u7684\u7ED3\u679C\u4E3Atrue</p></blockquote><blockquote><p>\u4E0D\u80FD\u4F7F\u7528 <code>!= null</code>, \u53EA\u80FD\u4F7F\u7528 <code>is null</code></p></blockquote><p>####\u903B\u8F91\u8FD0\u7B97\u7B26</p><p>\u5C31\u662F\u6211\u4EEC\u6240\u719F\u6089\u7684: and\u3001or\u3001not</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u6BD4\u8F83\u8FD0\u7B97\u7B26\uFF0Cnull\u53C2\u4E0E\u8FD0\u7B97</span>
<span class="token keyword">select</span> <span class="token boolean">null</span><span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">;</span>   <span class="token comment">-- NULL</span>
<span class="token keyword">select</span> <span class="token boolean">null</span><span class="token operator">=</span><span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">;</span>  <span class="token comment">-- NULL</span>
<span class="token keyword">select</span> <span class="token boolean">null</span><span class="token operator">&lt;=&gt;</span><span class="token boolean">null</span><span class="token punctuation">;</span> <span class="token comment">-- true \u76F8\u5F53\u4E8E is null</span>

<span class="token comment">-- \u4F7F\u7528 is null \u5224\u7A7A</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> comm <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">;</span>
<span class="token comment">-- \u4E0D\u80FD\u4F7F\u7528 \`!= null\`, \u53EA\u80FD\u4F7F\u7528 \`is null\`</span>

<span class="token comment">--\u4F7F\u7528in</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> deptno <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- \u4F7F\u7528 between ... and ...</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> sal <span class="token operator">between</span> <span class="token number">1000</span> <span class="token operator">and</span> <span class="token number">2000</span><span class="token punctuation">;</span>

<span class="token comment">-- \u4F7F\u7528 like</span>
<span class="token keyword">select</span> ename<span class="token punctuation">,</span> sal <span class="token keyword">from</span> emp <span class="token keyword">where</span> ename <span class="token operator">like</span> <span class="token string">&#39;%L%&#39;</span><span class="token punctuation">;</span>

<span class="token comment">-- \u4F7F\u7528 rlike\u3002\u6B63\u5219\u8868\u8FBE\u5F0F\uFF0C\u540D\u5B57\u4EE5A\u6216S\u5F00\u5934</span>
<span class="token keyword">select</span> ename<span class="token punctuation">,</span> sal <span class="token keyword">from</span> emp <span class="token keyword">where</span> ename <span class="token operator">rlike</span> <span class="token string">&#39;^(A|S).*&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="\u7B2C-3-\u8282-group-by\u5B50\u53E5" tabindex="-1"><a class="header-anchor" href="#\u7B2C-3-\u8282-group-by\u5B50\u53E5" aria-hidden="true">#</a> \u7B2C 3 \u8282 group by\u5B50\u53E5</h3><p>GROUP BY\u8BED\u53E5\u901A\u5E38\u4E0E\u805A\u7EC4\u51FD\u6570\u4E00\u8D77\u4F7F\u7528\uFF0C\u6309\u7167\u4E00\u4E2A\u6216\u591A\u4E2A\u5217\u5BF9\u6570\u636E\u8FDB\u884C\u5206\u7EC4\uFF0C\u5BF9\u6BCF\u4E2A\u7EC4\u8FDB\u884C\u805A\u5408\u64CD\u4F5C\u3002</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u8BA1\u7B97emp\u8868\u6BCF\u4E2A\u90E8\u95E8\u7684\u5E73\u5747\u5DE5\u8D44</span>
<span class="token keyword">SELECT</span> deptno<span class="token punctuation">,</span> <span class="token function">AVG</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">FROM</span> emp <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> deptno<span class="token punctuation">;</span>

<span class="token comment">-- \u8BA1\u7B97emp\u6BCF\u4E2A\u90E8\u95E8\u4E2D\u6BCF\u4E2A\u5C97\u4F4D\u7684\u6700\u9AD8\u85AA\u6C34</span>
<span class="token keyword">SELECT</span> deptno<span class="token punctuation">,</span> job<span class="token punctuation">,</span> <span class="token function">MAX</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">FROM</span> emp <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> deptno<span class="token punctuation">,</span> job<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>WHERE \u5B50\u53E5\u9488\u5BF9\u8868\u4E2D\u7684\u6570\u636E\u53D1\u6325\u4F5C\u7528; <em>HAVING \u9488\u5BF9\u67E5\u8BE2\u7ED3\u679C(\u805A\u7EC4\u4EE5\u540E\u7684\u7ED3\u679C)\u53D1\u6325\u4F5C\u7528</em></li><li>WHERE \u5B50\u53E5\u4E0D\u80FD\u6709\u5206\u7EC4\u51FD\u6570; HAVING \u5B50\u53E5\u53EF\u4EE5\u6709\u5206\u7EC4\u51FD\u6570</li><li>HAVING \u53EA\u7528\u4E8E GROUP BY \u5206\u7EC4\u7EDF\u8BA1\u4E4B\u540E</li></ul><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u6C42\u6BCF\u4E2A\u90E8\u95E8\u7684\u5E73\u5747\u85AA\u6C34\u5927\u4E8E2000\u7684\u90E8\u95E8 </span>
<span class="token keyword">SELECT</span> deptno<span class="token punctuation">,</span> <span class="token function">AVG</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> emp
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> deptno
<span class="token keyword">HAVING</span> <span class="token function">AVG</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2000</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="\u7B2C-4-\u8282-\u8868\u8FDE\u63A5" tabindex="-1"><a class="header-anchor" href="#\u7B2C-4-\u8282-\u8868\u8FDE\u63A5" aria-hidden="true">#</a> \u7B2C 4 \u8282 \u8868\u8FDE\u63A5</h3><p>Hive\u652F\u6301\u901A\u5E38SQL\u7684<code>JOIN</code>\u8BED\u53E5\u3002\u9ED8\u8BA4\u60C5\u51B5\u4E0B\uFF0C<em>\u4EC5\u652F\u6301\u7B49\u503C\u8FDE\u63A5</em>\uFF0C\u4E0D\u652F\u6301\u975E\u7B49\u503C\u8FDE\u63A5\u3002</p><p>JOIN \u8BED\u53E5\u4E2D\u7ECF\u5E38\u4F1A\u4F7F\u7528\u8868\u7684\u522B\u540D\u3002\u4F7F\u7528\u522B\u540D\u53EF\u4EE5\u7B80\u5316SQL\u8BED\u53E5\u7684\u7F16\u5199\uFF0C\u4F7F\u7528\u8868\u540D\u524D\u7F00\u53EF\u4EE5\u63D0\u9AD8SQL\u7684\u89E3\u6790\u6548\u7387\u3002</p><p>\u8FDE\u63A5\u67E5\u8BE2\u64CD\u4F5C\u5206\u4E3A\u4E24\u5927\u7C7B: \u5185\u8FDE\u63A5\u548C\u5916\u8FDE\u63A5\uFF0C\u800C\u5916\u8FDE\u63A5\u53EF\u8FDB\u4E00\u6B65\u7EC6\u5206\u4E3A\u4E09\u79CD\u7C7B\u578B:</p><ol><li>\u5185\u8FDE\u63A5: <code>[inner] join</code></li><li>\u5916\u8FDE\u63A5 (<code>outer join</code>) <ul><li>\u5DE6\u5916\u8FDE\u63A5\u3002 <code>left [outer] join</code>\uFF0C\u5DE6\u8868\u7684\u6570\u636E\u5168\u90E8\u663E\u793A</li><li>\u53F3\u5916\u8FDE\u63A5\u3002 <code>right [outer] join</code>\uFF0C\u53F3\u8868\u7684\u6570\u636E\u5168\u90E8\u663E\u793A</li><li>\u5168\u5916\u8FDE\u63A5\u3002 <code>full [outer] join</code>\uFF0C\u4E24\u5F20\u8868\u7684\u6570\u636E\u90FD\u663E\u793A</li></ul></li></ol><blockquote><p>\u4E2A\u4EBA\u89C9\u5F97\uFF1A\u5DE6\u5916\u8FDE\u63A5\u53EF\u4EE5\u7406\u89E3\u6210\u5DE6\u8FB9\u662F\u4E3B\u8868\uFF0C\u53F3\u8FB9\u7684\u8868\u662F\u7528\u4E8E\u5B8C\u5584\u5DE6\u8868\u7684\u6570\u636E\u7684\u8865\u5145\u3002</p></blockquote><h4 id="\u591A\u8868\u8FDE\u63A5" tabindex="-1"><a class="header-anchor" href="#\u591A\u8868\u8FDE\u63A5" aria-hidden="true">#</a> \u591A\u8868\u8FDE\u63A5</h4><p>\u8FDE\u63A5 n \u5F20\u8868\uFF0C\u81F3\u5C11\u9700\u8981 n-1 \u4E2A\u8FDE\u63A5\u6761\u4EF6\u3002</p><p>\u4F8B\u5982: \u8FDE\u63A5\u56DB\u5F20\u8868\uFF0C\u81F3\u5C11\u9700\u8981\u4E09\u4E2A\u8FDE\u63A5\u6761\u4EF6\u3002</p><p>\u591A\u8868\u8FDE\u63A5\u67E5\u8BE2\uFF0C\u67E5\u8BE2\u8001\u5E08\u5BF9\u5E94\u7684\u8BFE\u7A0B\uFF0C\u4EE5\u53CA\u5BF9\u5E94\u7684\u5206\u6570\uFF0C\u5BF9\u5E94\u7684\u5B66\u751F:</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> techer t 
    <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> course c <span class="token keyword">ON</span> t<span class="token punctuation">.</span>t_id <span class="token operator">=</span> c<span class="token punctuation">.</span>t_id
    <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> score  s <span class="token keyword">ON</span> s<span class="token punctuation">.</span>c_id <span class="token operator">=</span> c<span class="token punctuation">.</span>c_id
    <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> student stu <span class="token keyword">ON</span> s<span class="token punctuation">.</span>s_id <span class="token operator">=</span> stu<span class="token punctuation">.</span>s_id<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>Hive\u603B\u662F\u6309\u7167\u4ECE\u5DE6\u5230\u53F3\u7684\u987A\u5E8F\u6267\u884C\uFF0CHive\u4F1A\u5BF9\u6BCF\u5BF9 <code>JOIN</code> \u8FDE\u63A5\u5BF9\u8C61\u542F\u52A8\u4E00\u4E2A MapReduce \u4EFB\u52A1\u3002</p><p>\u4E0A\u9762\u7684\u4F8B\u5B50\u4E2D\u4F1A\u9996\u5148\u542F\u52A8\u4E00\u4E2A MapReduce job \u5BF9\u8868 t \u548C\u8868 c \u8FDB\u884C\u8FDE\u63A5\u64CD\u4F5C; \u7136\u540E\u518D\u542F\u52A8\u4E00\u4E2A MapReduce job \u5C06\u7B2C\u4E00\u4E2A MapReduce job \u7684\u8F93\u51FA\u548C\u8868 s \u8FDB\u884C\u8FDE\u63A5\u64CD\u4F5C; \u7136\u540E\u518D\u7EE7\u7EED\u76F4\u5230\u5168\u90E8\u64CD\u4F5C;</p><h4 id="\u7B1B\u5361\u5C14\u79EF" tabindex="-1"><a class="header-anchor" href="#\u7B1B\u5361\u5C14\u79EF" aria-hidden="true">#</a> \u7B1B\u5361\u5C14\u79EF</h4><p>\u6EE1\u8DB3\u4EE5\u4E0B\u6761\u4EF6\u5C06\u4F1A\u4EA7\u751F\u7B1B\u5361\u5C14\u96C6:</p><ul><li>\u6CA1\u6709\u8FDE\u63A5\u6761\u4EF6</li><li>\u8FDE\u63A5\u6761\u4EF6\u65E0\u6548</li><li>\u6240\u6709\u8868\u4E2D\u7684\u6240\u6709\u884C\u4E92\u76F8\u8FDE\u63A5</li></ul><p>\u5982\u679C\u8868A\u3001B\u5206\u522B\u6709M\u3001N\u6761\u6570\u636E\uFF0C\u5176\u7B1B\u5361\u5C14\u79EF\u7684\u7ED3\u679C\u5C06\u6709 M*N \u6761\u6570\u636E; \u9ED8\u8BA4\u60C5\u51B5\u4E0B Hive \u4E0D\u652F\u6301\u7B1B\u5361\u5C14\u79EF\u8FD0\u7B97;</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SET</span> hive<span class="token punctuation">.</span>strict<span class="token punctuation">.</span>checks<span class="token punctuation">.</span>cartesian<span class="token punctuation">.</span>product<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> u1<span class="token punctuation">,</span> u2<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="\u7B2C-5-\u8282-\u6392\u5E8F\u5B50\u53E5\u3010\u91CD\u70B9\u3011" tabindex="-1"><a class="header-anchor" href="#\u7B2C-5-\u8282-\u6392\u5E8F\u5B50\u53E5\u3010\u91CD\u70B9\u3011" aria-hidden="true">#</a> \u7B2C 5 \u8282 \u6392\u5E8F\u5B50\u53E5\u3010\u91CD\u70B9\u3011</h3><h4 id="\u5168\u5C40\u6392\u5E8F-order-by" tabindex="-1"><a class="header-anchor" href="#\u5168\u5C40\u6392\u5E8F-order-by" aria-hidden="true">#</a> \u5168\u5C40\u6392\u5E8F(order by)</h4><p>ORDER BY \u5B50\u53E5\u51FA\u73B0\u5728 SELECT \u8BED\u53E5\u7684\u7ED3\u5C3E;</p><p>ORDER BY \u5B50\u53E5\u5BF9\u6700\u7EC8\u7684\u7ED3\u679C\u8FDB\u884C\u6392\u5E8F;</p><p>\u9ED8\u8BA4\u4F7F\u7528\u5347\u5E8F(ASC);\u53EF\u4EE5\u4F7F\u7528DESC\uFF0C\u8DDF\u5728\u5B57\u6BB5\u540D\u4E4B\u540E\u8868\u793A\u964D\u5E8F;</p><p><em>ORDER BY \u6267\u884C\u5168\u5C40\u6392\u5E8F\uFF0C\u53EA\u6709\u4E00\u4E2A Reduce;</em>(\u56E0\u6B64\u5982\u679C\u6570\u636E\u91CF\u8FC7\u5927\uFF0C\u5C31\u4E0D\u9002\u7528)</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u666E\u901A\u6392\u5E8F</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> deptno<span class="token punctuation">;</span>

<span class="token comment">-- \u6309\u522B\u540D\u6392\u5E8F</span>
<span class="token keyword">SELECT</span> empno<span class="token punctuation">,</span> ename<span class="token punctuation">,</span> job<span class="token punctuation">,</span> mgr<span class="token punctuation">,</span> sal <span class="token operator">+</span> nvl<span class="token punctuation">(</span>comm<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> salcomm<span class="token punctuation">,</span> deptno
<span class="token keyword">FROM</span> emp
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salcomm <span class="token keyword">DESC</span><span class="token punctuation">;</span>

<span class="token comment">-- \u591A\u5217\u6392\u5E8F</span>
<span class="token keyword">SELECT</span> empno<span class="token punctuation">,</span> ename<span class="token punctuation">,</span> job<span class="token punctuation">,</span> mgr<span class="token punctuation">,</span> sal <span class="token operator">+</span> nvl<span class="token punctuation">(</span>comm<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> salcomm<span class="token punctuation">,</span> deptno
<span class="token keyword">FROM</span> emp
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> deptno<span class="token punctuation">,</span> salcomm <span class="token keyword">DESC</span><span class="token punctuation">;</span>

<span class="token comment">-- \u6392\u5E8F\u5B57\u6BB5\u8981\u51FA\u73B0\u5728SELECT\u5B50\u53E5\u4E2D\u3002\u4EE5\u4E0B\u8BED\u53E5\u65E0\u6CD5\u6267\u884C(\u56E0\u4E3ASELECT\u5B50\u53E5\u4E2D\u7F3A\u5C11deptno):</span>
<span class="token keyword">SELECT</span> empno<span class="token punctuation">,</span> ename<span class="token punctuation">,</span> job<span class="token punctuation">,</span> mgr<span class="token punctuation">,</span> sal <span class="token operator">+</span> nvl<span class="token punctuation">(</span>comm<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> salcomm
<span class="token keyword">FROM</span> emp
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> deptno<span class="token punctuation">,</span> salcomm <span class="token keyword">DESC</span><span class="token punctuation">;</span>
<span class="token comment">-- FAILED: SemanticException [Error 10004]: Line 3:9 Invalid table alias or column reference &#39;deptno&#39;: (possible column names are: empno, ename, job, mgr, salcomm)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="\u6BCF\u4E2Amr\u5185\u90E8\u6392\u5E8F-sort-by" tabindex="-1"><a class="header-anchor" href="#\u6BCF\u4E2Amr\u5185\u90E8\u6392\u5E8F-sort-by" aria-hidden="true">#</a> \u6BCF\u4E2AMR\u5185\u90E8\u6392\u5E8F(sort by)</h4><p>\u5BF9\u4E8E\u5927\u89C4\u6A21\u6570\u636E\u800C\u8A00 ORDER BY \u6548\u7387\u4F4E;</p><p>\u5728\u5F88\u591A\u4E1A\u52A1\u573A\u666F\uFF0C\u6211\u4EEC\u5E76\u4E0D\u9700\u8981\u5168\u5C40\u6709\u5E8F\u7684\u6570\u636E\uFF0C\u6B64\u65F6\u53EF\u4EE5\u4F7F\u7528sort by;</p><p>sort by\u4E3A\u6BCF\u4E2Areduce\u4EA7\u751F\u4E00\u4E2A\u6392\u5E8F\u6587\u4EF6\uFF0C\u5728reduce\u5185\u90E8\u8FDB\u884C\u6392\u5E8F\uFF0C\u5F97\u5230\u5C40\u90E8\u6709\u5E8F\u7684\u7ED3\u679C;</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u8BBE\u7F6Ereduce\u4E2A\u6570</span>
<span class="token keyword">set</span> mapreduce<span class="token punctuation">.</span>job<span class="token punctuation">.</span>reduces<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
<span class="token comment">-- \u6309\u7167\u5DE5\u8D44\u964D\u5E8F\u67E5\u770B\u5458\u5DE5\u4FE1\u606F</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp SORT <span class="token keyword">BY</span> sal <span class="token keyword">DESC</span><span class="token punctuation">;</span>
<span class="token comment">-- \u5C06\u67E5\u8BE2\u7ED3\u679C\u5BFC\u5165\u5230\u6587\u4EF6\u4E2D(\u6309\u7167\u5DE5\u8D44\u964D\u5E8F)\u3002\u751F\u6210\u4E24\u4E2A\u8F93\u51FA\u6587\u4EF6\uFF0C\u6BCF\u4E2A\u6587\u4EF6\u5185\u90E8\u6570\u636E \u6309\u5DE5\u8D44\u964D\u5E8F\u6392\u5217</span>
<span class="token keyword">INSERT</span> overwrite <span class="token keyword">local</span> directory <span class="token string">&#39;/home/hadoop/output/sortsal&#39;</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp SORT <span class="token keyword">BY</span> sal <span class="token keyword">DESC</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>ORDER BY \u5168\u5C40\u6392\u5E8F; SORT BY \u5728Reduce\u5185\u90E8\u5C40\u90E8\u6392\u5E8F\u3002</p></blockquote><h4 id="\u5206\u533A\u6392\u5E8F-distribute-by" tabindex="-1"><a class="header-anchor" href="#\u5206\u533A\u6392\u5E8F-distribute-by" aria-hidden="true">#</a> \u5206\u533A\u6392\u5E8F(distribute by)</h4><p>DISTRIBUTE BY \u5C06\u7279\u5B9A\u7684\u884C\u53D1\u9001\u5230\u7279\u5B9A\u7684reducer\u4E2D\uFF0C\u4FBF\u4E8E\u540E\u7EE7\u7684\u805A\u5408\u4E0E\u6392\u5E8F\u64CD\u4F5C;</p><p>DISTRIBUTE BY \u7C7B\u4F3C\u4E8EMR\u4E2D\u7684\u5206\u533A\u64CD\u4F5C\uFF0C\u53EF\u4EE5\u7ED3\u5408sort by\u64CD\u4F5C\uFF0C\u4F7F\u5206\u533A\u6570\u636E\u6709\u5E8F;</p><p>DISTRIBUTE BY \u8981\u5199\u5728 sort by \u4E4B\u524D;</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u542F\u52A82\u4E2Areducer task;</span>
<span class="token comment">-- \u5148\u6309 deptno \u5206\u533A\uFF0C\u5728\u5206\u533A\u5185\u6309 sal+comm \u6392\u5E8F </span>
<span class="token keyword">set</span> mapreduce<span class="token punctuation">.</span>job<span class="token punctuation">.</span>reduces<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
<span class="token comment">-- \u5C06\u7ED3\u679C\u8F93\u51FA\u5230\u6587\u4EF6\uFF0C\u89C2\u5BDF\u8F93\u51FA\u7ED3\u679C</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">local</span> directory <span class="token string">&#39;/home/hadoop/output/distBy&#39;</span> 
<span class="token keyword">SELECT</span> empno<span class="token punctuation">,</span> ename<span class="token punctuation">,</span> job<span class="token punctuation">,</span> deptno<span class="token punctuation">,</span> sal <span class="token operator">+</span> nvl<span class="token punctuation">(</span>comm<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> salcomm
<span class="token keyword">FROM</span> emp
DISTRIBUTE <span class="token keyword">BY</span> deptno
SORT <span class="token keyword">BY</span> salcomm <span class="token keyword">desc</span><span class="token punctuation">;</span>
<span class="token comment">-- \u4E0A\u4F8B\u4E2D\uFF0C\u6570\u636E\u88AB\u5206\u5230\u4E86\u540C\u4E00\u533A\uFF0C\u770B\u4E0D\u51FA\u5206\u533A\u7684\u7ED3\u679C\u3002</span>
<span class="token comment">-- \u56E0\u4E3A10,20,30 \u8FD9\u51E0\u4E2A\u503C % 2(\u5206\u533A\u6570) \u90FD\u7B49\u4E8E0\uFF0C\u6240\u4EE5\u6570\u636E\u90FD\u8FDB\u5165\u4E86 0 \u53F7\u5206\u533A</span>

<span class="token comment">-- \u5C06\u6570\u636E\u5206\u52303\u4E2A\u533A\u4E2D\uFF0C\u6BCF\u4E2A\u5206\u533A\u90FD\u6709\u6570\u636E</span>
<span class="token keyword">set</span> mapreduce<span class="token punctuation">.</span>job<span class="token punctuation">.</span>reduces<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">local</span> directory <span class="token string">&#39;/home/hadoop/output/distBy1&#39;</span>
<span class="token keyword">SELECT</span> empno<span class="token punctuation">,</span> ename<span class="token punctuation">,</span> job<span class="token punctuation">,</span> deptno<span class="token punctuation">,</span> sal <span class="token operator">+</span> nvl<span class="token punctuation">(</span>comm<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> salcomm
<span class="token keyword">FROM</span> emp
DISTRIBUTE <span class="token keyword">BY</span> deptno
SORT <span class="token keyword">BY</span> salcomm <span class="token keyword">DESC</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><blockquote><p>DISTRIBUTE BY \u76F8\u5F53\u4E8E MR \u5F53\u4E2D\u6307\u5B9A Partitioner, SORT BY \u76F8\u5F53\u4E8E MR \u5F53\u4E2D\u6307\u5B9A GroupingComparator</p></blockquote><h4 id="cluster-by" tabindex="-1"><a class="header-anchor" href="#cluster-by" aria-hidden="true">#</a> Cluster By</h4><p>\u5F53 <code>DISTRIBUTE BY</code> \u4E0E <code>SORT BY</code> \u662F\u540C\u4E00\u4E2A\u5B57\u6BB5\u65F6\uFF0C\u53EF\u4F7F\u7528 CLUSTER BY \u7B80\u5316\u8BED\u6CD5;</p><blockquote><p>\u4E5F\u5C31\u662F\u6839\u636E\u540C\u4E00\u5B57\u6BB5\u5206\u533A\u5E76\u6392\u5E8F\uFF0C\u6392\u5E8F\u89C4\u5219\u53EA\u80FD\u662F\u5347\u5E8F\u3002</p></blockquote><p>\u9650\u5236\uFF1ACLUSTER BY \u53EA\u80FD\u662F\u5347\u5E8F\uFF0C\u4E0D\u80FD\u6307\u5B9A\u6392\u5E8F\u89C4\u5219;</p><blockquote><p>\u4E2A\u4EBA\u5B9E\u6D4B\uFF1A\u6B64\u5904\u7684\u5347\u5E8F\u4E5F\u4E0D\u662F\u4E1A\u52A1\u610F\u4E49\u4E0A\u7684\u5347\u5E8F\uFF0C\u800C\u662F <code>\u5B57\u6BB5\u503C % \u5206\u533A\u6570</code> \u7684\u503C\u5F97\u5347\u5E8F\u3002\u8FD9\u53EF\u80FD\u4E5F\u662F\u4E3A\u4EC0\u4E48\u53EA\u80FD\u5347\u5E8F\u7684\u539F\u56E0\u5427\u3002</p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u8BED\u6CD5\u4E0A\u662F\u7B49\u4EF7\u7684</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp DISTRIBUTE <span class="token keyword">BY</span> deptno SORT <span class="token keyword">BY</span> deptno<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp CLUSTER <span class="token keyword">BY</span> deptno<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>\u6392\u5E8F\u5C0F\u7ED3</strong></p><ul><li>ORDER BY \u6267\u884C\u5168\u5C40\u6392\u5E8F\uFF0C\u6548\u7387\u4F4E\u3002<em>\u751F\u4EA7\u73AF\u5883\u4E2D\u614E\u7528</em></li><li>SORT BY \u4F7F\u6570\u636E\u5C40\u90E8\u6709\u5E8F(\u5728reduce\u5185\u90E8\u6709\u5E8F)</li><li>DISTRIBUTE BY \u6309\u7167\u6307\u5B9A\u7684\u6761\u4EF6\u5C06\u6570\u636E\u5206\u7EC4\uFF0C\u5E38\u4E0E SORT BY \u8054\u7528\uFF0C\u4F7F\u6570\u636E\u5C40\u90E8\u6709\u5E8F</li><li>CLUSTER BY \u5F53 DISTRIBUTE BY \u4E0E SORT BY \u662F\u540C\u4E00\u4E2A\u5B57\u6BB5\u65F6\uFF0C\u53EF\u4F7F\u7528 CLUSTER BY \u7B80\u5316\u8BED\u6CD5</li></ul><h2 id="\u7B2C\u4E03\u90E8\u5206-\u51FD\u6570" tabindex="-1"><a class="header-anchor" href="#\u7B2C\u4E03\u90E8\u5206-\u51FD\u6570" aria-hidden="true">#</a> \u7B2C\u4E03\u90E8\u5206 \u51FD\u6570</h2>`,77),b=a("Hive\u5185\u7F6E\u51FD\u6570: "),m={href:"https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF#LanguageManualUDF-Built-inFunctions",target:"_blank",rel:"noopener noreferrer"},d=a("https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF#LanguageManualUDF-Built-inFunctions"),y=s(`<h3 id="\u7B2C-1-\u8282-\u7CFB\u7EDF\u5185\u7F6E\u51FD\u6570" tabindex="-1"><a class="header-anchor" href="#\u7B2C-1-\u8282-\u7CFB\u7EDF\u5185\u7F6E\u51FD\u6570" aria-hidden="true">#</a> \u7B2C 1 \u8282 \u7CFB\u7EDF\u5185\u7F6E\u51FD\u6570</h3><h4 id="\u67E5\u770B\u7CFB\u7EDF\u51FD\u6570" tabindex="-1"><a class="header-anchor" href="#\u67E5\u770B\u7CFB\u7EDF\u51FD\u6570" aria-hidden="true">#</a> \u67E5\u770B\u7CFB\u7EDF\u51FD\u6570</h4><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u67E5\u770B\u7CFB\u7EDF\u81EA\u5E26\u51FD\u6570 </span>
<span class="token keyword">show</span> functions<span class="token punctuation">;</span>

<span class="token comment">-- \u663E\u793A\u81EA\u5E26\u51FD\u6570\u7684\u7528\u6CD5</span>
<span class="token keyword">desc</span> <span class="token keyword">function</span> upper<span class="token punctuation">;</span>
<span class="token keyword">desc</span> <span class="token keyword">function</span> <span class="token keyword">extended</span> upper<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="\u65E5\u671F\u51FD\u6570\u3010\u91CD\u8981\u3011" tabindex="-1"><a class="header-anchor" href="#\u65E5\u671F\u51FD\u6570\u3010\u91CD\u8981\u3011" aria-hidden="true">#</a> \u65E5\u671F\u51FD\u6570\u3010\u91CD\u8981\u3011</h4><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u5F53\u524D\u65E5\u671F</span>
<span class="token keyword">select</span> <span class="token keyword">current_date</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> unix_timestamp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- unix_timestamp(void) is deprecated. Use current_timestamp instead.</span>
<span class="token comment">-- \u5EFA\u8BAE\u4F7F\u7528current_timestamp\uFF0C\u6709\u6CA1\u6709\u62EC\u53F7\u90FD\u53EF\u4EE5 </span>
<span class="token keyword">select</span> <span class="token keyword">current_timestamp</span><span class="token punctuation">;</span>

<span class="token comment">-- \u65F6\u95F4\u6233\u8F6C\u65E5\u671F</span>
<span class="token keyword">select</span> from_unixtime<span class="token punctuation">(</span><span class="token number">1645067197</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> from_unixtime<span class="token punctuation">(</span><span class="token number">1645067197</span><span class="token punctuation">,</span> <span class="token string">&#39;yyyyMMdd&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> from_unixtime<span class="token punctuation">(</span><span class="token number">1645067197</span><span class="token punctuation">,</span> <span class="token string">&#39;yyyy-MM-dd HH:mm:ss&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- \u65E5\u671F\u8F6C\u65F6\u95F4\u6233</span>
<span class="token keyword">select</span> unix_timestamp<span class="token punctuation">(</span><span class="token string">&#39;2022-02-17 11:06:37&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- \u8BA1\u7B97\u65F6\u95F4\u5DEE</span>
<span class="token comment">-- 149</span>
<span class="token keyword">select</span> datediff<span class="token punctuation">(</span><span class="token string">&#39;2020-04-18&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;2019-11-21&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- -149</span>
<span class="token keyword">select</span> datediff<span class="token punctuation">(</span><span class="token string">&#39;2019-11-21&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;2020-04-18&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- \u67E5\u8BE2\u5F53\u6708\u7B2C\u51E0\u5929</span>
<span class="token keyword">select</span> dayofmonth<span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- \u8BA1\u7B97\u6708\u672B:</span>
<span class="token keyword">select</span> last_day<span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- \u5F53\u6708\u7B2C1\u5929:</span>
<span class="token comment">-- date_sub(start_date, num_days) - Returns the date that is num_days before start_date.</span>
<span class="token keyword">select</span> date_sub<span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">,</span> dayofmonth<span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- \u4E0B\u4E2A\u6708\u7B2C1\u5929:</span>
<span class="token comment">-- add_months(start_date, num_months) - Returns the date that is num_months after start_date.</span>
<span class="token keyword">select</span> add_months<span class="token punctuation">(</span>date_sub<span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">,</span> dayofmonth<span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- \u5B57\u7B26\u4E32\u8F6C\u65F6\u95F4(\u5B57\u7B26\u4E32\u5FC5\u987B\u4E3A:yyyy-MM-dd\u683C\u5F0F) </span>
<span class="token keyword">select</span> to_date<span class="token punctuation">(</span><span class="token string">&#39;2020-01-01&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> to_date<span class="token punctuation">(</span><span class="token string">&#39;2020-01-01 12:12:12&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- \u65E5\u671F\u3001\u65F6\u95F4\u6233\u3001\u5B57\u7B26\u4E32\u7C7B\u578B\u683C\u5F0F\u5316\u8F93\u51FA\u6807\u51C6\u65F6\u95F4\u683C\u5F0F</span>
<span class="token keyword">select</span> date_format<span class="token punctuation">(</span><span class="token keyword">current_timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#39;yyyy-MM-dd HH:mm:ss&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> date_format<span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#39;yyyyMMdd&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> date_format<span class="token punctuation">(</span><span class="token string">&#39;2020-06-01&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;yyyy-MM-dd HH:mm:ss&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- \u8BA1\u7B97emp\u8868\u4E2D\uFF0C\u6BCF\u4E2A\u4EBA\u7684\u5DE5\u9F84</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token function">round</span><span class="token punctuation">(</span>datediff<span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">,</span> hiredate<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">365</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> workingyears <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><h4 id="\u5B57\u7B26\u4E32\u51FD\u6570" tabindex="-1"><a class="header-anchor" href="#\u5B57\u7B26\u4E32\u51FD\u6570" aria-hidden="true">#</a> \u5B57\u7B26\u4E32\u51FD\u6570</h4><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u8F6C\u5C0F\u5199\u3002lower</span>
<span class="token keyword">select</span> lower<span class="token punctuation">(</span><span class="token string">&quot;HELLO WORLD&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- \u8F6C\u5927\u5199\u3002upper</span>
<span class="token keyword">select</span> lower<span class="token punctuation">(</span>ename<span class="token punctuation">)</span><span class="token punctuation">,</span> ename <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- \u6C42\u5B57\u7B26\u4E32\u957F\u5EA6\u3002length</span>
<span class="token keyword">select</span> length<span class="token punctuation">(</span>ename<span class="token punctuation">)</span><span class="token punctuation">,</span> ename <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- \u5B57\u7B26\u4E32\u62FC\u63A5\u3002 concat \u6216 ||</span>
<span class="token keyword">select</span> empno <span class="token operator">||</span> <span class="token string">&quot; &quot;</span> <span class="token operator">||</span>ename idname <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
<span class="token keyword">select</span> concat<span class="token punctuation">(</span>empno<span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span> <span class="token punctuation">,</span>ename<span class="token punctuation">)</span> idname <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- \u6307\u5B9A\u5206\u9694\u7B26\u3002concat_ws(separator, [string | array(string)]+)</span>
<span class="token keyword">SELECT</span> concat_ws<span class="token punctuation">(</span><span class="token string">&#39;.&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;www&#39;</span><span class="token punctuation">,</span> array<span class="token punctuation">(</span><span class="token string">&#39;zmn&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;com&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> concat_ws<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> ename<span class="token punctuation">,</span> job<span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- \u6C42\u5B50\u4E32\u3002substr</span>
<span class="token keyword">SELECT</span> substr<span class="token punctuation">(</span><span class="token string">&#39;www.zmn.com&#39;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> substr<span class="token punctuation">(</span><span class="token string">&#39;www.zmn.com&#39;</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> substr<span class="token punctuation">(</span><span class="token string">&#39;www.zmn.com&#39;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- \u5B57\u7B26\u4E32\u5207\u5206\u3002split\uFF0C\u6CE8\u610F &#39;.&#39; \u8981\u8F6C\u4E49</span>
<span class="token keyword">select</span> split<span class="token punctuation">(</span><span class="token string">&quot;www.zmn.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\\\\.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h4 id="\u6570\u5B66\u51FD\u6570" tabindex="-1"><a class="header-anchor" href="#\u6570\u5B66\u51FD\u6570" aria-hidden="true">#</a> \u6570\u5B66\u51FD\u6570</h4><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u56DB\u820D\u4E94\u5165\u3002round</span>
<span class="token keyword">select</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token number">314.15926</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">select</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token number">314.15926</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 314.16</span>
<span class="token keyword">select</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token number">314.15926</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 300</span>

<span class="token comment">-- \u5411\u4E0A\u53D6\u6574\u3002ceil</span>
<span class="token keyword">select</span> ceil<span class="token punctuation">(</span><span class="token number">3.1415926</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 4</span>
<span class="token comment">-- \u5411\u4E0B\u53D6\u6574\u3002floor</span>
<span class="token keyword">select</span> floor<span class="token punctuation">(</span><span class="token number">3.1415926</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 3</span>
<span class="token comment">-- \u5176\u4ED6\u6570\u5B66\u51FD\u6570\u5305\u62EC:\u7EDD\u5BF9\u503C\u3001\u5E73\u65B9\u3001\u5F00\u65B9\u3001\u5BF9\u6570\u8FD0\u7B97\u3001\u4E09\u89D2\u8FD0\u7B97\u7B49</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="\u6761\u4EF6\u51FD\u6570\u3010\u91CD\u8981\u3011" tabindex="-1"><a class="header-anchor" href="#\u6761\u4EF6\u51FD\u6570\u3010\u91CD\u8981\u3011" aria-hidden="true">#</a> \u6761\u4EF6\u51FD\u6570\u3010\u91CD\u8981\u3011</h4><p>\u6761\u4EF6\u51FD\u6570\u4E3B\u8981\u6709\uFF1Aif, case when, coalesce, isnull/isnotnull, nvl, nullif \u7B49\u7B49</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- if (boolean testCondition, T valueTrue, T valueFalseOrNull)</span>
<span class="token keyword">select</span> sal<span class="token punctuation">,</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sal<span class="token operator">&lt;</span><span class="token number">1500</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sal <span class="token operator">&lt;</span> <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- CASE WHEN a THEN b [WHEN c THEN d]* [ELSE e] END</span>
<span class="token comment">-- \u5C06emp\u8868\u7684\u5458\u5DE5\u5DE5\u8D44\u7B49\u7EA7\u5206\u7C7B:0-1500\u30011500-3000\u30013000\u4EE5\u4E0A</span>
<span class="token keyword">select</span> sal<span class="token punctuation">,</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sal<span class="token operator">&lt;=</span><span class="token number">1500</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sal <span class="token operator">&lt;=</span> <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- CASE WHEN a THEN b [WHEN c THEN d]* [ELSE e] END </span>
<span class="token comment">-- \u590D\u6742\u6761\u4EF6\u7528 case when \u66F4\u76F4\u89C2</span>
<span class="token keyword">select</span> sal<span class="token punctuation">,</span> <span class="token keyword">case</span> <span class="token keyword">when</span> sal<span class="token operator">&lt;=</span><span class="token number">1500</span> <span class="token keyword">then</span> <span class="token number">1</span>
                 <span class="token keyword">when</span> sal<span class="token operator">&lt;=</span><span class="token number">3000</span> <span class="token keyword">then</span> <span class="token number">2</span>
                 <span class="token keyword">else</span> <span class="token number">3</span> <span class="token keyword">end</span> sallevel <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- \u4EE5\u4E0B\u8BED\u53E5\u7B49\u4EF7</span>
<span class="token keyword">select</span> ename<span class="token punctuation">,</span> deptno<span class="token punctuation">,</span>
       <span class="token keyword">case</span> deptno <span class="token keyword">when</span> <span class="token number">10</span> <span class="token keyword">then</span> <span class="token string">&#39;accounting&#39;</span>
                   <span class="token keyword">when</span> <span class="token number">20</span> <span class="token keyword">then</span> <span class="token string">&#39;research&#39;</span>
                   <span class="token keyword">when</span> <span class="token number">30</span> <span class="token keyword">then</span> <span class="token string">&#39;sales&#39;</span>
                   <span class="token keyword">else</span> <span class="token string">&#39;unknown&#39;</span> <span class="token keyword">end</span> deptname
<span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token keyword">select</span> ename<span class="token punctuation">,</span> deptno<span class="token punctuation">,</span>
       <span class="token keyword">case</span> <span class="token keyword">when</span> deptno<span class="token operator">=</span><span class="token number">10</span> <span class="token keyword">then</span> <span class="token string">&#39;accounting&#39;</span>
            <span class="token keyword">when</span> deptno<span class="token operator">=</span><span class="token number">20</span> <span class="token keyword">then</span> <span class="token string">&#39;research&#39;</span>
            <span class="token keyword">when</span> deptno<span class="token operator">=</span><span class="token number">30</span> <span class="token keyword">then</span> <span class="token string">&#39;sales&#39;</span>
            <span class="token keyword">else</span> <span class="token string">&#39;unknown&#39;</span> <span class="token keyword">end</span> deptname
<span class="token keyword">from</span> emp<span class="token punctuation">;</span>


<span class="token comment">-- COALESCE(T v1, T v2, ...)\u3002</span>
<span class="token comment">-- \u8FD4\u56DE\u53C2\u6570\u4E2D\u7684\u7B2C\u4E00\u4E2A\u975E\u7A7A\u503C; \u5982\u679C\u6240\u6709\u503C\u90FD\u4E3ANULL\uFF0C\u90A3\u4E48\u8FD4\u56DENULL</span>
<span class="token keyword">select</span> sal<span class="token punctuation">,</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>comm<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- isnull(a) isnotnull(a)</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> isnull<span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> isnotnull<span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- nvl(T value, T default_value) \u7A7A\u503C\u8F6C\u6362\u51FD\u6570</span>
<span class="token keyword">select</span> empno<span class="token punctuation">,</span> ename<span class="token punctuation">,</span> job<span class="token punctuation">,</span> mgr<span class="token punctuation">,</span> hiredate<span class="token punctuation">,</span> deptno<span class="token punctuation">,</span> sal <span class="token operator">+</span> nvl<span class="token punctuation">(</span>comm<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> sumsal
<span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- nullif(x, y) \u76F8\u7B49\u4E3A\u7A7A\uFF0C\u5426\u5219\u4E3A x</span>
<span class="token comment">-- nullif(a1, a2) - shorthand for: case when a1 = a2 then null else a1</span>
<span class="token keyword">SELECT</span> <span class="token keyword">nullif</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">nullif</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h4 id="udtf\u51FD\u6570\u3010\u91CD\u8981\u3011" tabindex="-1"><a class="header-anchor" href="#udtf\u51FD\u6570\u3010\u91CD\u8981\u3011" aria-hidden="true">#</a> UDTF\u51FD\u6570\u3010\u91CD\u8981\u3011</h4><blockquote><p>UDTF : User Defined Table-Generating Functions\u3002</p></blockquote><p>\u7528\u6237\u5B9A\u4E49\u8868\u751F\u6210\u51FD\u6570\uFF0C\u7279\u70B9\u662F\uFF1A<em>&quot;\u4E00\u884C\u8F93\u5165\uFF0C\u591A\u884C\u8F93\u51FA&quot;</em>\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># explode\uFF0C\u70B8\u88C2\u51FD\u6570</span>
<span class="token comment"># \u5C31\u662F\u5C06\u4E00\u884C\u4E2D\u590D\u6742\u7684 array \u6216\u8005 map \u7ED3\u6784\u62C6\u5206\u6210\u591A\u884C </span>
hive <span class="token punctuation">(</span>default<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> explode<span class="token punctuation">(</span>array<span class="token punctuation">(</span><span class="token string">&#39;A&#39;</span>,<span class="token string">&#39;B&#39;</span>,<span class="token string">&#39;C&#39;</span><span class="token punctuation">))</span> as col<span class="token punctuation">;</span>
OK
col
A
B
C
Time taken: <span class="token number">0.179</span> seconds, Fetched: <span class="token number">3</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

hive <span class="token punctuation">(</span>default<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> explode<span class="token punctuation">(</span>map<span class="token punctuation">(</span><span class="token string">&#39;a&#39;</span>, <span class="token number">8</span>, <span class="token string">&#39;b&#39;</span>, <span class="token number">88</span>, <span class="token string">&#39;c&#39;</span>, <span class="token number">888</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
OK
key     value
a       <span class="token number">8</span>
b       <span class="token number">88</span>
c       <span class="token number">888</span>
Time taken: <span class="token number">0.185</span> seconds, Fetched: <span class="token number">3</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>
<span class="token comment">-- UDTF&#39;s are not supported outside the SELECT clause, nor nested in expressions</span>
<span class="token comment">-- SELECT pageid, explode(adid_list) AS myCol... is not supported   -- \u4E0D\u80FD\u6709\u5176\u4ED6\u5217</span>
<span class="token comment">-- SELECT explode(explode(adid_list)) AS myCol... is not supported  -- \u4E0D\u652F\u6301\u5D4C\u5957</span>

<span class="token comment">-- lateral view \u5E38\u4E0E \u8868\u751F\u6210\u51FD\u6570explode\u7ED3\u5408\u4F7F\u7528</span>

<span class="token comment">-- lateral view \u8BED\u6CD5:</span>
<span class="token comment">-- lateralView: LATERAL VIEW udtf(expression) tableAlias AS columnAlias (&#39;,&#39; columnAlias)*</span>
<span class="token comment">-- fromClause: FROM baseTable (lateralView)*</span>

<span class="token comment">-- lateral view \u7684\u57FA\u672C\u4F7F\u7528 </span>
<span class="token keyword">with</span> t1 <span class="token keyword">as</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token string">&#39;OK&#39;</span> cola<span class="token punctuation">,</span> split<span class="token punctuation">(</span><span class="token string">&#39;www.zmn.cn&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;\\\\.&#39;</span><span class="token punctuation">)</span> colb
<span class="token punctuation">)</span>
<span class="token keyword">select</span> cola<span class="token punctuation">,</span> colc <span class="token keyword">from</span> t1 
    lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>colb<span class="token punctuation">)</span> t2 <span class="token keyword">as</span> colc<span class="token punctuation">;</span>

OK
cola    colc
OK      www
OK      zmn
OK      cn
<span class="token keyword">Time</span> taken: <span class="token number">0.176</span> seconds<span class="token punctuation">,</span> Fetched: <span class="token number">3</span> <span class="token keyword">row</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>\u70B8\u88C2\u51FD\u6570\u6D4B\u8BD5\u6848\u4F8B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># \u6570\u636E
1   1,2,3
2   2,3
3   1,2

# \u5C55\u793A\u4E3A\u5982\u4E0B\u5F62\u5F0F
1   1
1   2
1   3
2   2
2   3
3   1
3   2
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u5EFA\u8868\u52A0\u8F7D\u6570\u636E</span>
hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> create table tab1<span class="token punctuation">(</span>id int, tags string<span class="token punctuation">)</span> row <span class="token function">format</span> delimited fields terminated by <span class="token string">&#39;\\t&#39;</span><span class="token punctuation">;</span>
OK
Time taken: <span class="token number">0.881</span> seconds

hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> load data <span class="token builtin class-name">local</span> inpath <span class="token string">&#39;/home/hadoop/data/tab1.dat&#39;</span> into table tab1<span class="token punctuation">;</span>
Loading data to table mydb.tab1
OK
Time taken: <span class="token number">0.774</span> seconds

hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> * from tab1<span class="token punctuation">;</span>
OK
tab1.id tab1.tags
<span class="token number">1</span>       <span class="token number">1,2</span>,3
<span class="token number">2</span>       <span class="token number">2,3</span>
<span class="token number">3</span>       <span class="token number">1,2</span>
Time taken: <span class="token number">2.228</span> seconds, Fetched: <span class="token number">3</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> id, tag from tab1 lateral view explode<span class="token punctuation">(</span>split<span class="token punctuation">(</span>tags, <span class="token string">&quot;,&quot;</span><span class="token punctuation">))</span> t1 as tag<span class="token punctuation">;</span>
OK
<span class="token function">id</span>      tag
<span class="token number">1</span>       <span class="token number">1</span>
<span class="token number">1</span>       <span class="token number">2</span>
<span class="token number">1</span>       <span class="token number">3</span>
<span class="token number">2</span>       <span class="token number">2</span>
<span class="token number">2</span>       <span class="token number">3</span>
<span class="token number">3</span>       <span class="token number">1</span>
<span class="token number">3</span>       <span class="token number">2</span>
Time taken: <span class="token number">0.102</span> seconds, Fetched: <span class="token number">7</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>\u6D4B\u8BD5\u6848\u4F8B2\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># \u6570\u636E\u51C6\u5907
lisi|Chinese:90,Math:80,English:70
wangwu|Chinese:88,Math:90,English:96
maliu|Chinese:99,Math:65,English:60
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u521B\u5EFA\u8868</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> studscore<span class="token punctuation">(</span>
    name  string<span class="token punctuation">,</span>
    score map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>string<span class="token operator">&gt;</span>
<span class="token punctuation">)</span> <span class="token keyword">row</span> format delimited
<span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">&#39;|&#39;</span>
collection items <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">&#39;,&#39;</span>
map <span class="token keyword">keys</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">&#39;:&#39;</span><span class="token punctuation">;</span>

<span class="token comment">-- \u52A0\u8F7D\u6570\u636E</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">&#39;/home/hadoop/data/score.dat&#39;</span> overwrite <span class="token keyword">into</span> <span class="token keyword">table</span> studscore<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u9700\u6C42\uFF1A\u627E\u5230\u6BCF\u4E2A\u5B66\u5458\u7684\u6700\u597D\u6210\u7EE9</span>
<span class="token comment"># \u7B2C\u4E00\u6B65\uFF0C\u4F7F\u7528 explode \u51FD\u6570\u5C06map\u7ED3\u6784\u62C6\u5206\u4E3A\u591A\u884C\u3002(\u6B64\u5904\u7684 as \u540E\u9762\u4E24\u4E2A\u5B57\u6BB5\u4E00\u5B9A\u8981\u52A0\u62EC\u53F7\uFF0C\u5426\u5219 hive \u8BA4\u4E3A mark \u662F\u8868\u4E2D\u7684\u5B57\u6BB5)</span>
hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> explode<span class="token punctuation">(</span>score<span class="token punctuation">)</span> as <span class="token punctuation">(</span>subject, mark<span class="token punctuation">)</span> from studscore<span class="token punctuation">;</span>
OK
subject mark
Chinese <span class="token number">90</span>
Math    <span class="token number">80</span>
English <span class="token number">70</span>
Chinese <span class="token number">88</span>
Math    <span class="token number">90</span>
English <span class="token number">96</span>
Chinese <span class="token number">99</span>
Math    <span class="token number">65</span>
English <span class="token number">60</span>
Time taken: <span class="token number">0.641</span> seconds, Fetched: <span class="token number">9</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

<span class="token comment"># \u4F46\u662F\u8FD9\u91CC\u7F3A\u5C11\u4E86\u5B66\u5458\u59D3\u540D\uFF0C\u52A0\u4E0A\u5B66\u5458\u59D3\u540D\u540E\u51FA\u9519\u3002\u4E0B\u9762\u7684\u8BED\u53E5\u6709\u662F\u9519\u7684</span>
hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> name, explode<span class="token punctuation">(</span>score<span class="token punctuation">)</span> as <span class="token punctuation">(</span>subject, mark<span class="token punctuation">)</span> from studscore<span class="token punctuation">;</span>
FAILED: SemanticException <span class="token number">1</span>:41 AS clause has an invalid number of aliases. Error encountered near token <span class="token string">&#39;mark&#39;</span>

<span class="token comment"># \u7B2C\u4E8C\u6B65\uFF1Aexplode\u5E38\u4E0E lateral view \u51FD\u6570\u8054\u7528\uFF0C\u8FD9\u4E24\u4E2A\u51FD\u6570\u7ED3\u5408\u5728\u4E00\u8D77\u80FD\u5173\u8054\u5176\u4ED6\u5B57\u6BB5</span>
hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> name, subject, mark from studscore lateral view explode<span class="token punctuation">(</span>score<span class="token punctuation">)</span> t1 as subject, mark<span class="token punctuation">;</span>
OK
name    subject mark
lisi    Chinese <span class="token number">90</span>
lisi    Math    <span class="token number">80</span>
lisi    English <span class="token number">70</span>
wangwu  Chinese <span class="token number">88</span>
wangwu  Math    <span class="token number">90</span>
wangwu  English <span class="token number">96</span>
maliu   Chinese <span class="token number">99</span>
maliu   Math    <span class="token number">65</span>
maliu   English <span class="token number">60</span>
Time taken: <span class="token number">0.092</span> seconds, Fetched: <span class="token number">9</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

<span class="token comment"># \u7B2C\u4E09\u6B65\uFF1A\u627E\u5230\u6BCF\u4E2A\u5B66\u5458\u7684\u6700\u597D\u6210\u7EE9</span>
<span class="token keyword">select</span> name, max<span class="token punctuation">(</span>mark<span class="token punctuation">)</span> maxScore from <span class="token punctuation">(</span>
  <span class="token keyword">select</span> name, subject, mark from studscore lateral view explode<span class="token punctuation">(</span>score<span class="token punctuation">)</span> t1 as subject, mark
<span class="token punctuation">)</span> t2 group by name<span class="token punctuation">;</span>

<span class="token comment"># \u5982\u4E0B SQL \u529F\u80FD\u548C\u4E0A\u9762\u7684\u76F8\u540C</span>
with tmp as <span class="token punctuation">(</span>select name, subject, mark from studscore lateral view explode<span class="token punctuation">(</span>score<span class="token punctuation">)</span> t1 as subject, mark<span class="token punctuation">)</span>
<span class="token keyword">select</span> name, max<span class="token punctuation">(</span>mark<span class="token punctuation">)</span> maxScore from tmp group by name<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p><strong>\u5C0F\u7ED3</strong></p><ul><li>\u5C06\u4E00\u884C\u6570\u636E\u8F6C\u6362\u6210\u591A\u884C\u6570\u636E\uFF0C\u53EF\u4EE5\u7528\u4E8E\u8F6C\u6362array\u548Cmap\u7C7B\u578B\u7684\u6570\u636E;</li><li>lateral view \u4E0E explode \u8054\u7528\uFF0C\u89E3\u51B3 UDTF \u4E0D\u80FD\u6DFB\u52A0\u989D\u5916\u5217\u7684\u95EE\u9898</li></ul><h3 id="\u7B2C-2-\u8282-\u7A97\u53E3\u51FD\u6570\u3010\u91CD\u8981\u3011" tabindex="-1"><a class="header-anchor" href="#\u7B2C-2-\u8282-\u7A97\u53E3\u51FD\u6570\u3010\u91CD\u8981\u3011" aria-hidden="true">#</a> \u7B2C 2 \u8282 \u7A97\u53E3\u51FD\u6570\u3010\u91CD\u8981\u3011</h3><p>\u7A97\u53E3\u51FD\u6570\u53C8\u540D\u5F00\u7A97\u51FD\u6570\uFF0C\u5C5E\u4E8E\u5206\u6790\u51FD\u6570\u7684\u4E00\u79CD\u3002\u7528\u4E8E\u89E3\u51B3\u590D\u6742\u62A5\u8868\u7EDF\u8BA1\u9700\u6C42\u7684\u529F\u80FD\u5F3A\u5927\u7684\u51FD\u6570\uFF0C\u5F88\u591A\u573A\u666F\u90FD\u9700\u8981\u7528\u5230\u3002</p><p>\u7A97\u53E3\u51FD\u6570\u7528\u4E8E\u8BA1\u7B97\u57FA\u4E8E\u7EC4\u7684\u67D0\u79CD\u805A\u5408\u503C\uFF0C\u5B83\u548C\u805A\u5408\u51FD\u6570\u7684\u4E0D\u540C\u4E4B\u5904\u662F: <em>\u7A97\u53E3\u51FD\u6570\u6BCF\u4E2A\u7EC4\u8FD4\u56DE\u591A\u884C\uFF0C\u800C\u805A\u5408\u51FD\u6570\u6BCF\u4E2A\u7EC4\u53EA\u8FD4\u56DE\u4E00\u884C</em>\u3002</p><p>\u7A97\u53E3\u51FD\u6570\u6307\u5B9A\u4E86\u5206\u6790\u51FD\u6570\u5DE5\u4F5C\u7684\u6570\u636E\u7A97\u53E3\u5927\u5C0F\uFF0C\u8FD9\u4E2A\u6570\u636E\u7A97\u53E3\u5927\u5C0F\u53EF\u80FD\u4F1A\u968F\u7740\u884C\u7684\u53D8\u5316\u800C\u53D8\u5316\u3002</p><h4 id="over-\u5173\u952E\u5B57" tabindex="-1"><a class="header-anchor" href="#over-\u5173\u952E\u5B57" aria-hidden="true">#</a> over \u5173\u952E\u5B57</h4><p>\u4F7F\u7528\u7A97\u53E3\u51FD\u6570\u4E4B\u524D\u4E00\u822C\u8981\u8981\u901A\u8FC7 <code>over()</code> \u8FDB\u884C\u5F00\u7A97</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u67E5\u8BE2emp\u8868\u5DE5\u8D44\u603B\u548C</span>
<span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- \u4E0D\u4F7F\u7528\u7A97\u53E3\u51FD\u6570\uFF0C\u6709\u8BED\u6CD5\u9519\u8BEF</span>
<span class="token keyword">select</span> ename<span class="token punctuation">,</span> sal<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> salsum <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
<span class="token comment">-- FAILED: SemanticException [Error 10025]: Line 1:7 Expression not in GROUP BY key &#39;ename&#39;</span>

<span class="token comment">-- \u4F7F\u7528\u7A97\u53E3\u51FD\u6570\uFF0C\u67E5\u8BE2\u5458\u5DE5\u59D3\u540D\u3001\u85AA\u6C34\u3001\u85AA\u6C34\u603B\u548C</span>
<span class="token keyword">select</span> ename<span class="token punctuation">,</span> sal<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">)</span> salsum  <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
<span class="token comment">-- \u6C42\u6BCF\u4E2A\u4EBA\u7684\u85AA\u6C34\u5360\u603B\u85AA\u6C34\u7684\u6BD4\u4F8B</span>
<span class="token keyword">select</span> ename<span class="token punctuation">,</span> sal<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">)</span> salsum<span class="token punctuation">,</span> concat<span class="token punctuation">(</span><span class="token function">round</span><span class="token punctuation">(</span>sal <span class="token operator">/</span> <span class="token function">sum</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&#39;%&#39;</span><span class="token punctuation">)</span> ratiosal <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><blockquote><p>\u6CE8\u610F: \u7A97\u53E3\u51FD\u6570\u662F\u9488\u5BF9\u6BCF\u4E00\u884C\u6570\u636E\u7684; \u5982\u679Cover\u4E2D\u6CA1\u6709\u53C2\u6570\uFF0C\u9ED8\u8BA4\u7684\u662F\u5168\u90E8\u7ED3\u679C\u96C6;</p></blockquote><h4 id="partition-by-\u5B50\u53E5" tabindex="-1"><a class="header-anchor" href="#partition-by-\u5B50\u53E5" aria-hidden="true">#</a> partition by \u5B50\u53E5</h4><p>\u5728over\u7A97\u53E3\u4E2D\u8FDB\u884C\u5206\u533A\uFF0C\u5BF9\u67D0\u4E00\u5217\u8FDB\u884C\u5206\u533A\u7EDF\u8BA1\uFF0C\u7A97\u53E3\u7684\u5927\u5C0F\u5C31\u662F\u5206\u533A\u7684\u5927\u5C0F</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u67E5\u8BE2\u5458\u5DE5\u59D3\u540D\u3001\u85AA\u6C34\u3001\u90E8\u95E8\u85AA\u6C34\u603B\u548C</span>
hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> ename, sal, sum<span class="token punctuation">(</span>sal<span class="token punctuation">)</span> over<span class="token punctuation">(</span>partition by deptno<span class="token punctuation">)</span> salsum from emp<span class="token punctuation">;</span>
OK
ename   sal     salsum
MILLER  <span class="token number">1300</span>    <span class="token number">8750</span>
KING    <span class="token number">5000</span>    <span class="token number">8750</span>
CLARK   <span class="token number">2450</span>    <span class="token number">8750</span>
ADAMS   <span class="token number">1100</span>    <span class="token number">10875</span>
SCOTT   <span class="token number">3000</span>    <span class="token number">10875</span>
SMITH   <span class="token number">800</span>     <span class="token number">10875</span>
JONES   <span class="token number">2975</span>    <span class="token number">10875</span>
FORD    <span class="token number">3000</span>    <span class="token number">10875</span>
TURNER  <span class="token number">1500</span>    <span class="token number">9400</span>
ALLEN   <span class="token number">1600</span>    <span class="token number">9400</span>
BLAKE   <span class="token number">2850</span>    <span class="token number">9400</span>
MARTIN  <span class="token number">1250</span>    <span class="token number">9400</span>
WARD    <span class="token number">1250</span>    <span class="token number">9400</span>
JAMES   <span class="token number">950</span>     <span class="token number">9400</span>
Time taken: <span class="token number">1.477</span> seconds, Fetched: <span class="token number">14</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="order-by-\u5B50\u53E5" tabindex="-1"><a class="header-anchor" href="#order-by-\u5B50\u53E5" aria-hidden="true">#</a> order by \u5B50\u53E5</h4><p>order by \u5B50\u53E5\u5BF9\u8F93\u5165\u7684\u6570\u636E\u8FDB\u884C\u6392\u5E8F</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u589E\u52A0\u4E86order by\u5B50\u53E5; \u6B64\u5904\u7684 sum \u8BA1\u7B97\u7684\u662F\uFF1A\u4ECE\u5206\u7EC4\u7684\u7B2C\u4E00\u884C\u5230\u5F53\u524D\u884C\u6C42\u548C(\u6CE8\u610F\u5E76\u5217\u60C5\u51B5)</span>
hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> ename, sal, deptno, sum<span class="token punctuation">(</span>sal<span class="token punctuation">)</span> over<span class="token punctuation">(</span>partition by deptno order by sal<span class="token punctuation">)</span> salsum from emp<span class="token punctuation">;</span>
OK
ename   sal     deptno  salsum
MILLER  <span class="token number">1300</span>    <span class="token number">10</span>      <span class="token number">1300</span>
CLARK   <span class="token number">2450</span>    <span class="token number">10</span>      <span class="token number">3750</span>
KING    <span class="token number">5000</span>    <span class="token number">10</span>      <span class="token number">8750</span>
SMITH   <span class="token number">800</span>     <span class="token number">20</span>      <span class="token number">800</span>
ADAMS   <span class="token number">1100</span>    <span class="token number">20</span>      <span class="token number">1900</span>
JONES   <span class="token number">2975</span>    <span class="token number">20</span>      <span class="token number">4875</span>
SCOTT   <span class="token number">3000</span>    <span class="token number">20</span>      <span class="token number">10875</span>
FORD    <span class="token number">3000</span>    <span class="token number">20</span>      <span class="token number">10875</span>
JAMES   <span class="token number">950</span>     <span class="token number">30</span>      <span class="token number">950</span>
MARTIN  <span class="token number">1250</span>    <span class="token number">30</span>      <span class="token number">3450</span>
WARD    <span class="token number">1250</span>    <span class="token number">30</span>      <span class="token number">3450</span>
TURNER  <span class="token number">1500</span>    <span class="token number">30</span>      <span class="token number">4950</span>
ALLEN   <span class="token number">1600</span>    <span class="token number">30</span>      <span class="token number">6550</span>
BLAKE   <span class="token number">2850</span>    <span class="token number">30</span>      <span class="token number">9400</span>
Time taken: <span class="token number">1.454</span> seconds, Fetched: <span class="token number">14</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="window\u5B50\u53E5" tabindex="-1"><a class="header-anchor" href="#window\u5B50\u53E5" aria-hidden="true">#</a> Window\u5B50\u53E5</h4><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">and</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>\u5982\u679C\u8981\u5BF9\u7A97\u53E3\u7684\u7ED3\u679C\u505A\u66F4\u7EC6\u7C92\u5EA6\u7684\u5212\u5206\uFF0C\u4F7F\u7528window\u5B50\u53E5\uFF0C\u6709\u5982\u4E0B\u7684\u51E0\u4E2A\u9009\u9879:</p><ul><li>unbounded preceding: \u7EC4\u5185\u7B2C\u4E00\u884C\u6570\u636E</li><li>n preceding: \u7EC4\u5185\u5F53\u524D\u884C\u7684\u524Dn\u884C\u6570\u636E</li><li>current row: \u5F53\u524D\u884C\u6570\u636E</li><li>n following: \u7EC4\u5185\u5F53\u524D\u884C\u7684\u540En\u884C\u6570\u636E</li><li>unbounded following: \u7EC4\u5185\u6700\u540E\u4E00\u884C\u6570\u636E</li></ul><p><img src="`+u+`" alt="\u53C2\u6570\u56FE\u89E3"></p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- rows between ... and ... \u5B50\u53E5 </span>
<span class="token comment">-- \u4E0B\u9762\u4E24\u8BED\u53E5\u7B49\u4EF7\u3002</span>
<span class="token comment">-- \u6309\u7167\u90E8\u95E8\u5206\u7EC4\uFF0C\u6309\u7167\u59D3\u540D\u6392\u5E8F\u3002\u7EC4\u5185\uFF0C\u7B2C\u4E00\u884C\u5230\u5F53\u524D\u884C\u7684\u548C </span>
<span class="token keyword">select</span> ename<span class="token punctuation">,</span> sal<span class="token punctuation">,</span> deptno<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> deptno <span class="token keyword">order</span> <span class="token keyword">by</span> ename<span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token keyword">select</span> ename<span class="token punctuation">,</span> sal<span class="token punctuation">,</span> deptno<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> deptno <span class="token keyword">order</span> <span class="token keyword">by</span> ename
                     <span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token keyword">unbounded</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token keyword">current</span> <span class="token keyword">row</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- \u7EC4\u5185\uFF0C\u7B2C\u4E00\u884C\u5230\u6700\u540E\u4E00\u884C\u7684\u548C</span>
<span class="token keyword">select</span> ename<span class="token punctuation">,</span> sal<span class="token punctuation">,</span> deptno<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> deptno <span class="token keyword">order</span> <span class="token keyword">by</span> ename
           <span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token keyword">unbounded</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token keyword">unbounded</span> <span class="token keyword">following</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- \u7EC4\u5185\uFF0C\u524D\u4E00\u884C\u3001\u5F53\u524D\u884C\u3001\u540E\u4E00\u884C\u7684\u548C (\u5F53\u524D\u884C\u53CA\u5176\u524D\u540E\uFF0C\u5171\u4E09\u884C)</span>
<span class="token keyword">select</span> ename<span class="token punctuation">,</span> sal<span class="token punctuation">,</span> deptno<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> deptno <span class="token keyword">order</span> <span class="token keyword">by</span> ename
                     <span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token number">1</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token number">1</span> <span class="token keyword">following</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> emp<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="\u6392\u540D\u51FD\u6570" tabindex="-1"><a class="header-anchor" href="#\u6392\u540D\u51FD\u6570" aria-hidden="true">#</a> \u6392\u540D\u51FD\u6570</h4><p>\u6392\u540D\u90FD\u662F\u4ECE1\u5F00\u59CB\uFF0C\u751F\u6210\u6570\u636E\u9879\u5728\u5206\u7EC4\u4E2D\u7684\u6392\u540D\u3002</p><blockquote><p>\u975E\u5E38\u5E38\u7528\uFF0C\u901A\u5E38\u7528\u4E8E\u6C42\u89E3 Top N \u7684\u95EE\u9898\u3002</p></blockquote><p>\u6392\u540D\u65B9\u5F0F\u6709\u4E09\u79CD\uFF1A</p><ul><li><code>row_number()</code> \u6392\u540D\u987A\u5E8F\u589E\u52A0\u4E0D\u4F1A\u91CD\u590D; \u59821\u30012\u30013\u30014\u3001... ...</li><li><code>RANK()</code> \u6392\u540D\u76F8\u7B49\u4F1A\u5728\u540D\u6B21\u4E2D\u7559\u4E0B\u7A7A\u4F4D; \u59821\u30012\u30012\u30014\u30015\u3001... ...</li><li><code>DENSE_RANK()</code> \u6392\u540D\u76F8\u7B49\u4F1A\u5728\u540D\u6B21\u4E2D\u4E0D\u4F1A\u7559\u4E0B\u7A7A\u4F4D; \u59821\u30012\u30012\u30013\u30014\u3001... ...</li></ul><p>\u6548\u679C\u793A\u4F8B\u5982\u4E0B\uFF1A</p><table><thead><tr><th>Val</th><th style="text-align:center;">row_number()</th><th style="text-align:center;">rank()</th><th style="text-align:center;">dense_rank()</th></tr></thead><tbody><tr><td>100</td><td style="text-align:center;">1</td><td style="text-align:center;">1</td><td style="text-align:center;">1</td></tr><tr><td>100</td><td style="text-align:center;">2</td><td style="text-align:center;">1</td><td style="text-align:center;">1</td></tr><tr><td>100</td><td style="text-align:center;">3</td><td style="text-align:center;">1</td><td style="text-align:center;">1</td></tr><tr><td>99</td><td style="text-align:center;">4</td><td style="text-align:center;">4</td><td style="text-align:center;">2</td></tr><tr><td>98</td><td style="text-align:center;">5</td><td style="text-align:center;">5</td><td style="text-align:center;">3</td></tr><tr><td>98</td><td style="text-align:center;">6</td><td style="text-align:center;">5</td><td style="text-align:center;">3</td></tr><tr><td>97</td><td style="text-align:center;">7</td><td style="text-align:center;">7</td><td style="text-align:center;">4</td></tr></tbody></table><p>\u6D4B\u8BD5\u6848\u4F8B\uFF1A</p><p>\u51C6\u5907\u6570\u636E</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>class1 s01 100
class1 s03 100
class1 s05 100
class1 s07 99
class1 s09 98
class1 s02 98
class1 s04 97
class2 s21 100
class2 s24 99
class2 s27 99
class2 s22 98
class2 s25 98
class2 s28 97
class2 s26 96
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u521B\u5EFA\u8868\u52A0\u8F7D\u6570\u636E</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> t2<span class="token punctuation">(</span>
  cname string<span class="token punctuation">,</span>
  sname string<span class="token punctuation">,</span>
  score <span class="token keyword">int</span>
<span class="token punctuation">)</span> <span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">;</span>

<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">&#39;/home/hadoop/data/t2.dat&#39;</span> <span class="token keyword">into</span> <span class="token keyword">table</span> t2<span class="token punctuation">;</span>

<span class="token comment">-- \u6309\u7167\u73ED\u7EA7\uFF0C\u4F7F\u75283\u79CD\u65B9\u5F0F\u5BF9\u6210\u7EE9\u8FDB\u884C\u6392\u540D</span>
<span class="token keyword">select</span> cname<span class="token punctuation">,</span> sname<span class="token punctuation">,</span> score<span class="token punctuation">,</span> 
       row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> cname <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> rank1<span class="token punctuation">,</span>
       rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> cname <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> rank2<span class="token punctuation">,</span>
       dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> cname <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> rank3
       <span class="token keyword">from</span> t2<span class="token punctuation">;</span>

<span class="token comment">-- \u6C42\u6BCF\u4E2A\u73ED\u7EA7\u524D3\u540D\u7684\u5B66\u5458</span>
<span class="token comment">-- \u524D3\u540D\u7684\u5B9A\u4E49\u662F\u4EC0\u4E48? (\u8FD9\u5176\u5B9E\u662F\u4E1A\u52A1\u95EE\u9898)</span>
<span class="token comment">-- \u5047\u8BBE\u4F7F\u7528 dense_rank</span>
<span class="token keyword">select</span> cname<span class="token punctuation">,</span> sname<span class="token punctuation">,</span> score<span class="token punctuation">,</span> rank <span class="token keyword">from</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> cname<span class="token punctuation">,</span> sname<span class="token punctuation">,</span> score<span class="token punctuation">,</span>
                  dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> cname <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> rank
    <span class="token keyword">from</span> t2
<span class="token punctuation">)</span> tmp <span class="token keyword">where</span> rank <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h4 id="\u5E8F\u5217\u51FD\u6570" tabindex="-1"><a class="header-anchor" href="#\u5E8F\u5217\u51FD\u6570" aria-hidden="true">#</a> \u5E8F\u5217\u51FD\u6570</h4><ul><li><code>lag</code> \u8FD4\u56DE\u5F53\u524D\u6570\u636E\u884C\u7684\u4E0A\u4E00\u884C\u6570\u636E</li><li><code>lead</code> \u8FD4\u56DE\u5F53\u524D\u6570\u636E\u884C\u7684\u4E0B\u4E00\u884C\u6570\u636E</li><li><code>first_value</code> \u6570\u636E\u5206\u7EC4\u5185\u6392\u5E8F\u540E\uFF0C\u622A\u6B62\u5230\u5F53\u524D\u884C\uFF0C\u7B2C\u4E00\u4E2A\u503C</li><li><code>last_value</code> \u6570\u636E\u5206\u7EC4\u5185\u6392\u5E8F\u540E\uFF0C\u622A\u6B62\u5230\u5F53\u524D\u884C\uFF0C\u6700\u540E\u4E00\u4E2A\u503C</li><li><code>ntile</code> \u5C06\u5206\u7EC4\u6392\u5E8F\u540E\u7684\u6570\u636E\u6309\u7167\u987A\u5E8F\u5207\u5206\u6210n\u7247\uFF0C\u8FD4\u56DE\u5F53\u524D\u5207\u7247\u503C(\u5F53\u524D\u884C\u6240\u5728\u7684\u5207\u7247\u6570)</li></ul><p>\u6D4B\u8BD5\u6848\u4F8B</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># \u51C6\u5907\u6570\u636E userpv.dat
cookie1,2019-04-10,1
cookie1,2019-04-11,5
cookie1,2019-04-12,7
cookie1,2019-04-13,3
cookie1,2019-04-14,2
cookie1,2019-04-15,4
cookie1,2019-04-16,4
cookie2,2019-04-10,2
cookie2,2019-04-11,3
cookie2,2019-04-12,5
cookie2,2019-04-13,6
cookie2,2019-04-14,3
cookie2,2019-04-15,9
cookie2,2019-04-16,7
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u521B\u5EFA\u8868\u5E76\u52A0\u8F7D\u6570\u636E</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> userpv<span class="token punctuation">(</span>
  cid string<span class="token punctuation">,</span>
  ctime <span class="token keyword">date</span><span class="token punctuation">,</span>
  pv <span class="token keyword">int</span>
<span class="token punctuation">)</span>
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">&#39;/home/hadoop/data/userpv.dat&#39;</span> <span class="token keyword">into</span> <span class="token keyword">table</span> userpv<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># lag\u3002\u8FD4\u56DE\u5F53\u524D\u6570\u636E\u884C\u7684\u4E0A\u4E00\u884C\u6570\u636E</span>
<span class="token comment"># lead\u3002\u529F\u80FD\u4E0A\u4E0Elag\u7C7B\u4F3C, \u8FD4\u56DE\u5F53\u524D\u6570\u636E\u884C\u7684\u4E0B\u4E00\u884C\u6570\u636E</span>
<span class="token keyword">select</span> cid, ctime, pv, 
  lag<span class="token punctuation">(</span>pv<span class="token punctuation">)</span> over<span class="token punctuation">(</span>partition by cid order by ctime<span class="token punctuation">)</span> lagpv, 
  lead<span class="token punctuation">(</span>pv<span class="token punctuation">)</span> over<span class="token punctuation">(</span>partition by cid order by ctime<span class="token punctuation">)</span> leadgpv
from userpv<span class="token punctuation">;</span>
<span class="token comment"># lag/lead \u7B2C\u4E8C\u4E2A\u53C2\u6570\u53EF\u4EE5\u6307\u5B9A \u4E0B\u79FB/\u4E0A\u79FB \u7684\u884C\u6570</span>

OK
cid     ctime   <span class="token function">pv</span>      lagpv   leadgpv
cookie1 <span class="token number">2019</span>-04-10      <span class="token number">1</span>       NULL    <span class="token number">5</span>
cookie1 <span class="token number">2019</span>-04-11      <span class="token number">5</span>       <span class="token number">1</span>       <span class="token number">7</span>
cookie1 <span class="token number">2019</span>-04-12      <span class="token number">7</span>       <span class="token number">5</span>       <span class="token number">3</span>
cookie1 <span class="token number">2019</span>-04-13      <span class="token number">3</span>       <span class="token number">7</span>       <span class="token number">2</span>
cookie1 <span class="token number">2019</span>-04-14      <span class="token number">2</span>       <span class="token number">3</span>       <span class="token number">4</span>
cookie1 <span class="token number">2019</span>-04-15      <span class="token number">4</span>       <span class="token number">2</span>       <span class="token number">4</span>
cookie1 <span class="token number">2019</span>-04-16      <span class="token number">4</span>       <span class="token number">4</span>       NULL
cookie2 <span class="token number">2019</span>-04-10      <span class="token number">2</span>       NULL    <span class="token number">3</span>
cookie2 <span class="token number">2019</span>-04-11      <span class="token number">3</span>       <span class="token number">2</span>       <span class="token number">5</span>
cookie2 <span class="token number">2019</span>-04-12      <span class="token number">5</span>       <span class="token number">3</span>       <span class="token number">6</span>
cookie2 <span class="token number">2019</span>-04-13      <span class="token number">6</span>       <span class="token number">5</span>       <span class="token number">3</span>
cookie2 <span class="token number">2019</span>-04-14      <span class="token number">3</span>       <span class="token number">6</span>       <span class="token number">9</span>
cookie2 <span class="token number">2019</span>-04-15      <span class="token number">9</span>       <span class="token number">3</span>       <span class="token number">7</span>
cookie2 <span class="token number">2019</span>-04-16      <span class="token number">7</span>       <span class="token number">9</span>       NULL


<span class="token comment"># first_value / last_value</span>
<span class="token keyword">select</span> cid, ctime, pv, 
  first_value<span class="token punctuation">(</span>pv<span class="token punctuation">)</span> over<span class="token punctuation">(</span>partition by cid order by ctime<span class="token punctuation">)</span> firstpv, 
  last_value<span class="token punctuation">(</span>pv<span class="token punctuation">)</span> over<span class="token punctuation">(</span>partition by cid order by ctime<span class="token punctuation">)</span> lastpv
from userpv<span class="token punctuation">;</span>

OK
cid     ctime   <span class="token function">pv</span>      firstpv lastpv
cookie1 <span class="token number">2019</span>-04-10      <span class="token number">1</span>       <span class="token number">1</span>       <span class="token number">1</span>
cookie1 <span class="token number">2019</span>-04-11      <span class="token number">5</span>       <span class="token number">1</span>       <span class="token number">5</span>
cookie1 <span class="token number">2019</span>-04-12      <span class="token number">7</span>       <span class="token number">1</span>       <span class="token number">7</span>
cookie1 <span class="token number">2019</span>-04-13      <span class="token number">3</span>       <span class="token number">1</span>       <span class="token number">3</span>
cookie1 <span class="token number">2019</span>-04-14      <span class="token number">2</span>       <span class="token number">1</span>       <span class="token number">2</span>
cookie1 <span class="token number">2019</span>-04-15      <span class="token number">4</span>       <span class="token number">1</span>       <span class="token number">4</span>
cookie1 <span class="token number">2019</span>-04-16      <span class="token number">4</span>       <span class="token number">1</span>       <span class="token number">4</span>
cookie2 <span class="token number">2019</span>-04-10      <span class="token number">2</span>       <span class="token number">2</span>       <span class="token number">2</span>
cookie2 <span class="token number">2019</span>-04-11      <span class="token number">3</span>       <span class="token number">2</span>       <span class="token number">3</span>
cookie2 <span class="token number">2019</span>-04-12      <span class="token number">5</span>       <span class="token number">2</span>       <span class="token number">5</span>
cookie2 <span class="token number">2019</span>-04-13      <span class="token number">6</span>       <span class="token number">2</span>       <span class="token number">6</span>
cookie2 <span class="token number">2019</span>-04-14      <span class="token number">3</span>       <span class="token number">2</span>       <span class="token number">3</span>
cookie2 <span class="token number">2019</span>-04-15      <span class="token number">9</span>       <span class="token number">2</span>       <span class="token number">9</span>
cookie2 <span class="token number">2019</span>-04-16      <span class="token number">7</span>       <span class="token number">2</span>       <span class="token number">7</span>


<span class="token comment"># ntile\u3002\u6309\u7167cid\u8FDB\u884C\u5206\u7EC4\uFF0C\u6BCF\u7EC4\u6570\u636E\u5206\u62102\u4EFD</span>
<span class="token keyword">select</span> cid, ctime, pv, 
  ntile<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> over<span class="token punctuation">(</span>partition by cid order by ctime<span class="token punctuation">)</span> ntile
from userpv<span class="token punctuation">;</span>

OK
cid     ctime   <span class="token function">pv</span>      ntile
cookie1 <span class="token number">2019</span>-04-10      <span class="token number">1</span>       <span class="token number">1</span>
cookie1 <span class="token number">2019</span>-04-11      <span class="token number">5</span>       <span class="token number">1</span>
cookie1 <span class="token number">2019</span>-04-12      <span class="token number">7</span>       <span class="token number">1</span>
cookie1 <span class="token number">2019</span>-04-13      <span class="token number">3</span>       <span class="token number">1</span>
cookie1 <span class="token number">2019</span>-04-14      <span class="token number">2</span>       <span class="token number">2</span>
cookie1 <span class="token number">2019</span>-04-15      <span class="token number">4</span>       <span class="token number">2</span>
cookie1 <span class="token number">2019</span>-04-16      <span class="token number">4</span>       <span class="token number">2</span>
cookie2 <span class="token number">2019</span>-04-10      <span class="token number">2</span>       <span class="token number">1</span>
cookie2 <span class="token number">2019</span>-04-11      <span class="token number">3</span>       <span class="token number">1</span>
cookie2 <span class="token number">2019</span>-04-12      <span class="token number">5</span>       <span class="token number">1</span>
cookie2 <span class="token number">2019</span>-04-13      <span class="token number">6</span>       <span class="token number">1</span>
cookie2 <span class="token number">2019</span>-04-14      <span class="token number">3</span>       <span class="token number">2</span>
cookie2 <span class="token number">2019</span>-04-15      <span class="token number">9</span>       <span class="token number">2</span>
cookie2 <span class="token number">2019</span>-04-16      <span class="token number">7</span>       <span class="token number">2</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><h4 id="sql\u9762\u8BD5\u9898" tabindex="-1"><a class="header-anchor" href="#sql\u9762\u8BD5\u9898" aria-hidden="true">#</a> SQL\u9762\u8BD5\u9898</h4><ol><li>\u8FDE\u7EED7\u5929\u767B\u5F55\u7684\u7528\u6237</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># \u6570\u636E\u51C6\u5907
# \u6570\u636E\u3002uid dt status(1 \u6B63\u5E38\u767B\u5F55\uFF0C0 \u5F02\u5E38)
1 2019-07-11 1
1 2019-07-12 1
1 2019-07-13 1
1 2019-07-14 1
1 2019-07-15 1
1 2019-07-16 1
1 2019-07-17 1
1 2019-07-18 1
2 2019-07-11 1
2 2019-07-12 1
2 2019-07-13 0
2 2019-07-14 1
2 2019-07-15 1
2 2019-07-16 0
2 2019-07-17 1
2 2019-07-18 0
3 2019-07-11 1
3 2019-07-12 1
3 2019-07-13 1
3 2019-07-14 0
3 2019-07-15 1
3 2019-07-16 1
3 2019-07-17 1
3 2019-07-18 1
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u5EFA\u8868\u5BFC\u5165\u6570\u636E</span>
<span class="token comment">-- \u5EFA\u8868\u8BED\u53E5</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> ulogin<span class="token punctuation">(</span>
  uid <span class="token keyword">int</span><span class="token punctuation">,</span>
  dt <span class="token keyword">date</span><span class="token punctuation">,</span>
  <span class="token keyword">status</span> <span class="token keyword">int</span>
<span class="token punctuation">)</span>
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">;</span>
<span class="token comment">-- \u52A0\u8F7D\u6570\u636E</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">&#39;/home/hadoop/data/ulogin.dat&#39;</span> <span class="token keyword">into</span> <span class="token keyword">table</span> ulogin<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><p>\u6B64\u5904\u6C42\u89E3\u7684\u6838\u5FC3\u601D\u8DEF\u662F\uFF1A\u5229\u7528 <code>row_number()</code> \u7684\u81EA\u589E\u7279\u6027\u3002</p><p>\u6C42\u89E3\u7684\u662F\u8FDE\u7EED\u6570\u636E\uFF0C<code>row_number()</code> \u80AF\u5B9A\u662F\u8FDE\u7EED\u7684\uFF0C\u4F46\u662F\u7B26\u5408\u6761\u4EF6\u7684\u539F\u6570\u636E\u4E0D\u4E00\u5B9A\u662F\u8FDE\u7EED\u7684\u3002\u4E24\u76F8\u6BD4\u8F83\uFF0C\u5C31\u5F97\u51FA\u4E86\u8FDE\u7EED\u7684\u6570\u636E\u3002</p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u8FDE\u7EED\u503C\u7684\u6C42\u89E3\uFF0C\u9762\u8BD5\u4E2D\u5E38\u89C1\u7684\u95EE\u9898\u3002\u8FD9\u4E5F\u662F\u540C\u4E00\u7C7B\uFF0C\u57FA\u672C\u90FD\u53EF\u6309\u7167\u4EE5\u4E0B\u601D\u8DEF\u8FDB\u884C</span>
<span class="token comment">-- 1\u3001\u4F7F\u7528 row_number \u5728\u7EC4\u5185\u7ED9\u6570\u636E\u7F16\u53F7(rownum)</span>
<span class="token comment">-- 2\u3001\u67D0\u4E2A\u503C - rownum = gid\uFF0C\u5F97\u5230\u7ED3\u679C\u53EF\u4EE5\u4F5C\u4E3A\u540E\u9762\u5206\u7EC4\u8BA1\u7B97\u7684\u4F9D\u636E</span>
<span class="token comment">-- 3\u3001\u6839\u636E\u6C42\u5F97\u7684gid\uFF0C\u4F5C\u4E3A\u5206\u7EC4\u6761\u4EF6\uFF0C\u6C42\u6700\u7EC8\u7ED3\u679C</span>

<span class="token keyword">select</span> uid<span class="token punctuation">,</span> dt<span class="token punctuation">,</span>
       date_sub<span class="token punctuation">(</span>dt<span class="token punctuation">,</span> row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> uid <span class="token keyword">order</span> <span class="token keyword">by</span> dt<span class="token punctuation">)</span><span class="token punctuation">)</span> gid
<span class="token keyword">from</span> ulogin <span class="token keyword">where</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">-- OK</span>
<span class="token comment">-- uid     dt      gid</span>
<span class="token comment">-- 1       2019-07-11      2019-07-10</span>
<span class="token comment">-- 1       2019-07-12      2019-07-10</span>
<span class="token comment">-- 1       2019-07-13      2019-07-10</span>
<span class="token comment">-- 1       2019-07-14      2019-07-10</span>
<span class="token comment">-- 1       2019-07-15      2019-07-10</span>
<span class="token comment">-- 1       2019-07-16      2019-07-10</span>
<span class="token comment">-- 1       2019-07-17      2019-07-10</span>
<span class="token comment">-- 1       2019-07-18      2019-07-10</span>
<span class="token comment">-- 2       2019-07-11      2019-07-10</span>
<span class="token comment">-- 2       2019-07-12      2019-07-10</span>
<span class="token comment">-- 2       2019-07-14      2019-07-11</span>
<span class="token comment">-- 2       2019-07-15      2019-07-11</span>
<span class="token comment">-- 2       2019-07-17      2019-07-12</span>

<span class="token keyword">select</span> uid<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> logincount
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> uid<span class="token punctuation">,</span> dt<span class="token punctuation">,</span>
             date_sub<span class="token punctuation">(</span>dt<span class="token punctuation">,</span> row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> uid <span class="token keyword">order</span> <span class="token keyword">by</span> dt<span class="token punctuation">)</span><span class="token punctuation">)</span> gid
      <span class="token keyword">from</span> ulogin <span class="token keyword">where</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">temp</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> uid<span class="token punctuation">,</span> gid
<span class="token keyword">having</span> logincount<span class="token operator">&gt;=</span><span class="token number">7</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><ol start="2"><li>\u7F16\u5199sql\u8BED\u53E5\u5B9E\u73B0\u6BCF\u73ED\u524D\u4E09\u540D\uFF0C\u5206\u6570\u4E00\u6837\u5E76\u5217\uFF0C\u540C\u65F6\u6C42\u51FA\u524D\u4E09\u540D\u6309\u540D\u6B21\u6392\u5E8F\u7684\u5206\u5DEE</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># \u6570\u636E\u3002sid class score
1 1901 90
2 1901 90
3 1901 83
4 1901 60
5 1902 66
6 1902 23
7 1902 99
8 1902 67
9 1902 87
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u5EFA\u8868\u5BFC\u5165\u6570\u636E</span>
<span class="token comment">-- \u5EFA\u8868\u8BED\u53E5</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> stu<span class="token punctuation">(</span>
  sno <span class="token keyword">int</span><span class="token punctuation">,</span>
  class string<span class="token punctuation">,</span>
  score <span class="token keyword">int</span>
<span class="token punctuation">)</span><span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">;</span>
<span class="token comment">-- \u52A0\u8F7D\u6570\u636E</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">&#39;/home/hadoop/data/stu.dat&#39;</span> <span class="token keyword">into</span> <span class="token keyword">table</span> stu<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p>\u6838\u5FC3\u601D\u8DEF\uFF1A\u6C42 Top \u4F7F\u7528 <code>rank()</code>, \u6C42\u524D\u540E\u5DEE\u503C\u4F7F\u7528 <code>lag/lead</code></p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u6C42\u89E3\u601D\u8DEF\uFF1A</span>
<span class="token comment">-- 1\u3001\u4E0A\u6392\u540D\u51FD\u6570\uFF0C\u5206\u6570\u4E00\u6837\u5E76\u5217\uFF0C\u6240\u4EE5\u7528 dense_rank</span>
<span class="token comment">-- 2\u3001\u5C06\u4E0A\u4E00\u884C\u6570\u636E\u4E0B\u79FB\uFF0C\u76F8\u51CF\u5373\u5F97\u5230\u5206\u6570\u5DEE</span>
<span class="token comment">-- 3\u3001\u5904\u7406 NULL</span>

<span class="token comment">-- step1</span>
<span class="token keyword">select</span> sno<span class="token punctuation">,</span> class<span class="token punctuation">,</span> score<span class="token punctuation">,</span> dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> class <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> rank <span class="token keyword">from</span> stu<span class="token punctuation">;</span>
<span class="token comment">-- step2</span>
<span class="token keyword">select</span> sno<span class="token punctuation">,</span> class<span class="token punctuation">,</span> score<span class="token punctuation">,</span> dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> class <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> rank<span class="token punctuation">,</span>
        score <span class="token operator">-</span> lag<span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> class <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> lagscore
<span class="token keyword">from</span> stu<span class="token punctuation">;</span>
<span class="token comment">-- step3</span>
<span class="token keyword">select</span> class<span class="token punctuation">,</span> score<span class="token punctuation">,</span> dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> class <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> rank<span class="token punctuation">,</span>
        nvl<span class="token punctuation">(</span>score <span class="token operator">-</span> lag<span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> class <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> lagscore
<span class="token keyword">from</span> stu<span class="token punctuation">;</span>
<span class="token comment">-- step4</span>
<span class="token keyword">with</span> tmp <span class="token keyword">as</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> sno<span class="token punctuation">,</span> class<span class="token punctuation">,</span> score<span class="token punctuation">,</span>
           dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> class <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rank
    <span class="token keyword">from</span> stu
<span class="token punctuation">)</span>
<span class="token keyword">select</span> class<span class="token punctuation">,</span> score<span class="token punctuation">,</span> rank<span class="token punctuation">,</span>
       nvl<span class="token punctuation">(</span>score <span class="token operator">-</span> lag<span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> class <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> lagscore
<span class="token keyword">from</span> tmp
<span class="token keyword">where</span> rank<span class="token operator">&lt;=</span><span class="token number">3</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>3\u3001\u884C\u5217\u4E92\u8F6C</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># \u6570\u636E\uFF1Aid course
1 java
1 hadoop
1 hive
1 hbase
2 java
2 hive
2 spark
2 flink
3 java
3 hadoop
3 hive
3 kafka

# \u76EE\u6807\u683C\u5F0F
id      java    hadoop  hive    hbase   spark   flink   kafka
1       1       1       1       1       0       0       0
2       1       0       1       0       1       1       0
3       1       1       1       0       0       0       1
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># \u5EFA\u8868\u52A0\u8F7D\u6570\u636E</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> rowline1<span class="token punctuation">(</span>
  id string<span class="token punctuation">,</span>
  course string
<span class="token punctuation">)</span><span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">;</span>

<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">&#39;/home/hadoop/data/data1.dat&#39;</span> <span class="token keyword">into</span> <span class="token keyword">table</span> rowline1<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u884C\u8F6C\u5217</span>
<span class="token comment">-- \u4F7F\u7528case when\uFF1Bgroup by + sum</span>
<span class="token keyword">select</span> id<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> course<span class="token operator">=</span><span class="token string">&quot;java&quot;</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> java<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> course<span class="token operator">=</span><span class="token string">&quot;hadoop&quot;</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> hadoop<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> course<span class="token operator">=</span><span class="token string">&quot;hive&quot;</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> hive<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> course<span class="token operator">=</span><span class="token string">&quot;hbase&quot;</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> hbase<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> course<span class="token operator">=</span><span class="token string">&quot;spark&quot;</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> spark<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> course<span class="token operator">=</span><span class="token string">&quot;flink&quot;</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> flink<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> course<span class="token operator">=</span><span class="token string">&quot;kafka&quot;</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> kafka
<span class="token keyword">from</span> rowline1
<span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># \u6570\u636E\u3002id1 id2 flag
a b 2
a b 1
a b 3
c d 6
c d 8
c d 8

# \u76EE\u6807\u6570\u636E\u683C\u5F0F
id1 id2 flag
a   b   2|1|3
c   d   6|8
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u521B\u5EFA\u8868 &amp; \u52A0\u8F7D\u6570\u636E</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> row2line<span class="token punctuation">(</span>
    id string<span class="token punctuation">,</span>
    tag string<span class="token punctuation">,</span>
    flag <span class="token keyword">int</span>
<span class="token punctuation">)</span> <span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">;</span>

<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">&#39;/home/hadoop/data/data2.dat&#39;</span> <span class="token keyword">into</span> <span class="token keyword">table</span> row2line<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 1.\u5206\u7EC4\u5C06\u6570\u636E\u805A\u62E2</span>
<span class="token comment">-- 2.\u5C06\u6570\u636E\u8FDE\u63A5\u5728\u4E00\u8D77</span>

<span class="token comment">-- step1</span>
<span class="token keyword">select</span> id<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token keyword">from</span> row2line <span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token punctuation">,</span> tag<span class="token punctuation">;</span>
<span class="token comment">-- collect_set \u6570\u636E\u53BB\u91CD (collect_list \u6570\u636E\u4E0D\u53BB\u91CD)</span>
<span class="token comment">-- id      tag     _c2</span>
<span class="token comment">-- a       b       [2,1,3]</span>
<span class="token comment">-- c       d       [6,8]</span>

<span class="token comment">-- step2</span>
<span class="token comment">-- \u4E0B\u9762\u7684\u8BED\u53E5\u4F1A\u62A5\u9519\uFF0C\u56E0\u4E3A concat_ws \u53EA\u80FD\u64CD\u4F5C string</span>
<span class="token keyword">select</span> id<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> concat_ws<span class="token punctuation">(</span><span class="token string">&quot;|&quot;</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">from</span> row2line <span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token punctuation">,</span> tag<span class="token punctuation">;</span>
<span class="token comment">-- FAILED: SemanticException [Error 10016]: Line 1:31 Argument type mismatch &#39;flag&#39;: Argument 2 of function CONCAT_WS must be &quot;string or array&lt;string&gt;&quot;, but &quot;array&lt;int&gt;&quot; was found.</span>

<span class="token keyword">select</span> id<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> concat_ws<span class="token punctuation">(</span><span class="token string">&quot;|&quot;</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>cast<span class="token punctuation">(</span>flag <span class="token keyword">as</span> string<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">from</span> row2line <span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token punctuation">,</span> tag<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>\u5C0F\u7ED3\uFF1A\u4E09\u7C7B\u5178\u578B\u95EE\u9898 \u2014\u2014 \u8FDE\u7EED\u503C\u6C42\u89E3\u3001Top n\u95EE\u9898\u3001\u884C\u5217\u4E92\u8F6C</p><h3 id="\u7B2C-3-\u8282-\u81EA\u5B9A\u4E49\u51FD\u6570" tabindex="-1"><a class="header-anchor" href="#\u7B2C-3-\u8282-\u81EA\u5B9A\u4E49\u51FD\u6570" aria-hidden="true">#</a> \u7B2C 3 \u8282 \u81EA\u5B9A\u4E49\u51FD\u6570</h3><p>\u5F53 Hive \u63D0\u4F9B\u7684\u5185\u7F6E\u51FD\u6570\u65E0\u6CD5\u6EE1\u8DB3\u5B9E\u9645\u7684\u4E1A\u52A1\u5904\u7406\u9700\u8981\u65F6\uFF0C\u53EF\u4EE5\u8003\u8651\u4F7F\u7528\u7528\u6237\u81EA\u5B9A\u4E49\u51FD\u6570\u8FDB\u884C\u6269\u5C55\u3002</p><p>\u7528\u6237\u81EA\u5B9A\u4E49\u51FD\u6570\u5206\u4E3A\u4EE5\u4E0B\u4E09\u7C7B:</p><ul><li>UDF(User Defined Function) \u7528\u6237\u81EA\u5B9A\u4E49\u51FD\u6570\uFF0C\u4E00\u8FDB\u4E00\u51FA; \u7C7B\u4F3C\u4E8E\uFF1A<code>current_date</code> \u7B49</li><li>UDAF(User Defined Aggregation Function) \u7528\u6237\u81EA\u5B9A\u4E49\u805A\u96C6\u51FD\u6570\uFF0C\u591A\u8FDB\u4E00\u51FA; \u7C7B\u4F3C\u4E8E: <code>count/max/min</code></li><li>UDTF(User Defined Table-Generating Functions) \u7528\u6237\u81EA\u5B9A\u4E49\u8868\u751F\u6210\u51FD\u6570\uFF0C\u4E00\u8FDB\u591A\u51FA; \u7C7B\u4F3C\u4E8E: <code>explode</code></li></ul><p>UDF\u5F00\u53D1:</p><ul><li>\u7EE7\u627F <code>org.apache.hadoop.hive.ql.exec.UDF</code></li><li>\u9700\u8981\u5B9E\u73B0evaluate\u51FD\u6570; evaluate\u51FD\u6570\u652F\u6301\u91CD\u8F7D</li><li>UDF\u5FC5\u987B\u8981\u6709\u8FD4\u56DE\u7C7B\u578B\uFF0C\u53EF\u4EE5\u8FD4\u56DEnull\uFF0C\u4F46\u662F\u8FD4\u56DE\u7C7B\u578B\u4E0D\u80FD\u4E3Avoid</li></ul><p>UDF\u5F00\u53D1\u6B65\u9AA4</p><ul><li>\u521B\u5EFAmaven java \u5DE5\u7A0B\uFF0C\u6DFB\u52A0\u4F9D\u8D56</li><li>\u5F00\u53D1java\u7C7B\u7EE7\u627FUDF\uFF0C\u5B9E\u73B0evaluate\u65B9\u6CD5</li><li>\u5C06\u9879\u76EE\u6253\u5305\u4E0A\u4F20\u670D\u52A1\u5668</li><li>\u6DFB\u52A0\u5F00\u53D1\u7684jar\u5305</li><li>\u8BBE\u7F6E\u51FD\u6570\u4E0E\u81EA\u5B9A\u4E49\u51FD\u6570\u5173\u8054</li><li>\u4F7F\u7528\u81EA\u5B9A\u4E49\u51FD\u6570</li></ul><p><strong>\u6D4B\u8BD5\u6848\u4F8B</strong></p><p>\u9700\u6C42: \u6269\u5C55\u7CFB\u7EDF nvl \u51FD\u6570\u529F\u80FD, \u5982\u679C <code>nvl()</code> \u51FD\u6570\u7684\u7B2C\u4E00\u4E2A\u53C2\u6570\u662F\u7A7A\u4E32\u6216\u8005\u7A7A\u767D\u4E5F\u8FD4\u56DE\u7B2C\u4E8C\u4E2A\u53C2\u6570\u3002</p><ol><li>\u521B\u5EFAmaven java \u5DE5\u7A0B\uFF0C\u6DFB\u52A0\u4F9D\u8D56</li></ol><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- pom.xml \u6587\u4EF6 --&gt;</span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hive<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hive-exec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.3.7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol start="2"><li>\u5F00\u53D1java\u7C7B\u7EE7\u627FUDF\uFF0C\u5B9E\u73B0evaluate \u65B9\u6CD5</li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> nvl <span class="token keyword">extends</span> <span class="token class-name">UDF</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Text</span> <span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Text</span> t<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Text</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> t<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> x<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> t<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol start="3"><li>\u5C06\u9879\u76EE\u6253\u5305\u4E0A\u4F20\u670D\u52A1\u5668</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">mv</span> hive-udf-test-1.0-SNAPSHOT.jar hiveudf.jar
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><ol start="4"><li>\u6DFB\u52A0\u5F00\u53D1\u7684jar\u5305(\u5728Hive\u547D\u4EE4\u884C\u4E2D)</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token function">add</span> jar /root/hiveudf.jar<span class="token punctuation">;</span>
Added <span class="token punctuation">[</span>/root/hiveudf.jar<span class="token punctuation">]</span> to class path
Added resources: <span class="token punctuation">[</span>/root/hiveudf.jar<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="5"><li>\u521B\u5EFA\u4E34\u65F6\u51FD\u6570\u3002\u6307\u5B9A\u7C7B\u540D\u4E00\u5B9A\u8981\u5B8C\u6574\u7684\u8DEF\u5F84\uFF0C\u5373\u5305\u540D\u52A0\u7C7B\u540D</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> create temporary <span class="token keyword">function</span> mynvl as <span class="token string">&quot;com.zmn.hive.Nvl&quot;</span><span class="token punctuation">;</span>
OK
Time taken: <span class="token number">0.016</span> seconds
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="6"><li>\u6267\u884C\u67E5\u8BE2</li></ol><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u57FA\u672C\u529F\u80FD\u8FD8\u6709</span>
<span class="token keyword">select</span> mynvl<span class="token punctuation">(</span>comm<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">from</span> mydb<span class="token punctuation">.</span>emp<span class="token punctuation">;</span>
<span class="token comment">-- \u6D4B\u8BD5\u6269\u5145\u7684\u529F\u80FD</span>
<span class="token keyword">select</span> mynvl<span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> mynvl<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>7\u3001\u9000\u51FAHive\u547D\u4EE4\u884C\uFF0C\u518D\u8FDB\u5165Hive\u547D\u4EE4\u884C\u3002\u6267\u884C\u6B65\u9AA46\u7684\u6D4B\u8BD5\uFF0C\u53D1\u73B0\u51FD\u6570\u5931\u6548\u3002</p><blockquote><p>\u5907\u6CE8: \u521B\u5EFA\u4E34\u65F6\u51FD\u6570\u6BCF\u6B21\u8FDB\u5165Hive\u547D\u4EE4\u884C\u65F6\uFF0C\u90FD\u5FC5\u987B\u6267\u884C\u4EE5\u4E0B\u8BED\u53E5\uFF0C\u5F88\u4E0D\u65B9\u4FBF</p></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">add</span> jar /root/hiveudf.jar<span class="token punctuation">;</span>

create temporary <span class="token keyword">function</span> mynvl as <span class="token string">&quot;com.zmn.hive.Nvl&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>\u521B\u5EFA\u6C38\u4E45\u51FD\u6570:</p><p>1\u3001\u5C06jar\u4E0A\u4F20HDFS</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>hdfs dfs -mkdir jar/
hdfs dfs -put hiveudf.jar jar/
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>2\u3001\u5728Hive\u547D\u4EE4\u884C\u4E2D\u521B\u5EFA\u6C38\u4E45\u51FD\u6570</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">create</span> <span class="token keyword">function</span> mynvl1 <span class="token keyword">as</span> <span class="token string">&#39;com.zmn.hive.Nvl&#39;</span> <span class="token keyword">using</span> jar <span class="token string">&#39;hdfs:/user/root/jar/hiveudf.jar&#39;</span><span class="token punctuation">;</span>
Added <span class="token punctuation">[</span><span class="token operator">/</span>tmp<span class="token operator">/</span>e46f2f98<span class="token operator">-</span><span class="token number">0820</span><span class="token operator">-</span><span class="token number">4</span>bb3<span class="token operator">-</span><span class="token number">98</span>ef<span class="token operator">-</span><span class="token number">49707</span>da29194_resources<span class="token operator">/</span>hiveudf<span class="token punctuation">.</span>jar<span class="token punctuation">]</span> <span class="token keyword">to</span> class path
Added resources: <span class="token punctuation">[</span>hdfs:<span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>root<span class="token operator">/</span>jar<span class="token operator">/</span>hiveudf<span class="token punctuation">.</span>jar<span class="token punctuation">]</span>
OK
<span class="token keyword">Time</span> taken: <span class="token number">0.467</span> seconds

<span class="token comment">-- \u67E5\u8BE2\u6240\u6709\u7684\u51FD\u6570\uFF0C\u53D1\u73B0 mynvl1 \u5728\u5217\u8868\u4E2D </span>
<span class="token keyword">show</span> functions<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>3\u3001\u9000\u51FAHive\uFF0C\u518D\u8FDB\u5165\uFF0C\u6267\u884C\u6D4B\u8BD5</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u57FA\u672C\u529F\u80FD\u8FD8\u6709</span>
<span class="token keyword">select</span> mynvl1<span class="token punctuation">(</span>comm<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
<span class="token comment">-- \u6D4B\u8BD5\u6269\u5145\u7684\u529F\u80FD</span>
<span class="token keyword">select</span> mynvl1<span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">select</span> mynvl1<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>4\u3001\u5220\u9664\u6C38\u4E45\u51FD\u6570\uFF0C\u5E76\u68C0\u67E5</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">drop</span> <span class="token keyword">function</span> mynvl1<span class="token punctuation">;</span> 
<span class="token keyword">show</span> functions<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="\u7B2C\u516B\u90E8\u5206-hql-dml\u547D\u4EE4" tabindex="-1"><a class="header-anchor" href="#\u7B2C\u516B\u90E8\u5206-hql-dml\u547D\u4EE4" aria-hidden="true">#</a> \u7B2C\u516B\u90E8\u5206 HQL DML\u547D\u4EE4</h2><p>\u6570\u636E\u64CD\u7EB5\u8BED\u8A00DML(Data Manipulation Language)\uFF0CDML\u4E3B\u8981\u6709\u4E09\u79CD\u5F62\u5F0F: \u63D2\u5165(INSERT)\u3001\u5220\u9664(DELETE)\u3001\u66F4\u65B0(UPDATE)\u3002</p><p>\u4E8B\u52A1(transaction)\u662F\u4E00\u7EC4\u5355\u5143\u5316\u64CD\u4F5C\uFF0C\u8FD9\u4E9B\u64CD\u4F5C\u8981\u4E48\u90FD\u6267\u884C\uFF0C\u8981\u4E48\u90FD\u4E0D\u6267\u884C\uFF0C\u662F\u4E00\u4E2A\u4E0D\u53EF\u5206\u5272\u7684\u5DE5\u4F5C\u5355\u5143\u3002</p><p>\u4E8B\u52A1\u5177\u6709\u7684\u56DB\u4E2A\u8981\u7D20:\u539F\u5B50\u6027(Atomicity)\u3001\u4E00\u81F4\u6027(Consistency)\u3001\u9694\u79BB\u6027(Isolation)\u3001\u6301\u4E45\u6027(Durability)\uFF0C\u8FD9\u56DB\u4E2A\u57FA\u672C\u8981\u7D20\u901A\u5E38\u79F0\u4E3AACID\u7279\u6027\u3002</p><ul><li>\u539F\u5B50\u6027\uFF1A\u4E00\u4E2A\u4E8B\u52A1\u662F\u4E00\u4E2A\u4E0D\u53EF\u518D\u5206\u5272\u7684\u5DE5\u4F5C\u5355\u4F4D\uFF0C\u4E8B\u52A1\u4E2D\u7684\u6240\u6709\u64CD\u4F5C\u8981\u4E48\u90FD\u53D1\u751F\uFF0C\u8981\u4E48\u90FD\u4E0D\u53D1\u751F\u3002</li><li>\u4E00\u81F4\u6027\uFF1A\u4E8B\u52A1\u7684\u4E00\u81F4\u6027\u662F\u6307\u4E8B\u52A1\u7684\u6267\u884C\u4E0D\u80FD\u7834\u574F\u6570\u636E\u5E93\u6570\u636E\u7684\u5B8C\u6574\u6027\u548C\u4E00\u81F4\u6027\uFF0C\u4E00\u4E2A\u4E8B\u52A1\u5728\u6267\u884C\u4E4B\u524D\u548C\u6267\u884C\u4E4B\u540E\uFF0C\u6570\u636E\u5E93\u90FD\u5FC5\u987B\u5904\u4E8E\u4E00\u81F4\u6027\u72B6\u6001\u3002</li><li>\u9694\u79BB\u6027\uFF1A\u5728\u5E76\u53D1\u73AF\u5883\u4E2D\uFF0C\u5E76\u53D1\u7684\u4E8B\u52A1\u662F\u76F8\u4E92\u9694\u79BB\u7684\uFF0C\u4E00\u4E2A\u4E8B\u52A1\u7684\u6267\u884C\u4E0D\u80FD\u88AB\u5176\u4ED6\u4E8B\u52A1\u5E72\u6270\u3002\u5373\u4E0D\u540C\u7684\u4E8B\u52A1\u5E76\u53D1\u64CD\u7EB5\u76F8\u540C\u7684\u6570\u636E\u65F6\uFF0C\u6BCF\u4E2A\u4E8B\u52A1\u90FD\u6709\u5404\u81EA\u5B8C\u6574\u7684\u6570\u636E\u7A7A\u95F4\uFF0C\u5373\u4E00\u4E2A\u4E8B\u52A1\u5185\u90E8\u7684\u64CD\u4F5C\u53CA\u4F7F\u7528\u7684\u6570\u636E\u5BF9\u5176\u4ED6\u5E76\u53D1\u4E8B\u52A1\u662F\u9694\u79BB\u7684\uFF0C\u5E76\u53D1\u6267\u884C\u7684\u5404\u4E2A\u4E8B\u52A1\u4E4B\u95F4\u4E0D\u80FD\u4E92\u76F8\u5E72\u6270\u3002</li><li>\u6301\u4E45\u6027\uFF1A\u4E8B\u52A1\u4E00\u65E6\u63D0\u4EA4\uFF0C\u5B83\u5BF9\u6570\u636E\u5E93\u4E2D\u6570\u636E\u7684\u6539\u53D8\u5C31\u5E94\u8BE5\u662F\u6C38\u4E45\u6027\u7684\u3002</li></ul><h3 id="\u7B2C-1-\u8282-hive\u4E8B\u52A1" tabindex="-1"><a class="header-anchor" href="#\u7B2C-1-\u8282-hive\u4E8B\u52A1" aria-hidden="true">#</a> \u7B2C 1 \u8282 Hive\u4E8B\u52A1</h3><p>Hive\u4ECE 0.14 \u7248\u672C\u5F00\u59CB\u652F\u6301\u4E8B\u52A1\u548C\u884C\u7EA7\u66F4\u65B0\uFF0C\u4F46\u7F3A\u7701\u662F\u4E0D\u652F\u6301\u7684\uFF0C\u9700\u8981\u4E00\u4E9B\u9644\u52A0\u7684\u914D\u7F6E\u3002\u8981\u60F3\u652F\u6301\u884C\u7EA7insert\u3001update\u3001delete\uFF0C\u9700\u8981\u914D\u7F6EHive\u652F\u6301\u4E8B\u52A1\u3002</p><p>Hive\u4E8B\u52A1\u7684\u9650\u5236:</p><ul><li>Hive\u63D0\u4F9B\u884C\u7EA7\u522B\u7684ACID\u8BED\u4E49</li><li>BEGIN\u3001COMMIT\u3001ROLLBACK \u6682\u65F6\u4E0D\u652F\u6301\uFF0C\u6240\u6709\u64CD\u4F5C\u81EA\u52A8\u63D0\u4EA4</li><li>\u76EE\u524D\u53EA\u652F\u6301 ORC \u7684\u6587\u4EF6\u683C\u5F0F</li><li>\u9ED8\u8BA4\u4E8B\u52A1\u662F\u5173\u95ED\u7684\uFF0C\u9700\u8981\u8BBE\u7F6E\u5F00\u542F</li><li>\u8981\u662F\u4F7F\u7528\u4E8B\u52A1\u7279\u6027\uFF0C\u8868\u5FC5\u987B\u662F\u5206\u6876\u7684</li><li>\u53EA\u80FD\u4F7F\u7528\u5185\u90E8\u8868</li><li>\u5982\u679C\u4E00\u4E2A\u8868\u7528\u4E8EACID\u5199\u5165(INSERT\u3001UPDATE\u3001DELETE)\uFF0C\u5FC5\u987B\u5728\u8868\u4E2D\u8BBE\u7F6E\u8868\u5C5E\u6027: <code>transactional=true</code></li><li>\u5FC5\u987B\u4F7F\u7528\u4E8B\u52A1\u7BA1\u7406\u5668 <code>org.apache.hadoop.hive.ql.lockmgr.DbTxnManager</code></li><li>\u76EE\u524D\u652F\u6301\u5FEB\u7167\u7EA7\u522B\u7684\u9694\u79BB\u3002\u5C31\u662F\u5F53\u4E00\u6B21\u6570\u636E\u67E5\u8BE2\u65F6\uFF0C\u4F1A\u63D0\u4F9B\u4E00\u4E2A\u6570\u636E\u4E00\u81F4\u6027\u7684\u5FEB\u7167</li><li><code>LOAD DATA</code> \u8BED\u53E5\u76EE\u524D\u5728\u4E8B\u52A1\u8868\u4E2D\u6682\u65F6\u4E0D\u652F\u6301</li></ul><p>HDFS \u662F\u4E0D\u652F\u6301\u6587\u4EF6\u7684\u4FEE\u6539;\u5E76\u4E14\u5F53\u6709\u6570\u636E\u8FFD\u52A0\u5230\u6587\u4EF6\uFF0CHDFS\u4E0D\u5BF9\u8BFB\u6570\u636E\u7684\u7528\u6237\u63D0\u4F9B\u4E00\u81F4\u6027\u4FDD\u8BC1\u3002</p><p>\u4E3A\u4E86\u5728HDFS\u4E0A\u652F\u6301\u6570\u636E\u7684\u66F4\u65B0:</p><ul><li>\u8868\u548C\u5206\u533A\u7684\u6570\u636E\u90FD\u88AB\u5B58\u5728\u57FA\u672C\u6587\u4EF6\u4E2D(base files)</li><li>\u65B0\u7684\u8BB0\u5F55\u548C\u66F4\u65B0\uFF0C\u5220\u9664\u90FD\u5B58\u5728\u589E\u91CF\u6587\u4EF6\u4E2D(delta files)</li><li>\u4E00\u4E2A\u4E8B\u52A1\u64CD\u4F5C\u521B\u5EFA\u4E00\u7CFB\u5217\u7684\u589E\u91CF\u6587\u4EF6</li><li>\u5728\u8BFB\u53D6\u7684\u65F6\u5019\uFF0C\u5C06\u57FA\u7840\u6587\u4EF6\u548C\u4FEE\u6539\uFF0C\u5220\u9664\u5408\u5E76\uFF0C\u6700\u540E\u8FD4\u56DE\u7ED9\u67E5\u8BE2</li></ul><h3 id="\u7B2C-2-\u8282-hive-\u4E8B\u52A1\u64CD\u4F5C\u793A\u4F8B" tabindex="-1"><a class="header-anchor" href="#\u7B2C-2-\u8282-hive-\u4E8B\u52A1\u64CD\u4F5C\u793A\u4F8B" aria-hidden="true">#</a> \u7B2C 2 \u8282 Hive \u4E8B\u52A1\u64CD\u4F5C\u793A\u4F8B</h3><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u5F00\u542F\u4E8B\u52A1</span>
<span class="token comment">-- \u8FD9\u4E9B\u53C2\u6570\u4E5F\u53EF\u4EE5\u8BBE\u7F6E\u5728hive-site.xml\u4E2D</span>
<span class="token keyword">SET</span> hive<span class="token punctuation">.</span>support<span class="token punctuation">.</span>concurrency <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token comment">-- Hive 0.x and 1.x only</span>
<span class="token keyword">SET</span> hive<span class="token punctuation">.</span>enforce<span class="token punctuation">.</span>bucketing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">-- \u5141\u8BB8\u5206\u6876. 2.x \u9ED8\u8BA4\u5141\u8BB8\u5206\u6876\uFF0C\u8FD9\u4E2A\u53C2\u6570\u5DF2\u7ECF\u6CA1\u6709\u4E86</span>
<span class="token keyword">SET</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span><span class="token keyword">partition</span><span class="token punctuation">.</span><span class="token keyword">mode</span> <span class="token operator">=</span> nonstrict<span class="token punctuation">;</span> <span class="token comment">-- \u6253\u5F00\u52A8\u6001\u5206\u533A</span>
<span class="token keyword">SET</span> hive<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>manager <span class="token operator">=</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hive<span class="token punctuation">.</span>ql<span class="token punctuation">.</span>lockmgr<span class="token punctuation">.</span>DbTxnManager<span class="token punctuation">;</span> <span class="token comment">-- \u8BBE\u7F6E\u4E8B\u52A1\u7BA1\u7406\u5668</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u521B\u5EFA\u8868\u7528\u4E8E\u66F4\u65B0\u7684\u4E8B\u52A1\u8868\u3002\u6EE1\u8DB3\u6761\u4EF6\uFF1A\u5185\u90E8\u8868\u3001ORC\u683C\u5F0F\u3001\u5206\u6876\u3001\u8BBE\u7F6E\u8868\u5C5E\u6027</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> zxz_data<span class="token punctuation">(</span>
    name string<span class="token punctuation">,</span>
    nid <span class="token keyword">int</span><span class="token punctuation">,</span>
    phone string<span class="token punctuation">,</span>
    ntime <span class="token keyword">date</span>
<span class="token punctuation">)</span><span class="token keyword">clustered</span> <span class="token keyword">by</span><span class="token punctuation">(</span>nid<span class="token punctuation">)</span> <span class="token keyword">into</span> <span class="token number">5</span> buckets
stored <span class="token keyword">as</span> orc
tblproperties<span class="token punctuation">(</span><span class="token string">&#39;transactional&#39;</span><span class="token operator">=</span><span class="token string">&#39;true&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- \u521B\u5EFA\u4E34\u65F6\u8868\uFF0C\u7528\u4E8E\u5411\u5206\u6876\u8868\u63D2\u5165\u6570\u636E</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> temp1<span class="token punctuation">(</span>
    name string<span class="token punctuation">,</span>
    nid <span class="token keyword">int</span><span class="token punctuation">,</span>
    phone string<span class="token punctuation">,</span>
    ntime <span class="token keyword">date</span>
<span class="token punctuation">)</span> <span class="token keyword">row</span> format delimited
<span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># \u6570\u636E
name1,1,010-83596208,2020-01-01
name2,2,027-63277201,2020-01-02
name3,3,010-83596208,2020-01-03
name4,4,010-83596208,2020-01-04
name5,5,010-83596208,2020-01-05
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- \u5411\u4E34\u65F6\u8868\u52A0\u8F7D\u6570\u636E\uFF1B\u5411\u4E8B\u52A1\u8868\u4E2D\u52A0\u8F7D\u6570\u636E</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">&#39;/home/hadoop/data/zxz_data.txt&#39;</span> overwrite <span class="token keyword">into</span> <span class="token keyword">table</span> temp1<span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> zxz_data <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> temp1<span class="token punctuation">;</span>

<span class="token comment">-- \u68C0\u67E5\u6570\u636E\u548C\u6587\u4EF6</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> zxz_data<span class="token punctuation">;</span>

<span class="token comment">-- \u67E5\u770B\u6570\u636E\u6587\u4EF6</span>
dfs <span class="token operator">-</span>ls <span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>hive<span class="token operator">/</span>warehouse<span class="token operator">/</span>mydb<span class="token punctuation">.</span>db<span class="token operator">/</span>zxz_data<span class="token punctuation">;</span>
dfs <span class="token operator">-</span>ls <span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>hive<span class="token operator">/</span>warehouse<span class="token operator">/</span>mydb<span class="token punctuation">.</span>db<span class="token operator">/</span>zxz_data<span class="token operator">/</span>delta_0000001_0000001_0000<span class="token punctuation">;</span>

<span class="token comment">-- DML \u64CD\u4F5C</span>
<span class="token keyword">delete</span> <span class="token keyword">from</span> zxz_data <span class="token keyword">where</span> nid <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

<span class="token comment">-- \u67E5\u770B\u6570\u636E\u6587\u4EF6</span>
dfs <span class="token operator">-</span>ls <span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>hive<span class="token operator">/</span>warehouse<span class="token operator">/</span>mydb<span class="token punctuation">.</span>db<span class="token operator">/</span>zxz_data<span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> zxz_data <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">&quot;name3&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;010-83596208&quot;</span><span class="token punctuation">,</span> <span class="token keyword">current_date</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- \u4E0D\u652F\u6301</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> zxz_data <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">&quot;name3&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;010-83596208&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2020-06-01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- \u6267\u884C</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> zxz_data <span class="token keyword">select</span> <span class="token string">&quot;name3&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;010-83596208&quot;</span><span class="token punctuation">,</span> <span class="token keyword">current_date</span><span class="token punctuation">;</span>

<span class="token comment">-- \u67E5\u770B\u6570\u636E\u6587\u4EF6</span>
dfs <span class="token operator">-</span>ls <span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>hive<span class="token operator">/</span>warehouse<span class="token operator">/</span>mydb<span class="token punctuation">.</span>db<span class="token operator">/</span>zxz_data<span class="token punctuation">;</span>
<span class="token comment">-- \u53EF\u4EE5\u53D1\u73B0\u589E\u52A0\u4E86\u6570\u636E\u6587\u4EF6</span>

<span class="token comment">-- \u6279\u91CF\u63D2\u5165</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> zxz_data <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token string">&quot;name6&quot;</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">&quot;010-83596208&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2020-06-02&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">&quot;name7&quot;</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">&quot;010-83596208&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2020-06-03&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">&quot;name8&quot;</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">&quot;010-83596208&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2020-06-05&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">&quot;name9&quot;</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">&quot;010-83596208&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2020-06-06&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- \u67E5\u770B\u6570\u636E\u6587\u4EF6\uFF0C\u53EF\u4EE5\u53D1\u73B0\u53C8\u589E\u52A0\u4E86\u4E00\u6279\u6570\u636E\u6587\u4EF6</span>
dfs <span class="token operator">-</span>ls <span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>hive<span class="token operator">/</span>warehouse<span class="token operator">/</span>mydb<span class="token punctuation">.</span>db<span class="token operator">/</span>zxz_data<span class="token punctuation">;</span>

<span class="token comment">-- \u4FEE\u6539\u6570\u636E</span>
<span class="token keyword">update</span> zxz_data <span class="token keyword">set</span> name<span class="token operator">=</span>concat<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">&quot;00&quot;</span><span class="token punctuation">)</span> <span class="token keyword">where</span> nid<span class="token operator">&gt;</span><span class="token number">3</span><span class="token punctuation">;</span>

<span class="token comment">-- \u67E5\u770B\u6570\u636E\u6587\u4EF6</span>
dfs <span class="token operator">-</span>ls <span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>hive<span class="token operator">/</span>warehouse<span class="token operator">/</span>mydb<span class="token punctuation">.</span>db<span class="token operator">/</span>zxz_data<span class="token punctuation">;</span>

<span class="token comment">-- \u5206\u6876\u5B57\u6BB5\u4E0D\u80FD\u4FEE\u6539\uFF0C\u4E0B\u9762\u7684\u8BED\u53E5\u4E0D\u80FD\u6267\u884C</span>
<span class="token comment">-- FAILED: SemanticException [Error 10302]: Updating values of bucketing columns is not supported.  Column nid.</span>
<span class="token keyword">update</span> zxz_data <span class="token keyword">set</span> nid <span class="token operator">=</span> nid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>\u5C0F\u7ED3\uFF1AHive\u652F\u6301\u884C\u7EA7\u4E8B\u52A1(\u610F\u5473\u7740\u5141\u8BB8\u5BF9\u6570\u636E\u8FDB\u884C\u4FEE\u6539,\u4F46\u662F\u603B\u7684\u6765\u8BF4,\u6761\u4EF6\u4E25\u683C\u3002\u4E0D\u5EFA\u8BAE\u5728\u751F\u4EA7\u73AF\u5883\u4E2D\u4F7F\u7528)</p>`,134);function w(g,h){const e=t("ExternalLinkIcon");return o(),l(r,null,[k,n("blockquote",null,[n("p",null,[b,n("a",m,[d,c(e)])])]),y],64)}var f=p(i,[["render",w],["__file","index.html.vue"]]);export{f as default};
