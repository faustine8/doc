import{_ as n,c as s}from"./app.40df414d.js";var a="/doc/assets/SpringBoot\u9AD8\u7EA7-1621252360565.7def8c14.png",t="/doc/assets/SpringBoot\u9AD8\u7EA7-1621383462773.9ec4dcdb.png",p="/doc/assets/SpringBoot\u9AD8\u7EA7-1621421757352.707dda3e.png",e="/doc/assets/SpringBoot\u9AD8\u7EA7-1621513590066.f3d45a4a.png";const o={},c=s(`<h1 id="springboot-\u9AD8\u7EA7" tabindex="-1"><a class="header-anchor" href="#springboot-\u9AD8\u7EA7" aria-hidden="true">#</a> SpringBoot \u9AD8\u7EA7</h1><h2 id="\u81EA\u5B9A\u4E49-starter" tabindex="-1"><a class="header-anchor" href="#\u81EA\u5B9A\u4E49-starter" aria-hidden="true">#</a> \u81EA\u5B9A\u4E49 Starter</h2><h3 id="springboot-starter-\u673A\u5236" tabindex="-1"><a class="header-anchor" href="#springboot-starter-\u673A\u5236" aria-hidden="true">#</a> SpringBoot starter \u673A\u5236</h3><p>SpringBoot \u4E2D\u7684starter\u662F\u4E00\u79CD\u975E\u5E38\u91CD\u8981\u7684\u673A\u5236\uFF0C\u80FD\u591F\u629B\u5F03\u4EE5\u524D\u7E41\u6742\u7684\u914D\u7F6E\uFF0C\u5C06\u5176\u7EDF\u4E00\u96C6\u6210\u8FDB starter\uFF0C \u5E94\u7528\u8005\u53EA\u9700\u8981\u5728maven\u4E2D\u5F15\u5165starter\u4F9D\u8D56\uFF0CSpringBoot\u5C31\u80FD\u81EA\u52A8\u626B\u63CF\u5230\u8981\u52A0\u8F7D\u7684\u4FE1\u606F\u5E76\u542F\u52A8\u76F8\u5E94\u7684\u9ED8\u8BA4\u914D\u7F6E\u3002</p><p>starter \u8BA9\u6211\u4EEC\u6446\u8131\u4E86\u5404\u79CD\u4F9D\u8D56\u5E93\u7684\u5904\u7406\uFF0C\u9700\u8981\u914D\u7F6E\u5404\u79CD\u4FE1\u606F\u7684\u56F0\u6270\u3002SpringBoot\u4F1A\u81EA\u52A8\u901A\u8FC7classpath\u8DEF\u5F84\u4E0B\u7684\u7C7B\u53D1\u73B0\u9700\u8981\u7684Bean\uFF0C\u5E76\u6CE8\u518C\u8FDBIOC\u5BB9\u5668\u3002 SpringBoot \u63D0\u4F9B\u4E86\u9488\u5BF9\u65E5\u5E38\u4F01\u4E1A\u5E94\u7528\u7814\u53D1\u5404\u79CD\u573A\u666F\u7684 spring-boot-starter \u4F9D\u8D56\u6A21\u5757\u3002 \u6240\u6709\u8FD9\u4E9B\u4F9D\u8D56\u6A21\u5757\u90FD\u9075\u5FAA\u7740\u7EA6\u5B9A\u6210\u4FD7\u7684\u9ED8\u8BA4\u914D\u7F6E\uFF0C\u5E76\u5141\u8BB8\u6211\u4EEC\u8C03\u6574\u8FD9\u4E9B\u914D\u7F6E\uFF0C\u5373\u9075\u5FAA\u201C\u7EA6\u5B9A\u5927\u4E8E\u914D\u7F6E\u201D\u7684\u7406\u5FF5\u3002</p><p>\u6BD4\u5982\u6211\u4EEC\u5728springboot\u91CC\u9762\u8981\u5F15\u5165redis,\u90A3\u4E48\u6211\u4EEC\u9700\u8981\u5728pom\u4E2D\u5F15\u5165\u4EE5\u4E0B\u5185\u5BB9</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>\u8FD9\u5C31\u662F\u4E00\u4E2Astarter\u3002 \u7B80\u800C\u8A00\u4E4B\uFF0Cstarter \u5C31\u662F\u4E00\u4E2A\u5916\u90E8\u7684\u9879\u76EE\uFF0C\u6211\u4EEC\u9700\u8981\u4F7F\u7528\u5B83\u7684\u65F6\u5019\u5C31\u53EF\u4EE5\u5728\u5F53\u524Dspringboot\u9879\u76EE\u4E2D\u5F15\u5165\u5B83\u3002</p><p><strong>\u4E3A\u4EC0\u4E48\u8981\u81EA\u5B9A\u4E49starter?</strong></p><p>\u5728\u6211\u4EEC\u7684\u65E5\u5E38\u5F00\u53D1\u5DE5\u4F5C\u4E2D\uFF0C\u7ECF\u5E38\u4F1A\u6709\u4E00\u4E9B\u72EC\u7ACB\u4E8E\u4E1A\u52A1\u4E4B\u5916\u7684\u914D\u7F6E\u6A21\u5757\uFF0C\u6211\u4EEC\u7ECF\u5E38\u5C06\u5176\u653E\u5230\u4E00\u4E2A\u7279\u5B9A\u7684\u5305\u4E0B\uFF0C\u7136\u540E\u5982\u679C\u53E6\u4E00\u4E2A\u5DE5\u7A0B\u9700\u8981\u590D\u7528\u8FD9\u5757\u529F\u80FD\u7684\u65F6\u5019\uFF0C\u9700\u8981\u5C06\u4EE3\u7801\u786C\u62F7\u8D1D\u5230\u53E6\u4E00\u4E2A\u5DE5\u7A0B\uFF0C\u91CD\u65B0\u96C6\u6210\u4E00\u904D\uFF0C\u9EBB\u70E6\u81F3\u6781\u3002 \u5982\u679C\u6211\u4EEC\u5C06\u8FD9\u4E9B\u53EF\u72EC\u7ACB\u4E8E\u4E1A\u52A1\u4EE3\u7801\u4E4B\u5916\u7684\u529F\u914D\u7F6E\u6A21\u5757\u5C01\u88C5\u6210\u4E00\u4E2A\u4E2Astarter\uFF0C\u590D\u7528\u7684\u65F6\u5019\u53EA\u9700\u8981\u5C06\u5176\u5728pom\u4E2D\u5F15\u7528\u4F9D\u8D56\u5373\u53EF\uFF0C\u518D\u7531SpringBoot\u4E3A\u6211\u4EEC\u5B8C\u6210\u81EA\u52A8\u88C5\u914D\uFF0C\u5C31\u975E\u5E38\u8F7B\u677E\u4E86\u3002</p><p><strong>\u81EA\u5B9A\u4E49starter\u7684\u547D\u540D\u89C4\u5219</strong></p><p>SpringBoot \u63D0\u4F9B\u7684starter\u4EE5<code>spring-boot-starter-xxx</code>\u7684\u65B9\u5F0F\u547D\u540D\u7684\uFF0C \u5B98\u65B9\u5EFA\u8BAE\u81EA\u5B9A\u4E49\u7684starter\u4F7F\u7528<code>xxx-spring-boot-starter</code>\u547D\u540D\u89C4\u5219\u3002 \u4EE5\u533A\u5206SpringBoot\u751F\u6001\u63D0\u4F9B\u7684starter\u3002</p><h3 id="\u81EA\u5B9A\u4E49starter\u4EE3\u7801\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#\u81EA\u5B9A\u4E49starter\u4EE3\u7801\u5B9E\u73B0" aria-hidden="true">#</a> \u81EA\u5B9A\u4E49starter\u4EE3\u7801\u5B9E\u73B0</h3><p><strong>\u81EA\u5B9A\u4E49starter</strong></p><p>\u65B0\u5EFA maven \u5DE5\u7A0B\u5E76\u5BFC\u5165\u4F9D\u8D56</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-autoconfigure<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.2.9.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>\u7F16\u5199\u9700\u8981\u81EA\u52A8\u6CE8\u5165\u7684 JavaBean</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">SimpleBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;simple.bean&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleBean</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>\u7F16\u5199\u81EA\u52A8\u914D\u7F6E\u7C7B</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyAutoConfiguration</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;=== MyAutoConfiguration init ===&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">SimpleBean</span> <span class="token function">simpleBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SimpleBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>resources\u4E0B\u521B\u5EFA/META-INF/spring.factories</p><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span><span class="token punctuation">=</span><span class="token value attr-value">\\
com.mujunlin.config.MyAutoConfiguration</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>SpringBoot \u542F\u52A8\u7684\u65F6\u5019\u4F1A\u53BB\u52A0\u8F7D\u6211\u4EEC\u7684simpleBean\u5230IOC\u5BB9\u5668\u4E2D\u3002\u8FD9\u5176\u5B9E\u662F\u4E00\u79CD\u53D8\u5F62\u7684SPI\u673A\u5236</p></blockquote><p><strong>\u4F7F\u7528starter</strong></p><p>\u5BFC\u5165\u81EA\u5B9A\u4E49starter\u7684\u4F9D\u8D56</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.mujunlin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>my-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>\u5728\u5168\u5C40\u914D\u7F6E\u6587\u4EF6\u4E2D\u914D\u7F6E\u5C5E\u6027\u503C</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">simple</span><span class="token punctuation">:</span>
  <span class="token key atrule">bean</span><span class="token punctuation">:</span>
    <span class="token key atrule">id</span><span class="token punctuation">:</span> <span class="token number">102</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> zhangsan
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>\u7F16\u5199\u6D4B\u8BD5\u65B9\u6CD5</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">SimpleBean</span> simpleBean<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test102</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>simpleBean<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="\u70ED\u63D2\u62D4\u6280\u672F\u652F\u6301" tabindex="-1"><a class="header-anchor" href="#\u70ED\u63D2\u62D4\u6280\u672F\u652F\u6301" aria-hidden="true">#</a> \u70ED\u63D2\u62D4\u6280\u672F\u652F\u6301</h3><p>\u5982\u679C\u6709\u4E00\u5929\u6211\u4EEC\u4E0D\u60F3\u8981\u542F\u52A8\u5DE5\u7A0B\u7684\u65F6\u5019\u81EA\u52A8\u88C5\u914D SimpleBean \u5462? \u53EF\u80FD\u6709\u7684\u540C\u5B66\u4F1A\u60F3\uFF0C\u6211\u4EEC\u53BBpom\u4E2D\u628A\u4F9D\u8D56\u6CE8\u91CA\u6389\uFF0C\u8FD9\u7684\u786E\u662F\u4E00\u79CD\u65B9\u6848\uFF0C\u4F46\u672A\u514D\u6709\u70B9Low\u3002</p><p>\u8FD8\u8BB0\u5F97\u6211\u4EEC\u7ECF\u5E38\u4F1A\u5728\u542F\u52A8\u7C7BApplication\u4E0A\u9762\u52A0@EnableXXX\u6CE8\u89E3\u5417?</p><p>\u5176\u5B9E\u8FD9\u4E2A<code>@Enablexxx</code>\u6CE8\u89E3\u5C31\u662F\u4E00\u79CD\u70ED\u62D4\u63D2\u6280\u672F\uFF0C\u52A0\u4E86\u8FD9\u4E2A\u6CE8\u89E3\u5C31\u53EF\u4EE5\u542F\u52A8\u5BF9\u5E94\u7684 starter\uFF0C \u5F53\u4E0D\u9700\u8981\u5BF9\u5E94\u7684 starter \u7684\u65F6\u5019\u53EA\u9700\u8981\u628A\u8FD9\u4E2A\u6CE8\u89E3\u6CE8\u91CA\u6389\u5C31\u884C\uFF0C\u662F\u4E0D\u662F\u5F88\u4F18\u96C5\u5462?\u90A3\u4E48\u8FD9\u662F\u5982\u4F55\u5B9E\u73B0\u7684\u5462?</p><ol><li>\u6DFB\u52A0\u6807\u8BB0\u7C7B</li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigMarker</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="2"><li>\u6DFB\u52A0\u542F\u7528\u6CE8\u89E3</li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">ConfigMarker</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">EnableRegisterServer</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="3"><li>\u5728 MyAutoConfiguration \u7C7B\u4E0A\u6DFB\u52A0\u6CE8\u89E3</li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ConditionalOnBean</span><span class="token punctuation">(</span><span class="token class-name">ConfigMarker</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><ol start="4"><li>\u9700\u8981\u542F\u7528\u65F6\uFF0C\u5728\u6838\u5FC3\u542F\u52A8\u7C7B\u4E0A\u6DFB\u52A0\u6CE8\u89E3</li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@EnableRegisterServer</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><blockquote><p>\u539F\u7406\u5176\u5B9E\u5F88\u7B80\u5355\uFF0C\u5F53\u52A0\u4E86<code>@EnableRegisterServer</code>\u6CE8\u89E3\u7684\u65F6\u5019\uFF0C\u7531\u4E8E\u8FD9\u4E2A\u6CE8\u89E3\u4F7F\u7528\u4E86<code>@Import({ConfigMarker.class})</code> \uFF0C \u6240\u4EE5Spring\u4F1A\u53BB\u52A0\u8F7D<code>ConfigMarker</code>\u5230\u4E0A\u4E0B\u6587\u4E2D\uFF0C\u56E0\u4E3A\u6761\u4EF6\u6CE8\u89E3<code>@ConditionalOnBean(ConfigMarker.class)</code>\u7684\u5B58\u5728\uFF0C \u6240\u4EE5<code>MyAutoConfiguration</code>\u7C7B\u5C31\u4F1A\u88AB\u5B9E\u4F8B\u5316\u3002</p></blockquote><h2 id="\u5185\u5D4Ctomcat" tabindex="-1"><a class="header-anchor" href="#\u5185\u5D4Ctomcat" aria-hidden="true">#</a> \u5185\u5D4CTomcat</h2><p>SpringBoot \u9ED8\u8BA4\u652F\u6301Tomcat\uFF0CJetty\uFF0C\u548CUndertow\u4F5C\u4E3A\u5E95\u5C42\u5BB9\u5668\u3002</p><p>\u9ED8\u8BA4\u4F7F\u7528Tomcat\uFF0C\u4E00\u65E6\u5F15\u5165<code>spring-boot-starter-web</code>\u6A21\u5757\uFF0C\u5C31\u9ED8\u8BA4\u4F7F\u7528Tomcat\u5BB9\u5668\u3002</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="servlet\u5BB9\u5668\u7684\u4F7F\u7528" tabindex="-1"><a class="header-anchor" href="#servlet\u5BB9\u5668\u7684\u4F7F\u7528" aria-hidden="true">#</a> Servlet\u5BB9\u5668\u7684\u4F7F\u7528</h3><p>\u89C2\u5BDF<code>spring-boot-starter-web</code>\u7684 POM \u6587\u4EF6</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-tomcat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-validation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.tomcat.embed<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>tomcat-embed-el<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-webmvc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>\u6838\u5FC3\u5C31\u662F\u5F15\u5165\u4E86\uFF0C Tomcat \u548C SpringMVC \u76F8\u5173\u7684\u4F9D\u8D56\u3002 \u56E0\u6B64\uFF0C\u9ED8\u8BA4\u7684 Servlet \u5BB9\u5668\u5C31\u662F Tomcat\u3002</p><p><strong>\u5207\u6362servlet\u5BB9\u5668</strong></p><p>\u5982\u679C\u60F3\u5207\u6362\u5176\u4ED6Servlet\u5BB9\u5668\u5462\uFF0C\u53EA\u9700\u5982\u4E0B\u4E24\u6B65:</p><ul><li>\u5C06tomcat\u4F9D\u8D56\u79FB\u9664\u6389</li><li>\u5F15\u5165\u5176\u4ED6Servlet\u5BB9\u5668\u4F9D\u8D56</li></ul><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
			<span class="token comment">&lt;!--\u79FB\u9664spring-boot-starter-web\u4E2D\u7684tomcat--&gt;</span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-tomcat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--\u5F15\u5165jetty--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-jetty<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="\u81EA\u52A8\u914D\u7F6E\u539F\u7406" tabindex="-1"><a class="header-anchor" href="#\u81EA\u52A8\u914D\u7F6E\u539F\u7406" aria-hidden="true">#</a> \u81EA\u52A8\u914D\u7F6E\u539F\u7406</h3><blockquote><p>\u95EE\u9898\uFF1ASpringBoot \u662F\u5982\u4F55\u542F\u52A8\u5185\u7F6E Tomcat \u7684?</p></blockquote><p><strong>SpringBoot \u542F\u52A8\u5185\u7F6E Tomcat \u6D41\u7A0B</strong></p><p>\u901A\u8FC7\u524D\u9762\u7684\u5B66\u4E60\u5DF2\u77E5\uFF1ASpringBoot \u7684\u6838\u5FC3\u542F\u52A8\u7C7B\u4E0A\u7684\u6CE8\u89E3<code>@SpringBootApplication</code>\u662F\u4E00\u4E2A\u7EC4\u5408\u6CE8\u89E3\u3002\u7EC4\u6210\u8FD9\u4E2A\u6CE8\u89E3\u7684\u6CE8\u89E3\u4E2D\u6709\u4E00\u4E2A\u542F\u52A8\u81EA\u52A8\u914D\u7F6E\u529F\u80FD\u7684\u6CE8\u89E3 <code>@EnableAutoConfiguration</code>\uFF0C\u5728\u8FD9\u4E2A\u6CE8\u89E3\u4E2D\u901A\u8FC7<code>@Import(AutoConfigurationImportSelector.class)</code>\u5BFC\u5165\u4E86<code>AutoConfigurationImportSelector</code>\u3002</p><p>\u7CFB\u7EDF\u542F\u52A8\u65F6\uFF0C\u9996\u5148\u8C03\u7528<code>selectImport()</code>\u65B9\u6CD5\uFF0C\u5728\u8BE5\u65B9\u6CD5\u4E2D\u8C03\u7528\u4E86<code>getAutoConfigurationEntry()</code>\u65B9\u6CD5\uFF0C \u5728\u4E4B\u4E2D\u53C8\u8C03\u7528\u4E86<code>getCandidateConfigurations()</code>\u65B9\u6CD5\uFF0C<code>getCandidateConfigurations()</code>\u65B9\u6CD5\u5C31\u53BB<code>META-INF/spring.factory</code>\u914D\u7F6E\u6587\u4EF6\u4E2D\u52A0\u8F7D\u76F8\u5173\u914D\u7F6E\u7C7B\u3002 \u8FD9\u4E2A<code>spring.factories</code>\u914D\u7F6E\u6587\u4EF6\u662F\u52A0\u8F7D\u7684 spring-boot-autoconfigure \u7684\u914D\u7F6E\u6587\u4EF6</p><p>\u914D\u7F6E\u6587\u4EF6\u4E2D\uFF0C\u6709\u4E00\u4E2A\u91CD\u8981\u7684\u914D\u7F6E\u7C7B<code>ServletWebServerFactoryAutoConfiguration</code>\u662F\u7528\u4E8E\u52A0\u8F7DServlet Web\u5BB9\u5668\u7684\u81EA\u52A8\u914D\u7F6E\u7C7B</p><p>\u8FDB\u5165<code>ServletWebServerFactoryAutoConfiguration</code>\u7C7B</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@AutoConfigureOrder</span><span class="token punctuation">(</span><span class="token class-name">Ordered</span><span class="token punctuation">.</span>HIGHEST_PRECEDENCE<span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnWebApplication</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">Type</span><span class="token punctuation">.</span>SERVLET<span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">ServerProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">ServletWebServerFactoryAutoConfiguration<span class="token punctuation">.</span>BeanPostProcessorsRegistrar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
		<span class="token class-name">ServletWebServerFactoryConfiguration<span class="token punctuation">.</span>EmbeddedTomcat</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
		<span class="token class-name">ServletWebServerFactoryConfiguration<span class="token punctuation">.</span>EmbeddedJetty</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
		<span class="token class-name">ServletWebServerFactoryConfiguration<span class="token punctuation">.</span>EmbeddedUndertow</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServletWebServerFactoryAutoConfiguration</span><span class="token punctuation">{</span>
    <span class="token comment">// \u7565...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ol><li><code>@ConditionalOnClass(ServletRequest.class)@ConditionalOnWebApplication(type = Type.SERVLET)</code>\u7528\u4E8E\u6307\u5B9A\u52A0\u8F7D\u6761\u4EF6</li><li><code>@EnableConfigurationProperties</code>\u7528\u4E8E\u6307\u5B9A<code>properties</code>\u6587\u4EF6\u76F8\u5173\u4FE1\u606F</li><li>\u6700\u540E\u901A\u8FC7<code>@Import</code>\u6CE8\u89E3\u5F15\u5165\u4E86\u4E00\u4E2A\u81EA\u52A8\u914D\u7F6E\u7684\u6CE8\u518C\u5668\u548C\u4E09\u79CDWeb\u5BB9\u5668\u3002\u8FD9\u4E5F\u662F\u4E3A\u4EC0\u4E48\u8BF4 SpringBoot \u9ED8\u8BA4\u652F\u6301\u8FD9\u4E09\u79CD\u5BB9\u5668\u7684\u539F\u56E0\u3002</li></ol><p>\u4EE5 Tomcat \u4E3A\u4F8B\uFF0C\u6211\u4EEC\u7EE7\u7EED\u8FDB\u5165<code>EmbeddedTomcat</code>\u5F53\u4E2D</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">Servlet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Tomcat</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">UpgradeProtocol</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">ServletWebServerFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> search <span class="token operator">=</span> <span class="token class-name">SearchStrategy</span><span class="token punctuation">.</span>CURRENT<span class="token punctuation">)</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">EmbeddedTomcat</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token class-name">TomcatServletWebServerFactory</span> <span class="token function">tomcatServletWebServerFactory</span><span class="token punctuation">(</span>
			<span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TomcatConnectorCustomizer</span><span class="token punctuation">&gt;</span></span> connectorCustomizers<span class="token punctuation">,</span>
			<span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TomcatContextCustomizer</span><span class="token punctuation">&gt;</span></span> contextCustomizers<span class="token punctuation">,</span>
			<span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TomcatProtocolHandlerCustomizer</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> protocolHandlerCustomizers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">TomcatServletWebServerFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TomcatServletWebServerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		factory<span class="token punctuation">.</span><span class="token function">getTomcatConnectorCustomizers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>connectorCustomizers<span class="token punctuation">.</span><span class="token function">orderedStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		factory<span class="token punctuation">.</span><span class="token function">getTomcatContextCustomizers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>contextCustomizers<span class="token punctuation">.</span><span class="token function">orderedStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		factory<span class="token punctuation">.</span><span class="token function">getTomcatProtocolHandlerCustomizers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>protocolHandlerCustomizers<span class="token punctuation">.</span><span class="token function">orderedStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> factory<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>\u8BE5\u7C7B\u4F1A\u5B9E\u4F8B\u5316<code>TomcatServletWebServerFactory</code>\u5E76\u6CE8\u5165\u5BB9\u5668\u4E2D\u3002\u6211\u4EEC\u7EE7\u7EED\u89C2\u5BDF<code>TomcatServletWebServerFactory</code>\uFF0C\u5176\u5185\u90E8\u7684<code>getWebServer</code>\u65B9\u6CD5\u662F\u6838\u5FC3</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">WebServer</span> <span class="token function">getWebServer</span><span class="token punctuation">(</span><span class="token class-name">ServletContextInitializer</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> initializers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>disableMBeanRegistry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Registry</span><span class="token punctuation">.</span><span class="token function">disableRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// \u5B9E\u4F8B\u5316\u4E00\u4E2A Tomcat</span>
	<span class="token class-name">Tomcat</span> tomcat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tomcat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// \u8BBE\u7F6E Tomcat \u7684\u4E34\u65F6\u5DE5\u4F5C\u76EE\u5F55</span>
	<span class="token class-name">File</span> baseDir <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>baseDirectory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseDirectory <span class="token operator">:</span> <span class="token function">createTempDir</span><span class="token punctuation">(</span><span class="token string">&quot;tomcat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	tomcat<span class="token punctuation">.</span><span class="token function">setBaseDir</span><span class="token punctuation">(</span>baseDir<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// \u9ED8\u8BA4\u4F7F\u7528 Http11NioProtocol \u5B9E\u4F8B\u5316 Connector</span>
	<span class="token class-name">Connector</span> connector <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Connector</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
	connector<span class="token punctuation">.</span><span class="token function">setThrowOnFailure</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// \u7ED9 service \u6DFB\u52A0 connector</span>
	tomcat<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addConnector</span><span class="token punctuation">(</span>connector<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">customizeConnector</span><span class="token punctuation">(</span>connector<span class="token punctuation">)</span><span class="token punctuation">;</span>
	tomcat<span class="token punctuation">.</span><span class="token function">setConnector</span><span class="token punctuation">(</span>connector<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// \u5173\u95ED\u70ED\u90E8\u7F72</span>
	tomcat<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoDeploy</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// \u914D\u7F6E Engine</span>
	<span class="token function">configureEngine</span><span class="token punctuation">(</span>tomcat<span class="token punctuation">.</span><span class="token function">getEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Connector</span> additionalConnector <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>additionalTomcatConnectors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		tomcat<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addConnector</span><span class="token punctuation">(</span>additionalConnector<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">prepareContext</span><span class="token punctuation">(</span>tomcat<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> initializers<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// \u5B9E\u4F8B\u5316Tomcat\u7684WebServer\u65F6\u4F1A\u5C06DispatcherServlet\u548C\u4E00\u4E9BFilter\u6DFB\u52A0\u5230Tomcat\u5F53\u4E2D</span>
	<span class="token keyword">return</span> <span class="token function">getTomcatWebServer</span><span class="token punctuation">(</span>tomcat<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>\u7EE7\u7EED\u8FDB\u5165<code>getTomcatWebServer()</code>\u7B49\u65B9\u6CD5\uFF0C\u4E00\u76F4\u5F80\u4E0B\u8DDF\u5230 Tomcat \u521D\u59CB\u5316\u65B9\u6CD5\uFF0C\u8C03\u7528<code>tomcat.start()</code>\u65B9\u6CD5\uFF0Ctomcat\u5C31\u6B63\u5F0F\u5F00\u542F\u8FD0\u884C</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">WebServerException</span> <span class="token punctuation">{</span>
	logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Tomcat initialized with port(s): &quot;</span> <span class="token operator">+</span> <span class="token function">getPortsDescription</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>monitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token comment">// Start the server to trigger initialization listeners</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// \u7565...</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// \u7565...</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>\u81F3\u6B64 Tomcat \u5728 SpringBoot \u4E2D\u7684\u914D\u7F6E\u4EE5\u53CA\u6700\u7EC8\u542F\u52A8\u7684\u6D41\u7A0B\u5C31\u5B8C\u6210\u4E86\u3002</p><p><strong>getWebServer()\u7684\u8C03\u7528\u5206\u6790</strong></p><p>\u5DF2\u77E5<code>getWebServer()</code>\u65B9\u6CD5\u662F\u5185\u5D4C Tomcat \u914D\u7F6E\u548C\u542F\u52A8\u7684\u6838\u5FC3\uFF0C\u90A3\u4E48\u8FD9\u4E2A\u65B9\u6CD5\u662F\u4EC0\u4E48\u65F6\u5019\u88AB\u8C03\u7528\u7684\u5462\uFF1F</p><p>\u6211\u4EEC\u8FD8\u662F\u4ECE\u4E00\u5207\u7684\u6E90\u5934\uFF0C\u6838\u5FC3\u542F\u52A8\u7C7B\u7684<code>run</code>\u65B9\u6CD5\u5F00\u59CB</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SpringBootTest2Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>\u8FD9\u4E2A\u65B9\u6CD5\u6700\u7EC8\u4F1A\u8C03\u7528\u5230\u4E00\u4E2A\u540C\u540D\u65B9\u6CD5<code>run(String... args)</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token class-name">ConfigurableApplicationContext</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// \u8BB0\u5F55\u7A0B\u5E8F\u8FD0\u884C\u65F6\u95F4</span>
		<span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// ConfigurableApplicationContext \u662F ApplicationContext \u63A5\u53E3\u7684\u5B50\u63A5\u53E3\u3002\u5728ApplicationContext \u57FA\u7840\u4E0A\u589E\u52A0\u4E86\u914D\u7F6E\u4E0A\u4E0B\u6587\u7684\u5DE5\u5177\u3002</span>
		<span class="token comment">// ConfigurableApplicationContext \u662F\u5BB9\u5668\u7684\u9AD8\u7EA7\u63A5\u53E3\u3002</span>
		<span class="token class-name">ConfigurableApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpringBootExceptionReporter</span><span class="token punctuation">&gt;</span></span> exceptionReporters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">configureHeadlessProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 1\u3001\u83B7\u53D6\u5E76\u542F\u52A8\u76D1\u542C\u5668</span>
		<span class="token class-name">SpringApplicationRunListeners</span> listeners <span class="token operator">=</span> <span class="token function">getRunListeners</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
		listeners<span class="token punctuation">.</span><span class="token function">starting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token class-name">ApplicationArguments</span> applicationArguments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultApplicationArguments</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 2\u3001\u6784\u9020\u5E94\u7528\u4E0A\u4E0B\u6587\u73AF\u5883</span>
			<span class="token class-name">ConfigurableEnvironment</span> environment <span class="token operator">=</span> <span class="token function">prepareEnvironment</span><span class="token punctuation">(</span>listeners<span class="token punctuation">,</span> applicationArguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// \u5904\u7406\u9700\u8981\u5FFD\u7565\u7684 Bean</span>
			<span class="token function">configureIgnoreBeanInfo</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// \u6253\u5370banner</span>
			<span class="token class-name">Banner</span> printedBanner <span class="token operator">=</span> <span class="token function">printBanner</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 3\u3001\u521D\u59CB\u5316\u5E94\u7528\u4E0A\u4E0B\u6587</span>
			context <span class="token operator">=</span> <span class="token function">createApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// \u5B9E\u4F8B\u5316 SpringBootExceptionReporter\u7C7B\uFF0C\u7528\u6765\u652F\u6301\u62A5\u544A\u5173\u4E8E\u542F\u52A8\u7684\u9519\u8BEF</span>
			exceptionReporters <span class="token operator">=</span> <span class="token function">getSpringFactoriesInstances</span><span class="token punctuation">(</span><span class="token class-name">SpringBootExceptionReporter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
					<span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 4\u3001\u5237\u65B0\u5E94\u7528\u4E0A\u4E0B\u6587\u524D\u7684\u51C6\u5907\u9636\u6BB5</span>
			<span class="token function">prepareContext</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> environment<span class="token punctuation">,</span> listeners<span class="token punctuation">,</span> applicationArguments<span class="token punctuation">,</span> printedBanner<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 5\u3001\u5237\u65B0\u5E94\u7528\u4E0A\u4E0B\u6587</span>
			<span class="token function">refreshContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// \u5237\u65B0\u5E94\u7528\u4E0A\u4E0B\u6587\u540E\u7684\u6269\u5C55\u63A5\u53E3</span>
			<span class="token function">afterRefresh</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> applicationArguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// \u65F6\u95F4\u8BB0\u5F55\u505C\u6B62</span>
			stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logStartupInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">new</span> <span class="token class-name">StartupInfoLogger</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mainApplicationClass<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logStarted</span><span class="token punctuation">(</span><span class="token function">getApplicationLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stopWatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// \u53D1\u5E03\u5BB9\u5668\u542F\u52A8\u5B8C\u6210\u4E8B\u4EF6</span>
			listeners<span class="token punctuation">.</span><span class="token function">started</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">callRunners</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> applicationArguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//...}</span>

		<span class="token keyword">try</span> <span class="token punctuation">{</span>listeners<span class="token punctuation">.</span><span class="token function">running</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//...}</span>
		<span class="token keyword">return</span> context<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>\u5728\u7B2C5\u6B65<code>refreshContext</code>\u65B9\u6CD5\u5185\u90E8\uFF0C\u6700\u7EC8\u4F1A\u8C03\u7528\u5230<code>AbstractApplicationContext#refresh()</code>\u65B9\u6CD5\uFF0C \u5176\u5185\u90E8\u7684<code>onRefresh()</code>\u65B9\u6CD5\u4F1A\u8C03\u7528\u5230<code>ServletWebServerApplicationContext#createWebServer</code>\u65B9\u6CD5</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createWebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">WebServer</span> webServer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>webServer<span class="token punctuation">;</span>
	<span class="token class-name">ServletContext</span> servletContext <span class="token operator">=</span> <span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>webServer <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> servletContext <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">ServletWebServerFactory</span> factory <span class="token operator">=</span> <span class="token function">getWebServerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>webServer <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">getWebServer</span><span class="token punctuation">(</span><span class="token function">getSelfInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>servletContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token function">getSelfInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onStartup</span><span class="token punctuation">(</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ServletException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationContextException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot initialize servlet context&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">initPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>Tomcat \u914D\u7F6E\u548C\u542F\u52A8\u540E\uFF0C\u6211\u4EEC\u518D\u6B21\u56DE\u5230<code>AbstractApplicationContext#refresh()</code>\u65B9\u6CD5\u5F53\u4E2D\uFF0C \u7EE7\u7EED\u770B\u4ED6\u7684\u6700\u540E\u4E00\u6B65<code>finishRefresh</code>\u65B9\u6CD5\uFF0C\u6765\u5230<code>ServletWebServerApplicationContext#finishRefresh</code>\u65B9\u6CD5\u5F53\u4E2D</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// \u542F\u52A8\u9700\u8981\u5728Tomcat\u542F\u52A8\u65F6\u5B8C\u6210\u542F\u52A8\u7684Servlet\uFF1B\u68C0\u67E5Connector\u662F\u5426\u90FD\u542F\u52A8\u5B8C\u6210\uFF1B\u6253\u5370\u6700\u7EC8\u542F\u52A8\u5B8C\u6210\u65E5\u5FD7</span>
	<span class="token class-name">WebServer</span> webServer <span class="token operator">=</span> <span class="token function">startWebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>webServer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServletWebServerInitializedEvent</span><span class="token punctuation">(</span>webServer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>\u6211\u4EEC\u7EE7\u7EED\u8FDB\u5165<code>startWebServer</code>\u65B9\u6CD5\uFF0C\u6700\u7EC8\u6765\u5230<code>TomcatWebServer#start</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">WebServerException</span> <span class="token punctuation">{</span>
	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>monitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>started<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token function">addPreviouslyRemovedConnectors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">Connector</span> connector <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span><span class="token function">getConnector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>connector <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>autoStart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// \u542F\u52A8\u9700\u8981\u5728Tomcat\u542F\u52A8\u65F6\u5B8C\u6210\u542F\u52A8\u7684Servlet</span>
				<span class="token function">performDeferredLoadOnStartup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// \u68C0\u67E5Connector\u662F\u5426\u90FD\u542F\u52A8\u5B8C\u6210</span>
			<span class="token function">checkThatConnectorsHaveStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>started <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token comment">// \u6253\u5370\u6700\u7EC8\u542F\u52A8\u5B8C\u6210\u65E5\u5FD7</span>
			logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Tomcat started on port(s): &quot;</span> <span class="token operator">+</span> <span class="token function">getPortsDescription</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; with context path &#39;&quot;</span>
					<span class="token operator">+</span> <span class="token function">getContextPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ConnectorStartFailedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">stopSilently</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">PortInUseException</span><span class="token punctuation">.</span><span class="token function">throwIfPortBindingException</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span><span class="token function">getConnector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WebServerException</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to start embedded Tomcat server&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">finally</span> <span class="token punctuation">{</span>
			<span class="token class-name">Context</span> context <span class="token operator">=</span> <span class="token function">findContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">ContextBindings</span><span class="token punctuation">.</span><span class="token function">unbindClassLoader</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getNamingToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>\u81F3\u6B64\uFF0C\u5B8C\u6210<code>ServletWebServerFactory#getWebServer</code>\u65B9\u6CD5\u8C03\u7528\uFF0C\u914D\u7F6E\u5E76\u542F\u52A8 Tomcat \u5BB9\u5668\u5B8C\u6210\u3002</p><h2 id="\u81EA\u52A8\u914D\u7F6Espringmvc" tabindex="-1"><a class="header-anchor" href="#\u81EA\u52A8\u914D\u7F6Espringmvc" aria-hidden="true">#</a> \u81EA\u52A8\u914D\u7F6ESpringMVC</h2><p>\u5728 SpringBoot \u9879\u76EE\u4E2D\u6211\u4EEC\u53EF\u4EE5\u76F4\u63A5\u4F7F\u7528\u8BF8\u5982<code>@RequestMapping</code>\u8FD9\u7C7B SpringMVC \u6CE8\u89E3\uFF0C\u53EF\u662F\u6211\u4EEC\u660E\u660E\u6CA1\u6709\u914D\u7F6E SpringMVC \u4E3A\u4EC0\u4E48\u5C31\u53EF\u4EE5\u76F4\u63A5\u4F7F\u7528\u5462\uFF1F</p><p>\u6211\u4EEC\u9996\u5148\u56DE\u987E\u4E00\u4E0B\uFF0C\u5728\u4E00\u4E2A\u666E\u901A\u7684 WEB \u9879\u76EE\u4E2D\u6211\u4EEC\u5E94\u8BE5\u5982\u4F55\u4F7F\u7528 SpringMVC\u3002\u6211\u4EEC\u9996\u5148\u9700\u8981\u5728 web.xml \u6587\u4EF6\u4E2D\u914D\u7F6E\u5982\u4E0B\u5185\u5BB9\uFF1A</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>spring mvc servlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">&gt;</span></span>springMvc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-class</span><span class="token punctuation">&gt;</span></span>org.springframework.web.servlet.DispatcherServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-class</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>load-on-startup</span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>load-on-startup</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-mapping</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">&gt;</span></span>springMvc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">&gt;</span></span>*.do<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-mapping</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>\u5728 SpringBoot \u9879\u76EE\u4E2D\uFF0C\u6211\u4EEC\u6CA1\u6709 web.xml \u6587\u4EF6\uFF0C\u90A3\u4E48\u6211\u4EEC\u5982\u4F55\u914D\u7F6E<code>DispatcherServlet</code>\u5462\uFF1F</p><p>Servlet3.0 \u89C4\u8303\u7684\u8BDE\u751F\uFF0C\u4E3A SpringBoot \u5F7B\u5E95\u53BB\u6389 web.xml \u5960\u5B9A\u4E86\u57FA\u7840\u3002</p><blockquote><p>\u5F53\u5B9E\u73B0\u4E86 Servlet3.0 \u89C4\u8303\u7684\u5BB9\u5668(\u5982Tomcat7\u53CA\u4EE5\u4E0A)\u542F\u52A8\u65F6\uFF0C\u4F1A\u901A\u8FC7SPI\u6269\u5C55\u673A\u5236\u81EA\u52A8\u626B\u63CF\u6240\u6709\u5DF2\u6DFB\u52A0\u7684jar\u5305\u4E0B\u7684 <code>/META-INF/services/javax.servlet.ServletContainerInitializer</code>\u4E2D\u6307\u5B9A\u7684\u7C7B\uFF0C\u5E76\u5B9E\u4F8B\u5316\u8BE5\u7C7B\uFF1B \u7136\u540E\u8C03\u7528\u5B9E\u4F8B\u5316\u5BF9\u8C61\u4E2D\u7684<code>onStartup</code>\u65B9\u6CD5\u3002</p></blockquote><p>\u5728 Servlet3.0 \u89C4\u8303\u4E2D\uFF0C\u5982\u679C\u8981\u6DFB\u52A0\u4E00\u4E2A servlet\uFF0C\u9664\u4E86\u53EF\u4EE5\u91C7\u7528 xml \u914D\u7F6E\u7684\u65B9\u5F0F\uFF0C\u8FD8\u53EF\u4EE5\u901A\u8FC7\u4EE3\u7801\u7684\u65B9\u5F0F\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>servletContext<span class="token punctuation">.</span><span class="token function">addServlet</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>servlet<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>\u501F\u6B64\uFF0C\u6211\u4EEC\u80FD\u591F\u52A8\u6001\u5730\u5F80 web \u5BB9\u5668\u4E2D\u6DFB\u52A0\u4E00\u4E2A\u6211\u4EEC\u6784\u9020\u597D\u7684<code>DispatcherServlet</code>\u5BF9\u8C61\uFF0C\u4ECE\u800C\u5B9E\u73B0\u81EA\u52A8\u88C5\u914D SpringMVC\u3002</p><h3 id="\u81EA\u52A8\u914D\u7F6Edispatcherservlet\u548Cdispatcherservletregistry" tabindex="-1"><a class="header-anchor" href="#\u81EA\u52A8\u914D\u7F6Edispatcherservlet\u548Cdispatcherservletregistry" aria-hidden="true">#</a> \u81EA\u52A8\u914D\u7F6EDispatcherServlet\u548CDispatcherServletRegistry</h3><p>SpringBoot \u7684\u81EA\u52A8\u914D\u7F6E\u57FA\u4E8ESPI\u673A\u5236\uFF0C\u5B9E\u73B0\u81EA\u52A8\u914D\u7F6E\u7684\u6838\u5FC3\u8981\u70B9\u5C31\u662F\u6DFB\u52A0\u4E00\u4E2A\u81EA\u52A8\u914D\u7F6E\u7684\u7C7B\uFF0CSpringBoot MVC \u7684\u81EA\u52A8\u914D\u7F6E\u4E5F\u662F\u76F8\u540C\u539F\u7406\u3002</p><p>\u6211\u4EEC\u9996\u5148\u627E\u5230 SpringMVC \u5BF9\u5E94\u7684\u81EA\u52A8\u914D\u7F6E\u7C7B<code>org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@AutoConfigureOrder</span><span class="token punctuation">(</span><span class="token class-name">Ordered</span><span class="token punctuation">.</span>HIGHEST_PRECEDENCE<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnWebApplication</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">Type</span><span class="token punctuation">.</span>SERVLET<span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">DispatcherServlet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@AutoConfigureAfter</span><span class="token punctuation">(</span><span class="token class-name">ServletWebServerFactoryAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DispatcherServletAutoConfiguration</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol><li><code>@Configuration</code>\u8868\u540D\u8FD9\u662F\u4E00\u4E2A\u914D\u7F6E\u7C7B\uFF0C\u5C06\u4F1A\u88ABspring\u89E3\u6790\u3002</li><li><code>@ConditionalOnWebApplication</code>\u610F\u5473\u7740\u5F53\u65F6\u4E00\u4E2Aweb\u9879\u76EE\uFF0C\u4E14\u662F<code>Servlet</code>\u9879\u76EE\u7684\u65F6\u5019\u624D\u4F1A\u88AB\u89E3\u6790\u3002</li><li><code>@ConditionalOnClass</code>\u6307\u660E<code>DispatcherServlet</code>\u8FD9\u4E2A\u6838\u5FC3\u7C7B\u5FC5\u987B\u5B58\u5728\u624D\u89E3\u6790\u8BE5\u7C7B\u3002</li><li><code>@AutoConfigureAfter</code>\u6307\u660E\u5728<code>ServletWebServerFactoryAutoConfiguration</code>\u8FD9\u4E2A\u7C7B\u4E4B\u540E\u518D\u89E3\u6790\uFF0C\u8BBE\u5B9A\u4E86\u4E00\u4E2A\u987A\u5E8F\u3002 (\u88AB\u6307\u7684\u8FD9\u4E2A\u7C7B\u5C31\u662F\u524D\u9762\u914D\u7F6ETomcat\u5BB9\u5668\u7684\u81EA\u52A8\u914D\u7F6E\u7C7B)</li></ol><p>\u8FD9\u4E9B\u6CE8\u89E3\u8868\u660E\u4E86\u89E3\u6790\u8BE5\u81EA\u52A8\u914D\u7F6E\u7C7B\u6240\u9700\u7684\u524D\u7F6E\u6761\u4EF6\u3002</p><p>\u6B64\u5916\uFF0C<code>DispatcherServletAutoConfiguration</code>\u7C7B\u5305\u542B\u4E86\u4E24\u4E2A\u5185\u90E8\u7C7B\uFF0C\u5206\u522B\u662F</p><ol><li>DispatcherServletConfiguration</li><li>DispatcherServletRegistrationConfiguration</li></ol><p>\u524D\u8005\u662F\u7528\u4E8E\u914D\u7F6E<code>DispatcherServlet</code>\uFF0C\u540E\u8005\u662F\u7528\u4E8E\u914D\u7F6E<code>DispatcherServlet</code>\u7684\u6CE8\u518C\u7C7B\u3002</p><blockquote><p>\u4EC0\u4E48\u662F\u6CE8\u518C\u7C7B?</p><p>\u6211\u4EEC\u77E5\u9053<code>Servlet</code>\u5B9E\u4F8B\u9700\u8981\u88AB\u6DFB\u52A0(\u6CE8\u518C)\u5230\u5982 Tomcat \u8FD9\u6837\u7684<code>ServletContext</code>\u4E2D\u624D\u80FD\u591F\u63D0\u4F9B\u8BF7\u6C42\u670D\u52A1\u3002 <code>DispatcherServletRegistrationConfiguration</code>\u5C06\u751F\u6210\u4E00\u4E2ABean(<code>DispatcherServletRegistrationBean</code>)\uFF0C \u8D1F\u8D23\u5C06<code>DispatcherServlet</code>\u6CE8\u518C\u5230<code>ServletContext</code>\u4E2D\u3002</p></blockquote><p><strong>DispatcherServletConfiguration</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Conditional</span><span class="token punctuation">(</span><span class="token class-name">DefaultDispatcherServletCondition</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">ServletRegistration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">HttpProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">WebMvcProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DispatcherServletConfiguration</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li><p><code>@Conditional</code>\u6307\u660E\u4E86\u4E00\u4E2A\u524D\u7F6E\u6761\u4EF6\u5224\u65AD\uFF0C\u7531DefaultDispatcherServletCondition\u5B9E\u73B0\u3002\u4E3B\u8981\u662F\u5224\u65AD\u4E86\u662F\u5426\u5DF2\u7ECF\u5B58\u5728<code>DispatcherServlet</code>\u7C7B\uFF0C\u5982\u679C\u6CA1\u6709\u624D\u4F1A\u89E6\u53D1\u89E3\u6790\u3002</p></li><li><p><code>@ConditionalOnClass</code>\u6307\u660E\u4E86\u5F53<code>ServletRegistration</code>\u7C7B\u5B58\u5728\u7684\u65F6\u5019\u624D\u4F1A\u89E6\u53D1\u89E3\u6790\uFF0C\u751F\u6210\u7684<code>DispatcherServlet</code>\u624D\u80FD\u6CE8\u518C\u5230ServletContext\u4E2D\u3002</p></li><li><p><code>@EnableConfigurationProperties</code>\u5C06\u4F1A\u4ECE<code>application.properties</code>\u8FD9\u6837\u7684\u914D\u7F6E\u6587\u4EF6\u4E2D\u8BFB\u53D6<code>spring.http</code>\u548C<code>spring.mvc</code>\u524D\u7F00\u7684\u5C5E\u6027\u751F\u6210\u914D\u7F6E\u5BF9\u8C61HttpProperties\u548CWebMvcProperties\u3002</p></li></ul><p>\u518D\u770B<code>DispatcherServletConfiguration</code>\u7684\u5185\u90E8\u4EE3\u7801</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> DEFAULT_DISPATCHER_SERVLET_BEAN_NAME<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">DispatcherServlet</span> <span class="token function">dispatcherServlet</span><span class="token punctuation">(</span><span class="token class-name">HttpProperties</span> httpProperties<span class="token punctuation">,</span> <span class="token class-name">WebMvcProperties</span> webMvcProperties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">DispatcherServlet</span> dispatcherServlet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DispatcherServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	dispatcherServlet<span class="token punctuation">.</span><span class="token function">setDispatchOptionsRequest</span><span class="token punctuation">(</span>webMvcProperties<span class="token punctuation">.</span><span class="token function">isDispatchOptionsRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	dispatcherServlet<span class="token punctuation">.</span><span class="token function">setDispatchTraceRequest</span><span class="token punctuation">(</span>webMvcProperties<span class="token punctuation">.</span><span class="token function">isDispatchTraceRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	dispatcherServlet<span class="token punctuation">.</span><span class="token function">setThrowExceptionIfNoHandlerFound</span><span class="token punctuation">(</span>webMvcProperties<span class="token punctuation">.</span><span class="token function">isThrowExceptionIfNoHandlerFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	dispatcherServlet<span class="token punctuation">.</span><span class="token function">setPublishEvents</span><span class="token punctuation">(</span>webMvcProperties<span class="token punctuation">.</span><span class="token function">isPublishRequestHandledEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	dispatcherServlet<span class="token punctuation">.</span><span class="token function">setEnableLoggingRequestDetails</span><span class="token punctuation">(</span>httpProperties<span class="token punctuation">.</span><span class="token function">isLogRequestDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> dispatcherServlet<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnBean</span><span class="token punctuation">(</span><span class="token class-name">MultipartResolver</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token class-name">DispatcherServlet</span><span class="token punctuation">.</span>MULTIPART_RESOLVER_BEAN_NAME<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">MultipartResolver</span> <span class="token function">multipartResolver</span><span class="token punctuation">(</span><span class="token class-name">MultipartResolver</span> resolver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Detect if the user has created a MultipartResolver but named it incorrectly</span>
	<span class="token keyword">return</span> resolver<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><ul><li><p><code>dispatcherServlet</code>\u65B9\u6CD5\u5C06\u751F\u6210\u4E00\u4E2A<code>DispatcherServlet</code>\u7684Bean\u5BF9\u8C61\uFF0C\u5E76\u653E\u5230 IoC \u5BB9\u5668\u4E2D\u3002(\u6BD4\u8F83\u7B80\u5355\uFF0C\u5C31\u662F\u83B7\u53D6\u4E00\u4E2A\u5B9E\u4F8B\uFF0C\u7136\u540E\u6DFB\u52A0\u4E00\u4E9B\u5C5E\u6027\u8BBE\u7F6E\u3002)</p></li><li><p><code>multipartResolver</code>\u65B9\u6CD5\u4E3B\u8981\u662F\u628A\u4F60\u914D\u7F6E\u7684<code>MultipartResolver</code>\u7684Bean\u91CD\u547D\u540D\u4E00\u4E0B\uFF0C\u9632\u6B62\u4F60\u4E0D\u662F\u7528multipartResolver\u8FD9\u4E2A\u540D\u5B57\u4F5C\u4E3ABean\u7684\u540D\u5B57\u3002</p></li></ul><p><strong>DispatcherServletRegistrationConfiguration</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Conditional</span><span class="token punctuation">(</span><span class="token class-name">DispatcherServletRegistrationCondition</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">ServletRegistration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">WebMvcProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">DispatcherServletConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DispatcherServletRegistrationConfiguration</span><span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> DEFAULT_DISPATCHER_SERVLET_REGISTRATION_BEAN_NAME<span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConditionalOnBean</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">DispatcherServlet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> name <span class="token operator">=</span> DEFAULT_DISPATCHER_SERVLET_BEAN_NAME<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DispatcherServletRegistrationBean</span> <span class="token function">dispatcherServletRegistration</span><span class="token punctuation">(</span><span class="token class-name">DispatcherServlet</span> dispatcherServlet<span class="token punctuation">,</span>
                                                                           <span class="token class-name">WebMvcProperties</span> webMvcProperties<span class="token punctuation">,</span> <span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MultipartConfigElement</span><span class="token punctuation">&gt;</span></span> multipartConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DispatcherServletRegistrationBean</span> registration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DispatcherServletRegistrationBean</span><span class="token punctuation">(</span>dispatcherServlet<span class="token punctuation">,</span>
                webMvcProperties<span class="token punctuation">.</span><span class="token function">getServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        registration<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>DEFAULT_DISPATCHER_SERVLET_BEAN_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        registration<span class="token punctuation">.</span><span class="token function">setLoadOnStartup</span><span class="token punctuation">(</span>webMvcProperties<span class="token punctuation">.</span><span class="token function">getServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLoadOnStartup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        multipartConfig<span class="token punctuation">.</span><span class="token function">ifAvailable</span><span class="token punctuation">(</span>registration<span class="token operator">::</span><span class="token function">setMultipartConfig</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> registration<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>\u9996\u5148\u6211\u4EEC\u6765\u770B\u7C7B\u7684\u58F0\u660E\uFF1A</p><ul><li><p><code>@Conditional</code>\u6307\u660E\u4E86\u4E00\u4E2A\u524D\u7F6E\u5224\u65AD\uFF0C\u7531DispatcherServletRegistrationCondition\u5B9E\u73B0\u3002\u4E3B\u8981\u5224\u65AD\u4E86\u6CE8\u518C\u7C7B<code>dispatcherServletRegistration</code>\u7684Bean\u662F\u5426\u5B58\u5728\u3002</p></li><li><p><code>@ConditionOnClass</code>\u5224\u65AD\u4E86<code>ServletRegistration</code>\u662F\u5426\u5B58\u5728</p></li><li><p><code>@EnableConfigurationProperties</code>\u751F\u6210\u4E86WebMvcProperties\u7684\u5C5E\u6027\u5BF9\u8C61</p></li><li><p><code>@Import</code>\u5BFC\u5165\u4E86<code>DispatcherServletConfiguration</code>\uFF0C\u4E5F\u5C31\u662F\u6211\u4EEC\u4E0A\u9762\u7684\u914D\u7F6E\u5BF9\u8C61\u3002</p></li></ul><p>\u6211\u4EEC\u518D\u770B\u7C7B\u7684\u5185\u90E8\u5185\u5BB9\uFF1A</p><p>\u5185\u90E8\u53EA\u6709\u4E00\u4E2A\u65B9\u6CD5\uFF0C\u751F\u6210\u4E86<code>DispatcherServletRegistrationBean</code>\u3002 \u6838\u5FC3\u903B\u8F91\u5C31\u662F\u5B9E\u4F8B\u5316\u4E86\u4E00\u4E2ABean\uFF0C\u8BBE\u7F6E\u4E86\u4E00\u4E9B\u53C2\u6570\uFF0C\u5982dispatcherServlet\u3001loadOnStartup\u7B49\u3002</p><blockquote><p>\u9700\u8981\u6CE8\u610F\u4E00\u70B9\uFF1A\u5728\u5185\u90E8\u65B9\u6CD5\u4E0A\u58F0\u660E\u4E86\u4E00\u4E2A<code>@ConditionalOnBean</code>\uFF0C\u8868\u793A\u9700\u8981\u8FD9\u4E2A\u65B9\u6CD5\u7684\u6267\u884C\u4F9D\u8D56\u4E8E\u8FD9\u4E2ABean\uFF1B \u4E00\u822C\u6765\u8BF4\u4E5F\u5C31\u662F\u8BF4\u660E\u8FD9\u4E2A\u65B9\u6CD5\u5C31\u662F\u4E3A\u4E0A\u9762\u58F0\u660E\u7684\u8FD9\u4E2ABean\u670D\u52A1\u7684\u3002</p></blockquote><p><strong>\u603B\u7ED3</strong></p><p>SpringBoot MVC \u7684\u81EA\u52A8\u914D\u7F6E\u7C7B\u662F<code>DispatcherServletAutoConfiguration</code>\uFF0C\u4E3B\u8981\u505A\u4E86\u4E24\u4EF6\u4E8B:</p><ol><li>\u914D\u7F6EDispatcherServlet</li><li>\u914D\u7F6EDispatcherServlet\u7684\u6CE8\u518CBean(DispatcherServletRegistrationBean)</li></ol><h3 id="\u6CE8\u518C-dispatcherservlet-\u5230-servletcontext" tabindex="-1"><a class="header-anchor" href="#\u6CE8\u518C-dispatcherservlet-\u5230-servletcontext" aria-hidden="true">#</a> \u6CE8\u518C DispatcherServlet \u5230 ServletContext</h3><p>\u5DF2\u77E5<code>DispatcherServlet</code>\u548C<code>DispatcherServletRegistrationBean</code>\u8FD9\u4E24\u4E2ABean\u7684\u81EA\u52A8\u914D\u7F6E\u3002</p><p><code>DispatcherServlet</code>\u6211\u4EEC\u5F88\u719F\u6089\uFF0C\u800C<code>DispatcherServletRegistrationBean</code>\u4E3B\u8981\u8D1F\u8D23\u5C06<code>DispatcherServlet</code>\u6CE8\u518C\u5230<code>ServletContext</code>\u5F53\u4E2D\u3002</p><p><strong>\u6CE8\u518C DispatcherServlet \u6D41\u7A0B</strong></p><p>\u65E2\u7136\u8BE5\u7C7B\u7684\u804C\u8D23\u662F\u8D1F\u8D23\u6CE8\u518CDispatcherServlet\uFF0C\u90A3\u4E48\u6211\u4EEC\u9700\u8981\u77E5\u9053\u4EC0\u4E48\u65F6\u5019\u89E6\u53D1\u6CE8\u518C\u64CD\u4F5C\u3002 \u4E3A\u6B64\uFF0C\u6211\u4EEC\u5148\u770B\u770B<code>DispatcherServletRegistrationBean</code>\u8FD9\u4E2A\u7C7B\u7684\u7C7B\u56FE</p><p><img src="`+a+`" alt="DispatcherServletRegistrationBean.png"></p><p>\u6211\u4EEC\u4ECE\u4ED6\u7684\u9876\u7EA7\u63A5\u53E3<code>ServletContextInitializer</code>\u5F00\u59CB</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@FunctionalInterface</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ServletContextInitializer</span> <span class="token punctuation">{</span>
	<span class="token keyword">void</span> <span class="token function">onStartup</span><span class="token punctuation">(</span><span class="token class-name">ServletContext</span> servletContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>\u7EE7\u7EED\u8FDB\u5165\u5176\u5B9E\u73B0\u2014\u2014<code>RegistrationBean#onStartup</code>\u4E2D</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">onStartup</span><span class="token punctuation">(</span><span class="token class-name">ServletContext</span> servletContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u5224\u65AD\u5F53\u524D\u5230\u5E95\u662F\u4E00\u4E2A filter\uFF0C\u8FD8\u662F servlet\uFF0C\u8FD8\u662Flistener</span>
	<span class="token class-name">String</span> description <span class="token operator">=</span> <span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">capitalize</span><span class="token punctuation">(</span>description<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; was not registered (disabled)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">register</span><span class="token punctuation">(</span>description<span class="token punctuation">,</span> servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>\u6211\u4EEC\u7EE7\u7EED\u8DDF\u8FDB<code>register</code>\u65B9\u6CD5\uFF0C\u6700\u7EC8\u6765\u5230<code>DynamicRegistrationBean#register</code>\u4E2D</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">String</span> description<span class="token punctuation">,</span> <span class="token class-name">ServletContext</span> servletContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">D</span> registration <span class="token operator">=</span> <span class="token function">addRegistration</span><span class="token punctuation">(</span>description<span class="token punctuation">,</span> servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>registration <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">capitalize</span><span class="token punctuation">(</span>description<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; was not registered (possibly already registered?)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">configure</span><span class="token punctuation">(</span>registration<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>\u7EE7\u7EED\u8FDB\u5165<code>addRegistration</code>\u65B9\u6CD5\u6700\u7EC8\u6765\u5230<code>ServletRegistrationBean#addRegistration</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">ServletRegistration<span class="token punctuation">.</span>Dynamic</span> <span class="token function">addRegistration</span><span class="token punctuation">(</span><span class="token class-name">String</span> description<span class="token punctuation">,</span> <span class="token class-name">ServletContext</span> servletContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token function">getServletName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> servletContext<span class="token punctuation">.</span><span class="token function">addServlet</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>servlet<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>\u5176\u5185\u90E8\u4EE3\u7801\u5341\u5206\u7B80\u5355\uFF1A\u76F4\u63A5\u5C06<code>DispatcherServlet</code>\u7ED9add\u5230\u4E86<code>servletContext</code>\u5F53\u4E2D\u3002</p><p>\u81F3\u6B64\uFF0C\u5B8C\u6210 DispatcherServlet \u7684\u6CE8\u518C\u5DE5\u4F5C\u3002</p><p><strong>SpringBoot \u542F\u52A8\u6D41\u7A0B\u4E2D\u5177\u4F53\u4F53\u73B0</strong></p><p>\u6211\u4EEC\u73B0\u5728\u5DF2\u77E5\u5728<code>ServletContextInitializer#onStartup</code>\u65B9\u6CD5\u4E2D\uFF0C\u6700\u7EC8\u4F1A\u5C06 dispatcherServlet \u6CE8\u518C\u5230 servletContext \u5F53\u4E2D\uFF0C \u90A3\u4E48\u8FD9\u4E2A\u65B9\u6CD5\u5728 SpringBoot \u542F\u52A8\u8FC7\u7A0B\u7684\u4EC0\u4E48\u65F6\u95F4\u8282\u70B9\u8C03\u7528\u7684\u5462\uFF1F</p><p>\u6211\u4EEC\u518D\u6B21\u56DE\u5230\u83B7\u53D6 Tomcat \u7684\u5730\u65B9<code>ServletWebServerApplicationContext#createWebServer</code>\u65B9\u6CD5\u5F53\u4E2D</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ServletWebServerFactory</span> factory <span class="token operator">=</span> <span class="token function">getWebServerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>webServer <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">getWebServer</span><span class="token punctuation">(</span><span class="token function">getSelfInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>\u6211\u4EEC\u53EA\u5173\u6CE8\u6700\u6838\u5FC3\u7684\u8FD9\u4E24\u884C\uFF0C\u8FDB\u5165<code>getSelfInitializer</code>\u65B9\u6CD5\u5F53\u4E2D</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">selfInitialize</span><span class="token punctuation">(</span><span class="token class-name">ServletContext</span> servletContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
	<span class="token function">prepareWebApplicationContext</span><span class="token punctuation">(</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">registerApplicationScope</span><span class="token punctuation">(</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">WebApplicationContextUtils</span><span class="token punctuation">.</span><span class="token function">registerEnvironmentBeans</span><span class="token punctuation">(</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ServletContextInitializer</span> beans <span class="token operator">:</span> <span class="token function">getServletContextInitializerBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		beans<span class="token punctuation">.</span><span class="token function">onStartup</span><span class="token punctuation">(</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>\u5728<code>beans.onStartup(servletContext);</code>\u7684\u8FD9\u4E00\u884C\u4EE3\u7801\u4E2D\uFF0C\u6700\u7EC8\u8C03\u7528\u4E86<code>ServletContextInitializer#onStartup</code>\u65B9\u6CD5\u3002</p><p><strong>\u603B\u7ED3</strong></p><p>SpringBoot \u81EA\u52A8\u88C5\u914D SpringMVC \u5176\u5B9E\u5C31\u662F\u5F80ServletContext\u4E2D\u52A0\u5165\u4E86\u4E00\u4E2A DispatcherServlet\u3002 Servlet3.0 \u89C4\u8303\u4E2D\u6709\u8FD9\u4E2A\u8BF4\u660E\uFF0C\u9664\u4E86\u53EF\u4EE5\u52A8\u6001\u52A0\u5165<code>Servlet</code>\u8FD8\u53EF\u4EE5\u52A8\u6001\u52A0<code>Listener</code>\u548C<code>Filter</code></p><ul><li><code>public ServletRegistration.Dynamic addServlet(String servletName, Servlet servlet);</code></li><li><code>public FilterRegistration.Dynamic addFilter(String filterName, Class &lt;? extends Filter&gt; filterClass);</code></li><li><code>public void addListener(Class &lt;? extends EventListener&gt; listenerClass);</code></li></ul><h2 id="springboot\u6570\u636E\u8BBF\u95EE" tabindex="-1"><a class="header-anchor" href="#springboot\u6570\u636E\u8BBF\u95EE" aria-hidden="true">#</a> SpringBoot\u6570\u636E\u8BBF\u95EE</h2><h3 id="\u7B80\u5355\u4F7F\u7528" tabindex="-1"><a class="header-anchor" href="#\u7B80\u5355\u4F7F\u7528" aria-hidden="true">#</a> \u7B80\u5355\u4F7F\u7528</h3><p>\u6DFB\u52A0\u6570\u636E\u5E93\u9A71\u52A8\u4F9D\u8D56</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>\u914D\u7F6E\u6570\u636E\u5E93\u8FDE\u63A5</p><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">spring.datasource.driver-class-name</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.cj.jdbc.Driver</span>
<span class="token key attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql:///springboot?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true&amp;serverTimezone=UTC</span>
<span class="token key attr-name">spring.datasource.username</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token key attr-name">spring.datasource.password</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>\u6DFB\u52A0spring-boot-starter-jdbc\u4F9D\u8D56</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>\u6DFB\u52A0\u6D4B\u8BD5\u65B9\u6CD5</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">SpringbootTestDataApplicationTests</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> dataSource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>\u5207\u6362\u6570\u636E\u5E93\u8FDE\u63A5\u6C60</strong></p><p>SpringBoot\u63D0\u4F9B\u4E86\u4E09\u79CD\u6570\u636E\u5E93\u8FDE\u63A5\u6C60: HikariCP\u3001CommonsDBCP2\u3001Tomcat JDBC Connection Pool</p><p>\u5176\u4E2Dspring boot2.x\u7248\u672C\u9ED8\u8BA4\u4F7F\u7528HikariCP\uFF0Cmaven\u4E2D\u914D\u7F6E\u5982\u4E0B:</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>\u5982\u679C\u4E0D\u4F7F\u7528HikariCP\uFF0C\u800C\u6539\u7528Commons DBCP2\uFF0C\u5219\u914D\u7F6E\u5982\u4E0B:</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-dbcp2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.zaxxer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>HikariCP<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><blockquote><p>\u8FD8\u662F\u540C\u6837\u7684\u5957\u8DEF\uFF0C\u6392\u9664\u9ED8\u8BA4\u6DFB\u52A0\u7684\u4F9D\u8D56\uFF0C\u7136\u540E\u6DFB\u52A0\u65B0\u7684\u4F9D\u8D56\u3002</p></blockquote><p>\u540C\u6837\u65B9\u6CD5\u4E5F\u53EF\u5207\u6362\u81F3 Tomcat JDBC Connection Pool</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.tomcat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>tomcat-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.zaxxer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>HikariCP<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="\u6570\u636E\u6E90\u81EA\u52A8\u914D\u7F6E" tabindex="-1"><a class="header-anchor" href="#\u6570\u636E\u6E90\u81EA\u52A8\u914D\u7F6E" aria-hidden="true">#</a> \u6570\u636E\u6E90\u81EA\u52A8\u914D\u7F6E</h3><blockquote><p>\u95EE\u9898: \u4E3A\u4EC0\u4E48\u8BF4 SpringBoot \u9ED8\u8BA4\u4F7F\u7528\u7684\u8FDE\u63A5\u6C60\u7C7B\u578B\u662FHikariCP\uFF0C\u5728\u54EA\u91CC\u6307\u5B9A\u7684?</p></blockquote><p>\u6211\u4EEC\u8FD8\u662F\u9996\u5148\u4ECE<code>spring.factories</code>\u4E2D\u627E\u5230\u6570\u636E\u6E90\u7684\u914D\u7F6E\u7C7B<code>org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration</code></p><p>\u8BE5\u7C7B\u5185\u90E8\u9996\u5148\u6709\u4E24\u4E2A\u5185\u90E8\u7C7B\uFF1A<code>EmbeddedDatabaseConfiguration</code>\u548C<code>PooledDataSourceConfiguration</code>\u3002\u6211\u4EEC\u4E3B\u8981\u5173\u6CE8<code>PooledDataSourceConfiguration</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Conditional</span><span class="token punctuation">(</span><span class="token class-name">PooledDataSourceCondition</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">DataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">XADataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">DataSourceConfiguration<span class="token punctuation">.</span>Hikari</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">DataSourceConfiguration<span class="token punctuation">.</span>Tomcat</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
		<span class="token class-name">DataSourceConfiguration<span class="token punctuation">.</span>Dbcp2</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">DataSourceConfiguration<span class="token punctuation">.</span>Generic</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
		<span class="token class-name">DataSourceJmxConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">PooledDataSourceConfiguration</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ol><li><code>@Conditional(PooledDataSourceCondition.class)</code>\u6307\u660E\u4E86\u52A0\u8F7D\u7684\u6761\u4EF6\uFF0C\u8FDB\u5165\u8FD9\u4E2A\u6761\u4EF6\u7C7B\u4F1A\u53D1\u73B0\uFF0C\u5C31\u662F\u770B\u662F\u5426\u6709\u6307\u5B9A\u5C5E\u6027<code>spring.datasource.type=</code>\uFF0C\u6307\u5B9A\u6570\u636E\u5E93\u8FDE\u63A5\u6C60\u7684\u7C7B\u578B\u3002 \uFF08\u5982\u679C\u6CA1\u6709\u6307\u5B9A\uFF0C\u4F1A\u6709\u9ED8\u8BA4\u503C\u3002\uFF09</li><li><code>@Import</code>\u6CE8\u89E3\u6307\u660E\u4E86\u4F1A\u5BFC\u5165\u7684\u7C7B\u3002\u800C\u5B83\u4EEC\u90FD\u662F<code>DataSourceConfiguration</code>\u7684\u5B50\u7C7B\u3002 \u8FDB\u5165\u8BE5\u7C7B\u5F53\u4E2D\uFF0C\u4ED6\u6709\u56DB\u4E2A\u5B50\u7C7B\u3002\u524D\u9762\u4E09\u4E2A\u90FD\u5F88\u719F\u6089\uFF0C\u5C31\u662F SpringBoot \u9ED8\u8BA4\u652F\u6301\u7684\u4E09\u79CD\u6570\u636E\u5E93\u8FDE\u63A5\u6C60\u3002 \u800C\u6700\u540E\u4E00\u4E2A\u5B50\u7C7B<code>Generic</code>\u5219\u8868\u793A\u81EA\u5B9A\u4E49\u7684\u8FDE\u63A5\u6C60\u7C7B\u578B\uFF0C\u5982 Druid \u8FDE\u63A5\u6C60\u3002</li></ol><p>\u4ED6\u7684\u4E09\u4E2A\u5B50\u7C7B\u90FD\u662F\u5F88\u76F8\u4F3C\u7684\uFF0C\u6211\u4EEC\u4EE5<code>Hikari</code>\u4E3A\u4F8B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">HikariDataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;spring.datasource.type&quot;</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">&quot;com.zaxxer.hikari.HikariDataSource&quot;</span><span class="token punctuation">,</span>
		matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Hikari</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.datasource.hikari&quot;</span><span class="token punctuation">)</span>
	<span class="token class-name">HikariDataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token class-name">DataSourceProperties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">HikariDataSource</span> dataSource <span class="token operator">=</span> <span class="token function">createDataSource</span><span class="token punctuation">(</span>properties<span class="token punctuation">,</span> <span class="token class-name">HikariDataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			dataSource<span class="token punctuation">.</span><span class="token function">setPoolName</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> dataSource<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><ol><li><p>\u524D\u9762\u4E09\u884C\u90FD\u662F\u6307\u660E\u8FD9\u662F\u914D\u7F6E\u7C7B\u548C\u6307\u660E\u4E86\u52A0\u8F7D\u7684\u6761\u4EF6\uFF0C\u6CE8\u610F\u770B\u7B2C\u56DB\u884C\uFF0C\u548C\u521A\u521A\u4E00\u6837\uFF0C\u4E5F\u662F\u770B\u662F\u5426\u6709\u6307\u5B9A<code>spring.datasource.type</code>\u5C5E\u6027\u3002 \u800C\u5173\u952E\u5C31\u5728\u4E8E\u6700\u540E\u4E00\u53E5\uFF0C<code>matchIfMissing = true</code>\u8868\u660E\u5982\u679C\u6CA1\u6709\u6307\u5B9A\u8BE5\u5C5E\u6027\u7684\u8BDD\uFF0C\u9ED8\u8BA4\u662F\u751F\u6548\u3002\u8FD9\u4E5F\u662F\u4E3A\u4EC0\u4E48\u524D\u9762\u8BF4\u6CA1\u6709\u6307\u5B9A\u7684\u8BDD\uFF0C\u4F1A\u6709\u9ED8\u8BA4\u503C\u3002</p></li><li><p>\u8BE5\u7C7B\u7684\u5185\u90E8\u53EA\u6709\u4E00\u4E2A\u65B9\u6CD5\uFF0C\u8FD4\u56DE\u4E86\u4E00\u4E2A Bean : <code>HikariDataSource</code>\u3002 \u4ED6\u4E0A\u9762\u7684<code>@ConfigurationProperties(prefix = &quot;spring.datasource.hikari&quot;)</code>\u8868\u660E\u53EF\u4EE5\u4F7F\u7528\u6B64\u524D\u7F00\u4E3A\u8FD9\u4E2ABean\u6DFB\u52A0\u5C5E\u6027\u3002</p></li><li><p>\u518D\u6765\u770B\u8FD9\u4E2A\u65B9\u6CD5\u7684\u5185\u90E8\uFF0C\u5173\u952E\u5C31\u662F<code>createDataSource(properties, HikariDataSource.class);</code>\u65B9\u6CD5\uFF0C\u6211\u4EEC\u8FDB\u5165\u5176\u4E2D\uFF1A</p></li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">createDataSource</span><span class="token punctuation">(</span><span class="token class-name">DataSourceProperties</span> properties<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">DataSource</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// \u4F7F\u7528 DataSource \u5EFA\u9020\u6570\u636E\u6E90\uFF1B\u5229\u7528\u53CD\u5C04\u521B\u5EFAtype\u6570\u636E\u6E90\uFF1B\u7ED1\u5B9A\u76F8\u5173\u5C5E\u6027</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> properties<span class="token punctuation">.</span><span class="token function">initializeDataSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>\u6211\u4EEC\u9010\u4E00\u6765\u770B\u8FD9\u4E09\u4E2A\u65B9\u6CD5</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">DataSourceBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">initializeDataSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token class-name">DataSourceBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">driverClassName</span><span class="token punctuation">(</span><span class="token function">determineDriverClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token function">determineUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token function">determineUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token function">determinePassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span> <span class="token keyword">extends</span> <span class="token class-name">DataSource</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">DataSourceBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> <span class="token function">type</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">DataSourceBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// \u6839\u636E\u7C7B\u578B\u521B\u5EFA Datasource \u5E76\u8FD4\u56DE</span>
<span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">DataSource</span><span class="token punctuation">&gt;</span></span> type <span class="token operator">=</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">DataSource</span> result <span class="token operator">=</span> <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">instantiateClass</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">maybeGetDriverClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">bind</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// \u83B7\u53D6\u6570\u636E\u5E93\u8FDE\u63A5\u6C60\u7684\u7C7B\u578B</span>
<span class="token keyword">private</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">DataSource</span><span class="token punctuation">&gt;</span></span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">DataSource</span><span class="token punctuation">&gt;</span></span> type <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">:</span> <span class="token function">findType</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> type<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;No supported DataSource type found&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// \u5982\u679C\u5F53\u524D type \u672A\u8BBE\u7F6E\u7684\u8BDD\uFF0C\u9ED8\u8BA4\u4ECE\u4E0B\u9762\u6570\u7EC4\u4E2D\u6328\u4E2A\u5C1D\u8BD5\u521B\u5EFA\uFF0C\u76F4\u5230\u6210\u529F\u4E3A\u6B62\u3002</span>
<span class="token comment">// \u524D\u9762\u8BF4\u5982\u679C\u6CA1\u6709\u914D\u7F6E type \u5C5E\u6027\uFF0C\u4F1A\u6709\u9ED8\u8BA4\u503C\u3002\u5176\u5B9E\u4E0D\u51C6\u786E\uFF0C\u5E94\u8BE5\u8BF4\u6CA1\u6709\u914D\u7F6E\u8FDB\u5165\u9ED8\u8BA4\u7684\u521B\u5EFA\u6570\u636E\u5E93\u8FDE\u63A5\u6C60\u7684\u65B9\u6CD5\uFF0C</span>
<span class="token comment">// \u5177\u4F53\u521B\u5EFA\u4EC0\u4E48\u7C7B\u578B\u7684\u6570\u636E\u5E93\u8FDE\u63A5\u6C60\u8FD8\u662F\u770B\u8FD9\u4E2A\u9ED8\u8BA4\u7684 DATA_SOURCE_TYPE_NAMES \u6570\u7EC4</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">DataSource</span><span class="token punctuation">&gt;</span></span> <span class="token function">findType</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> name <span class="token operator">:</span> DATA_SOURCE_TYPE_NAMES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">DataSource</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// Swallow and continue</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// \u9ED8\u8BA4\u7684\u6570\u636E\u5E93\u8FDE\u63A5\u6C60\u7C7B\u578B\u96C6\u5408</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> DATA_SOURCE_TYPE_NAMES <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">&quot;com.zaxxer.hikari.HikariDataSource&quot;</span><span class="token punctuation">,</span>
		<span class="token string">&quot;org.apache.tomcat.jdbc.pool.DataSource&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.commons.dbcp2.BasicDataSource&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>\u4E09\u4E2A\u65B9\u6CD5\u4F7F\u7528 DataSource \u5EFA\u9020\u6570\u636E\u6E90\uFF0C\u7136\u540E\u5229\u7528\u53CD\u5C04\u521B\u5EFAtype\u6570\u636E\u6E90\uFF0C\u7ED1\u5B9A\u76F8\u5173\u5C5E\u6027\uFF0C\u6700\u7EC8\u8FD4\u56DE\u5B9E\u4F8B\u5316\u7684 DataSource \u5E76\u5B58\u5165 Spring \u5BB9\u5668\u4E2D\u3002</p><blockquote><p>2.0 \u4E4B\u540E\u4E0D\u518D\u9ED8\u8BA4\u4F7F\u7528Tomcat\u8FDE\u63A5\u6C60\uFF0C\u9ED8\u8BA4\u5F00\u59CB\u4F7F\u7528 Hikari \u8FDE\u63A5\u6C60</p></blockquote><h3 id="\u4F7F\u7528-druid-\u8FDE\u63A5\u6C60" tabindex="-1"><a class="header-anchor" href="#\u4F7F\u7528-druid-\u8FDE\u63A5\u6C60" aria-hidden="true">#</a> \u4F7F\u7528 Druid \u8FDE\u63A5\u6C60</h3><p>\u6DFB\u52A0\u4F9D\u8D56</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>druid-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><p>SpringBoot \u5B98\u65B9\u6CA1\u6709\u5BF9\u6B64\u6570\u636E\u5E93\u8FDE\u63A5\u6C60\u505A\u6574\u5408\uFF0C\u56E0\u6B64\u9700\u8981\u624B\u52A8\u6307\u5B9A\u7248\u672C\u53F7</p></blockquote><p>\u914D\u7F6E\u6587\u4EF6\u4E2D\u5F15\u5165\u76F8\u5173\u4F9D\u8D56</p><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment"># \u6307\u5B9A\u6570\u636E\u5E93\u8FDE\u63A5\u6C60\u7C7B\u578B</span>
<span class="token key attr-name">spring.datasource.type</span><span class="token punctuation">=</span><span class="token value attr-value">com.alibaba.druid.pool.DruidDataSource</span>

<span class="token key attr-name">spring.datasource.druid.initial-size</span><span class="token punctuation">=</span><span class="token value attr-value">5</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>\u756A\u5916</strong></p><p>\u5982\u679C\u5E0C\u671B\u4F7F\u7528<code>spring.datasource.xx</code>\u8FD9\u7C7B Spring \u539F\u751F\u4E0E\u6570\u636E\u6E90\u76F8\u5173\u7684\u5C5E\u6027\u914D\u7F6E\uFF0C\u53EF\u4EE5\u6DFB\u52A0\u5982\u4E0B\u7C7B\u4F7F<code>DruidDataSource</code>\u63A5\u6536\u539F\u751F\u5C5E\u6027\u914D\u7F6E\u7684\u5C5E\u6027</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DruidConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.datasource&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DruidDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="springboot\u4E0Emybatis" tabindex="-1"><a class="header-anchor" href="#springboot\u4E0Emybatis" aria-hidden="true">#</a> SpringBoot\u4E0EMyBatis</h3><p>MyBatis \u662F\u4E00\u6B3E\u4F18\u79C0\u7684\u6301\u4E45\u5C42\u6846\u67B6\uFF0CSpringBoot \u5B98\u65B9\u867D\u7136\u6CA1\u6709\u5BF9MyBatis\u8FDB\u884C\u6574\u5408\uFF0C\u4F46\u662FMyBatis\u56E2\u961F\u81EA\u884C\u9002\u914D\u4E86\u5BF9\u5E94\u7684\u542F\u52A8\u5668\uFF0C\u8FDB\u4E00\u6B65\u7B80\u5316\u4E86\u4F7F\u7528MyBatis\u8FDB\u884C\u6570\u636E\u7684\u64CD\u4F5C\u3002</p><p>\u56E0\u4E3A SpringBoot \u6846\u67B6\u5F00\u53D1\u7684\u4FBF\u5229\u6027\uFF0C\u6240\u4EE5\u5B9E\u73B0 SpringBoot \u4E0E\u6570\u636E\u8BBF\u95EE\u5C42\u6846\u67B6(\u4F8B\u5982 MyBatis)\u7684\u6574\u5408\u975E\u5E38\u7B80\u5355\uFF0C\u4E3B\u8981\u662F\u5F15\u5165\u5BF9\u5E94\u7684\u4F9D\u8D56\u542F\u52A8\u5668\uFF0C\u5E76\u8FDB\u884C\u6570\u636E\u5E93\u76F8\u5173\u53C2\u6570\u8BBE\u7F6E\u5373\u53EF</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.mybatis.spring.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.3.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>Mybatis\u81EA\u52A8\u914D\u7F6E\u6E90\u7801\u5206\u6790</strong></p><p>\u8FD8\u662F\u8001\u65B9\u6CD5\uFF0C\u6211\u4EEC\u9996\u5148\u627E\u5230<code>spring.factories</code>\u4E2D\u6307\u5B9A\u7684\u81EA\u52A8\u914D\u7F6E\u7C7B<code>org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration</code></p><p>\u9996\u5148\u6765\u770B\u8FD9\u4E2A\u81EA\u52A8\u914D\u7F6E\u7C7B\u7684\u58F0\u660E</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@org.springframework.context.annotation.Configuration</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">SqlSessionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">SqlSessionFactoryBean</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnBean</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">MybatisProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@AutoConfigureAfter</span><span class="token punctuation">(</span><span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MybatisAutoConfiguration</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>\u7C7B\u7684\u58F0\u660E\u4E0A\u9762\u6CA1\u6709\u4EC0\u4E48\u7279\u6B8A\u7684\uFF0C\u65E0\u975E\u5C31\u662F\u6307\u660E\u4E86\u52A0\u8F7D\u7684\u6761\u4EF6\u3001\u4F7F\u7528\u7684\u914D\u7F6E\u6587\u4EF6\u548C\u52A0\u8F7D\u7684\u987A\u5E8F\uFF08\u9700\u8981\u5728<code>DataSourceAutoConfiguration</code>\u52A0\u8F7D\u540E\u52A0\u8F7D\uFF09\u3002</p><p>\u518D\u6765\u770B\u7C7B\u7684\u5185\u90E8\uFF0C\u7C7B\u7684\u5185\u90E8\u4E3B\u8981\u5173\u6CE8\u4E24\u4E2A\u6807\u6CE8\u4E86<code>@Bean</code>\u6CE8\u89E3\u7684\u65B9\u6CD5\uFF1A<code>sqlSessionFactory</code>\u548C<code>sqlSessionTemplate</code></p><ol><li><p><code>sqlSessionFactory</code>\u65B9\u6CD5\u4E3B\u8981\u5728\u5185\u90E8\u89E3\u6790\u4E86\u914D\u7F6E\u6587\u4EF6\uFF0C\u7136\u540E\u901A\u8FC7\u8C03\u7528<code>SqlSessionFactoryBuilder#build</code>\u65B9\u6CD5\u5E76\u4F7F\u7528\u914D\u7F6E\u7684\u6570\u636E\u6784\u5EFA\u4E00\u4E2A<code>DefaultSqlSessionFactory</code>\u5E76\u8FD4\u56DE\u3002</p></li><li><p><code>sqlSessionTemplate</code>\u65B9\u6CD5\u5219\u4E3B\u8981\u521B\u5EFA\u4E86\u4E00\u4E2A<code>SqlSessionTemplate</code>\u5BF9\u8C61\u5E76\u8FD4\u56DE\u3002\u8FD9\u4E2A\u7C7B\u540C\u6837\u5B9E\u73B0\u4E86<code>SqlSession</code>\u63A5\u53E3\uFF0C\u76F8\u8F83\u4E8E<code>DefaultSqlSession</code>\u4ED6\u662F\u7EBF\u7A0B\u5B89\u5168\u7684\u3002</p></li></ol><p>\u81F3\u6B64\uFF0C\u5DF2\u7ECF\u5B8C\u6210\u4E86<code>sqlSessionFactory</code>\u548C<code>sqlSessionTemplate</code>\u7684\u5B9E\u4F8B\u5316\u548C\u6CE8\u518C\u3002\u90A3\u4E48\uFF0C\u7ED9Mapper\u63A5\u53E3\u521B\u5EFA\u4EE3\u7406\u5BF9\u8C61\u5E76\u5B58\u5165\u5BB9\u5668\u4E2D\u662F\u5982\u4F55\u5B9E\u73B0\u7684\u5462\uFF1F</p><p>\u5DF2\u77E5\uFF0C<code>@MapperScan(basePackages = \u201Ccom.mybatis.mapper\u201D)</code>\u6307\u5B9A\u4E86\u5305\u626B\u63CF\u7684\u8DEF\u5F84\uFF0C\u90A3\u4E48\u6211\u4EEC\u5C31\u4ECE\u6B64\u6CE8\u89E3\u5F00\u59CB</p><p>\u6211\u4EEC\u5148\u6765\u770B\u6CE8\u89E3\u7684\u58F0\u660E</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">MapperScannerRegistrar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">MapperScan</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>\u6CE8\u89E3\u7684\u58F0\u660E\u4E0A\u6CA1\u6709\u4EC0\u4E48\u7279\u522B\u7684\uFF0C\u4E3B\u8981\u5C31\u662F\u5BFC\u5165\u4E86<code>MapperScannerRegistrar</code>\u3002 \u7531\u4E8E<code>MapperScannerRegistrar</code>\u5B9E\u73B0\u4E86<code>ImportBeanDefinitionRegistrar</code>\u63A5\u53E3\uFF0CSpring\u5728\u5B9E\u4F8B\u5316\u4E4B\u524D\u4F1A\u8C03\u7528\u5230<code>registerBeanDefinitions</code>\u65B9\u6CD5\u3002</p><p>\u5728<code>registerBeanDefinitions</code>\u65B9\u6CD5\u4E2D\uFF0C\u83B7\u53D6\u5230\u4E86<code>@MapperScan</code>\u6240\u6709\u7684\u6CE8\u89E3\u5C5E\u6027\uFF0C\u7136\u540E\u521B\u5EFA\u4E86\u4E00\u4E2A<code>scanner</code>\u626B\u63CF\u5BF9\u8C61\uFF0C\u5E76\u5C06\u6CE8\u89E3\u6807\u6CE8\u7684\u5C5E\u6027\u8D4B\u503C\u7ED9\u8FD9\u4E2A\u626B\u63CF\u5BF9\u8C61\u3002 \u7136\u540E\u8C03\u7528\u4E86<code>scanner.doScan(StringUtils.toStringArray(basePackages));</code>\u65B9\u6CD5\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> <span class="token function">doScan</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> basePackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> beanDefinitions <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">doScan</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>beanDefinitions<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;No MyBatis mapper was found in &#39;&quot;</span> <span class="token operator">+</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&#39; package. Please check your configuration.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">processBeanDefinitions</span><span class="token punctuation">(</span>beanDefinitions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> beanDefinitions<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>\u9996\u5148\u8C03\u7528\u4E86\u7236\u7C7B\u7684<code>doScan</code>\u65B9\u6CD5\uFF0C\u626B\u63CF\u5230\u4E86\u6240\u6709\u7684Mapper\u63A5\u53E3\uFF0C\u5E76\u5C01\u88C5\u6210<code>BeanDefinition</code>\u7136\u540E\u5B58\u5165<code>beanDefinitionMap</code>\u4E2D\u3002 \u7136\u540E\u8FD4\u56DE\u5C01\u88C5\u4E86<code>BeanDefinition</code>\u7684<code>BeanDefinitionHolder</code>\u96C6\u5408\u8C03\u7528<code>processBeanDefinitions</code>\u8FDB\u884C\u540E\u7F6E\u5904\u7406\u3002</p><p>\u8FD9\u4E2A\u65B9\u6CD5\u4E2D\u6709\u4E00\u884C\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>definition<span class="token punctuation">.</span><span class="token function">setBeanClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mapperFactoryBean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>\u6267\u884C\u5B8C\u8FD9\u4E00\u884C\u540E\uFF0C\u5C06mapper\u7684Bean\u7C7B\u8BBE\u7F6E\u4E3A\u4E86<code>MapperFactoryBean</code>\u3002MapperFactoryBean\u5B9E\u73B0\u4E86FactoryBean\u63A5\u53E3\uFF0C\u6240\u4EE5\u5F53Spring\u4ECE\u5F85\u5B9E\u4F8B\u5316\u7684Bean\u5BB9\u5668\u4E2D\u904D\u5386\u5230\u8FD9\u4E2ABean\u5E76\u5F00\u59CB\u6267\u884C\u5B9E\u4F8B\u5316\u65F6\uFF0C \u8FD4\u56DE\u7684\u5BF9\u8C61\u5B9E\u9645\u4E0A\u662FgetObject\u65B9\u6CD5\u4E2D\u8FD4\u56DE\u7684\u5BF9\u8C61\u3002\u6211\u4EEC\u6765\u770B\u4ED6\u7684<code>getObject()</code>\u65B9\u6CD5\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">getSqlSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mapperInterface<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// \u6211\u4EEC\u7EE7\u7EED\u8FDB\u5165 getMapper \u65B9\u6CD5</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// \u7EE7\u7EED\u8FDB\u5165</span>
<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">SqlSession</span> sqlSession<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> mapperRegistry<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> sqlSession<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// \u7EE7\u7EED\u8FDB\u5165</span>
<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">SqlSession</span> sqlSession<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> <span class="token class-name">MapperProxyFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> mapperProxyFactory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MapperProxyFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> knownMappers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mapperProxyFactory <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BindingException</span><span class="token punctuation">(</span><span class="token string">&quot;Type &quot;</span> <span class="token operator">+</span> type <span class="token operator">+</span> <span class="token string">&quot; is not known to the MapperRegistry.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u4EE3\u7406\u5BF9\u8C61\u521B\u5EFA\u6210\u529F  </span>
    <span class="token keyword">return</span> mapperProxyFactory<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BindingException</span><span class="token punctuation">(</span><span class="token string">&quot;Error getting mapper instance. Cause: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>\u6B64\u5904\u7684<code>this.mapperInterface</code>\u5C31\u662F\u5F53\u524DMapper\u63A5\u53E3\u3002\u81F3\u6B64\uFF0C\u4EE3\u7406\u5BF9\u8C61\u521B\u5EFA\u5B8C\u6210\u3002</p><h3 id="\u52A8\u6001\u6570\u636E\u6E90\u5207\u6362" tabindex="-1"><a class="header-anchor" href="#\u52A8\u6001\u6570\u636E\u6E90\u5207\u6362" aria-hidden="true">#</a> \u52A8\u6001\u6570\u636E\u6E90\u5207\u6362</h3><p><strong>\u52A8\u6001\u6570\u636E\u6E90\u4ECB\u7ECD</strong></p><p>\u4E1A\u52A1\u80CC\u666F</p><p>\u7535\u5546\u8BA2\u5355\u9879\u76EE\u5206\u6B63\u5411\u548C\u9006\u5411\u4E24\u4E2A\u90E8\u5206: \u5176\u4E2D\u6B63\u5411\u6570\u636E\u5E93\u8BB0\u5F55\u4E86\u8BA2\u5355\u7684<em>\u57FA\u672C\u4FE1\u606F</em>\uFF0C\u5305\u62EC\u8BA2\u5355\u57FA\u672C\u4FE1\u606F\u3001\u8BA2\u5355\u5546\u54C1\u4FE1\u606F\u3001\u4F18\u60E0\u5238\u4FE1\u606F\u3001\u53D1\u7968\u4FE1\u606F\u3001\u8D26\u671F\u4FE1\u606F\u3001\u7ED3\u7B97\u4FE1\u606F\u3001\u8BA2\u5355\u5907\u6CE8\u4FE1\u606F\u3001\u6536\u8D27\u4EBA\u4FE1\u606F \u7B49; \u9006\u5411\u6570\u636E\u5E93\u4E3B\u8981\u5305\u542B\u4E86\u5546\u54C1\u7684\u9000\u8D27\u4FE1\u606F\u548C\u7EF4\u4FEE\u4FE1\u606F\u3002 \u6570\u636E\u91CF\u8D85\u8FC7500\u4E07\u884C\u5C31\u8981\u8003\u8651\u5206\u5E93\u5206\u8868\u548C\u8BFB\u5199\u5206\u79BB\uFF0C\u90A3\u4E48\u6211\u4EEC\u5728\u6B63\u5411\u64CD\u4F5C\u548C\u9006\u5411\u64CD\u4F5C\u7684\u65F6\u5019\uFF0C\u5C31\u9700\u8981\u52A8\u6001\u7684\u5207\u6362\u5230\u76F8\u5E94\u7684\u6570\u636E\u5E93\uFF0C\u8FDB\u884C\u76F8\u5173\u7684\u64CD\u4F5C\u3002</p><p>\u89E3\u51B3\u601D\u8DEF</p><p>\u73B0\u5728\u9879\u76EE\u7684\u7ED3\u6784\u8BBE\u8BA1\u57FA\u672C\u4E0A\u662F\u57FA\u4E8EMVC\u7684\uFF0C\u90A3\u4E48\u6570\u636E\u5E93\u7684\u64CD\u4F5C\u96C6\u4E2D\u5728dao\u5C42\u5B8C\u6210\uFF0C\u4E1A\u52A1\u903B\u8F91\u96C6\u4E2D\u5728service\u5C42\u5904\u7406\uFF0Ccontroller\u5C42\u5904\u7406\u8BF7\u6C42\u3002 \u5047\u8BBE\u5728\u6267\u884Cdao\u5C42\u4EE3\u7801\u4E4B\u524D\u80FD\u591F\u5C06\u6570\u636E\u6E90(DataSource)\u6362\u6210\u6211\u4EEC\u60F3\u8981\u6267\u884C\u64CD\u4F5C\u7684\u6570\u636E\u6E90\uFF0C\u90A3\u4E48\u8FD9\u4E2A\u95EE\u9898\u5C31\u89E3\u51B3\u4E86\u3002</p><p>\u539F\u7406</p><p>Spring\u5185\u7F6E\u4E86\u4E00\u4E2A<code>AbstractRoutingDataSource</code>\uFF0C\u5B83\u53EF\u4EE5\u628A\u591A\u4E2A\u6570\u636E\u6E90\u914D\u7F6E\u6210\u4E00\u4E2AMap\uFF0C\u7136\u540E\u6839\u636E\u4E0D\u540C\u7684key\u8FD4\u56DE\u4E0D\u540C\u7684\u6570\u636E\u6E90\u3002 \u56E0\u4E3A<code>AbstractRoutingDataSource</code>\u4E5F\u5B9E\u73B0\u4E86<code>DataSource</code>\u63A5\u53E3\uFF0C\u56E0\u6B64\u5E94\u7528\u7A0B\u5E8F\u53EF\u4EE5\u5148\u8BBE\u7F6E\u597Dkey\uFF0C \u8BBF\u95EE\u6570\u636E\u5E93\u7684\u4EE3\u7801\u5C31\u53EF\u4EE5\u4ECE<code>AbstractRoutingDataSource</code>\u62FF\u5230\u5BF9\u5E94\u7684\u771F\u5B9E\u7684\u6570\u636E\u6E90\uFF0C\u4ECE\u800C\u8BBF\u95EE\u6307\u5B9A\u7684\u6570\u636E\u5E93\u3002</p><p><img src="`+t+`" alt="\u52A8\u6001\u5207\u6362\u6570\u636E\u6E90\u539F\u7406"></p><p><strong>AbstractRoutingDataSource</strong></p><p>\u9996\u5148\u770B\u6E90\u7801</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractRoutingDataSource</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractDataSource</span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Nullable</span>
   <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> targetDataSources<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Nullable</span>
   <span class="token keyword">private</span> <span class="token class-name">Object</span> defaultTargetDataSource<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">boolean</span> lenientFallback <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">DataSourceLookup</span> dataSourceLookup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JndiDataSourceLookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Nullable</span>
   <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">DataSource</span><span class="token punctuation">&gt;</span></span> resolvedDataSources<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Nullable</span>
   <span class="token keyword">private</span> <span class="token class-name">DataSource</span> resolvedDefaultDataSource<span class="token punctuation">;</span>
   
   <span class="token comment">// \u65B9\u6CD5\u7565...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><ol><li>\u8BE5\u62BD\u8C61\u7C7B\u7EE7\u627F\u4E86<code>AbstractDataSource</code>\uFF0C\u800C\u8FD9\u4E2A\u7C7B\u5B9E\u73B0\u4E86<code>DataSource</code>\u63A5\u53E3\uFF0C\u56E0\u6B64\u8BE5\u7C7B\u4E5F\u662F\u4E00\u4E2A\u6807\u51C6\u7684\u6570\u636E\u6E90\u3002</li><li><code>targetDataSources</code>\u5B58\u653E\u4E86\u591A\u6570\u636E\u6E90\uFF0C<code>resolvedDataSources</code>\u662F\u88AB\u8F6C\u6362\u6210\u6570\u636E\u6E90\u540E\u7684Map\u3002\uFF08\u4E5F\u5C31\u662F\u8BF4\u8FD9\u4E24\u4E2AMap\u7684\u5185\u5BB9\u5B9E\u8D28\u4E0A\u662F\u4E00\u6837\u7684\uFF0C\u53EA\u662F\u4E00\u4E2A\u539F\u59CB\u6570\u636E\uFF0C\u4E00\u4E2A\u662F\u8F6C\u6362\u6210\u6570\u636E\u6E90\u5BF9\u8C61\u540E\u7684\uFF09</li><li><code>defaultTargetDataSource</code>\u5B58\u653E\u4E86\u9ED8\u8BA4\u6570\u636E\u6E90\u5BF9\u8C61\u3002</li></ol><p>\u518D\u770B\u7C7B\u5185\u90E8\u7684\u4E00\u4E2A\u91CD\u8981\u65B9\u6CD5 <code>getConnection</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">determineTargetDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>\u7EE7\u7EED\u5173\u6CE8determineTargetDataSource</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">DataSource</span> <span class="token function">determineTargetDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolvedDataSources<span class="token punctuation">,</span> <span class="token string">&quot;DataSource router not initialized&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Object</span> lookupKey <span class="token operator">=</span> <span class="token function">determineCurrentLookupKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">DataSource</span> dataSource <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resolvedDataSources<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>lookupKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>dataSource <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lenientFallback <span class="token operator">||</span> lookupKey <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		dataSource <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resolvedDefaultDataSource<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>dataSource <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot determine target DataSource for lookup key [&quot;</span> <span class="token operator">+</span> lookupKey <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> dataSource<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>\u53EF\u4EE5\u53D1\u73B0\u5C31\u662F\u4ECE<code>resolvedDataSources</code>\u4E2D\u6839\u636E<code>key</code>\u53D6\u51FA\u4E86\u5BF9\u5E94\u7684\u6570\u636E\u6E90\u5BF9\u8C61\u3002\u56E0\u6B64\uFF0C\u83B7\u53D6\u8FD9\u4E2Akey\u7684<code>determineCurrentLookupKey</code>\u662F\u5173\u952E\u3002</p><p>\u6211\u4EEC\u53EF\u4EE5\u901A\u8FC7\u8986\u76D6\u8BE5\u65B9\u6CD5\u4ECE\u800C\u5B9E\u73B0\u6570\u636E\u6E90\u52A8\u6001\u5207\u6362\u3002\u90A3\u4E48\u73B0\u5728\u7684\u95EE\u9898\u5C31\u662F\u5982\u4F55\u5B58\u50A8\u52A8\u6001\u9009\u62E9\u7684key\uFF0C\u5728\u8C03\u7528<code>determineCurrentLookupKey</code>\u65B9\u6CD5\u7684\u65F6\u5019\u8FD4\u56DE\u5462\uFF1F</p><p>\u5728Servlet\u7684\u7EBF\u7A0B\u6A21\u578B\u4E2D\uFF0C\u63A8\u8350\u4F7F\u7528ThreadLocal\u5B58\u50A8key\u3002</p><p><strong>\u7B80\u5355\u5B9E\u73B0</strong></p><p>\u9996\u5148\u51C6\u5907MVC\u7684\u57FA\u7840\u73AF\u5883\u3002\u57FA\u7840\u73AF\u5883\u51C6\u5907\u5B8C\u6210\u540E\uFF0C\u9996\u5148\u6DFB\u52A0\u591A\u6570\u636E\u6E90\u7684\u914D\u7F6E</p><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">spring.druid.datasource.master.password</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token key attr-name">spring.druid.datasource.master.username</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token key attr-name">spring.druid.datasource.master.jdbc-url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://localhost:3306/product_master?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true&amp;serverTimezone=UTC</span>
<span class="token key attr-name">spring.druid.datasource.master.driver-class-name</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.cj.jdbc.Driver</span>

<span class="token key attr-name">spring.druid.datasource.slave.password</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token key attr-name">spring.druid.datasource.slave.username</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token key attr-name">spring.druid.datasource.slave.jdbc-url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://localhost:3306/product_slave?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true&amp;serverTimezone=UTC</span>
<span class="token key attr-name">spring.druid.datasource.slave.driver-class-name</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.cj.jdbc.Driver</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>\u7136\u540E\u5411Spring\u5BB9\u5668\u4E2D\u6CE8\u5165<code>DataSource</code>\u5B9E\u4F8B\u5BF9\u8C61</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyDataSourceConfiguration</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;masterDataSource&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.druid.datasource.master&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">DataSource</span> <span class="token function">masterDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;create master datasource...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">DataSourceBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;slaveDataSource&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.druid.datasource.slave&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">DataSource</span> <span class="token function">slaveDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;create slave datasource...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">DataSourceBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>\u540C\u65F6\u6392\u9664SpringBoot\u81EA\u52A8\u914D\u7F6E</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>\u6DFB\u52A0<code>AbstractRoutingDataSource</code>\u7684\u5B50\u7C7B\u5E76\u8986\u76D6<code>determineCurrentLookupKey</code>\u65B9\u6CD5\uFF0C\u5B9E\u73B0\u6570\u636E\u6E90\u52A8\u6001\u5207\u6362</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoutingDataSource</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRoutingDataSource</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">determineCurrentLookupKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;masterDataSource&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>\u5728\u6CE8\u5165<code>DataSource</code>\u7684\u81EA\u5B9A\u4E49\u81EA\u52A8\u914D\u7F6E\u7C7B\u4E2D\u6DFB\u52A0\u4E3B\u6570\u636E\u6E90\u914D\u7F6E</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@Primary</span>    <span class="token comment">// \u5F53\u524D\u914D\u7F6E\u7C7B\u5C06\u8FD4\u56DE\u591A\u4E2A Datasource \u5BF9\u8C61\uFF0C\u90A3\u4E48\u4EE5\u8C01\u4E3A\u4E3B\u5462\uFF1F\u4F7F\u7528\u6B64\u6CE8\u89E3</span>
<span class="token class-name">DataSource</span> <span class="token function">primaryDataSource</span><span class="token punctuation">(</span>
        <span class="token annotation punctuation">@Autowired</span> <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;masterDataSource&quot;</span><span class="token punctuation">)</span> <span class="token class-name">DataSource</span> masterDataSource<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@Autowired</span> <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;slaveDataSource&quot;</span><span class="token punctuation">)</span> <span class="token class-name">DataSource</span> slaveDataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;create routing datasource...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;masterDataSource&quot;</span><span class="token punctuation">,</span> masterDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;slaveDataSource&quot;</span><span class="token punctuation">,</span> slaveDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RoutingDataSource</span> routing <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoutingDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    routing<span class="token punctuation">.</span><span class="token function">setTargetDataSources</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    routing<span class="token punctuation">.</span><span class="token function">setDefaultTargetDataSource</span><span class="token punctuation">(</span>masterDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> routing<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>\u5F53\u524D\uFF0C\u81EA\u5B9A\u4E49\u7684\u6570\u636E\u6E90\u81EA\u52A8\u914D\u7F6E\u7C7B\u6CE8\u5165\u7684\u4E3B\u6570\u636E\u6E90\u662F\u4E00\u4E2A<code>RoutingDataSource</code>\uFF1B \u5177\u4F53\u4F7F\u7528\u54EA\u4E00\u4E2A\u6570\u636E\u6E90\uFF0C\u4F1A\u901A\u8FC7\u8C03\u7528<code>AbstractRoutingDataSource</code>\u5B50\u7C7B\u7684<code>determineCurrentLookupKey</code>\u65B9\u6CD5\u51B3\u5B9A\u3002</p><p>\u800C\u5F53\u524D\u8FD9\u4E2A\u65B9\u6CD5\u76F4\u63A5\u8FD4\u56DE\u4E86<code>&quot;masterDataSource&quot;</code>\u663E\u7136\u662F\u4E0D\u884C\u7684\u3002\u524D\u9762\u5DF2\u7ECF\u8BF4\u8FC7\uFF0C\u5BF9\u4E8E Servlet \u7EBF\u7A0B\u6A21\u578B\u7684\u5E94\u7528\uFF0C\u63A8\u8350\u4F7F\u7528 ThreadLocal \u4FDD\u5B58key\u503C\u3002</p><p>\u63A5\u4E0B\u6765\u6211\u4EEC\u6DFB\u52A0<code>RoutingDataSourceContext</code>\u7528\u4E8E\u4FDD\u5B58key\u503C\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoutingDataSourceContext</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> local <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// key : \u6307\u5B9A\u6570\u636E\u6E90\u7C7B\u578B master/slave</span>
    <span class="token keyword">public</span> <span class="token class-name">RoutingDataSourceContext</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        local<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getDataSourceRoutingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;masterDataSource&quot;</span> <span class="token operator">:</span> key<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        local<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>\u540C\u65F6\u4FEE\u6539\u83B7\u53D6key\u7684\u65B9\u6CD5</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">determineCurrentLookupKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">RoutingDataSourceContext</span><span class="token punctuation">.</span><span class="token function">getDataSourceRoutingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>\u5728Controller\u65B9\u6CD5\u4E2D\u4F7F\u7528RoutingDataSourceContext</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/findAllProductM&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">findAllProductM</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;masterDataSource&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">RoutingDataSourceContext</span> routingDataSourceContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoutingDataSourceContext</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    productService<span class="token punctuation">.</span><span class="token function">findAllM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;master&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>\u4F18\u5316\uFF1A\u4F7F\u7528\u6CE8\u89E3\u58F0\u660E\u65B9\u5F0F</strong></p><p>Spring\u63D0\u4F9B\u7684\u58F0\u660E\u5F0F\u4E8B\u52A1\u7BA1\u7406\uFF0C\u5C31\u53EA\u9700\u8981\u4E00\u4E2A @Transactional() \u6CE8\u89E3\uFF0C\u653E\u5728\u67D0\u4E2AJava\u65B9\u6CD5\u4E0A\uFF0C\u8FD9\u4E2A\u65B9\u6CD5\u5C31\u81EA\u52A8\u5177\u6709\u4E86\u4E8B\u52A1\u3002 \u6211\u4EEC\u4E5F\u53EF\u4EE5\u7F16\u5199\u4E00\u4E2A\u7C7B\u4F3C\u7684<code>@RoutingWith(&quot;slaveDataSource&quot;)</code>\u6CE8\u89E3\uFF0C\u653E\u5230\u67D0\u4E2AController\u7684\u65B9\u6CD5\u4E0A\uFF0C\u8FD9\u4E2A\u65B9\u6CD5\u5185\u90E8\u5C31\u81EA\u52A8\u9009\u62E9\u4E86\u5BF9\u5E94\u7684\u6570\u636E\u6E90\u3002</p><p>\u6DFB\u52A0\u6CE8\u89E3\u7C7B</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">RoutingWith</span> <span class="token punctuation">{</span>

    <span class="token class-name">String</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;masterDataSource&quot;</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>\u6DFB\u52A0\u5207\u9762</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoutingAspect</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">&quot;@annotation(routingWith)&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">routingWithDatasource</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">,</span> <span class="token class-name">RoutingWith</span> routingWith<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> routingWith<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RoutingDataSourceContext</span> routingDataSourceContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoutingDataSourceContext</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> joinPoint<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>\u4F7F\u7528\u6CE8\u89E3</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/findAllProductM&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RoutingWith</span><span class="token punctuation">(</span><span class="token string">&quot;masterDataSource&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">findAllProductM</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    productService<span class="token punctuation">.</span><span class="token function">findAllM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;master&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="springboot-\u7F13\u5B58" tabindex="-1"><a class="header-anchor" href="#springboot-\u7F13\u5B58" aria-hidden="true">#</a> SpringBoot \u7F13\u5B58</h2><h3 id="jsr107" tabindex="-1"><a class="header-anchor" href="#jsr107" aria-hidden="true">#</a> JSR107</h3><p>JSR\u662F Java Specification Requests \u7684\u7F29\u5199\uFF0CJava\u89C4\u8303\u8BF7\u6C42\u3002 \u6545\u540D\u601D\u8BAE\u63D0\u4EA4Java\u89C4\u8303\uFF0CJSR-107\u5C31\u662F\u5173\u4E8E\u5982\u4F55\u4F7F\u7528\u7F13\u5B58\u7684\u89C4\u8303\uFF0C\u662Fjava\u63D0\u4F9B\u7684\u4E00\u4E2A\u63A5\u53E3\u89C4\u8303\uFF0C\u7C7B\u4F3C\u4E8EJDBC\u89C4\u8303\uFF0C\u6CA1\u6709\u5177\u4F53\u7684\u5B9E\u73B0\uFF0C\u5177\u4F53\u7684\u5B9E\u73B0\u5C31\u662FRedis\u7B49\u8FD9\u4E9B\u7F13\u5B58\u3002</p><p>Java Caching(JSR-107)\u5B9A\u4E49\u4E865\u4E2A\u6838\u5FC3\u63A5\u53E3\uFF0C\u5206\u522B\u662FCachingProvider\u3001CacheManager\u3001 Cache\u3001Entry\u548CExpiry\u3002</p><ul><li><p>CachingProvider(\u7F13\u5B58\u63D0\u4F9B\u8005): \u521B\u5EFA\u3001\u914D\u7F6E\u3001\u83B7\u53D6\u3001\u7BA1\u7406\u548C\u63A7\u5236\u591A\u4E2ACacheManager\u3002</p></li><li><p>CacheManager(\u7F13\u5B58\u7BA1\u7406\u5668): \u521B\u5EFA\u3001\u914D\u7F6E\u3001\u83B7\u53D6\u3001\u7BA1\u7406\u548C\u63A7\u5236\u591A\u4E2A\u552F\u4E00\u547D\u540D\u7684Cache\uFF0CCache\u5B58\u5728\u4E8ECacheManager\u7684\u4E0A\u4E0B\u6587\u4E2D\u3002 \u4E00\u4E2ACacheManager\u4EC5\u5BF9\u5E94\u4E00\u4E2ACachingProvider\u3002</p></li><li><p>Cache(\u7F13\u5B58): \u7531CacheManager\u8FDB\u884C\u7BA1\u7406\uFF0CCacheManager\u7BA1\u7406Cache\u7684\u751F\u547D\u5468\u671F\u3002 Cache\u5B58\u5728\u4E8ECacheManager\u7684\u4E0A\u4E0B\u6587\u4E2D\uFF0C\u662F\u4E00\u4E2A\u7C7B\u4F3Cmap\u7684\u6570\u636E\u7ED3\u6784\uFF0C\u5E76\u4E34\u65F6\u5B58\u50A8\u4EE5key\u4E3A\u7D22\u5F15\u7684\u503C\u3002 \u4E00\u4E2ACache\u4EC5\u88AB\u4E00\u4E2ACacheManager\u6240\u62E5\u6709</p></li><li><p>Entry(\u7F13\u5B58\u952E\u503C\u5BF9): \u662F\u4E00\u4E2A\u5B58\u50A8\u5728Cache\u4E2D\u7684key-value\u5BF9(\u7B80\u5355\u7406\u89E3\u5C31\u662FCache\u4E2D\u7684\u4E00\u6761\u6570\u636E)</p></li><li><p>Expiry(\u7F13\u5B58\u65F6\u6548):\u6BCF\u4E00\u4E2A\u5B58\u50A8\u5728Cache\u4E2D\u7684\u6761\u76EE\u90FD\u6709\u4E00\u4E2A\u5B9A\u4E49\u7684\u6709\u6548\u671F\u3002 \u4E00\u65E6\u8D85\u8FC7\u8FD9\u4E2A\u65F6\u95F4\uFF0C\u6761\u76EE\u5C31\u81EA\u52A8\u8FC7\u671F\uFF0C\u8FC7\u671F\u540E\uFF0C\u6761\u76EE\u5C06\u4E0D\u53EF\u4EE5\u8BBF\u95EE\u3001\u66F4\u65B0\u548C\u5220\u9664\u64CD\u4F5C\u3002 \u7F13\u5B58\u6709\u6548\u671F\u53EF\u4EE5\u901A\u8FC7ExpiryPolicy\u8BBE\u7F6E</p></li></ul><p><img src="`+p+`" alt="JSR107\u56FE\u793A"></p><p>\u4E00\u4E2A\u5E94\u7528\u91CC\u9762\u53EF\u4EE5\u6709\u591A\u4E2A\u7F13\u5B58\u63D0\u4F9B\u8005(CachingProvider)\uFF0C\u4E00\u4E2A\u7F13\u5B58\u63D0\u4F9B\u8005\u53EF\u4EE5\u83B7\u53D6\u5230\u591A\u4E2A\u7F13\u5B58\u7BA1\u7406\u5668(CacheManager)\uFF0C \u4E00\u4E2A\u7F13\u5B58\u7BA1\u7406\u5668\u7BA1\u7406\u7740\u4E0D\u540C\u7684\u7F13\u5B58(Cache)\uFF0C\u7F13\u5B58\u4E2D\u662F\u4E00\u4E2A\u4E2A\u7684\u7F13\u5B58\u952E\u503C\u5BF9(Entry)\uFF0C\u6BCF\u4E2Aentry\u90FD\u6709\u4E00\u4E2A\u6709\u6548\u671F(Expiry)\u3002</p><blockquote><p>\u7F13\u5B58\u7BA1\u7406\u5668\u548C\u7F13\u5B58\u4E4B\u95F4\u7684\u5173\u7CFB\uFF0C\u6709\u70B9\u7C7B\u4F3C\u4E8E\u6570\u636E\u5E93\u4E2D\u8FDE\u63A5\u6C60\u548C\u8FDE\u63A5\u7684\u5173\u7CFB\u3002</p></blockquote><p>\u4F7F\u7528JSR-107\u9700\u5BFC\u5165\u4F9D\u8D56</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>javax.cache<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>cache-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="spring\u7684\u7F13\u5B58\u62BD\u8C61" tabindex="-1"><a class="header-anchor" href="#spring\u7684\u7F13\u5B58\u62BD\u8C61" aria-hidden="true">#</a> Spring\u7684\u7F13\u5B58\u62BD\u8C61</h3><p><strong>\u7F13\u5B58\u62BD\u8C61\u5B9A\u4E49</strong></p><p>Spring\u4ECE3.1\u5F00\u59CB\u5B9A\u4E49\u4E86<code>org.springframework.cache.Cache</code>\u548C<code>org.springframework.cache.CacheManager</code>\u63A5\u53E3\u6765\u7EDF\u4E00\u4E0D\u540C\u7684\u7F13\u5B58\u6280\u672F; \u5E76\u652F\u6301\u4F7F\u7528<code>Java Caching(JSR-107)</code>\u6CE8\u89E3\u7B80\u5316\u6211\u4EEC\u8FDB\u884C\u7F13\u5B58\u5F00\u53D1\u3002 Spring Cache \u53EA\u8D1F\u8D23\u7EF4\u62A4\u62BD\u8C61\u5C42\uFF0C\u5177\u4F53\u7684\u5B9E\u73B0\u7531\u81EA\u5DF1\u7684\u6280\u672F\u9009\u578B\u6765\u51B3\u5B9A\u3002\u5C06\u7F13\u5B58\u5904\u7406\u548C\u7F13\u5B58\u6280\u672F\u89E3\u9664\u8026\u5408\u3002</p><p>\u6BCF\u6B21\u8C03\u7528\u9700\u8981\u7F13\u5B58\u529F\u80FD\u7684\u65B9\u6CD5\u65F6\uFF0CSpring\u4F1A\u68C0\u67E5\u6307\u5B9A\u53C2\u6570\u7684\u6307\u5B9A\u7684\u76EE\u6807\u65B9\u6CD5\u662F\u5426\u5DF2\u7ECF\u88AB\u8C03\u7528\u8FC7\uFF0C \u5982\u679C\u6709\u5C31\u76F4\u63A5\u4ECE\u7F13\u5B58\u4E2D\u83B7\u53D6\u65B9\u6CD5\u8C03\u7528\u540E\u7684\u7ED3\u679C\uFF0C\u5982\u679C\u6CA1\u6709\u5C31\u8C03\u7528\u65B9\u6CD5\u5E76\u7F13\u5B58\u7ED3\u679C\u540E\u8FD4\u56DE\u7ED9\u7528\u6237\uFF0C\u4E0B\u6B21\u8C03\u7528\u76F4\u63A5\u4ECE\u7F13\u5B58\u4E2D\u83B7\u53D6\u3002</p><p>\u4F7F\u7528Spring\u7F13\u5B58\u62BD\u8C61\u65F6\u6211\u4EEC\u9700\u8981\u5173\u6CE8\u4EE5\u4E0B\u4E24\u70B9:</p><ol><li><p>\u786E\u5B9A\u90A3\u4E9B\u65B9\u6CD5\u9700\u8981\u88AB\u7F13\u5B58</p></li><li><p>\u7F13\u5B58\u7B56\u7565</p></li></ol><p><strong>\u91CD\u8981\u63A5\u53E3</strong></p><ul><li><p>Cache:\u7F13\u5B58\u62BD\u8C61\u7684\u89C4\u8303\u63A5\u53E3\uFF0C\u7F13\u5B58\u5B9E\u73B0\u6709:RedisCache\u3001EhCache\u3001ConcurrentMapCache\u7B49</p></li><li><p>CacheManager:\u7F13\u5B58\u7BA1\u7406\u5668\uFF0C\u7BA1\u7406Cache\u7684\u751F\u547D\u5468\u671F</p></li></ul><h3 id="spring\u7F13\u5B58\u4F7F\u7528" tabindex="-1"><a class="header-anchor" href="#spring\u7F13\u5B58\u4F7F\u7528" aria-hidden="true">#</a> Spring\u7F13\u5B58\u4F7F\u7528</h3><p>\u5148\u4ECB\u7ECD\u4E0BSpring\u63D0\u4F9B\u7684\u91CD\u8981\u7F13\u5B58\u6CE8\u89E3\u53CA\u51E0\u4E2A\u91CD\u8981\u6982\u5FF5:</p><table><thead><tr><th>\u6982\u5FF5/\u6CE8\u89E3</th><th>\u4F5C\u7528</th></tr></thead><tbody><tr><td>Cache</td><td>\u7F13\u5B58\u63A5\u53E3\uFF0C\u5B9A\u4E49\u7F13\u5B58\u64CD\u4F5C\u3002\u5B9E\u73B0\u6709:RedisCache\u3001EhCacheCache\u3001 ConcurrentMapCache\u7B49</td></tr><tr><td>CacheManager</td><td>\u7F13\u5B58\u7BA1\u7406\u5668\uFF0C\u7BA1\u7406\u5404\u79CD\u7F13\u5B58(Cache)\u7EC4\u4EF6</td></tr><tr><td><code>@Cacheable</code></td><td>\u4E3B\u8981\u9488\u5BF9\u65B9\u6CD5\u914D\u7F6E\uFF0C\u80FD\u591F\u6839\u636E\u65B9\u6CD5\u7684\u8BF7\u6C42\u53C2\u6570\u5BF9\u5176\u7ED3\u679C\u8FDB\u884C\u7F13\u5B58\u3002\u3010\u7F13\u5B58\u67E5\u8BE2\u3011</td></tr><tr><td><code>@CacheEvict</code></td><td>\u6E05\u7A7A\u7F13\u5B58\u3002\u3010\u6267\u884C\u4E86\u6807\u6CE8\u8BE5\u6CE8\u89E3\u7684\u65B9\u6CD5\uFF0C\u4F1A\u6E05\u7A7A\u7F13\u5B58\u3011</td></tr><tr><td><code>@CachePut</code></td><td>\u4FDD\u8BC1\u65B9\u6CD5\u88AB\u8C03\u7528\uFF0C\u53C8\u5E0C\u671B\u7ED3\u679C\u88AB\u7F13\u5B58\u3002\u3010\u7F13\u5B58\u66F4\u65B0\u3011</td></tr><tr><td><code>@EnableCaching</code></td><td>\u5F00\u542F\u57FA\u4E8E\u6CE8\u89E3\u7684\u7F13\u5B58\u3010\u8FD9\u4E2A\u6CE8\u89E3\u662F\u524D\u9762\u4E09\u4E2A\u6CE8\u89E3\u751F\u6548\u7684\u524D\u63D0\u3011</td></tr><tr><td>keyGenerator</td><td>\u7F13\u5B58\u6570\u636E\u65F6key\u751F\u6210\u7B56\u7565</td></tr><tr><td>serialize</td><td>\u7F13\u5B58\u6570\u636E\u65F6value\u5E8F\u5217\u5316\u7B56\u7565</td></tr></tbody></table><blockquote><p>\u6CE8\u610F\uFF1A</p><p><code>@Cacheable</code>\u6807\u6CE8\u5728\u65B9\u6CD5\u4E0A\uFF0C\u8868\u793A\u8BE5\u65B9\u6CD5\u7684\u7ED3\u679C\u9700\u8981\u88AB\u7F13\u5B58\u8D77\u6765\uFF0C\u7F13\u5B58\u7684\u952E\u7531keyGenerator\u7684\u7B56\u7565\u51B3\u5B9A\uFF0C\u7F13\u5B58\u7684\u503C\u7684\u5F62\u5F0F\u5219\u7531serialize\u5E8F\u5217\u5316\u7B56\u7565\u51B3\u5B9A(\u5E8F\u5217\u5316\u8FD8\u662Fjson\u683C\u5F0F); \u6807\u6CE8\u4E0A\u8BE5\u6CE8\u89E3\u540E\uFF0C\u5728\u7F13\u5B58\u65F6\u6548\u5185\u518D\u6B21\u8C03\u7528\u8BE5\u65B9\u6CD5\u65F6\u5C06\u4E0D\u4F1A\u8C03\u7528\u65B9\u6CD5\u672C\u8EAB\u800C\u662F\u76F4\u63A5\u4ECE\u7F13\u5B58\u83B7\u53D6\u7ED3\u679C\u3002</p><p><code>@CachePut</code>\u4E5F\u6807\u6CE8\u5728\u65B9\u6CD5\u4E0A\uFF0C\u548C<code>@Cacheable</code>\u76F8\u4F3C\u4E5F\u4F1A\u5C06\u65B9\u6CD5\u7684\u8FD4\u56DE\u503C\u7F13\u5B58\u8D77\u6765\uFF0C \u4E0D\u540C\u7684\u662F\u6807\u6CE8@CachePut\u7684\u65B9\u6CD5\u6BCF\u6B21\u90FD\u4F1A\u88AB\u8C03\u7528\uFF0C\u800C\u4E14\u6BCF\u6B21\u90FD\u4F1A\u5C06\u7ED3\u679C\u7F13\u5B58\u8D77\u6765\uFF0C\u9002\u7528\u4E8E\u5BF9\u8C61\u7684\u66F4\u65B0</p></blockquote><p><strong>@Cacheable\u521D\u4F53\u9A8C</strong></p><ol><li>\u5F00\u542F\u57FA\u4E8E\u6CE8\u89E3\u7684\u7F13\u5B58\u529F\u80FD:\u4E3B\u542F\u52A8\u7C7B\u6807\u6CE8<code>@EnableCaching</code></li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableCaching</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringbootTestDataApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SpringbootTestDataApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="2"><li>\u6807\u6CE8\u7F13\u5B58\u76F8\u5173\u6CE8\u89E3:<code>@Cacheable</code>\u3001<code>@CacheEvict</code>\u3001<code>@CachePut</code></li></ol><p><code>@Cacheable</code>: \u5C06\u65B9\u6CD5\u8FD0\u884C\u7684\u7ED3\u679C\u8FDB\u884C\u7F13\u5B58\uFF0C\u4EE5\u540E\u518D\u83B7\u53D6\u76F8\u540C\u7684\u6570\u636E\u65F6\uFF0C\u76F4\u63A5\u4ECE\u7F13\u5B58\u4E2D\u83B7\u53D6\uFF0C\u4E0D\u518D\u8C03\u7528\u65B9\u6CD5\u3002</p><p><strong>@Cacheable\u6CE8\u89E3\u7684\u5C5E\u6027</strong></p><table><thead><tr><th>\u5C5E\u6027\u540D</th><th>\u63CF\u8FF0</th></tr></thead><tbody><tr><td>cacheNames/value</td><td>\u6307\u5B9A\u7F13\u5B58\u7684\u540D\u5B57\uFF0C\u7F13\u5B58\u4F7F\u7528CacheManager\u7BA1\u7406\u591A\u4E2A\u7F13\u5B58\u7EC4\u4EF6 Cache\uFF0C\u8FD9\u4E9BCache\u7EC4\u4EF6\u5C31\u662F\u6839\u636E\u8FD9\u4E2A\u540D\u5B57\u8FDB\u884C\u533A\u5206\u7684\u3002\u5BF9\u7F13\u5B58\u7684\u771F \u6B63CRUD\u64CD\u4F5C\u5728Cache\u4E2D\u5B9A\u4E49\uFF0C\u6BCF\u4E2A\u7F13\u5B58\u7EC4\u4EF6Cache\u90FD\u6709\u81EA\u5DF1\u552F\u4E00\u7684 \u540D\u5B57\uFF0C\u901A\u8FC7cacheNames\u6216\u8005value\u5C5E\u6027\u6307\u5B9A\uFF0C\u76F8\u5F53\u4E8E\u662F\u5C06\u7F13\u5B58\u7684\u952E \u503C\u5BF9\u8FDB\u884C\u5206\u7EC4\uFF0C\u7F13\u5B58\u7684\u540D\u5B57\u662F\u4E00\u4E2A\u6570\u7EC4\uFF0C\u4E5F\u5C31\u662F\u8BF4\u53EF\u4EE5\u5C06\u4E00\u4E2A\u7F13\u5B58 \u952E\u503C\u5BF9\u5206\u5230\u591A\u4E2A\u7EC4\u91CC\u9762</td></tr><tr><td>key</td><td>\u7F13\u5B58\u6570\u636E\u65F6\u7684key\u7684\u503C\uFF0C\u9ED8\u8BA4\u662F\u4F7F\u7528\u65B9\u6CD5\u53C2\u6570\u7684\u503C\uFF0C\u53EF\u4EE5\u4F7F\u7528SpEL\u8868 \u8FBE\u5F0F\u8BA1\u7B97key\u7684\u503C</td></tr><tr><td>keyGenerator</td><td>\u7F13\u5B58\u7684\u751F\u6210\u7B56\u7565\uFF0C\u548Ckey\u4E8C\u9009\u4E00\uFF0C\u90FD\u662F\u751F\u6210\u952E\u7684\uFF0CkeyGenerator\u53EF\u81EA\u5B9A\u4E49</td></tr><tr><td>cacheManager</td><td>\u6307\u5B9A\u7F13\u5B58\u7BA1\u7406\u5668(\u5982ConcurrentHashMap\u3001Redis\u7B49)</td></tr><tr><td>cacheResolver</td><td>\u548CcacheManager\u529F\u80FD\u4E00\u6837\uFF0C\u548CcacheManager\u4E8C\u9009\u4E00</td></tr><tr><td>condition</td><td>\u6307\u5B9A\u7F13\u5B58\u7684\u6761\u4EF6(\u6EE1\u8DB3\u4EC0\u4E48\u6761\u4EF6\u65F6\u624D\u7F13\u5B58)\uFF0C\u53EF\u7528SpEL\u8868\u8FBE\u5F0F(\u5982 #id&gt;0\uFF0C\u8868\u793A\u5F53\u5165\u53C2id\u5927\u4E8E0\u65F6\u624D\u7F13\u5B58)</td></tr><tr><td>unless</td><td>\u5426\u5B9A\u7F13\u5B58\uFF0C\u5373\u6EE1\u8DB3unless\u6307\u5B9A\u7684\u6761\u4EF6\u65F6\uFF0C\u65B9\u6CD5\u7684\u7ED3\u679C\u4E0D\u8FDB\u884C\u7F13\u5B58\u3002\u4F7F\u7528unless\u65F6\u53EF\u4EE5\u5728\u8C03\u7528\u7684\u65B9\u6CD5\u83B7\u53D6\u5230\u7ED3\u679C\u4E4B\u540E\u518D\u8FDB\u884C\u5224\u65AD(\u5982 #result==null\uFF0C\u8868\u793A\u5982\u679C\u7ED3\u679C\u4E3Anull\u65F6\u4E0D\u7F13\u5B58)</td></tr><tr><td>sync</td><td>\u662F\u5426\u4F7F\u7528\u5F02\u6B65\u6A21\u5F0F\u8FDB\u884C\u7F13\u5B58</td></tr></tbody></table><blockquote><p>\u6CE8\u610F:</p><p>\u65E2\u6EE1\u8DB3condition\u53C8\u6EE1\u8DB3unless\u6761\u4EF6\u7684\u4E5F\u4E0D\u8FDB\u884C\u7F13\u5B58</p><p>\u4F7F\u7528\u5F02\u6B65\u6A21\u5F0F\u8FDB\u884C\u7F13\u5B58\u65F6(sync=true):unless\u6761\u4EF6\u5C06\u4E0D\u88AB\u652F\u6301</p></blockquote><p>\u53EF\u7528\u7684SpEL\u8868\u8FBE\u5F0F\u89C1\u4E0B\u8868:</p><table><thead><tr><th>\u540D\u5B57</th><th>\u4F4D\u7F6E</th><th>\u63CF\u8FF0</th><th>\u793A\u4F8B</th></tr></thead><tbody><tr><td>methodName</td><td>root object</td><td>\u5F53\u524D\u88AB\u8C03\u7528\u7684\u65B9\u6CD5\u540D</td><td>#root.methodName</td></tr><tr><td>target</td><td>root object</td><td>\u5F53\u524D\u88AB\u8C03\u7528\u7684\u76EE\u6807\u5BF9\u8C61</td><td>#root.target</td></tr><tr><td>args</td><td>root object</td><td>\u5F53\u524D\u88AB\u8C03\u7528\u7684\u65B9\u6CD5\u7684\u53C2\u6570\u5217\u8868</td><td>#root.args[0]</td></tr><tr><td>method</td><td>root</td><td>\u5F53\u524D\u88AB\u8C03\u7528\u7684\u65B9\u6CD5</td><td>#root.method.name object</td></tr><tr><td>targetClass</td><td>root</td><td>\u5F53\u524D\u88AB\u8C03\u7528\u7684\u76EE\u6807\u5BF9\u8C61\u7C7B</td><td>root.targetClass object</td></tr><tr><td>caches</td><td>root object</td><td>\u5F53\u524D\u65B9\u6CD5\u8C03\u7528\u4F7F\u7528\u7684\u7F13\u5B58\u5217\u8868 (\u5982@Cacheable(value= {\u201Ccache1\u201D, \u201Ccache2\u201D}))\uFF0C\u5219\u6709\u4E24 \u4E2Acache</td><td>#root.caches[0].name</td></tr><tr><td>argument name</td><td>evaluation context</td><td>\u65B9\u6CD5\u53C2\u6570\u7684\u540D\u5B57\uFF0C\u53EF\u4EE5\u76F4\u63A5 # \u53C2\u6570\u540D\uFF0C\u4E5F\u53EF\u4EE5\u4F7F\u7528#p0\u6216#a0 \u7684\u5F62\u5F0F\uFF0C0\u4EE3\u8868\u53C2\u6570\u7684\u7D22\u5F15</td><td>#iban\u3001#a0\u3001#p0</td></tr><tr><td>result</td><td>evaluation context</td><td>\u65B9\u6CD5\u6267\u884C\u540E\u7684\u8FD4\u56DE\u503C(\u4EC5\u5F53\u65B9\u6CD5 \u6267\u884C\u4E4B\u540E\u7684\u5224\u65AD\u6709\u6548\uFF0C \u5982&quot;unless&quot;\uFF0C&quot;cache put&quot;\u7684\u8868 \u8FBE\u5F0F\uFF0C&quot;cache evict&quot;\u7684\u8868\u8FBE\u5F0F beforeInvocation=false)</td><td>#result</td></tr></tbody></table><h3 id="\u7F13\u5B58\u81EA\u52A8\u914D\u7F6E\u539F\u7406\u6E90\u7801\u5256\u6790" tabindex="-1"><a class="header-anchor" href="#\u7F13\u5B58\u81EA\u52A8\u914D\u7F6E\u539F\u7406\u6E90\u7801\u5256\u6790" aria-hidden="true">#</a> \u7F13\u5B58\u81EA\u52A8\u914D\u7F6E\u539F\u7406\u6E90\u7801\u5256\u6790</h3><p>\u770B\u81EA\u52A8\u914D\u7F6E\u6E90\u7801\uFF0C\u8001\u65B9\u6CD5\uFF0C\u6211\u4EEC\u5148\u627E\u5230\u76F8\u5173\u7684\u81EA\u52A8\u914D\u7F6E\u7C7B\u3002 \u7F13\u5B58\u76F8\u5173\u7684\u81EA\u52A8\u914D\u7F6E\u7C7B\uFF1A<code>org.springframework.boot.autoconfigure.cache.CacheAutoConfiguration</code></p><p>\u5173\u6CE8\u4E09\u4EF6\u4E8B\uFF1A</p><ol><li>\u81EA\u52A8\u914D\u7F6E\u8FC7\u7A0B\u4E2D\uFF0C\u5B8C\u6210\u4E86\u90A3\u4E9BBean\u5BF9\u8C61\u7684\u521B\u5EFA\uFF1F\u505A\u4E86\u54EA\u4E9B\u4E8B\uFF1F</li><li>\u5F53\u524D\u7F13\u5B58\u5BF9\u8C61(Cache)\u4F7F\u7528\u7684\u5E95\u5C42\u6570\u636E\u7ED3\u6784\u662F\u4EC0\u4E48\uFF1F</li><li>\u6DFB\u52A0\u597D\u4F7F\u7528\u7F13\u5B58\u7684\u6CE8\u89E3\u540E\uFF0C\u67E5\u8BE2\u6D41\u7A0B\u6709\u4EC0\u4E48\u6837\u7684\u6539\u53D8\uFF1F</li></ol><p>\u6211\u4EEC\u9996\u5148\u770B\u7C7B\u7684\u58F0\u660E</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">CacheManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnBean</span><span class="token punctuation">(</span><span class="token class-name">CacheAspectSupport</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">CacheManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">&quot;cacheResolver&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">CacheProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@AutoConfigureAfter</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">CouchbaseAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">HazelcastAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
		<span class="token class-name">HibernateJpaAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">RedisAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">CacheConfigurationImportSelector</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">CacheManagerEntityManagerFactoryDependsOnPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CacheAutoConfiguration</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>\u4E00\u4E9B\u6761\u4EF6\u548C\u52A0\u8F7D\u65F6\u673A\u76F8\u5173\u7684\u6CE8\u89E3\u65E0\u9700\u8FC7\u591A\u5173\u6CE8\u3002\u6211\u4EEC\u4E3B\u8981\u5173\u6CE8\u4E24\u4E2A\u6CE8\u89E3<code>@EnableConfigurationProperties(CacheProperties.class)</code>\u548C<code>@Import</code></p><p><code>@EnableConfigurationProperties(CacheProperties.class)</code>\u8868\u793A\u53EF\u4EE5\u4F7F\u7528<code>spring.cache.xxx</code>\u6CE8\u89E3\u5B8C\u6210\u7F13\u5B58\u76F8\u5173\u7684\u5C5E\u6027\u6CE8\u5165\u3002</p><p><code>@Import</code>\u6CE8\u89E3\u5BFC\u5165\u4E86\u4E24\u4E2A\u7C7B\uFF0C\u6211\u4EEC\u9996\u5148\u770B\u7B2C\u4E00\u4E2A\uFF1A <code>CacheConfigurationImportSelector</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CacheConfigurationImportSelector</span> <span class="token keyword">implements</span> <span class="token class-name">ImportSelector</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">selectImports</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> importingClassMetadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">CacheType</span><span class="token punctuation">[</span><span class="token punctuation">]</span> types <span class="token operator">=</span> <span class="token class-name">CacheType</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> imports <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>types<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> types<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			imports<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">CacheConfigurations</span><span class="token punctuation">.</span><span class="token function">getConfigurationClass</span><span class="token punctuation">(</span>types<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> imports<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><code>selectImports</code>\u65B9\u6CD5\u6267\u884C\u5B8C\u6210\u4E4B\u540E\uFF0C\u8FD4\u56DE\u7684<code>imports</code>\u6570\u7EC4\u5305\u542B\u4E86\u6240\u6709\u652F\u6301\u7684\u7F13\u5B58\u7684\u7C7B\u578B\u7684\u5168\u9650\u5B9A\u7C7B\u540D\u5217\u8868\u3002</p><p>\u6211\u4EEC\u968F\u4FBF\u8FDB\u5165\u4E00\u4E2A\uFF0C\u6B64\u5904\u4EE5<code>RedisCacheConfiguration</code>\u4E3A\u4F8B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@AutoConfigureAfter</span><span class="token punctuation">(</span><span class="token class-name">RedisAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnBean</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token class-name">CacheManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Conditional</span><span class="token punctuation">(</span><span class="token class-name">CacheCondition</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">RedisCacheConfiguration</span> <span class="token punctuation">{</span>
    <span class="token comment">// </span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>\u5728\u7C7B\u58F0\u660E\u4E0A\u6DFB\u52A0\u4E86\u8BB8\u591A\u52A0\u8F7D\u7684\u6761\u4EF6\u3002\u56E0\u6B64\uFF0C\u5982\u679C\u8981\u4F7F\u8FD9\u4E2A\u914D\u7F6E\u7C7B\u751F\u6548\uFF0C\u9700\u8981\u5F15\u5165Redis\u76F8\u5173\u7684\u4F9D\u8D56\u3002 \u5982\u679C\u6CA1\u6709\u7279\u522B\u5F15\u5165\u7F13\u5B58\u76F8\u5173\u7684\u4F9D\u8D56\u65F6\uFF0C\u9ED8\u8BA4\u751F\u6548\u7684\u662F\uFF1A<code>SimpleCacheConfiguration</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token class-name">CacheManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Conditional</span><span class="token punctuation">(</span><span class="token class-name">CacheCondition</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">SimpleCacheConfiguration</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token class-name">ConcurrentMapCacheManager</span> <span class="token function">cacheManager</span><span class="token punctuation">(</span><span class="token class-name">CacheProperties</span> cacheProperties<span class="token punctuation">,</span>
			<span class="token class-name">CacheManagerCustomizers</span> cacheManagerCustomizers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">ConcurrentMapCacheManager</span> cacheManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentMapCacheManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cacheNames <span class="token operator">=</span> cacheProperties<span class="token punctuation">.</span><span class="token function">getCacheNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cacheNames<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			cacheManager<span class="token punctuation">.</span><span class="token function">setCacheNames</span><span class="token punctuation">(</span>cacheNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> cacheManagerCustomizers<span class="token punctuation">.</span><span class="token function">customize</span><span class="token punctuation">(</span>cacheManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>\u8BE5\u7C7B\u6CA1\u6709\u8FC7\u591A\u7684\u6761\u4EF6\u6CE8\u89E3\uFF0C\u4F1A\u9ED8\u8BA4\u751F\u6548\u3002</p><p>\u4ED6\u7ED9 Spring \u5BB9\u5668\u6DFB\u52A0\u4E86\u4E00\u4E2ABean\uFF0C\u662F\u4E00\u4E2A CacheManager \u3002\u81F3\u6B64\uFF0C\u7F13\u5B58\u81EA\u52A8\u914D\u7F6E\u5B8C\u6210\u3002 \u5BF9\u4E8E\u65B9\u6CD5\u7684\u6267\u884C\u8FC7\u7A0B\uFF0C\u4E0D\u5FC5\u8FC7\u591A\u5173\u5FC3\uFF0C\u6211\u4EEC\u6765\u770B\u770B\u6CE8\u5165\u7684\u8FD9\u4E2A<code>ConcurrentMapCacheManager</code>\u3002</p><p>ConcurrentMapCacheManager\u5B9E\u73B0\u4E86CacheManager\u63A5\u53E3\u3002 \u518D\u6765\u770B<code>ConcurrentMapCacheManager</code>\u7684getCache\u65B9\u6CD5</p><blockquote><p>\u7F13\u5B58\u6DFB\u52A0\u6210\u529F\u540E\uFF0C\u6267\u884C\u67E5\u8BE2\u7684\u65F6\u5019\uFF0C\u4F1A\u9996\u5148\u8FDB\u5165 getCache \u65B9\u6CD5\u3002</p></blockquote><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">public</span> <span class="token class-name">Cache</span> <span class="token function">getCache</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">Cache</span> cache <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cacheMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>cache <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dynamic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cacheMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			cache <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cacheMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>cache <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				cache <span class="token operator">=</span> <span class="token function">createConcurrentMapCache</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>cacheMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> cache<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>\u65B9\u6CD5\u6267\u884C\u8FC7\u7A0B\u4E2D\uFF0C\u5982\u679C\u83B7\u53D6 Cache \u5BF9\u8C61\u5931\u8D25\uFF0C\u5219\u4F1A\u521B\u5EFA\u4E00\u4E2A ConcurrentMapCache \u5BF9\u8C61\u5E76\u8FD4\u56DE\u3002</p><blockquote><p>\u6B64\u5904\u53EF\u77E5\uFF0C\u5F53\u524D\u7684\u7F13\u5B58\u5BF9\u8C61\u7684\u5E95\u5C42\u6570\u636E\u7ED3\u6784\u5C31\u662F\uFF1AConcurrentHashMap</p></blockquote><p>\u6211\u4EEC\u7EE7\u7EED\u8FDB\u5165\u8FD4\u56DE\u7684<code>ConcurrentMapCache</code>\u5BF9\u8C61\u5F53\u4E2D\uFF0C\u6211\u4EEC\u91CD\u70B9\u5173\u6CE8\u4E24\u4E2A\u65B9\u6CD5</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">lookup</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>\u4E0D\u96BE\u7406\u89E3\uFF0C\u5C31\u662F\u901A\u8FC7key\u67E5\u8BE2\u7F13\u5B58\u503C\u7684\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token function">toStoreValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>put\u65B9\u6CD5\uFF0C\u987E\u540D\u601D\u4E49\u5C31\u662F\u5411\u7F13\u5B58\u4E2D\u5B58\u5165\u6570\u636E\u7684\u3002</p><p><strong>@Cacheable\u8FD0\u884C\u6D41\u7A0B:</strong></p><ol><li><p>\u65B9\u6CD5\u8FD0\u884C\u4E4B\u524D\uFF0C\u5148\u53BB\u67E5\u8BE2Cache(\u7F13\u5B58\u7EC4\u4EF6)\uFF0C\u6309\u7167cacheNames\u6307\u5B9A\u7684\u540D\u5B57\u83B7\u53D6 (CacheManager\u5148\u83B7\u53D6\u76F8\u5E94\u7684\u7F13\u5B58\uFF0C\u7B2C\u4E00\u6B21\u83B7\u53D6\u7F13\u5B58\u5982\u679C\u6CA1\u6709Cache\u7EC4\u4EF6\u4F1A\u81EA\u52A8\u521B\u5EFA)</p></li><li><p>\u53BBCache\u4E2D\u67E5\u627E\u7F13\u5B58\u7684\u5185\u5BB9\uFF0C\u4F7F\u7528\u7684key\u9ED8\u8BA4\u5C31\u662F\u65B9\u6CD5\u7684\u53C2\u6570: key\u9ED8\u8BA4\u662F\u4F7F\u7528keyGenerator\u751F\u6210\u7684\uFF0C\u9ED8\u8BA4\u4F7F\u7528\u7684\u662FSimpleKeyGenerator</p></li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">generateKey</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token class-name">SimpleKey</span><span class="token punctuation">.</span>EMPTY<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Object</span> param <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>param <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>param<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> param<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SimpleKey</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><blockquote><p>SimpleKeyGenerator\u751F\u6210key\u7684\u9ED8\u8BA4\u7B56\u7565:</p><p>\u5982\u679C\u6CA1\u6709\u53C2\u6570:key = new SimpleKey();</p><p>\u5982\u679C\u6709\u4E00\u4E2A\u53C2\u6570:key = \u53C2\u6570\u7684\u503C</p><p>\u5982\u679C\u6709\u591A\u4E2A\u53C2\u6570:key = new SimpleKey(params);</p></blockquote><ol start="3"><li><p>\u6CA1\u6709\u67E5\u5230\u7F13\u5B58\u5C31\u8C03\u7528\u76EE\u6807\u65B9\u6CD5</p></li><li><p>\u5C06\u76EE\u6807\u65B9\u6CD5\u8FD4\u56DE\u7684\u7ED3\u679C\u653E\u8FDB\u7F13\u5B58\u4E2D</p></li></ol><p><strong>\u603B\u7ED3:</strong></p><p><code>@Cacheable</code>\u6807\u6CE8\u7684\u65B9\u6CD5\u5728\u6267\u884C\u4E4B\u524D\u4F1A\u5148\u68C0\u67E5\u7F13\u5B58\u4E2D\u6709\u6CA1\u6709\u8FD9\u4E2A\u6570\u636E\uFF0C\u9ED8\u8BA4\u6309\u7167\u53C2\u6570\u7684\u503C\u4E3Akey\u67E5\u8BE2\u7F13\u5B58\uFF0C \u5982\u679C\u6CA1\u6709\u5C31\u8FD0\u884C\u65B9\u6CD5\u5E76\u5C06\u7ED3\u679C\u653E\u5165\u7F13\u5B58\uFF0C\u4EE5\u540E\u518D\u6765\u8C03\u7528\u65F6\u76F4\u63A5\u4F7F\u7528\u7F13\u5B58\u4E2D\u7684\u6570\u636E\u3002</p><blockquote><p>\u6838\u5FC3</p><p>1\u3001\u4F7F\u7528<code>CacheManager(ConcurrentMapCacheManager)</code>\u6309\u7167\u540D\u5B57\u5F97\u5230<code>Cache(ConcurrentMapCache)</code>\u7EC4\u4EF6</p><p>2\u3001key\u4F7F\u7528keyGenerator\u751F\u6210\uFF0C\u9ED8\u8BA4\u4F7F\u7528SimpleKeyGenerator</p></blockquote><h3 id="\u5176\u4ED6\u5E38\u7528\u7F13\u5B58\u6CE8\u89E3" tabindex="-1"><a class="header-anchor" href="#\u5176\u4ED6\u5E38\u7528\u7F13\u5B58\u6CE8\u89E3" aria-hidden="true">#</a> \u5176\u4ED6\u5E38\u7528\u7F13\u5B58\u6CE8\u89E3</h3><p><strong>@CachePut</strong></p><p>\u8BF4\u660E:</p><p>\u65E2\u8C03\u7528\u65B9\u6CD5\uFF0C\u53C8\u66F4\u65B0\u7F13\u5B58\u6570\u636E\uFF0C<em>\u4E00\u822C\u7528\u4E8E\u66F4\u65B0\u64CD\u4F5C</em>\u3002 \u5728\u66F4\u65B0\u7F13\u5B58\u65F6\u4E00\u5B9A\u8981\u548C\u60F3\u66F4\u65B0\u7684\u7F13\u5B58\u6709<em>\u76F8\u540C\u540D\u79F0\u548C\u76F8\u540C\u7684key</em>(\u53EF\u7C7B\u6BD4\u540C\u4E00\u5F20\u8868\u7684\u540C\u4E00\u6761\u6570\u636E)</p><p>\u8FD0\u884C\u65F6\u673A:</p><p>\u5148\u8C03\u7528\u76EE\u6807\u65B9\u6CD5\uFF0C\u7136\u540E\u5C06\u76EE\u6807\u65B9\u6CD5\u7684\u7ED3\u679C\u7F13\u5B58\u8D77\u6765</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@CachePut</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;emp&quot;</span><span class="token punctuation">,</span>key <span class="token operator">=</span> <span class="token string">&quot;#employee.id&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Employee</span> <span class="token function">updateEmp</span><span class="token punctuation">(</span><span class="token class-name">Employee</span> employee<span class="token punctuation">)</span><span class="token punctuation">{</span>
    employeeMapper<span class="token punctuation">.</span><span class="token function">updateEmp</span><span class="token punctuation">(</span>employee<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> employee<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><p><code>@CachePut</code>\u6807\u6CE8\u7684\u65B9\u6CD5\u603B\u4F1A\u88AB\u8C03\u7528\uFF0C\u4E14\u8C03\u7528\u4E4B\u540E\u624D\u5C06\u7ED3\u679C\u653E\u5165\u7F13\u5B58\uFF0C\u56E0\u6B64\u53EF\u4EE5\u4F7F\u7528<code>#result</code>\u83B7\u53D6\u5230\u65B9\u6CD5\u7684\u8FD4\u56DE\u503C\u3002</p></blockquote><p><strong>@CacheEvict</strong></p><p>\u8BF4\u660E:</p><p>\u7F13\u5B58\u6E05\u9664\uFF0C\u6E05\u9664\u7F13\u5B58\u65F6\u8981\u6307\u660E\u7F13\u5B58\u7684\u540D\u5B57\u548Ckey\uFF0C\u76F8\u5F53\u4E8E\u544A\u8BC9\u6570\u636E\u5E93\u8981\u5220\u9664\u54EA\u4E2A\u8868\u4E2D\u7684\u54EA\u6761\u6570\u636E\uFF0Ckey\u9ED8\u8BA4\u4E3A\u53C2\u6570\u7684\u503C</p><p>\u5C5E\u6027:</p><ul><li>value/cacheNames: \u7F13\u5B58\u7684\u540D\u5B57</li><li>key: \u7F13\u5B58\u7684\u952E</li><li>allEntries: \u662F\u5426\u6E05\u9664\u6307\u5B9A\u7F13\u5B58\u4E2D\u7684\u6240\u6709\u952E\u503C\u5BF9\uFF0C\u9ED8\u8BA4\u4E3Afalse\uFF0C\u8BBE\u7F6E\u4E3Atrue\u65F6\u4F1A\u6E05\u9664\u7F13\u5B58\u4E2D\u7684\u6240\u6709\u952E\u503C\u5BF9\uFF0C\u4E0Ekey\u5C5E\u6027\u4E8C\u9009\u4E00\u4F7F\u7528</li><li>beforeInvocation: \u5728<code>@CacheEvict</code>\u6CE8\u89E3\u7684\u65B9\u6CD5\u8C03\u7528\u4E4B\u524D\u6E05\u9664\u6307\u5B9A\u7F13\u5B58\uFF0C\u9ED8\u8BA4\u4E3Afalse\uFF0C\u5373\u5728\u65B9\u6CD5\u8C03\u7528\u4E4B\u540E\u6E05\u9664\u7F13\u5B58\uFF1B \u8BBE\u7F6E\u4E3Atrue\u65F6\u5219\u4F1A\u5728\u65B9\u6CD5\u8C03\u7528\u4E4B\u524D\u6E05\u9664\u7F13\u5B58 (\u5728\u65B9\u6CD5\u8C03\u7528\u4E4B\u524D\u8FD8\u662F\u4E4B\u540E\u6E05\u9664\u7F13\u5B58\u7684\u533A\u522B\u5728\u4E8E\uFF0C\u65B9\u6CD5\u8C03\u7528\u65F6\u662F\u5426\u4F1A\u51FA\u73B0\u5F02\u5E38\u3002 \u82E5\u4E0D\u51FA\u73B0\u5F02\u5E38\uFF0C\u8FD9\u4E24\u79CD\u8BBE\u7F6E\u6CA1\u6709\u533A\u522B\uFF1B\u82E5\u51FA\u73B0\u5F02\u5E38\uFF0C\u8BBE\u7F6E\u4E3A\u5728\u65B9\u6CD5\u8C03\u7528\u4E4B\u540E\u6E05\u9664\u7F13\u5B58\u5C06\u4E0D\u8D77\u4F5C\u7528\uFF0C\u56E0\u4E3A\u65B9\u6CD5\u8C03\u7528\u5931\u8D25\u4E86)</li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@CacheEvict</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;emp&quot;</span><span class="token punctuation">,</span>key <span class="token operator">=</span> <span class="token string">&quot;#id&quot;</span><span class="token punctuation">,</span>beforeInvocation <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delEmp</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
    employeeMapper<span class="token punctuation">.</span><span class="token function">deleteEmpById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>@CacheConfig</strong></p><p>\u4F5C\u7528:</p><p>\u6807\u6CE8\u5728\u7C7B\u4E0A\uFF0C\u62BD\u53D6\u7F13\u5B58\u76F8\u5173\u6CE8\u89E3\u7684\u516C\u5171\u914D\u7F6E\uFF0C\u53EF\u62BD\u53D6\u7684\u516C\u5171\u914D\u7F6E\u6709\u7F13\u5B58\u540D\u5B57\u3001\u4E3B\u952E\u751F\u6210\u5668\u7B49(\u5982\u6CE8\u89E3\u4E2D\u7684\u5C5E\u6027\u6240\u793A)</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">CacheConfig</span> <span class="token punctuation">{</span>

	<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">cacheNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token class-name">String</span> <span class="token function">keyGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

	<span class="token class-name">String</span> <span class="token function">cacheManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

	<span class="token class-name">String</span> <span class="token function">cacheResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>\u901A\u8FC7<code>@CacheConfig</code>\u7684cacheNames\u5C5E\u6027\u6307\u5B9A\u7F13\u5B58\u7684\u540D\u5B57\u4E4B\u540E\uFF0C\u8BE5\u7C7B\u4E2D\u7684\u5176\u4ED6\u7F13\u5B58\u6CE8\u89E3\u5C31\u4E0D\u5FC5\u518D\u5199value\u6216\u8005cacheName\u4E86\uFF0C\u4F1A\u4F7F\u7528\u8BE5\u540D\u5B57\u4F5C\u4E3Avalue\u6216cacheName\u7684\u503C\u3002 \u5F53\u7136\u4E5F\u9075\u5FAA\u5C31\u8FD1\u539F\u5219\u3002</p><h3 id="\u57FA\u4E8Eredis\u7684\u7F13\u5B58\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#\u57FA\u4E8Eredis\u7684\u7F13\u5B58\u5B9E\u73B0" aria-hidden="true">#</a> \u57FA\u4E8ERedis\u7684\u7F13\u5B58\u5B9E\u73B0</h3><p>SpringBoot\u9ED8\u8BA4\u5F00\u542F\u7684\u7F13\u5B58\u7BA1\u7406\u5668\u662F<code>ConcurrentMapCacheManager</code>\uFF0C\u521B\u5EFA\u7F13\u5B58\u7EC4\u4EF6\u662FConcurrentMapCache\uFF0C\u5C06\u7F13\u5B58\u6570\u636E\u4FDD\u5B58\u5728\u4E00\u4E2A\u4E2A\u7684ConcurrentHashMap&lt;Object, Object&gt;\u4E2D\u3002</p><p>\u5F00\u53D1\u65F6\u6211\u4EEC\u53EF\u4EE5\u4F7F\u7528\u7F13\u5B58\u4E2D\u95F4\u4EF6:redis\u3001memcache\u3001ehcache\u7B49\uFF0C\u8FD9\u4E9B\u7F13\u5B58\u4E2D\u95F4\u4EF6\u7684\u542F\u7528\u5F88\u7B80\u5355 \u2014\u2014 \u53EA\u8981\u5411\u5BB9\u5668\u4E2D\u52A0\u5165\u76F8\u5173\u7684bean\u5C31\u4F1A\u542F\u7528\uFF0C\u53EF\u4EE5\u542F\u7528\u591A\u4E2A\u7F13\u5B58\u4E2D\u95F4\u4EF6\u3002</p><p>\u6211\u4EEC\u4EE5 Redis \u4E3A\u4F8B</p><p>\u9996\u5148\u5F15\u5165\u4F9D\u8D56</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>\u7167\u4F8B\u6211\u4EEC\u770B\u770BRedis\u81EA\u52A8\u914D\u7F6E\u505A\u4E86\u54EA\u4E9B\u4E8B\u60C5\uFF0C \u8001\u65B9\u6CD5\uFF0C\u6211\u4EEC\u627E\u5230Redis\u7684\u81EA\u52A8\u914D\u7F6E\u7C7B<code>org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>
    proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">RedisOperations</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">RedisProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">LettuceConnectionConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">JedisConnectionConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisAutoConfiguration</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisAutoConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>
        name <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;redisTemplate&quot;</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConditionalOnSingleCandidate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> template<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnMissingBean</span>
    <span class="token annotation punctuation">@ConditionalOnSingleCandidate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">StringRedisTemplate</span> <span class="token function">stringRedisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringRedisTemplate</span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringRedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> template<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>\u9996\u5148\u770B\u7C7B\u7684\u58F0\u660E\uFF0C<code>@EnableConfigurationProperties</code>\u6CE8\u89E3\u6307\u5B9A\u4E86Redis\u53EF\u4EE5\u4F7F\u7528\u7684\u914D\u7F6E\uFF0C\u540C\u65F6\u8FD8\u5F15\u5165\u4E86\u4E24\u4E2A\u914D\u7F6E\u7C7B\uFF0C\u6211\u4EEC\u8D5E\u4E0D\u5173\u6CE8\u3002</p><p>\u7C7B\u5185\u90E8\u5411\u5BB9\u5668\u4E2D\u6CE8\u5165\u4E86\u4E24\u4E2ABean\uFF1A<code>RedisTemplate</code>\u548C<code>StringRedisTemplate</code>\u3002 \u5176\u4E2D<code>StringRedisTemplate</code>\u662F\u7528\u6765\u64CD\u4F5C\u5B57\u7B26\u4E32\uFF0Ckey\u548Cvalue\u90FD\u662F\u5B57\u7B26\u4E32\u7684\u60C5\u51B5\u3002\u8FD9\u662F\u57FA\u4E8E\u6211\u4EEC\u7F13\u5B58\u5F88\u591A\u60C5\u51B5\u4E0B\u90FD\u662F\u5B57\u7B26\u4E32\u7684\u8BBE\u8BA1\u3002</p><p>\u81F3\u6B64\uFF0CRedis\u81EA\u52A8\u914D\u7F6E\u5B8C\u6210\uFF0C\u6211\u4EEC\u53EF\u4EE5\u5728\u4EE3\u7801\u4E2D\u76F4\u63A5\u4F7F\u7528<code>@Autowired</code>\u6CE8\u89E3\u6CE8\u5165\u4E24\u4E2A Template \u64CD\u4F5CRedis\u7F13\u5B58\u3002</p><blockquote><p>\u4F7F\u7528redis\u5B58\u50A8\u5BF9\u8C61\u65F6\uFF0C\u8BE5\u5BF9\u8C61\u5FC5\u987B\u53EF\u5E8F\u5217\u5316(\u5B9E\u73B0Serializable\u63A5\u53E3)\uFF0C\u5426\u5219\u4F1A\u62A5\u9519\u3002</p></blockquote><h3 id="\u81EA\u5B9A\u4E49rediscachemanager" tabindex="-1"><a class="header-anchor" href="#\u81EA\u5B9A\u4E49rediscachemanager" aria-hidden="true">#</a> \u81EA\u5B9A\u4E49RedisCacheManager</h3><p>SpringBoot\u9ED8\u8BA4\u91C7\u7528\u7684\u662FJDK\u7684\u5BF9\u8C61\u5E8F\u5217\u5316\u65B9\u5F0F\uFF0C\u6211\u4EEC\u53EF\u4EE5\u5207\u6362\u4E3A\u4F7F\u7528JSON\u683C\u5F0F\u8FDB\u884C\u5BF9\u8C61\u7684\u5E8F\u5217\u5316\u64CD\u4F5C\uFF0C \u8FD9\u65F6\u9700\u8981\u6211\u4EEC\u81EA\u5B9A\u4E49\u5E8F\u5217\u5316\u89C4\u5219(\u5F53\u7136\u6211\u4EEC\u4E5F\u53EF\u4EE5\u4F7F\u7528Json\u5DE5\u5177\u5148\u5C06\u5BF9\u8C61\u8F6C\u5316\u4E3AJson\u683C\u5F0F\u4E4B\u540E\u518D\u4FDD\u5B58\u81F3redis\uFF0C\u8FD9\u6837\u5C31\u65E0\u9700\u81EA\u5B9A\u4E49\u5E8F\u5217\u5316)</p><p><strong>Redis\u6CE8\u89E3\u9ED8\u8BA4\u5E8F\u5217\u5316\u673A\u5236</strong></p><p>\u4E00\u5207\u591A\u8981\u4ECESpringBoot\u7F13\u5B58\u81EA\u52A8\u914D\u7F6E\u8BF4\u8D77\u3002 \u5728\u7F13\u5B58\u81EA\u52A8\u914D\u7F6E\u7C7B\u4E2D\u5BFC\u5165\u4E86\u4E00\u4E2A\u7C7B\uFF1A<code>CacheConfigurationImportSelector</code>\uFF0C\u800C\u8FD9\u4E2A\u7C7B\u53EA\u6709\u4E00\u4E2A\u65B9\u6CD5<code>selectImports</code>\u3002 \u5728\u8FD9\u4E2A\u65B9\u6CD5\u4E2D\uFF0C\u4F1A\u5FAA\u73AF\u4F9D\u6B21\u5C1D\u8BD5\u52A0\u8F7DSpringBoot\u652F\u6301\u5404\u79CD\u7F13\u5B58\u914D\u7F6E\u7C7B\uFF0C\u76F4\u5230Spring\u5BB9\u5668\u4E2D\u5B58\u5728\u4E86CacheManager\u5BF9\u8C61\u4E3A\u6B62\u3002 \u52A0\u8F7D\u987A\u5E8F\u53C2\u89C1<code>CacheConfigurations#MAPPINGS</code>\u6570\u7EC4\u3002</p><p>\u65E2\u7136\u8981\u770BRedis\u7684\u9ED8\u8BA4\u5E8F\u5217\u5316\u673A\u5236\uFF0C\u6211\u4EEC\u8FDB\u5165\u8FD9\u4E2A\u6570\u7EC4\u7684<code>RedisCacheConfiguration</code>\u7C7B\u4E2D\u3002</p><p>\u8FD9\u4E2A\u7C7B\u4E3B\u8981\u662F\u5411\u5BB9\u5668\u4E2D\u6CE8\u5165\u4E86\u4E00\u4E2A<code>cacheManager</code>\u5BF9\u8C61\u3002\u800C\u8FD9\u4E2A\u65B9\u6CD5\u6700\u7EC8\u4F1A\u8C03\u7528\u5230\u4E00\u884C\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">serializeValuesWith</span><span class="token punctuation">(</span>
				<span class="token class-name">SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JdkSerializationRedisSerializer</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>\u56E0\u6B64\uFF0C\u6211\u4EEC\u8BF4SpringBoot\u9ED8\u8BA4\u91C7\u7528\u7684\u662FJDK\u7684\u5BF9\u8C61\u5E8F\u5217\u5316\u65B9\u5F0F\u3002</p><blockquote><p>RedisCacheConfiguration\u5185\u90E8\u540C\u6837\u901A\u8FC7Redis\u8FDE\u63A5\u5DE5\u5382RedisConnectionFactory\u5B9A\u4E49\u4E86\u4E00\u4E2A\u7F13\u5B58\u7BA1\u7406\u5668RedisCacheManager;</p><p>\u540C\u65F6\u5B9A\u5236RedisCacheManager\u65F6\uFF0C\u4E5F\u9ED8\u8BA4\u4F7F\u7528\u4E86JdkSerializationRedisSerializer\u5E8F\u5217\u5316\u65B9\u5F0F</p></blockquote><p><strong>\u81EA\u5B9A\u4E49RedisCacheManager</strong></p><p>\u6211\u4EEC\u518D\u56DE\u5934\u770B\u8FD9\u4E2A\u7C7B\u7684\u58F0\u660E\u4E0A\u3002\u6709\u4E00\u884C<code>@ConditionalOnMissingBean(CacheManager.class)</code>\uFF0C \u56E0\u6B64\u6211\u4EEC\u53EF\u4EE5\u81EA\u5B9A\u4E49\u7C7B\u7136\u540E\u6CE8\u5165\u4E00\u4E2A<code>CacheManager</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisCacheConfig</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisCacheManager</span> <span class="token function">cacheManager</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span>
                                                  redisConnectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u5206\u522B\u521B\u5EFAString\u548CJSON\u683C\u5F0F\u5E8F\u5217\u5316\u5BF9\u8C61\uFF0C\u5BF9\u7F13\u5B58\u6570\u636Ekey\u548Cvalue\u8FDB\u884C\u8F6C\u6362 </span>
        <span class="token class-name">RedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> strSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Jackson2JsonRedisSerializer</span> jacksonSeial <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u89E3\u51B3\u67E5\u8BE2\u7F13\u5B58\u8F6C\u6362\u5F02\u5E38\u7684\u95EE\u9898</span>
        <span class="token class-name">ObjectMapper</span> om <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        om<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token class-name">PropertyAccessor</span><span class="token punctuation">.</span>ALL<span class="token punctuation">,</span> <span class="token class-name">JsonAutoDetect<span class="token punctuation">.</span>Visibility</span><span class="token punctuation">.</span>ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        om<span class="token punctuation">.</span><span class="token function">enableDefaultTyping</span><span class="token punctuation">(</span><span class="token class-name">ObjectMapper<span class="token punctuation">.</span>DefaultTyping</span><span class="token punctuation">.</span>NON_FINAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jacksonSeial<span class="token punctuation">.</span><span class="token function">setObjectMapper</span><span class="token punctuation">(</span>om<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u5B9A\u5236\u7F13\u5B58\u6570\u636E\u5E8F\u5217\u5316\u65B9\u5F0F\u53CA\u65F6\u6548</span>
        <span class="token class-name">RedisCacheConfiguration</span> config <span class="token operator">=</span>
                <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">.</span><span class="token function">defaultCacheConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">entryTtl</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofDays</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">serializeKeysWith</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span>
                                <span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span>strSerializer<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">serializeValuesWith</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span>
                                <span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span>jacksonSeial<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">disableCachingNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RedisCacheManager</span> cacheManager <span class="token operator">=</span> <span class="token class-name">RedisCacheManager</span>
                <span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cacheDefaults</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cacheManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>\u5728\u5B9A\u4E49\u7684Bean\u7EC4\u4EF6\u4E2D\uFF0C\u901A\u8FC7RedisCacheConfiguration\u5BF9\u7F13\u5B58\u6570\u636E\u7684key\u548Cvalue\u5206\u522B\u8FDB\u884C\u4E86\u5E8F\u5217\u5316\u65B9\u5F0F\u7684\u5B9A\u5236\u3002 \u5176\u4E2D\u7F13\u5B58\u6570\u636E\u7684key\u5B9A\u5236\u4E3AStringRedisSerializer(\u5373String\u683C\u5F0F)\uFF0C\u800Cvalue\u5B9A\u5236\u4E3A\u4E86Jackson2JsonRedisSerializer(\u5373JSON\u683C\u5F0F)\uFF0C \u540C\u65F6\u8FD8\u4F7F\u7528<code>entryTtl(Duration.ofDays(1))</code>\u65B9\u6CD5\u5C06\u7F13\u5B58\u6570\u636E\u6709\u6548\u671F\u8BBE\u7F6E\u4E3A1\u5929\u3002</p><p>\u5B8C\u6210\u57FA\u4E8E\u6CE8\u89E3\u7684Redis\u7F13\u5B58\u7BA1\u7406\u5668RedisCacheManager\u5B9A\u5236\u540E\uFF0C\u53EF\u4EE5\u5BF9\u8BE5\u7F13\u5B58\u7BA1\u7406\u5668\u7684\u6548\u679C\u8FDB\u884C\u6D4B\u8BD5 (\u4F7F\u7528\u81EA\u5B9A\u4E49\u5E8F\u5217\u5316\u673A\u5236\u7684RedisCacheManager\u6D4B\u8BD5\u65F6\uFF0C\u5B9E\u4F53\u7C7B\u53EF\u4EE5\u4E0D\u7528\u5B9E\u73B0\u5E8F\u5217\u5316\u63A5\u53E3)</p><h2 id="\u90E8\u7F72\u4E0E\u76D1\u63A7" tabindex="-1"><a class="header-anchor" href="#\u90E8\u7F72\u4E0E\u76D1\u63A7" aria-hidden="true">#</a> \u90E8\u7F72\u4E0E\u76D1\u63A7</h2><h3 id="\u591A\u73AF\u5883\u90E8\u7F72" tabindex="-1"><a class="header-anchor" href="#\u591A\u73AF\u5883\u90E8\u7F72" aria-hidden="true">#</a> \u591A\u73AF\u5883\u90E8\u7F72</h3><p>\u5728\u9879\u76EE\u8FD0\u884C\u4E2D\uFF0C\u5305\u62EC\u591A\u79CD\u73AF\u5883\uFF0C\u4F8B\u5982\u7EBF\u4E0A\u73AF\u5883prod(product)\u3001\u5F00\u53D1\u73AF\u5883dev(development)\u3001\u6D4B\u8BD5 \u73AF\u5883test\u3001\u63D0\u6D4B\u73AF\u5883qa\u3001\u5355\u5143\u6D4B\u8BD5unitest\u7B49\u7B49\u3002 \u4E0D\u540C\u7684\u73AF\u5883\u9700\u8981\u8FDB\u884C\u4E0D\u540C\u7684\u914D\u7F6E\uFF0C\u4ECE\u800C\u5728\u4E0D\u540C\u7684\u573A\u666F\u4E2D\u8DD1\u6211\u4EEC\u7684\u7A0B\u5E8F\u3002\u4F8B\u5982prod\u73AF\u5883\u548Cdev\u73AF\u5883\u901A\u5E38\u9700\u8981\u8FDE\u63A5\u4E0D\u540C\u7684\u6570\u636E\u5E93\u3001\u9700\u8981\u914D\u7F6E\u4E0D\u540C\u7684\u65E5\u5FD7\u8F93\u51FA\u914D\u7F6E\u3002 \u8FD8\u6709\u4E00\u4E9B\u7C7B\u548C\u65B9\u6CD5\uFF0C\u5728\u4E0D\u540C\u7684\u73AF\u5883\u4E0B\u6709\u4E0D\u540C\u7684\u5B9E\u73B0\u65B9\u5F0F\u3002</p><p>Spring Boot \u5BF9\u6B64\u63D0\u4F9B\u4E86\u652F\u6301\uFF0C\u4E00\u65B9\u9762\u662F\u6CE8\u89E3@Profile\uFF0C\u53E6\u4E00\u65B9\u9762\u8FD8\u6709\u591A\u8D44\u6E90\u914D\u7F6E\u6587\u4EF6\u3002</p><h4 id="profile-\u6CE8\u89E3" tabindex="-1"><a class="header-anchor" href="#profile-\u6CE8\u89E3" aria-hidden="true">#</a> @Profile \u6CE8\u89E3</h4><p><code>@profile</code>\u6CE8\u89E3\u7684\u4F5C\u7528\u662F\u6307\u5B9A\u7C7B\u6216\u65B9\u6CD5\u5728\u7279\u5B9A\u7684Profile\u73AF\u5883\u751F\u6548\uFF0C\u4EFB\u4F55<code>@Component</code>\u6216<code>@Configuration</code>\u6CE8\u89E3\u7684\u7C7B\u90FD\u53EF\u4EE5\u4F7F\u7528<code>@Profile</code>\u6CE8\u89E3\u3002 \u5728\u4F7F\u7528DI\u6765\u4F9D\u8D56\u6CE8\u5165\u7684\u65F6\u5019\uFF0C\u80FD\u591F\u6839\u636E<code>@Profile</code>\u6807\u660E\u7684\u73AF\u5883\uFF0C\u6CE8\u5165\u7B26\u5408\u5F53\u524D\u8FD0\u884C\u73AF\u5883\u7684\u76F8\u5E94\u7684Bean\u3002</p><p>\u4F7F\u7528\u8981\u6C42:</p><ul><li><p>@Component \u6216 @Configuration \u6CE8\u89E3\u7684\u7C7B\u53EF\u4EE5\u4F7F\u7528 @profile</p></li><li><p>@Profile \u4E2D\u9700\u8981\u6307\u5B9A\u4E00\u4E2A\u5B57\u7B26\u4E32\uFF0C\u7EA6\u5B9A\u751F\u6548\u7684\u73AF\u5883</p></li></ul><blockquote><p>@Profile \u6CE8\u89E3\u652F\u6301\u5B9A\u4E49\u5728\u5176\u4ED6\u6CE8\u89E3\u4E4B\u4E0A</p></blockquote><p><strong>Profile\u6FC0\u6D3B</strong></p><p>\u5B9E\u9645\u4F7F\u7528\u4E2D\uFF0C\u6CE8\u89E3\u4E2D\u6807\u793A\u4E86prod\u3001test\u3001qa\u7B49\u591A\u4E2A\u73AF\u5883\uFF0C\u8FD0\u884C\u65F6\u4F7F\u7528\u54EA\u4E2Aprofile\u7531<code>spring.profiles.active</code>\u63A7\u5236\uFF0C \u4EE5\u4E0B\u8BF4\u660E2\u79CD\u65B9\u5F0F:\u914D\u7F6E\u6587\u4EF6\u65B9\u5F0F\u3001\u547D\u4EE4\u884C\u65B9\u5F0F\u3002</p><ol><li>\u914D\u7F6E\u6587\u4EF6\u65B9\u5F0F\u6FC0\u6D3Bprofile</li></ol><p>\u786E\u5B9A\u5F53\u524D\u4F7F\u7528\u7684\u662F\u54EA\u4E2A\u73AF\u5883\uFF0C\u73AF\u5883\u7684\u503C\u4E0Eapplication-prod.properties\u4E2D-\u540E\u9762\u7684\u503C\u5BF9\u5E94\uFF0C\u8FD9\u662FSpringBoot\u7EA6\u5B9A\u597D\u7684\u3002 \u5728<code>resources/application.properties</code>\u4E2D\u6DFB\u52A0\u4E0B\u9762\u7684\u914D\u7F6E\u3002</p><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">spring.profiles.active</span><span class="token punctuation">=</span><span class="token value attr-value">dev</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><blockquote><p>\u9700\u8981\u6CE8\u610F\u7684\u662F\uFF0Cspring.profiles.active \u7684\u53D6\u503C\u5E94\u8BE5\u4E0E @Profile \u6CE8\u89E3\u4E2D\u7684\u6807\u793A\u4FDD\u6301\u4E00\u81F4\u3002</p></blockquote><p>\u9664\u6B64\u4E4B\u5916\uFF0C\u540C\u7406\u8FD8\u53EF\u4EE5\u5728<code>resources/application.yml</code>\u4E2D\u914D\u7F6E\uFF0C\u6548\u679C\u662F\u4E00\u6837\u7684:</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="2"><li>\u547D\u4EE4\u884C\u65B9\u5F0F\u6FC0\u6D3Bprofile</li></ol><p>\u5728\u6253\u5305\u540E\u8FD0\u884C\u7684\u65F6\u5019\uFF0C\u6DFB\u52A0\u53C2\u6570:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>java -jar spring-boot-config-0.0.1-SNAPSHOT.jar --spring.profiles.active<span class="token operator">=</span>dev
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="\u591Aprofile\u7684\u8D44\u6E90\u6587\u4EF6" tabindex="-1"><a class="header-anchor" href="#\u591Aprofile\u7684\u8D44\u6E90\u6587\u4EF6" aria-hidden="true">#</a> \u591AProfile\u7684\u8D44\u6E90\u6587\u4EF6</h4><p>\u9664\u4E86<code>@Profile</code>\u6CE8\u89E3\u7684\u53EF\u4EE5\u6307\u5B9A\u67D0\u4E9B\u65B9\u6CD5\u548C\u7C7B\u5177\u4F53\u5728\u54EA\u4E2A\u73AF\u5883\u4E0B\u6CE8\u5165\u3002 springboot\u7684\u73AF\u5883\u9694\u79BB\u8FD8\u53EF\u4EE5\u4F7F\u7528\u591A\u8D44\u6E90\u6587\u4EF6\u7684\u65B9\u5F0F\uFF0C\u8FDB\u884C\u4E00\u4E9B\u53C2\u6570\u7684\u914D\u7F6E\u3002</p><p><strong>\u8D44\u6E90\u914D\u7F6E\u6587\u4EF6</strong></p><p>Springboot\u7684\u8D44\u6E90\u914D\u7F6E\u6587\u4EF6\u9664\u4E86<code>application.properties</code>\u4E4B\u5916\uFF0C\u8FD8\u53EF\u4EE5\u6709\u5BF9\u5E94\u7684\u8D44\u6E90\u6587\u4EF6 application-{profile}.properties\u3002</p><p>\u5047\u8BBE\uFF0C\u4E00\u4E2A\u5E94\u7528\u7684\u5DE5\u4F5C\u73AF\u5883\u6709: dev\u3001test\u3001prod \u90A3\u4E48\uFF0C\u6211\u4EEC\u53EF\u4EE5\u6DFB\u52A0 4 \u4E2A\u914D\u7F6E\u6587\u4EF6:</p><ul><li><code>application.properties</code> - \u516C\u5171\u914D\u7F6E</li><li><code>application-dev.properties</code> - \u5F00\u53D1\u73AF\u5883\u914D\u7F6E</li><li><code>application-test.properties</code> - \u6D4B\u8BD5\u73AF\u5883\u914D\u7F6E</li><li><code>application-prod.properties</code> - \u751F\u4EA7\u73AF\u5883\u914D\u7F6E</li></ul><p>\u4E0D\u540C\u7684<code>properties</code>\u914D\u7F6E\u6587\u4EF6\u4E5F\u53EF\u4EE5\u5728<code>application.properties</code>\u6587\u4EF6\u4E2D\u6765\u6FC0\u6D3B <code>profile: spring.profiles.active=test</code></p><h2 id="springboot\u76D1\u63A7" tabindex="-1"><a class="header-anchor" href="#springboot\u76D1\u63A7" aria-hidden="true">#</a> SpringBoot\u76D1\u63A7</h2><p>\u5FAE\u670D\u52A1\u7684\u7279\u70B9\u51B3\u5B9A\u4E86\u529F\u80FD\u6A21\u5757\u7684\u90E8\u7F72\u662F\u5206\u5E03\u5F0F\u7684\uFF0C\u5927\u90E8\u5206\u529F\u80FD\u6A21\u5757\u90FD\u662F\u8FD0\u884C\u5728\u4E0D\u540C\u7684\u673A\u5668\u4E0A\uFF0C\u5F7C\u6B64\u901A\u8FC7\u670D\u52A1\u8C03\u7528\u8FDB\u884C\u4EA4\u4E92\uFF0C \u524D\u540E\u53F0\u7684\u4E1A\u52A1\u6D41\u4F1A\u7ECF\u8FC7\u5F88\u591A\u4E2A\u5FAE\u670D\u52A1\u7684\u5904\u7406\u548C\u4F20\u9012\uFF0C\u51FA\u73B0\u4E86\u5F02\u5E38\u5982\u4F55\u5FEB\u901F\u5B9A\u4F4D\u662F\u54EA\u4E2A\u73AF\u8282\u51FA\u73B0\u4E86\u95EE\u9898?</p><p>\u5728\u8FD9\u79CD\u60C5\u51B5\u4E0B\uFF0C\u5FAE\u670D\u52A1\u7684\u76D1\u63A7\u663E\u5F97\u5C24\u4E3A\u91CD\u8981\u3002springboot\u4F5C\u4E3A\u5FAE\u670D\u52A1\u6846\u67B6\uFF0C\u9664\u4E86\u5B83\u5F3A\u5927\u7684\u5FEB\u901F\u5F00\u53D1\u529F\u80FD\u5916\uFF0C\u8FD8\u6709\u5C31\u662F\u5B83\u63D0\u4F9B\u4E86actuator\u6A21\u5757\uFF0C \u5F15\u5165\u8BE5\u6A21\u5757\u80FD\u591F\u81EA\u52A8\u4E3Aspringboot\u5E94\u7528\u63D0\u4F9B\u4E00\u7CFB\u5217\u7528\u4E8E\u76D1\u63A7\u7684\u7AEF\u70B9\u3002</p><h3 id="actuator" tabindex="-1"><a class="header-anchor" href="#actuator" aria-hidden="true">#</a> Actuator</h3><p><strong>\u4EC0\u4E48\u662FActuator</strong></p><p>Actuator\u662F SpringBoot \u7684\u4E00\u4E2A\u9644\u52A0\u529F\u80FD,\u53EF\u5E2E\u52A9\u4F60\u5728\u5E94\u7528\u7A0B\u5E8F\u751F\u4EA7\u73AF\u5883\u65F6\u76D1\u89C6\u548C\u7BA1\u7406\u5E94\u7528\u7A0B\u5E8F\u3002 \u53EF\u4EE5\u4F7F\u7528HTTP\u7684\u5404\u79CD\u8BF7\u6C42\u6765\u76D1\u7BA1,\u5BA1\u8BA1,\u6536\u96C6\u5E94\u7528\u7684\u8FD0\u884C\u60C5\u51B5\u3002</p><p>SpringBoot Actuator\u63D0\u4F9B\u4E86\u5BF9\u5355\u4E2A SpringBoot \u7684\u76D1\u63A7\uFF0C\u4FE1\u606F\u5305\u542B:\u5E94\u7528\u72B6\u6001\u3001\u5185\u5B58\u3001\u7EBF\u7A0B\u3001\u5806\u6808\u7B49\u7B49\uFF0C\u6BD4\u8F83\u5168\u9762\u7684\u76D1\u63A7\u4E86Spring Boot\u5E94\u7528\u7684\u6574\u4E2A\u751F\u547D\u5468\u671F\u3002 \u7279\u522B\u5BF9\u4E8E\u5FAE\u670D\u52A1\u7BA1\u7406\u5341\u5206\u6709\u610F\u4E49\u3002</p><p><strong>Actuator \u7684 REST \u63A5\u53E3</strong></p><p>Actuator \u76D1\u63A7\u5206\u6210\u4E24\u7C7B:\u539F\u751F\u7AEF\u70B9\u548C\u7528\u6237\u81EA\u5B9A\u4E49\u7AEF\u70B9;</p><p>\u81EA\u5B9A\u4E49\u7AEF\u70B9\uFF1A\u7528\u6237\u53EF\u4EE5\u6839\u636E\u81EA\u5DF1\u7684\u5B9E\u9645\u5E94\u7528\uFF0C\u5B9A\u4E49\u4E00\u4E9B\u6BD4\u8F83\u5173\u5FC3\u7684\u6307\u6807\uFF0C\u5728\u8FD0\u884C\u671F\u8FDB\u884C\u76D1\u63A7\u3002\uFF08\u662F\u6269\u5C55\u6027\u7684\u4F53\u73B0\uFF09</p><p>\u539F\u751F\u7AEF\u70B9\uFF1A\u5728\u5E94\u7528\u7A0B\u5E8F\u91CC\u63D0\u4F9B\u4F17\u591A Web \u63A5\u53E3\uFF0C\u901A\u8FC7\u5B83\u4EEC\u4E86\u89E3\u5E94\u7528\u7A0B\u5E8F\u8FD0\u884C\u65F6\u7684\u5185\u90E8\u72B6\u51B5\u3002</p><p>\u539F\u751F\u7AEF\u70B9\u53C8\u53EF\u4EE5\u5206\u6210\u4E09\u7C7B:</p><ul><li>\u5E94\u7528\u914D\u7F6E\u7C7B: \u53EF\u4EE5\u67E5\u770B\u5E94\u7528\u5728\u8FD0\u884C\u671F\u7684\u9759\u6001\u4FE1\u606F\u3002\u4F8B\u5982\u81EA\u52A8\u914D\u7F6E\u4FE1\u606F\u3001\u52A0\u8F7D\u7684 Spring Bean \u4FE1\u606F\u3001yml\u6587\u4EF6\u914D\u7F6E\u4FE1\u606F\u3001\u73AF\u5883\u4FE1\u606F\u3001\u8BF7\u6C42\u6620\u5C04\u4FE1\u606F;</li><li>\u5EA6\u91CF\u6307\u6807\u7C7B: \u4E3B\u8981\u662F\u8FD0\u884C\u671F\u7684\u52A8\u6001\u4FE1\u606F\uFF0C\u4F8B\u5982\u5806\u6808\u3001\u8BF7\u6C42\u94FE\u3001\u4E00\u4E9B\u5065\u5EB7\u6307\u6807\u3001metrics \u4FE1\u606F\u7B49;</li><li>\u64CD\u4F5C\u63A7\u5236\u7C7B: \u4E3B\u8981\u662F\u6307 shutdown,\u7528\u6237\u53EF\u4EE5\u53D1\u9001\u4E00\u4E2A\u8BF7\u6C42\u5C06\u5E94\u7528\u7684\u76D1\u63A7\u529F\u80FD\u5173\u95ED\u3002</li></ul><p>Actuator \u63D0\u4F9B\u4E86 13 \u4E2A\u63A5\u53E3\uFF0C\u5177\u4F53\u5982\u4E0B\u8868\u6240\u793A:</p><table><thead><tr><th>HTTP\u65B9\u6CD5</th><th>\u8DEF\u5F84</th><th>\u63CF\u8FF0</th></tr></thead><tbody><tr><td>GET</td><td>/auditevents</td><td>\u663E\u793A\u5E94\u7528\u66B4\u9732\u7684\u5BA1\u8BA1\u4E8B\u4EF6 (\u6BD4\u5982\u8BA4\u8BC1\u8FDB\u5165\u3001\u8BA2\u5355\u5931\u8D25)</td></tr><tr><td>GET</td><td>/beans</td><td>\u63CF\u8FF0\u5E94\u7528\u7A0B\u5E8F\u4E0A\u4E0B\u6587\u91CC\u5168\u90E8\u7684 Bean\uFF0C\u4EE5\u53CA\u5B83\u4EEC\u7684\u5173\u7CFB</td></tr><tr><td>GET</td><td>/conditions</td><td>\u5C31\u662F 1.0 \u7684/autoconfig\uFF0C\u63D0\u4F9B\u4E00\u4EFD\u81EA\u52A8\u914D\u7F6E\u751F\u6548\u7684\u6761\u4EF6\u60C5\u51B5\uFF0C\u8BB0\u5F55\u54EA\u4E9B\u81EA\u52A8\u914D\u7F6E\u6761\u4EF6\u901A\u8FC7\u4E86\uFF0C\u54EA\u4E9B\u6CA1\u901A\u8FC7</td></tr><tr><td>GET</td><td>/configprops</td><td>\u63CF\u8FF0\u914D\u7F6E\u5C5E\u6027(\u5305\u542B\u9ED8\u8BA4\u503C)\u5982\u4F55\u6CE8\u5165Bean</td></tr><tr><td>GET</td><td>/env</td><td>\u83B7\u53D6\u5168\u90E8\u73AF\u5883\u5C5E\u6027</td></tr><tr><td>GET</td><td>/env/{name}</td><td>\u6839\u636E\u540D\u79F0\u83B7\u53D6\u7279\u5B9A\u7684\u73AF\u5883\u5C5E\u6027\u503C</td></tr><tr><td>GET</td><td>/flyway</td><td>\u63D0\u4F9B\u4E00\u4EFD Flyway \u6570\u636E\u5E93\u8FC1\u79FB\u4FE1\u606F</td></tr><tr><td>GET</td><td>/liquidbase</td><td>\u663E\u793ALiquibase \u6570\u636E\u5E93\u8FC1\u79FB\u7684\u7EA4\u7EC6\u4FE1\u606F</td></tr><tr><td>GET</td><td>/health</td><td>\u62A5\u544A\u5E94\u7528\u7A0B\u5E8F\u7684\u5065\u5EB7\u6307\u6807\uFF0C\u8FD9\u4E9B\u503C\u7531 HealthIndicator \u7684\u5B9E\u73B0\u7C7B\u63D0\u4F9B</td></tr><tr><td>GET</td><td>/heapdump</td><td>dump \u4E00\u4EFD\u5E94\u7528\u7684 JVM \u5806\u4FE1\u606F</td></tr><tr><td>GET</td><td>/httptrace</td><td>\u663E\u793AHTTP\u8DB3\u8FF9\uFF0C\u6700\u8FD1100\u4E2AHTTP request/response</td></tr><tr><td>GET</td><td>/info</td><td>\u83B7\u53D6\u5E94\u7528\u7A0B\u5E8F\u7684\u5B9A\u5236\u4FE1\u606F\uFF0C\u8FD9\u4E9B\u4FE1\u606F\u7531info\u6253\u5934\u7684\u5C5E\u6027\u63D0\u4F9B</td></tr><tr><td>GET</td><td>/logfile</td><td>\u8FD4\u56DElog file\u4E2D\u7684\u5185\u5BB9(\u5982\u679Clogging.file\u6216\u8005logging.path\u88AB\u8BBE\u7F6E)</td></tr><tr><td>GET</td><td>/loggers</td><td>\u663E\u793A\u548C\u4FEE\u6539\u914D\u7F6E\u7684loggers</td></tr><tr><td>GET</td><td>/metrics</td><td>\u62A5\u544A\u5404\u79CD\u5E94\u7528\u7A0B\u5E8F\u5EA6\u91CF\u4FE1\u606F\uFF0C\u6BD4\u5982\u5185\u5B58\u7528\u91CF\u548CHTTP\u8BF7\u6C42\u8BA1\u6570</td></tr><tr><td>GET</td><td>/metrics/{name}</td><td>\u62A5\u544A\u6307\u5B9A\u540D\u79F0\u7684\u5E94\u7528\u7A0B\u5E8F\u5EA6\u91CF\u503C</td></tr><tr><td>GET</td><td>/scheduledtasks</td><td>\u5C55\u793A\u5E94\u7528\u4E2D\u7684\u5B9A\u65F6\u4EFB\u52A1\u4FE1\u606F</td></tr><tr><td>\u{1F680} POST</td><td>/shutdown</td><td>\u5173\u95ED\u5E94\u7528\u7A0B\u5E8F\uFF0C\u8981\u6C42endpoints.shutdown.enabled\u8BBE\u7F6E\u4E3A true</td></tr><tr><td>GET</td><td>/threaddump</td><td>\u83B7\u53D6\u7EBF\u7A0B\u6D3B\u52A8\u7684\u5FEB\u7167</td></tr><tr><td>GET</td><td>/sessions</td><td>\u5982\u679C\u6211\u4EEC\u4F7F\u7528\u4E86 Spring Session\uFF0C \u5C55\u793A\u5E94\u7528\u4E2D\u7684 HTTP sessions \u4FE1\u606F</td></tr><tr><td>GET</td><td>/mappings</td><td>\u63CF\u8FF0\u5168\u90E8\u7684URI\u8DEF\u5F84\uFF0C\u4EE5\u53CA\u5B83\u4EEC\u548C\u63A7\u5236\u5668(\u5305\u542BActuator\u7AEF \u70B9)\u7684\u6620\u5C04\u5173\u7CFB</td></tr></tbody></table><p><strong>\u4F7F\u7528Actuator</strong></p><p>\u4F7F\u7528<code>Actuator</code>\u529F\u80FD\u4E0E<code>SpringBoot</code>\u4F7F\u7528\u5176\u4ED6\u529F\u80FD\u4E00\u6837\u7B80\u5355\uFF0C\u53EA\u9700\u8981\u5728pom.xml\u4E2D\u6DFB\u52A0\u5982\u4E0B\u4F9D\u8D56:</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>\u4E3A\u4E86\u4FDD\u8BC1<code>actuator</code>\u66B4\u9732\u7684\u76D1\u63A7\u63A5\u53E3\u7684\u5B89\u5168\u6027\uFF0C\u9700\u8981\u6DFB\u52A0\u5B89\u5168\u63A7\u5236\u7684\u4F9D\u8D56<code>spring-boot-starter-security</code>\uFF0C\u8BBF\u95EE\u5E94\u7528\u76D1\u63A7\u7AEF\u70B9\u65F6\uFF0C\u90FD\u9700\u8981\u8F93\u5165\u9A8C\u8BC1\u4FE1\u606F\u3002 Security\u4F9D\u8D56\uFF0C\u53EF\u4EE5\u9009\u62E9\u4E0D\u52A0\uFF0C\u4E0D\u8FDB\u884C\u5B89\u5168\u7BA1\u7406\u3002</p></blockquote><p><strong>\u5C5E\u6027\u8BE6\u89E3</strong></p><p>\u5728 Spring Boot 2.x \u4E2D\u4E3A\u4E86\u5B89\u5168\u8D77\u89C1\uFF0CActuator\u53EA\u5F00\u653E\u4E86\u4E24\u4E2A\u7AEF\u70B9<code>/actuator/health</code>\u548C<code>/actuator/info</code>\u3002\u5176\u4ED6\u7AEF\u70B9\u53EF\u4EE5\u5728\u914D\u7F6E\u6587\u4EF6\u4E2D\u8BBE\u7F6E\u6253\u5F00\u3002</p><ol><li>\u5F00\u542F\u6240\u6709\u7684\u76D1\u63A7\u70B9</li></ol><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">management.endpoints.web.exposure.include</span><span class="token punctuation">=</span><span class="token value attr-value">*</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><ol start="2"><li>\u5F00\u542F\u90E8\u5206\u76D1\u63A7\u70B9</li></ol><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">management.endpoints.web.exposure.include</span><span class="token punctuation">=</span><span class="token value attr-value">beans,trace</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><ol start="3"><li>Actuator \u9ED8\u8BA4\u6240\u6709\u7684\u76D1\u63A7\u70B9\u8DEF\u5F84\u90FD\u5728<code>/actuator</code>\uFF0C\u8FD9\u4E2A\u8DEF\u5F84\u4E5F\u652F\u6301\u5B9A\u5236</li></ol><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">management.endpoints.web.base-path</span><span class="token punctuation">=</span><span class="token value attr-value">/manage</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>\u8BBE\u7F6E\u5B8C\u91CD\u542F\u540E\uFF0C\u518D\u6B21\u8BBF\u95EE\u5730\u5740\u5C31\u4F1A\u53D8\u6210<code>/manage</code>\u3002</p><p>Actuator \u51E0\u4E4E\u76D1\u63A7\u4E86\u5E94\u7528\u6D89\u53CA\u7684\u65B9\u65B9\u9762\u9762\uFF0C\u6211\u4EEC\u91CD\u70B9\u8BB2\u8FF0\u4E00\u4E9B\u7ECF\u5E38\u5728\u9879\u76EE\u4E2D\u5E38\u7528\u7684\u5C5E\u6027\u3002</p><p><strong>health</strong></p><p>health \u4E3B\u8981\u7528\u6765\u68C0\u67E5\u5E94\u7528\u7684\u8FD0\u884C\u72B6\u6001\uFF0C\u8FD9\u662F\u6211\u4EEC\u4F7F\u7528\u6700\u9AD8\u9891\u7684\u4E00\u4E2A\u76D1\u63A7\u70B9\u3002 \u901A\u5E38\u4F7F\u7528\u6B64\u63A5\u53E3\u63D0\u9192\u6211\u4EEC\u5E94\u7528\u5B9E\u4F8B\u7684\u8FD0\u884C\u72B6\u6001\uFF0C\u4EE5\u53CA\u5E94\u7528\u4E0D\u201D\u5065\u5EB7\u201C\u7684\u539F\u56E0\uFF0C\u6BD4\u5982\u6570\u636E\u5E93\u8FDE\u63A5\u3001\u78C1\u76D8\u7A7A\u95F4\u4E0D\u591F\u7B49\u3002</p><p>health \u901A\u8FC7\u5408\u5E76\u51E0\u4E2A\u5065\u5EB7\u6307\u6570\u68C0\u67E5\u5E94\u7528\u7684\u5065\u5EB7\u60C5\u51B5\u3002SpringBoot Actuator \u6709\u51E0\u4E2A\u9884\u5B9A\u4E49\u7684\u5065\u5EB7\u6307\u6807\uFF0C \u6BD4\u5982<code>DataSourceHealthIndicator</code>, <code>DiskSpaceHealthIndicator</code>, <code>MongoHealthIndicator</code>, <code>RedisHealthIndicator</code>\u7B49\uFF0C \u5B83\u4F7F\u7528\u8FD9\u4E9B\u5065\u5EB7\u6307\u6807\u4F5C\u4E3A\u5065\u5EB7\u68C0\u67E5\u7684\u4E00\u90E8\u5206\u3002</p><p>\u4E3E\u4E2A\u4F8B\u5B50\uFF0C\u5982\u679C\u4F60\u7684\u5E94\u7528\u4E2D\u4F7F\u7528Redis\uFF0C<code>RedisHealthIndicator</code>\u5C06\u88AB\u5F53\u4F5C\u68C0\u67E5\u7684\u4E00\u90E8\u5206; \u5982\u679C\u4F7F\u7528MongoDB\uFF0C\u90A3\u4E48<code>MongoHealthIndicator</code>\u5C06\u88AB\u5F53\u4F5C\u68C0\u67E5\u7684\u4E00\u90E8\u5206\u3002</p><p>\u53EF\u4EE5\u5728\u914D\u7F6E\u6587\u4EF6\u4E2D\u5173\u95ED\u7279\u5B9A\u7684\u5065\u5EB7\u68C0\u67E5\u6307\u6807\uFF0C\u6BD4\u5982\u5173\u95ED<code>Redis</code>\u7684\u5065\u5EB7\u68C0\u67E5:</p><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">management.health.redise.enabled</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>\u9ED8\u8BA4\uFF0C\u6240\u6709\u7684\u8FD9\u4E9B\u5065\u5EB7\u6307\u6807\u88AB\u5F53\u4F5C\u5065\u5EB7\u68C0\u67E5\u7684\u4E00\u90E8\u5206\u3002</p><p><strong>info</strong></p><p>info \u5C31\u662F\u6211\u4EEC\u81EA\u5DF1\u914D\u7F6E\u5728\u914D\u7F6E\u6587\u4EF6\u4E2D\u4EE5<code>info</code>\u5F00\u5934\u7684\u914D\u7F6E\u4FE1\u606F\u3002</p><p><strong>beans</strong></p><p>\u5C55\u793ABean\u7684\u522B\u540D\u3001\u7C7B\u578B\u3001\u662F\u5426\u5355\u4F8B\u3001\u7C7B\u7684\u5730\u5740\u3001\u4F9D\u8D56\u7B49\u4FE1\u606F\u3002</p><p><strong>conditions</strong></p><p>SpringBoot \u7684\u81EA\u52A8\u914D\u7F6E\u529F\u80FD\u975E\u5E38\u4FBF\u5229\uFF0C\u4F46\u6709\u65F6\u5019\u4E5F\u610F\u5473\u7740\u51FA\u95EE\u9898\u6BD4\u8F83\u96BE\u627E\u51FA\u5177\u4F53\u7684\u539F\u56E0\u3002 \u4F7F\u7528<code>conditions</code>\u53EF\u4EE5\u5728\u5E94\u7528\u8FD0\u884C\u65F6\u67E5\u770B\u4EE3\u7801\u67D0\u4E2A\u914D\u7F6E\u5728\u4EC0\u4E48\u6761\u4EF6\u4E0B\u751F\u6548\uFF0C\u6216\u8005\u67D0\u4E2A\u81EA\u52A8\u914D\u7F6E\u4E3A\u4EC0\u4E48\u6CA1\u6709\u751F\u6548\u3002</p><p><strong>heapdump</strong></p><p>\u8FD4\u56DE\u4E00\u4E2A GZip \u538B\u7F29\u7684 JVM \u5806 dump</p><p>\u542F\u52A8\u793A\u4F8B\u9879\u76EE\uFF0C\u8BBF\u95EE: <code>http://localhost:8080/actuator/heapdump</code> \u4F1A\u81EA\u52A8\u751F\u6210\u4E00\u4E2AJvm\u7684\u5806\u6587\u4EF6<code>heapdump</code>\uFF0C \u6211\u4EEC\u53EF\u4EE5\u4F7F\u7528JDK\u81EA\u5E26\u7684Jvm\u76D1\u63A7\u5DE5\u5177VisualVM\u6253\u5F00\u6B64\u6587\u4EF6\u67E5\u770B\u5185\u5B58\u5FEB\u7167\u3002</p><p><strong>mappings</strong></p><p>\u63CF\u8FF0\u5168\u90E8\u7684 URI \u8DEF\u5F84\uFF0C\u4EE5\u53CA\u5B83\u4EEC\u548C\u63A7\u5236\u5668\u7684\u6620\u5C04\u5173\u7CFB</p><p><strong>threaddump</strong></p><p><code>/threaddump</code>\u63A5\u53E3\u4F1A\u751F\u6210\u5F53\u524D\u7EBF\u7A0B\u6D3B\u52A8\u7684\u5FEB\u7167\u3002</p><p>\u8FD9\u4E2A\u529F\u80FD\u975E\u5E38\u597D\uFF0C\u65B9\u4FBF\u6211\u4EEC\u5728\u65E5\u5E38\u5B9A\u4F4D\u95EE\u9898\u7684\u65F6\u5019\u67E5\u770B\u7EBF\u7A0B\u7684\u60C5\u51B5\u3002 \u4E3B\u8981\u5C55\u793A\u4E86\u7EBF\u7A0B\u540D\u3001\u7EBF\u7A0BID\u3001\u7EBF\u7A0B\u7684\u72B6\u6001\u3001\u662F\u5426\u7B49\u5F85\u9501\u8D44\u6E90\u7B49\u4FE1\u606F\u3002</p><p>\u751F\u4EA7\u51FA\u73B0\u95EE\u9898\u7684\u65F6\u5019\uFF0C\u53EF\u4EE5\u901A\u8FC7\u5E94\u7528\u7684\u7EBF\u7A0B\u5FEB\u7167\u6765\u68C0\u6D4B\u5E94\u7528\u6B63\u5728\u6267\u884C\u7684\u4EFB\u52A1\u3002</p><p><strong>shutdown</strong></p><p>\u5F00\u542F\u63A5\u53E3\u4F18\u96C5\u5173\u95ED SpringBoot \u5E94\u7528\u529F\u80FD\uFF0C\u8981\u4F7F\u7528\u8FD9\u4E2A\u529F\u80FD\u9996\u5148\u9700\u8981\u5728\u914D\u7F6E\u6587\u4EF6\u4E2D\u5F00\u542F:</p><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">management.endpoint.shutdown.enabled</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><blockquote><p>shutdown \u63A5\u53E3\u9ED8\u8BA4\u53EA\u652F\u6301 POST \u8BF7\u6C42\u3002</p></blockquote><h3 id="springboot-admin" tabindex="-1"><a class="header-anchor" href="#springboot-admin" aria-hidden="true">#</a> SpringBoot Admin</h3><p>\u5BF9\u4E8E Spring Actuator \u800C\u8A00\uFF0C\u6700\u5927\u7684\u7F3A\u70B9\u5728\u4E8E\u662F\u4EE5json\u5F62\u5F0F\u6765\u8FDB\u884C\u5C55\u793A\uFF0C\u4E3A\u4E86\u66F4\u597D\u7684\u8FDB\u884C\u76D1\u63A7\u663E\u793A\uFF0C\u6211\u4EEC\u6765\u4ECB\u7ECD\u4E00\u4E2A\u66F4\u52A0\u65B9\u4FBF\u7684\u5DE5\u5177: SpringBoot Admin\u3002</p><p>Spring Boot Admin: \u53EF\u89C6\u5316\u540E\u53F0\u7BA1\u7406\u7CFB\u7EDF\u3002</p><p>SpringBoot Admin \u662F\u4E00\u4E2A\u9488\u5BF9spring-boot\u7684actuator\u63A5\u53E3\u8FDB\u884CUI\u7F8E\u5316\u5C01\u88C5\u7684\u76D1\u63A7\u5DE5\u5177\u3002 \u4ED6\u53EF\u4EE5\u8FD4\u56DE\u5728\u5217\u8868\u4E2D\u6D4F\u89C8\u6240\u6709\u88AB\u76D1\u63A7spring-boot\u9879\u76EE\u7684\u57FA\u672C\u4FE1\u606F\uFF0C \u6BD4\u5982: Spring\u5BB9\u5668\u7BA1\u7406\u7684\u6240\u6709\u7684bean\u3001\u8BE6\u7EC6\u7684Health\u4FE1\u606F\u3001\u5185\u5B58\u4FE1\u606F\u3001JVM\u4FE1\u606F\u3001\u5783\u573E\u56DE\u6536\u4FE1\u606F\u3001\u5404\u79CD\u914D\u7F6E\u4FE1\u606F(\u6BD4\u5982\u6570\u636E\u6E90\u3001\u7F13\u5B58\u5217\u8868\u548C\u547D\u4E2D\u7387)\u7B49\uFF0C Threads \u7EBF\u7A0B\u7BA1\u7406\uFF0CEnvironment \u7BA1\u7406\u7B49\u3002</p><p>\u5229\u7528SpringBoot Admin\u8FDB\u884C\u76D1\u63A7\u7684\u67B6\u6784\u56FE\u5982\u4E0B:</p><p><img src="`+e+`" alt="SpringBootAdmin\u76D1\u63A7\u67B6\u6784"></p><p>SpringBoot Admin \u76D1\u63A7\uFF0C \u901A\u4FD7\u70B9\u5C31\u662F\u6211\u4EEC\u5982\u679C\u6709n\u4E2Aspringboot\u4E1A\u52A1\u7CFB\u7EDF\u9700\u8981\u76D1\u63A7\u7684\u8BDD\uFF0C \u90A3\u4E48\u9700\u8981\u4E00\u4E2A\u989D\u5916\u7684SpringBoot Admin\u5E94\u7528\u6765\u8FDB\u884C\u76D1\u63A7\u8FD9\u4E9Bclient\uFF0Cclient\u548Cserver\u4E4B\u95F4\u9700\u8981\u505A\u4E00\u70B9\u914D\u7F6E\u5373\u53EF\u3002</p><p><strong>\u6DFB\u52A0Server\u6A21\u5757</strong></p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>de.codecentric<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-admin-starter-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>\u4E3B\u542F\u52A8\u7C7B\u6DFB\u52A0\u542F\u7528Server\u6CE8\u89E3</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@EnableAdminServer</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>\u6DFB\u52A0Client\u7AEF</strong></p><p>\u7ED9\u9700\u8981\u88AB\u76D1\u63A7\u7684\u7C7B\u6DFB\u52A0\u4F9D\u8D56</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>de.codecentric<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-admin-starter-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>\u6DFB\u52A0\u914D\u7F6E\u6587\u4EF6\u6CE8\u518C\u8FDBserver</p><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">management.endpoints.web.exposure.include</span><span class="token punctuation">=</span><span class="token value attr-value">*</span>
<span class="token key attr-name">management.endpoint.health.show-details</span><span class="token punctuation">=</span><span class="token value attr-value">always</span>

<span class="token key attr-name">spring.boot.admin.client.url</span><span class="token punctuation">=</span><span class="token value attr-value">http://localhost:8081</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div>`,471);function l(u,i){return c}var k=n(o,[["render",l],["__file","SpringBoot\u9AD8\u7EA7.html.vue"]]);export{k as default};
