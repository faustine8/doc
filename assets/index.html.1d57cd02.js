import{_ as n,c as s}from"./app.40df414d.js";const a={},e=s(`<h1 id="redis-\u6162\u67E5\u8BE2\u65E5\u5FD7" tabindex="-1"><a class="header-anchor" href="#redis-\u6162\u67E5\u8BE2\u65E5\u5FD7" aria-hidden="true">#</a> Redis \u6162\u67E5\u8BE2\u65E5\u5FD7</h1><p>\u6211\u4EEC\u90FD\u77E5\u9053 MySQL \u6709\u6162\u67E5\u8BE2\u65E5\u5FD7\uFF0CRedis \u4E5F\u6709\u6162\u67E5\u8BE2\u65E5\u5FD7\uFF0C\u53EF\u7528\u4E8E\u76D1\u89C6\u548C\u4F18\u5316\u67E5\u8BE2</p><h2 id="_1-\u6162\u67E5\u8BE2\u8BBE\u7F6E" tabindex="-1"><a class="header-anchor" href="#_1-\u6162\u67E5\u8BE2\u8BBE\u7F6E" aria-hidden="true">#</a> 1. \u6162\u67E5\u8BE2\u8BBE\u7F6E</h2><p>\u5728 <code>redis.conf</code> \u4E2D\u53EF\u4EE5\u914D\u7F6E\u548C\u6162\u67E5\u8BE2\u65E5\u5FD7\u76F8\u5173\u7684\u9009\u9879:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u6267\u884C\u65F6\u95F4\u8D85\u8FC7\u591A\u5C11\u5FAE\u79D2\u7684\u547D\u4EE4\u8BF7\u6C42\u4F1A\u88AB\u8BB0\u5F55\u5230\u65E5\u5FD7\u4E0A 0 :\u5168\u8BB0\u5F55 &lt;0 \u4E0D\u8BB0\u5F55 </span>
slowlog-log-slower-than <span class="token number">10000</span>
<span class="token comment"># slowlog-max-len \u5B58\u50A8\u6162\u67E5\u8BE2\u65E5\u5FD7\u6761\u6570</span>
slowlog-max-len <span class="token number">128</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Redis \u4F7F\u7528\u5217\u8868\u5B58\u50A8\u6162\u67E5\u8BE2\u65E5\u5FD7\uFF0C\u91C7\u7528\u961F\u5217\u65B9\u5F0F(FIFO)</p><p><code>config set</code> \u7684\u65B9\u5F0F\u53EF\u4EE5\u4E34\u65F6\u8BBE\u7F6E\uFF0CRedis \u91CD\u542F\u540E\u5C31\u65E0\u6548</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>config <span class="token builtin class-name">set</span> slowlog-log-slower-than \u5FAE\u79D2
config <span class="token builtin class-name">set</span> slowlog-max-len \u6761\u6570 
<span class="token comment"># \u67E5\u770B\u65E5\u5FD7</span>
slowlog get <span class="token punctuation">[</span>n<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> config <span class="token builtin class-name">set</span> slowlog-log-slower-than <span class="token number">0</span>
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> config <span class="token builtin class-name">set</span> slowlog-max-len <span class="token number">2</span>
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> name:001 john
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> name:002 jack
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get name:002
<span class="token string">&quot;jack&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> slowlog get
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">4</span>             <span class="token comment"># \u65E5\u5FD7\u7684\u552F\u4E00\u6807\u8BC6\u7B26(uid)</span>
   <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1649814537</span>    <span class="token comment"># \u547D\u4EE4\u6267\u884C\u65F6\u7684UNIX\u65F6\u95F4\u6233</span>
   <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">4</span>             <span class="token comment"># \u547D\u4EE4\u6267\u884C\u7684\u65F6\u957F(\u5FAE\u79D2)</span>
   <span class="token number">4</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;get&quot;</span>                <span class="token comment"># \u6267\u884C\u547D\u4EE4\u53CA\u53C2\u6570</span>
      <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;name:002&quot;</span>
   <span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">&quot;127.0.0.1:46752&quot;</span>
   <span class="token number">6</span><span class="token punctuation">)</span> <span class="token string">&quot;&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">3</span>
   <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1649814528</span>
   <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">8</span>
   <span class="token number">4</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;set&quot;</span>
      <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;name:002&quot;</span>
      <span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;jack&quot;</span>
   <span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">&quot;127.0.0.1:46752&quot;</span>
   <span class="token number">6</span><span class="token punctuation">)</span> <span class="token string">&quot;&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h2 id="_2-\u6162\u67E5\u8BE2\u8BB0\u5F55\u7684\u4FDD\u5B58" tabindex="-1"><a class="header-anchor" href="#_2-\u6162\u67E5\u8BE2\u8BB0\u5F55\u7684\u4FDD\u5B58" aria-hidden="true">#</a> 2. \u6162\u67E5\u8BE2\u8BB0\u5F55\u7684\u4FDD\u5B58</h2><p>\u5728 <code>redisServer</code> \u4E2D\u4FDD\u5B58\u548C\u6162\u67E5\u8BE2\u65E5\u5FD7\u76F8\u5173\u7684\u4FE1\u606F</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    
    <span class="token comment">// \u4E0B\u4E00\u6761\u6162\u67E5\u8BE2\u65E5\u5FD7\u7684 ID</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> slowlog_entry_id<span class="token punctuation">;</span>
    
    <span class="token comment">// \u4FDD\u5B58\u4E86\u6240\u6709\u6162\u67E5\u8BE2\u65E5\u5FD7\u7684\u94FE\u8868 FIFO </span>
    list <span class="token operator">*</span>slowlog<span class="token punctuation">;</span>
    
    <span class="token comment">// \u670D\u52A1\u5668\u914D\u7F6E slowlog-log-slower-than \u9009\u9879\u7684\u503C </span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> slowlog_log_slower_than<span class="token punctuation">;</span>
    
    <span class="token comment">// \u670D\u52A1\u5668\u914D\u7F6E slowlog-max-len \u9009\u9879\u7684\u503C </span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> slowlog_max_len<span class="token punctuation">;</span>
    
    <span class="token comment">// ...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><code>slowlog</code> \u94FE\u8868\u4FDD\u5B58\u4E86\u670D\u52A1\u5668\u4E2D\u7684\u6240\u6709\u6162\u67E5\u8BE2\u65E5\u5FD7\uFF0C\u94FE\u8868\u4E2D\u7684\u6BCF\u4E2A\u8282\u70B9\u90FD\u4FDD\u5B58\u4E86\u4E00\u4E2A <code>slowlogEntry</code> \u7ED3\u6784\uFF0C \u6BCF\u4E2A <code>slowlogEntry</code> \u7ED3\u6784\u4EE3\u8868\u4E00\u6761\u6162\u67E5\u8BE2\u65E5\u5FD7\u3002</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">slowlogEntry</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u552F\u4E00\u6807\u8BC6\u7B26</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> id<span class="token punctuation">;</span>
    
    <span class="token comment">// \u547D\u4EE4\u6267\u884C\u65F6\u7684\u65F6\u95F4\uFF0C\u683C\u5F0F\u4E3A UNIX \u65F6\u95F4\u6233</span>
    <span class="token class-name">time_t</span> time<span class="token punctuation">;</span>
    
    <span class="token comment">// \u6267\u884C\u547D\u4EE4\u6D88\u8017\u7684\u65F6\u95F4\uFF0C\u4EE5\u5FAE\u79D2\u4E3A\u5355\u4F4D</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> duration<span class="token punctuation">;</span> 
    
    <span class="token comment">// \u547D\u4EE4\u4E0E\u547D\u4EE4\u53C2\u6570</span>
    robj <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">;</span>
    
    <span class="token comment">// \u547D\u4EE4\u4E0E\u547D\u4EE4\u53C2\u6570\u7684\u6570\u91CF</span>
    <span class="token keyword">int</span> argc<span class="token punctuation">;</span>
<span class="token punctuation">}</span> slowlogEntry<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="_3-\u6162\u67E5\u8BE2\u65E5\u5FD7\u7684\u9605\u89C8-\u5220\u9664" tabindex="-1"><a class="header-anchor" href="#_3-\u6162\u67E5\u8BE2\u65E5\u5FD7\u7684\u9605\u89C8-\u5220\u9664" aria-hidden="true">#</a> 3. \u6162\u67E5\u8BE2\u65E5\u5FD7\u7684\u9605\u89C8&amp;\u5220\u9664</h2><p>\u521D\u59CB\u5316\u65E5\u5FD7\u5217\u8868</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">slowlogInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    server<span class="token punctuation">.</span>slowlog <span class="token operator">=</span> <span class="token function">listCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* \u521B\u5EFA\u4E00\u4E2Alist\u5217\u8868 */</span> 
    server<span class="token punctuation">.</span>slowlog_entry_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/* \u65E5\u5FD7ID\u4ECE0\u5F00\u59CB */</span> 
    <span class="token function">listSetFreeMethod</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>slowlog<span class="token punctuation">,</span>slowlogFreeEntry<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* \u6307\u5B9A\u6162\u67E5\u8BE2\u65E5\u5FD7list\u7A7A\u95F4\u7684\u91CA\u653E\u65B9\u6CD5 */</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>\u83B7\u5F97\u6162\u67E5\u8BE2\u65E5\u5FD7\u8BB0\u5F55</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>slowlog get <span class="token punctuation">[</span>n<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>def <span class="token function">SLOWLOG_GET</span><span class="token punctuation">(</span>number<span class="token operator">=</span>None<span class="token punctuation">)</span><span class="token operator">:</span>
    # \u7528\u6237\u6CA1\u6709\u7ED9\u5B9A number \u53C2\u6570
    # \u90A3\u4E48\u6253\u5370\u670D\u52A1\u5668\u5305\u542B\u7684\u5168\u90E8\u6162\u67E5\u8BE2\u65E5\u5FD7 
    <span class="token keyword">if</span> number is None<span class="token operator">:</span>
      number <span class="token operator">=</span> <span class="token function">SLOWLOG_LEN</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
      
    # \u904D\u5386\u670D\u52A1\u5668\u4E2D\u7684\u6162\u67E5\u8BE2\u65E5\u5FD7
    <span class="token keyword">for</span> log in redisServer<span class="token punctuation">.</span>slowlog<span class="token operator">:</span>
      <span class="token keyword">if</span> number <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token operator">:</span>
        # \u6253\u5370\u7684\u65E5\u5FD7\u6570\u91CF\u5DF2\u7ECF\u8DB3\u591F\uFF0C\u8DF3\u51FA\u5FAA\u73AF
        <span class="token keyword">break</span> 
      <span class="token keyword">else</span><span class="token operator">:</span>
        # \u7EE7\u7EED\u6253\u5370\uFF0C\u5C06\u8BA1\u6570\u5668\u7684\u503C\u51CF\u4E00 
        number <span class="token operator">-=</span> <span class="token number">1</span>
        # \u6253\u5370\u65E5\u5FD7 
      <span class="token function">printLog</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>\u67E5\u770B\u65E5\u5FD7\u6570\u91CF\u7684 <code>slowlog len</code></p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>def <span class="token function">SLOWLOG_LEN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
    <span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">slowlog</span> <span class="token expression">\u94FE\u8868\u7684\u957F\u5EA6\u5C31\u662F\u6162\u67E5\u8BE2\u65E5\u5FD7\u7684\u6761\u76EE\u6570\u91CF </span></span>
    <span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>redisServer<span class="token punctuation">.</span>slowlog<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>\u6E05\u9664\u65E5\u5FD7 <code>slowlog reset</code></p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>def <span class="token function">SLOWLOG_RESET</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>

    # \u904D\u5386\u670D\u52A1\u5668\u4E2D\u7684\u6240\u6709\u6162\u67E5\u8BE2\u65E5\u5FD7
    <span class="token keyword">for</span> log in redisServer<span class="token punctuation">.</span>slowlog<span class="token operator">:</span>
    
        # \u5220\u9664\u65E5\u5FD7 
        <span class="token function">deleteLog</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="_4-\u6DFB\u52A0\u65E5\u5FD7\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_4-\u6DFB\u52A0\u65E5\u5FD7\u5B9E\u73B0" aria-hidden="true">#</a> 4. \u6DFB\u52A0\u65E5\u5FD7\u5B9E\u73B0</h2><p>\u5728\u6BCF\u6B21\u6267\u884C\u547D\u4EE4\u7684\u4E4B\u524D\u548C\u4E4B\u540E\uFF0C\u7A0B\u5E8F\u90FD\u4F1A\u8BB0\u5F55\u5FAE\u79D2\u683C\u5F0F\u7684\u5F53\u524D UNIX \u65F6\u95F4\u6233\uFF0C\u8FD9\u4E24\u4E2A\u65F6\u95F4\u6233\u4E4B\u95F4\u7684\u5DEE\u5C31\u662F\u670D\u52A1\u5668\u6267\u884C\u547D\u4EE4\u6240\u8017\u8D39\u7684\u65F6\u957F\uFF0C \u670D\u52A1\u5668\u4F1A\u5C06\u8FD9\u4E2A\u65F6\u957F\u4F5C\u4E3A\u53C2\u6570\u4E4B\u4E00\u4F20\u7ED9 <code>slowlogPushEntryIfNeeded</code> \u51FD\u6570\uFF0C \u800C <code>slowlogPushEntryIfNeeded</code> \u51FD\u6570\u5219\u8D1F\u8D23\u68C0\u67E5\u662F\u5426\u9700\u8981\u4E3A\u8FD9\u6B21\u6267\u884C\u7684\u547D\u4EE4\u521B\u5EFA\u6162\u67E5\u8BE2\u65E5\u5FD7</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// \u8BB0\u5F55\u6267\u884C\u547D\u4EE4\u524D\u7684\u65F6\u95F4</span>
before <span class="token operator">=</span> <span class="token function">unixtime_now_in_us</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">//\u6267\u884C\u547D\u4EE4</span>
<span class="token function">execute_command</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> argc<span class="token punctuation">,</span> client<span class="token punctuation">)</span>

<span class="token comment">//\u8BB0\u5F55\u6267\u884C\u547D\u4EE4\u540E\u7684\u65F6\u95F4</span>
after <span class="token operator">=</span> <span class="token function">unixtime_now_in_us</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// \u68C0\u67E5\u662F\u5426\u9700\u8981\u521B\u5EFA\u65B0\u7684\u6162\u67E5\u8BE2\u65E5\u5FD7 </span>
<span class="token function">slowlogPushEntryIfNeeded</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> argc<span class="token punctuation">,</span> before<span class="token operator">-</span>after<span class="token punctuation">)</span>

<span class="token keyword">void</span> <span class="token function">slowlogPushEntryIfNeeded</span><span class="token punctuation">(</span>robj <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token keyword">long</span> duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>slowlog_log_slower_than <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">/* Slowlog disabled */</span> <span class="token comment">/* \u8D1F\u6570\u8868\u793A\u7981\u7528 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>duration <span class="token operator">&gt;=</span> server<span class="token punctuation">.</span>slowlog_log_slower_than<span class="token punctuation">)</span> <span class="token comment">/* \u5982\u679C\u6267\u884C\u65F6\u95F4 &gt; \u6307\u5B9A\u9608\u503C*/</span>
        <span class="token function">listAddNodeHead</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>slowlog<span class="token punctuation">,</span><span class="token function">slowlogCreateEntry</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span>argc<span class="token punctuation">,</span>duration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* \u521B\u5EFA\u4E00\u4E2AslowlogEntry\u5BF9\u8C61,\u6DFB\u52A0\u5230\u5217\u8868\u9996\u90E8*/</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">listLength</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>slowlog<span class="token punctuation">)</span> <span class="token operator">&gt;</span> server<span class="token punctuation">.</span>slowlog_max_len<span class="token punctuation">)</span> <span class="token comment">/* \u5982\u679C\u5217\u8868\u957F\u5EA6 &gt; \u6307\u5B9A\u957F\u5EA6 */</span>
        <span class="token function">listDelNode</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>slowlog<span class="token punctuation">,</span><span class="token function">listLast</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>slowlog<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* \u79FB\u9664\u5217\u8868\u5C3E\u90E8\u5143\u7D20 */</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><div class="highlight-line">\xA0</div><br><br><br><br><br><div class="highlight-line">\xA0</div><br><br><div class="highlight-line">\xA0</div><br><br><br><div class="highlight-line">\xA0</div><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><code>slowlogPushEntryIfNeeded</code> \u51FD\u6570\u7684\u4F5C\u7528\u6709\u4E24\u4E2A:</p><ol><li>\u68C0\u67E5\u547D\u4EE4\u7684\u6267\u884C\u65F6\u957F\u662F\u5426\u8D85\u8FC7 <code>slowlog-log-slower-than</code> \u9009\u9879\u6240\u8BBE\u7F6E\u7684\u65F6\u95F4\u3002\u5982\u679C\u662F\u7684\u8BDD\uFF0C\u5C31\u4E3A\u547D\u4EE4\u521B\u5EFA\u4E00\u4E2A\u65B0\u7684\u65E5\u5FD7\uFF0C\u5E76\u5C06\u65B0\u65E5\u5FD7\u6DFB\u52A0\u5230 <code>slowlog</code> \u94FE\u8868\u7684\u8868\u5934\u3002</li><li>\u68C0\u67E5\u6162\u67E5\u8BE2\u65E5\u5FD7\u7684\u957F\u5EA6\u662F\u5426\u8D85\u8FC7 <code>slowlog-max-len</code> \u9009\u9879\u6240\u8BBE\u7F6E\u7684\u957F\u5EA6\u3002\u5982\u679C\u662F\u7684\u8BDD\uFF0C\u90A3\u4E48\u5C06\u591A\u51FA\u6765\u7684\u65E5\u5FD7\u4ECE <code>slowlog</code> \u94FE\u8868\u4E2D\u5220\u9664\u6389\u3002</li></ol><h2 id="_5-\u6162\u67E5\u8BE2\u5B9A\u4F4D-\u5904\u7406" tabindex="-1"><a class="header-anchor" href="#_5-\u6162\u67E5\u8BE2\u5B9A\u4F4D-\u5904\u7406" aria-hidden="true">#</a> 5. \u6162\u67E5\u8BE2\u5B9A\u4F4D&amp;\u5904\u7406</h2><p>\u4F7F\u7528 <code>slowlog get</code> \u53EF\u4EE5\u83B7\u5F97\u6267\u884C\u8F83\u6162\u7684 Redis \u547D\u4EE4\uFF0C\u9488\u5BF9\u8BE5\u547D\u4EE4\u53EF\u4EE5\u8FDB\u884C\u4F18\u5316:</p><ol><li>\u5C3D\u91CF\u4F7F\u7528\u77ED\u7684 key\uFF0C\u5BF9\u4E8E value \u6709\u4E9B\u4E5F\u53EF\u7CBE\u7B80\uFF0C\u80FD\u4F7F\u7528 int \u5C31 int\u3002</li><li>\u907F\u514D\u4F7F\u7528 <code>keys *</code>\u3001<code>hgetall</code> \u7B49\u5168\u91CF\u64CD\u4F5C\u3002</li><li>\u51CF\u5C11\u5927 key \u7684\u5B58\u53D6\uFF0C\u6253\u6563\u4E3A\u5C0F key (100K\u4EE5\u4E0A)</li><li>\u5C06 RDB \u6539\u4E3A AOF \u6A21\u5F0F</li></ol><blockquote><p>RDB fork \u5B50\u8FDB\u7A0B, \u6570\u636E\u91CF\u8FC7\u5927, \u4E3B\u8FDB\u7A0B\u963B\u585E, Redis \u6027\u80FD\u5927\u5E45\u4E0B\u964D</p><p>\u5173\u95ED\u6301\u4E45\u5316 (\u9002\u5408\u4E8E\u6570\u636E\u91CF\u8F83\u5C0F\uFF0C\u6709\u56FA\u5B9A\u6570\u636E\u6E90)</p></blockquote><ol start="5"><li>\u60F3\u8981\u4E00\u6B21\u6DFB\u52A0\u591A\u6761\u6570\u636E\u7684\u65F6\u5019\u53EF\u4EE5\u4F7F\u7528\u7BA1\u9053</li><li>\u5C3D\u53EF\u80FD\u5730\u4F7F\u7528\u54C8\u5E0C\u5B58\u50A8</li><li>\u5C3D\u91CF\u9650\u5236\u4E0B Redis \u4F7F\u7528\u7684\u5185\u5B58\u5927\u5C0F\uFF0C\u8FD9\u6837\u53EF\u4EE5\u907F\u514D Redis \u4F7F\u7528 swap \u5206\u533A\u6216\u8005\u51FA\u73B0 OOM \u9519\u8BEF</li></ol><blockquote><p>\u5185\u5B58\u4E0E\u786C\u76D8\u7684 swap</p></blockquote>`,35);function p(o,t){return e}var c=n(a,[["render",p],["__file","index.html.vue"]]);export{c as default};
