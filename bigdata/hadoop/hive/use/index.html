<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.42">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>zmn.cn</title><meta name="description" content="后端开发知识库">
    <link rel="modulepreload" href="/doc/assets/app.40df414d.js"><link rel="modulepreload" href="/doc/assets/index.html.a5eeaab0.js"><link rel="modulepreload" href="/doc/assets/index.html.e03489a4.js"><link rel="prefetch" href="/doc/assets/index.html.ac157e58.js"><link rel="prefetch" href="/doc/assets/index.html.795c9140.js"><link rel="prefetch" href="/doc/assets/index.html.fd51b8b2.js"><link rel="prefetch" href="/doc/assets/index.html.0c15a99b.js"><link rel="prefetch" href="/doc/assets/index.html.0c59ef61.js"><link rel="prefetch" href="/doc/assets/index.html.f10e9c63.js"><link rel="prefetch" href="/doc/assets/index.html.b5bfa26a.js"><link rel="prefetch" href="/doc/assets/index.html.e8912321.js"><link rel="prefetch" href="/doc/assets/index.html.e524e2c7.js"><link rel="prefetch" href="/doc/assets/index.html.e2c03529.js"><link rel="prefetch" href="/doc/assets/index.html.1a75e17e.js"><link rel="prefetch" href="/doc/assets/index.html.27d315d2.js"><link rel="prefetch" href="/doc/assets/index.html.8527be29.js"><link rel="prefetch" href="/doc/assets/index.html.5603dc63.js"><link rel="prefetch" href="/doc/assets/index.html.a735b5dd.js"><link rel="prefetch" href="/doc/assets/index.html.68217935.js"><link rel="prefetch" href="/doc/assets/index.html.79799519.js"><link rel="prefetch" href="/doc/assets/index.html.6881f0e6.js"><link rel="prefetch" href="/doc/assets/index.html.e7ff66c5.js"><link rel="prefetch" href="/doc/assets/index.html.b3989c09.js"><link rel="prefetch" href="/doc/assets/index.html.90a11c7e.js"><link rel="prefetch" href="/doc/assets/index.html.e552d764.js"><link rel="prefetch" href="/doc/assets/index.html.a2e921be.js"><link rel="prefetch" href="/doc/assets/index.html.40de4d57.js"><link rel="prefetch" href="/doc/assets/index.html.8dfb5661.js"><link rel="prefetch" href="/doc/assets/index.html.0b633e02.js"><link rel="prefetch" href="/doc/assets/index.html.325a81ac.js"><link rel="prefetch" href="/doc/assets/index.html.fc94b663.js"><link rel="prefetch" href="/doc/assets/index.html.a61a14dc.js"><link rel="prefetch" href="/doc/assets/index.html.915b115c.js"><link rel="prefetch" href="/doc/assets/index.html.74c3962d.js"><link rel="prefetch" href="/doc/assets/index.html.50e666c4.js"><link rel="prefetch" href="/doc/assets/index.html.bd0865d1.js"><link rel="prefetch" href="/doc/assets/index.html.670a8d54.js"><link rel="prefetch" href="/doc/assets/index.html.267a5925.js"><link rel="prefetch" href="/doc/assets/index.html.820a240a.js"><link rel="prefetch" href="/doc/assets/index.html.956e3861.js"><link rel="prefetch" href="/doc/assets/index.html.1eb9b84f.js"><link rel="prefetch" href="/doc/assets/index.html.085c7b3b.js"><link rel="prefetch" href="/doc/assets/index.html.cc6b0c3f.js"><link rel="prefetch" href="/doc/assets/index.html.878a89e3.js"><link rel="prefetch" href="/doc/assets/index.html.4349d3a7.js"><link rel="prefetch" href="/doc/assets/index.html.ad70fd8f.js"><link rel="prefetch" href="/doc/assets/index.html.ae8f6e96.js"><link rel="prefetch" href="/doc/assets/index.html.5904c85d.js"><link rel="prefetch" href="/doc/assets/index.html.67ad7772.js"><link rel="prefetch" href="/doc/assets/index.html.1fb78180.js"><link rel="prefetch" href="/doc/assets/index.html.79837727.js"><link rel="prefetch" href="/doc/assets/index.html.3b548d45.js"><link rel="prefetch" href="/doc/assets/index.html.3a65bcaf.js"><link rel="prefetch" href="/doc/assets/index.html.636ab4d4.js"><link rel="prefetch" href="/doc/assets/index.html.8c20145c.js"><link rel="prefetch" href="/doc/assets/index.html.93d3f714.js"><link rel="prefetch" href="/doc/assets/index.html.5cc28277.js"><link rel="prefetch" href="/doc/assets/index.html.587df9cf.js"><link rel="prefetch" href="/doc/assets/index.html.cffff73c.js"><link rel="prefetch" href="/doc/assets/index.html.0faea7db.js"><link rel="prefetch" href="/doc/assets/index.html.9ec36555.js"><link rel="prefetch" href="/doc/assets/index.html.4fbceb17.js"><link rel="prefetch" href="/doc/assets/index.html.a8892ad4.js"><link rel="prefetch" href="/doc/assets/index.html.1a7d6859.js"><link rel="prefetch" href="/doc/assets/index.html.5c08cce8.js"><link rel="prefetch" href="/doc/assets/index.html.ff1641e6.js"><link rel="prefetch" href="/doc/assets/index.html.10100559.js"><link rel="prefetch" href="/doc/assets/index.html.eca48ebd.js"><link rel="prefetch" href="/doc/assets/index.html.d9180794.js"><link rel="prefetch" href="/doc/assets/Spring.html.41ca96bd.js"><link rel="prefetch" href="/doc/assets/SpringBoot.html.c063ae1a.js"><link rel="prefetch" href="/doc/assets/SpringBoot源码.html.cdd45461.js"><link rel="prefetch" href="/doc/assets/SpringBoot高级.html.b3e5002b.js"><link rel="prefetch" href="/doc/assets/SpringMVC.html.25759dd3.js"><link rel="prefetch" href="/doc/assets/SpringSecurity.html.2ba8791d.js"><link rel="prefetch" href="/doc/assets/index.html.3afa53b5.js"><link rel="prefetch" href="/doc/assets/index.html.1963ae5c.js"><link rel="prefetch" href="/doc/assets/index.html.657aec84.js"><link rel="prefetch" href="/doc/assets/index.html.871b2105.js"><link rel="prefetch" href="/doc/assets/index.html.46266feb.js"><link rel="prefetch" href="/doc/assets/index.html.019ddb74.js"><link rel="prefetch" href="/doc/assets/index.html.2636a08e.js"><link rel="prefetch" href="/doc/assets/index.html.c6a50762.js"><link rel="prefetch" href="/doc/assets/index.html.6632d187.js"><link rel="prefetch" href="/doc/assets/index.html.480096df.js"><link rel="prefetch" href="/doc/assets/index.html.7bf9c484.js"><link rel="prefetch" href="/doc/assets/index.html.1ca63bf8.js"><link rel="prefetch" href="/doc/assets/index.html.ee1ff92b.js"><link rel="prefetch" href="/doc/assets/index.html.d1efbe95.js"><link rel="prefetch" href="/doc/assets/index.html.d302d742.js"><link rel="prefetch" href="/doc/assets/index.html.73b0a46e.js"><link rel="prefetch" href="/doc/assets/index.html.9b9e7b22.js"><link rel="prefetch" href="/doc/assets/index.html.5080b714.js"><link rel="prefetch" href="/doc/assets/index.html.e2de7b5a.js"><link rel="prefetch" href="/doc/assets/index.html.5a365a3f.js"><link rel="prefetch" href="/doc/assets/index.html.ea186b24.js"><link rel="prefetch" href="/doc/assets/index.html.da1b811a.js"><link rel="prefetch" href="/doc/assets/index.html.ba20a9fa.js"><link rel="prefetch" href="/doc/assets/index.html.23e205db.js"><link rel="prefetch" href="/doc/assets/index.html.92cefa25.js"><link rel="prefetch" href="/doc/assets/index.html.0519d6c0.js"><link rel="prefetch" href="/doc/assets/index.html.df3e94ce.js"><link rel="prefetch" href="/doc/assets/index.html.850ddff2.js"><link rel="prefetch" href="/doc/assets/index.html.060bc27e.js"><link rel="prefetch" href="/doc/assets/index.html.e9e53a65.js"><link rel="prefetch" href="/doc/assets/index.html.5730a56d.js"><link rel="prefetch" href="/doc/assets/index.html.b2f4abe8.js"><link rel="prefetch" href="/doc/assets/index.html.cafd859a.js"><link rel="prefetch" href="/doc/assets/index.html.c8328127.js"><link rel="prefetch" href="/doc/assets/index.html.887c0664.js"><link rel="prefetch" href="/doc/assets/index.html.4bf77624.js"><link rel="prefetch" href="/doc/assets/index.html.0e7972f9.js"><link rel="prefetch" href="/doc/assets/index.html.265aab2e.js"><link rel="prefetch" href="/doc/assets/index.html.ec74946d.js"><link rel="prefetch" href="/doc/assets/index.html.e3a2fec1.js"><link rel="prefetch" href="/doc/assets/index.html.36b699b6.js"><link rel="prefetch" href="/doc/assets/index.html.fdaf1cae.js"><link rel="prefetch" href="/doc/assets/index.html.ae3b119d.js"><link rel="prefetch" href="/doc/assets/index.html.b6c53f53.js"><link rel="prefetch" href="/doc/assets/index.html.0773f88d.js"><link rel="prefetch" href="/doc/assets/index.html.d571ef54.js"><link rel="prefetch" href="/doc/assets/index.html.86f9e908.js"><link rel="prefetch" href="/doc/assets/index.html.60f723ac.js"><link rel="prefetch" href="/doc/assets/index.html.01581c9b.js"><link rel="prefetch" href="/doc/assets/index.html.d96d738e.js"><link rel="prefetch" href="/doc/assets/index.html.5ddae78d.js"><link rel="prefetch" href="/doc/assets/index.html.7c0814ab.js"><link rel="prefetch" href="/doc/assets/index.html.965b7fff.js"><link rel="prefetch" href="/doc/assets/vue3快速上手.html.8773c5ea.js"><link rel="prefetch" href="/doc/assets/index.html.b2090b45.js"><link rel="prefetch" href="/doc/assets/index.html.f6fbe2a7.js"><link rel="prefetch" href="/doc/assets/index.html.5079d83e.js"><link rel="prefetch" href="/doc/assets/index.html.0e7d3814.js"><link rel="prefetch" href="/doc/assets/index.html.236535af.js"><link rel="prefetch" href="/doc/assets/index.html.e7057fa7.js"><link rel="prefetch" href="/doc/assets/index.html.0dfecf7e.js"><link rel="prefetch" href="/doc/assets/index.html.ba833381.js"><link rel="prefetch" href="/doc/assets/404.html.93146c89.js"><link rel="prefetch" href="/doc/assets/index.html.3b7265f0.js"><link rel="prefetch" href="/doc/assets/index.html.f94b83e6.js"><link rel="prefetch" href="/doc/assets/index.html.478d12bf.js"><link rel="prefetch" href="/doc/assets/index.html.9eee768a.js"><link rel="prefetch" href="/doc/assets/index.html.2b8b2ed7.js"><link rel="prefetch" href="/doc/assets/index.html.a370c4da.js"><link rel="prefetch" href="/doc/assets/index.html.4078504f.js"><link rel="prefetch" href="/doc/assets/index.html.0a470d26.js"><link rel="prefetch" href="/doc/assets/index.html.70589c68.js"><link rel="prefetch" href="/doc/assets/index.html.3e00e696.js"><link rel="prefetch" href="/doc/assets/index.html.a2857e37.js"><link rel="prefetch" href="/doc/assets/index.html.11a24d88.js"><link rel="prefetch" href="/doc/assets/index.html.13fcd6dc.js"><link rel="prefetch" href="/doc/assets/index.html.bb926e52.js"><link rel="prefetch" href="/doc/assets/index.html.83c356d4.js"><link rel="prefetch" href="/doc/assets/index.html.9093f441.js"><link rel="prefetch" href="/doc/assets/index.html.99329590.js"><link rel="prefetch" href="/doc/assets/index.html.a25f2824.js"><link rel="prefetch" href="/doc/assets/index.html.5dd4e8e8.js"><link rel="prefetch" href="/doc/assets/index.html.80a1a8a8.js"><link rel="prefetch" href="/doc/assets/index.html.e6aaf5e4.js"><link rel="prefetch" href="/doc/assets/index.html.4b4f53af.js"><link rel="prefetch" href="/doc/assets/index.html.63d82858.js"><link rel="prefetch" href="/doc/assets/index.html.02f66c42.js"><link rel="prefetch" href="/doc/assets/index.html.b02e0cb9.js"><link rel="prefetch" href="/doc/assets/index.html.b2cf2462.js"><link rel="prefetch" href="/doc/assets/index.html.4d88523a.js"><link rel="prefetch" href="/doc/assets/index.html.b6d3a8c2.js"><link rel="prefetch" href="/doc/assets/index.html.8e3bc1fc.js"><link rel="prefetch" href="/doc/assets/index.html.593a1904.js"><link rel="prefetch" href="/doc/assets/index.html.d0fdf009.js"><link rel="prefetch" href="/doc/assets/index.html.bb125db3.js"><link rel="prefetch" href="/doc/assets/index.html.7a967c9a.js"><link rel="prefetch" href="/doc/assets/index.html.ca6b22e1.js"><link rel="prefetch" href="/doc/assets/index.html.e1c469a1.js"><link rel="prefetch" href="/doc/assets/index.html.ff09b3af.js"><link rel="prefetch" href="/doc/assets/index.html.ec4bbb87.js"><link rel="prefetch" href="/doc/assets/index.html.12c1e355.js"><link rel="prefetch" href="/doc/assets/index.html.8a4045e6.js"><link rel="prefetch" href="/doc/assets/index.html.b54dc8a6.js"><link rel="prefetch" href="/doc/assets/index.html.721d96fd.js"><link rel="prefetch" href="/doc/assets/index.html.d855e8ed.js"><link rel="prefetch" href="/doc/assets/index.html.17fbd68b.js"><link rel="prefetch" href="/doc/assets/index.html.ad5ccf5a.js"><link rel="prefetch" href="/doc/assets/index.html.130dead3.js"><link rel="prefetch" href="/doc/assets/index.html.0bcc78cc.js"><link rel="prefetch" href="/doc/assets/index.html.557897f7.js"><link rel="prefetch" href="/doc/assets/index.html.1d57cd02.js"><link rel="prefetch" href="/doc/assets/index.html.df77ede5.js"><link rel="prefetch" href="/doc/assets/index.html.ac04a9ed.js"><link rel="prefetch" href="/doc/assets/index.html.037f3861.js"><link rel="prefetch" href="/doc/assets/index.html.08a635f2.js"><link rel="prefetch" href="/doc/assets/index.html.d37ad707.js"><link rel="prefetch" href="/doc/assets/index.html.af40cb25.js"><link rel="prefetch" href="/doc/assets/index.html.7b09b414.js"><link rel="prefetch" href="/doc/assets/index.html.ca416dcc.js"><link rel="prefetch" href="/doc/assets/index.html.f5eae5e4.js"><link rel="prefetch" href="/doc/assets/index.html.acf5622e.js"><link rel="prefetch" href="/doc/assets/index.html.77c30969.js"><link rel="prefetch" href="/doc/assets/index.html.ff8fef88.js"><link rel="prefetch" href="/doc/assets/index.html.b03ad9ee.js"><link rel="prefetch" href="/doc/assets/index.html.883bb815.js"><link rel="prefetch" href="/doc/assets/index.html.e5048f53.js"><link rel="prefetch" href="/doc/assets/index.html.80bf8279.js"><link rel="prefetch" href="/doc/assets/index.html.411d2f13.js"><link rel="prefetch" href="/doc/assets/index.html.e55b3889.js"><link rel="prefetch" href="/doc/assets/Spring.html.2f3df8d9.js"><link rel="prefetch" href="/doc/assets/SpringBoot.html.9cb899e2.js"><link rel="prefetch" href="/doc/assets/SpringBoot源码.html.6dd51782.js"><link rel="prefetch" href="/doc/assets/SpringBoot高级.html.74275d08.js"><link rel="prefetch" href="/doc/assets/SpringMVC.html.cf650f7b.js"><link rel="prefetch" href="/doc/assets/SpringSecurity.html.1e2f9882.js"><link rel="prefetch" href="/doc/assets/index.html.8489e95c.js"><link rel="prefetch" href="/doc/assets/index.html.4fc255fb.js"><link rel="prefetch" href="/doc/assets/index.html.6e298d1f.js"><link rel="prefetch" href="/doc/assets/index.html.dfb5c354.js"><link rel="prefetch" href="/doc/assets/index.html.55c13f7d.js"><link rel="prefetch" href="/doc/assets/index.html.9746da44.js"><link rel="prefetch" href="/doc/assets/index.html.5cad0d30.js"><link rel="prefetch" href="/doc/assets/index.html.a5a742fd.js"><link rel="prefetch" href="/doc/assets/index.html.2d7d46f5.js"><link rel="prefetch" href="/doc/assets/index.html.4fd15fc0.js"><link rel="prefetch" href="/doc/assets/index.html.5cf91540.js"><link rel="prefetch" href="/doc/assets/index.html.3d50e978.js"><link rel="prefetch" href="/doc/assets/index.html.21ff9d3b.js"><link rel="prefetch" href="/doc/assets/index.html.47b83ec4.js"><link rel="prefetch" href="/doc/assets/index.html.bc304f81.js"><link rel="prefetch" href="/doc/assets/index.html.b2a59940.js"><link rel="prefetch" href="/doc/assets/index.html.13415a43.js"><link rel="prefetch" href="/doc/assets/index.html.100ec837.js"><link rel="prefetch" href="/doc/assets/index.html.3472a443.js"><link rel="prefetch" href="/doc/assets/index.html.33aece6b.js"><link rel="prefetch" href="/doc/assets/index.html.e61dd289.js"><link rel="prefetch" href="/doc/assets/index.html.64183ae2.js"><link rel="prefetch" href="/doc/assets/index.html.446a1818.js"><link rel="prefetch" href="/doc/assets/index.html.97ea4a5c.js"><link rel="prefetch" href="/doc/assets/index.html.a6ef03fb.js"><link rel="prefetch" href="/doc/assets/index.html.3920cc47.js"><link rel="prefetch" href="/doc/assets/index.html.34f4e287.js"><link rel="prefetch" href="/doc/assets/index.html.1351290b.js"><link rel="prefetch" href="/doc/assets/index.html.84a20a4f.js"><link rel="prefetch" href="/doc/assets/index.html.e55a3317.js"><link rel="prefetch" href="/doc/assets/index.html.a8d854c3.js"><link rel="prefetch" href="/doc/assets/index.html.74d28158.js"><link rel="prefetch" href="/doc/assets/index.html.9b6544ca.js"><link rel="prefetch" href="/doc/assets/index.html.ea3deaa2.js"><link rel="prefetch" href="/doc/assets/index.html.f5114c18.js"><link rel="prefetch" href="/doc/assets/index.html.ca8dada1.js"><link rel="prefetch" href="/doc/assets/index.html.0d3a5370.js"><link rel="prefetch" href="/doc/assets/index.html.13e899ea.js"><link rel="prefetch" href="/doc/assets/index.html.4f4461aa.js"><link rel="prefetch" href="/doc/assets/index.html.b6ced39d.js"><link rel="prefetch" href="/doc/assets/index.html.6c0283f0.js"><link rel="prefetch" href="/doc/assets/index.html.01661ebc.js"><link rel="prefetch" href="/doc/assets/index.html.657c6ed2.js"><link rel="prefetch" href="/doc/assets/index.html.f5f7aed0.js"><link rel="prefetch" href="/doc/assets/index.html.cdd6e499.js"><link rel="prefetch" href="/doc/assets/index.html.2d661523.js"><link rel="prefetch" href="/doc/assets/index.html.6893b4fb.js"><link rel="prefetch" href="/doc/assets/index.html.566e406c.js"><link rel="prefetch" href="/doc/assets/index.html.1357e2d3.js"><link rel="prefetch" href="/doc/assets/index.html.d910030e.js"><link rel="prefetch" href="/doc/assets/index.html.4d5146a8.js"><link rel="prefetch" href="/doc/assets/index.html.d830c4f5.js"><link rel="prefetch" href="/doc/assets/index.html.b1bef10b.js"><link rel="prefetch" href="/doc/assets/vue3快速上手.html.d36d3c30.js"><link rel="prefetch" href="/doc/assets/index.html.1e6ab806.js"><link rel="prefetch" href="/doc/assets/index.html.4125d933.js"><link rel="prefetch" href="/doc/assets/index.html.c5dc4567.js"><link rel="prefetch" href="/doc/assets/index.html.451edb2d.js"><link rel="prefetch" href="/doc/assets/index.html.a665dde3.js"><link rel="prefetch" href="/doc/assets/index.html.5ba5e8a1.js"><link rel="prefetch" href="/doc/assets/index.html.23b6b000.js"><link rel="prefetch" href="/doc/assets/index.html.629d6531.js"><link rel="prefetch" href="/doc/assets/404.html.d315880d.js"><link rel="prefetch" href="/doc/assets/404.bebaa092.js"><link rel="prefetch" href="/doc/assets/Layout.4134e473.js">
    <link rel="stylesheet" href="/doc/assets/style.83db67df.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/doc/" class=""><img class="logo" src="https://cdn-statics.zmn.cn/_nuxt/img/logo_web.b793f2a.png" alt="zmn.cn"><span class="site-name can-hide">zmn.cn</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/doc/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Java"><span class="title">Java</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Java"><span class="title">Java</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/doc/java/kafka/" class="" aria-label="Kafka"><!--[--><!--]--> Kafka <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/doc/java/redis/" class="" aria-label="Redis"><!--[--><!--]--> Redis <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/doc/java/skywalking/" class="" aria-label="SkyWalking"><!--[--><!--]--> SkyWalking <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/doc/java/es/01/" class="" aria-label="ElasticSearch"><!--[--><!--]--> ElasticSearch <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/doc/java/drools/" class="" aria-label="Drools"><!--[--><!--]--> Drools <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/doc/java/jvm/01/" class="" aria-label="JVM"><!--[--><!--]--> JVM <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="BigData"><span class="title">BigData</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="BigData"><span class="title">BigData</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/doc/bigdata/hadoop/core/hadoop/01/" class="" aria-label="Hadoop"><!--[--><!--]--> Hadoop <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/doc/bigdata/scala/01base/" class="" aria-label="Scala"><!--[--><!--]--> Scala <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/doc/bigdata/spark/core/base/" class="" aria-label="Spark"><!--[--><!--]--> Spark <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/faustine8/doc" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="搜索" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/doc/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Java"><span class="title">Java</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Java"><span class="title">Java</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/doc/java/kafka/" class="" aria-label="Kafka"><!--[--><!--]--> Kafka <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/doc/java/redis/" class="" aria-label="Redis"><!--[--><!--]--> Redis <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/doc/java/skywalking/" class="" aria-label="SkyWalking"><!--[--><!--]--> SkyWalking <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/doc/java/es/01/" class="" aria-label="ElasticSearch"><!--[--><!--]--> ElasticSearch <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/doc/java/drools/" class="" aria-label="Drools"><!--[--><!--]--> Drools <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/doc/java/jvm/01/" class="" aria-label="JVM"><!--[--><!--]--> JVM <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="BigData"><span class="title">BigData</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="BigData"><span class="title">BigData</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/doc/bigdata/hadoop/core/hadoop/01/" class="" aria-label="Hadoop"><!--[--><!--]--> Hadoop <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/doc/bigdata/scala/01base/" class="" aria-label="Scala"><!--[--><!--]--> Scala <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/doc/bigdata/spark/core/base/" class="" aria-label="Spark"><!--[--><!--]--> Spark <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/faustine8/doc" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading"> <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/doc/bigdata/hadoop/hive/use/#第六部分-hql-dql命令【重点】" class="router-link-active router-link-exact-active sidebar-item" aria-label="第六部分 HQL DQL命令【重点】"><!--[--><!--]--> 第六部分 HQL DQL命令【重点】 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/doc/bigdata/hadoop/hive/use/#第-1-节-基本查询" class="router-link-active router-link-exact-active sidebar-item" aria-label="第 1 节 基本查询"><!--[--><!--]--> 第 1 节 基本查询 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/doc/bigdata/hadoop/hive/use/#第-2-节-where子句" class="router-link-active router-link-exact-active sidebar-item" aria-label="第 2 节 where子句"><!--[--><!--]--> 第 2 节 where子句 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/doc/bigdata/hadoop/hive/use/#第-3-节-group-by子句" class="router-link-active router-link-exact-active sidebar-item" aria-label="第 3 节 group by子句"><!--[--><!--]--> 第 3 节 group by子句 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/doc/bigdata/hadoop/hive/use/#第-4-节-表连接" class="router-link-active router-link-exact-active sidebar-item" aria-label="第 4 节 表连接"><!--[--><!--]--> 第 4 节 表连接 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/doc/bigdata/hadoop/hive/use/#第-5-节-排序子句【重点】" class="router-link-active router-link-exact-active sidebar-item" aria-label="第 5 节 排序子句【重点】"><!--[--><!--]--> 第 5 节 排序子句【重点】 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/doc/bigdata/hadoop/hive/use/#第七部分-函数" class="router-link-active router-link-exact-active sidebar-item" aria-label="第七部分 函数"><!--[--><!--]--> 第七部分 函数 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/doc/bigdata/hadoop/hive/use/#第-1-节-系统内置函数" class="router-link-active router-link-exact-active sidebar-item" aria-label="第 1 节 系统内置函数"><!--[--><!--]--> 第 1 节 系统内置函数 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/doc/bigdata/hadoop/hive/use/#第-2-节-窗口函数【重要】" class="router-link-active router-link-exact-active sidebar-item" aria-label="第 2 节 窗口函数【重要】"><!--[--><!--]--> 第 2 节 窗口函数【重要】 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/doc/bigdata/hadoop/hive/use/#第-3-节-自定义函数" class="router-link-active router-link-exact-active sidebar-item" aria-label="第 3 节 自定义函数"><!--[--><!--]--> 第 3 节 自定义函数 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/doc/bigdata/hadoop/hive/use/#第八部分-hql-dml命令" class="router-link-active router-link-exact-active sidebar-item" aria-label="第八部分 HQL DML命令"><!--[--><!--]--> 第八部分 HQL DML命令 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/doc/bigdata/hadoop/hive/use/#第-1-节-hive事务" class="router-link-active router-link-exact-active sidebar-item" aria-label="第 1 节 Hive事务"><!--[--><!--]--> 第 1 节 Hive事务 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/doc/bigdata/hadoop/hive/use/#第-2-节-hive-事务操作示例" class="router-link-active router-link-exact-active sidebar-item" aria-label="第 2 节 Hive 事务操作示例"><!--[--><!--]--> 第 2 节 Hive 事务操作示例 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h2 id="第六部分-hql-dql命令【重点】" tabindex="-1"><a class="header-anchor" href="#第六部分-hql-dql命令【重点】" aria-hidden="true">#</a> 第六部分 HQL DQL命令【重点】</h2><blockquote><p>DQL (Data Query Language) 数据查询语言</p></blockquote><p>select语法:</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">[</span><span class="token keyword">ALL</span> <span class="token operator">|</span> <span class="token keyword">DISTINCT</span><span class="token punctuation">]</span> select_expr<span class="token punctuation">,</span> select_expr<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">FROM</span> table_reference
<span class="token punctuation">[</span><span class="token keyword">WHERE</span> where_condition<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token keyword">GROUP</span> <span class="token keyword">BY</span> col_list<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> col_list<span class="token punctuation">]</span>
<span class="token punctuation">[</span>CLUSTER <span class="token keyword">BY</span> col_list <span class="token operator">|</span> <span class="token punctuation">[</span>DISTRIBUTE <span class="token keyword">BY</span> col_list<span class="token punctuation">]</span> <span class="token punctuation">[</span>SORT <span class="token keyword">BY</span> col_list<span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token keyword">LIMIT</span> <span class="token punctuation">[</span><span class="token keyword">offset</span><span class="token punctuation">,</span><span class="token punctuation">]</span> <span class="token keyword">rows</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>SQL语句书写注意事项:</p><ul><li>SQL语句对大小写不敏感</li><li>SQL语句可以写一行(简单SQL)也可以写多行(复杂SQL)</li><li>关键字不能缩写，也不能分行</li><li>各子句一般要分行</li><li>使用缩进格式，提高SQL语句的可读性(重要)</li></ul><p>创建表，加载数据</p><p>测试数据 <code>/home/hadoop/data/emp.dat</code></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>7369,SMITH,CLERK,7902,2010-12-17,800,,20
7499,ALLEN,SALESMAN,7698,2011-02-20,1600,300,30
7521,WARD,SALESMAN,7698,2011-02-22,1250,500,30
7566,JONES,MANAGER,7839,2011-04-02,2975,,20
7654,MARTIN,SALESMAN,7698,2011-09-28,1250,1400,30
7698,BLAKE,MANAGER,7839,2011-05-01,2850,,30
7782,CLARK,MANAGER,7839,2011-06-09,2450,,10
7788,SCOTT,ANALYST,7566,2017-07-13,3000,,20
7839,KING,PRESIDENT,,2011-11-07,5000,,10
7844,TURNER,SALESMAN,7698,2011-09-08,1500,0,30
7876,ADAMS,CLERK,7788,2017-07-13,1100,,20
7900,JAMES,CLERK,7698,2011-12-03,950,,30
7902,FORD,ANALYST,7566,2011-12-03,3000,,20
7934,MILLER,CLERK,7782,2012-01-23,1300,,10
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 建表并加载数据</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> emp <span class="token punctuation">(</span>
    empno <span class="token keyword">int</span><span class="token punctuation">,</span>
    ename string<span class="token punctuation">,</span>
    job string<span class="token punctuation">,</span>
    mgr <span class="token keyword">int</span><span class="token punctuation">,</span>
    hiredate <span class="token keyword">DATE</span><span class="token punctuation">,</span>
    sal <span class="token keyword">int</span><span class="token punctuation">,</span>
    comm <span class="token keyword">int</span><span class="token punctuation">,</span>
    deptno <span class="token keyword">int</span>
<span class="token punctuation">)</span><span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">;</span>

<span class="token comment">-- 加载数据</span>
<span class="token keyword">LOAD</span> <span class="token keyword">DATA</span> <span class="token keyword">LOCAL</span> INPATH <span class="token string">&#39;/home/hadoop/data/emp.dat&#39;</span> <span class="token keyword">INTO</span> <span class="token keyword">TABLE</span> emp<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="第-1-节-基本查询" tabindex="-1"><a class="header-anchor" href="#第-1-节-基本查询" aria-hidden="true">#</a> 第 1 节 基本查询</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 省略from子句的查询</span>
hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token number">8</span>*888<span class="token punctuation">;</span>
OK
_c0
<span class="token number">7104</span>
Time taken: <span class="token number">0.132</span> seconds, Fetched: <span class="token number">1</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> current_date<span class="token punctuation">;</span>
OK
_c0
<span class="token number">2022</span>-02-16
Time taken: <span class="token number">0.111</span> seconds, Fetched: <span class="token number">1</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>


<span class="token comment"># 使用列别名</span>
hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token number">8</span>*888 product<span class="token punctuation">;</span>
OK
product
<span class="token number">7104</span>
Time taken: <span class="token number">0.121</span> seconds, Fetched: <span class="token number">1</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> current_date as currdate<span class="token punctuation">;</span>
OK
currdate
<span class="token number">2022</span>-02-16
Time taken: <span class="token number">0.1</span> seconds, Fetched: <span class="token number">1</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 全表查询</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- 选择特定列查询</span>
<span class="token keyword">select</span> ename<span class="token punctuation">,</span> sal<span class="token punctuation">,</span> comm <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- 使用函数</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
<span class="token comment">-- count(colname) 按字段进行count，不统计column为NULL的数据</span>

<span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token function">min</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token function">avg</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- 使用limit子句限制返回的行数</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">limit</span> <span class="token number">3</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="第-2-节-where子句" tabindex="-1"><a class="header-anchor" href="#第-2-节-where子句" aria-hidden="true">#</a> 第 2 节 where子句</h3><p>WHERE子句紧随FROM子句，使用WHERE子句，过滤不满足条件的数据;</p><p><em>WHERE 子句中不能使用列的别名</em></p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> sal <span class="token operator">&gt;</span> <span class="token number">2000</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>WHERE 子句中会涉及到较多的比较运算和逻辑运算;</p><h4 id="比较运算符" tabindex="-1"><a class="header-anchor" href="#比较运算符" aria-hidden="true">#</a> 比较运算符</h4><blockquote><p>官方文档: https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF</p></blockquote><table><thead><tr><th>比较运算符</th><th>描述</th></tr></thead><tbody><tr><td><code>=、==、&lt;=&gt;</code></td><td>等于</td></tr><tr><td><code>&lt;&gt;、!=</code></td><td>不等于</td></tr><tr><td><code>&lt;、&lt;=、 &gt;、&gt;=</code></td><td>大于等于、小于等于</td></tr><tr><td><code>is [not] null</code></td><td>如果A等于NULL，则返回TRUE，反之返回FALSE。使用NOT关键字结果相反。</td></tr><tr><td><code>in (value1, value2, ... ...)</code></td><td>匹配列表中的值</td></tr><tr><td><code>LIKE</code></td><td>简单正则表达式，也称通配符模式。&#39;x%&#39; 表示必须以字母 &#39;x&#39; 开 头;&#39;%x&#39;表示必须以字母&#39;x&#39;结尾;&#39;%x%&#39;表示包含有字母&#39;x&#39;，可以位于字符串任意位置。使用NOT关键字结果相反。<br>% 代表匹配零个或多个字符(任意个字符);_ 代表匹配一个字符。</td></tr><tr><td><code>[NOT] BETWEEN ... AND ...</code></td><td>范围的判断，使用NOT关键字结果相反。</td></tr><tr><td><code>RLIKE、 REGEXP</code></td><td>基于java的正则表达式，匹配返回TRUE，反之返回FALSE。匹配使用的是JDK中的正则表达式接口实现的，因为正则也依据其中的规则。例如，正则表达式必须和整个字符串A相匹配，而不是只需与其字符串匹配。</td></tr></tbody></table><blockquote><p>备注: 通常情况下NULL参与运算，返回值为NULL; <code>NULL&lt;=&gt;NULL</code> 的结果为true</p></blockquote><blockquote><p>不能使用 <code>!= null</code>, 只能使用 <code>is null</code></p></blockquote><p>####逻辑运算符</p><p>就是我们所熟悉的: and、or、not</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 比较运算符，null参与运算</span>
<span class="token keyword">select</span> <span class="token boolean">null</span><span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">;</span>   <span class="token comment">-- NULL</span>
<span class="token keyword">select</span> <span class="token boolean">null</span><span class="token operator">=</span><span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">;</span>  <span class="token comment">-- NULL</span>
<span class="token keyword">select</span> <span class="token boolean">null</span><span class="token operator">&lt;=&gt;</span><span class="token boolean">null</span><span class="token punctuation">;</span> <span class="token comment">-- true 相当于 is null</span>

<span class="token comment">-- 使用 is null 判空</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> comm <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">;</span>
<span class="token comment">-- 不能使用 `!= null`, 只能使用 `is null`</span>

<span class="token comment">--使用in</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> deptno <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 使用 between ... and ...</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> sal <span class="token operator">between</span> <span class="token number">1000</span> <span class="token operator">and</span> <span class="token number">2000</span><span class="token punctuation">;</span>

<span class="token comment">-- 使用 like</span>
<span class="token keyword">select</span> ename<span class="token punctuation">,</span> sal <span class="token keyword">from</span> emp <span class="token keyword">where</span> ename <span class="token operator">like</span> <span class="token string">&#39;%L%&#39;</span><span class="token punctuation">;</span>

<span class="token comment">-- 使用 rlike。正则表达式，名字以A或S开头</span>
<span class="token keyword">select</span> ename<span class="token punctuation">,</span> sal <span class="token keyword">from</span> emp <span class="token keyword">where</span> ename <span class="token operator">rlike</span> <span class="token string">&#39;^(A|S).*&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="第-3-节-group-by子句" tabindex="-1"><a class="header-anchor" href="#第-3-节-group-by子句" aria-hidden="true">#</a> 第 3 节 group by子句</h3><p>GROUP BY语句通常与聚组函数一起使用，按照一个或多个列对数据进行分组，对每个组进行聚合操作。</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 计算emp表每个部门的平均工资</span>
<span class="token keyword">SELECT</span> deptno<span class="token punctuation">,</span> <span class="token function">AVG</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">FROM</span> emp <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> deptno<span class="token punctuation">;</span>

<span class="token comment">-- 计算emp每个部门中每个岗位的最高薪水</span>
<span class="token keyword">SELECT</span> deptno<span class="token punctuation">,</span> job<span class="token punctuation">,</span> <span class="token function">MAX</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">FROM</span> emp <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> deptno<span class="token punctuation">,</span> job<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>WHERE 子句针对表中的数据发挥作用; <em>HAVING 针对查询结果(聚组以后的结果)发挥作用</em></li><li>WHERE 子句不能有分组函数; HAVING 子句可以有分组函数</li><li>HAVING 只用于 GROUP BY 分组统计之后</li></ul><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 求每个部门的平均薪水大于2000的部门 </span>
<span class="token keyword">SELECT</span> deptno<span class="token punctuation">,</span> <span class="token function">AVG</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> emp
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> deptno
<span class="token keyword">HAVING</span> <span class="token function">AVG</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2000</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="第-4-节-表连接" tabindex="-1"><a class="header-anchor" href="#第-4-节-表连接" aria-hidden="true">#</a> 第 4 节 表连接</h3><p>Hive支持通常SQL的<code>JOIN</code>语句。默认情况下，<em>仅支持等值连接</em>，不支持非等值连接。</p><p>JOIN 语句中经常会使用表的别名。使用别名可以简化SQL语句的编写，使用表名前缀可以提高SQL的解析效率。</p><p>连接查询操作分为两大类: 内连接和外连接，而外连接可进一步细分为三种类型:</p><ol><li>内连接: <code>[inner] join</code></li><li>外连接 (<code>outer join</code>) <ul><li>左外连接。 <code>left [outer] join</code>，左表的数据全部显示</li><li>右外连接。 <code>right [outer] join</code>，右表的数据全部显示</li><li>全外连接。 <code>full [outer] join</code>，两张表的数据都显示</li></ul></li></ol><blockquote><p>个人觉得：左外连接可以理解成左边是主表，右边的表是用于完善左表的数据的补充。</p></blockquote><h4 id="多表连接" tabindex="-1"><a class="header-anchor" href="#多表连接" aria-hidden="true">#</a> 多表连接</h4><p>连接 n 张表，至少需要 n-1 个连接条件。</p><p>例如: 连接四张表，至少需要三个连接条件。</p><p>多表连接查询，查询老师对应的课程，以及对应的分数，对应的学生:</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> techer t 
    <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> course c <span class="token keyword">ON</span> t<span class="token punctuation">.</span>t_id <span class="token operator">=</span> c<span class="token punctuation">.</span>t_id
    <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> score  s <span class="token keyword">ON</span> s<span class="token punctuation">.</span>c_id <span class="token operator">=</span> c<span class="token punctuation">.</span>c_id
    <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> student stu <span class="token keyword">ON</span> s<span class="token punctuation">.</span>s_id <span class="token operator">=</span> stu<span class="token punctuation">.</span>s_id<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>Hive总是按照从左到右的顺序执行，Hive会对每对 <code>JOIN</code> 连接对象启动一个 MapReduce 任务。</p><p>上面的例子中会首先启动一个 MapReduce job 对表 t 和表 c 进行连接操作; 然后再启动一个 MapReduce job 将第一个 MapReduce job 的输出和表 s 进行连接操作; 然后再继续直到全部操作;</p><h4 id="笛卡尔积" tabindex="-1"><a class="header-anchor" href="#笛卡尔积" aria-hidden="true">#</a> 笛卡尔积</h4><p>满足以下条件将会产生笛卡尔集:</p><ul><li>没有连接条件</li><li>连接条件无效</li><li>所有表中的所有行互相连接</li></ul><p>如果表A、B分别有M、N条数据，其笛卡尔积的结果将有 M*N 条数据; 默认情况下 Hive 不支持笛卡尔积运算;</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SET</span> hive<span class="token punctuation">.</span>strict<span class="token punctuation">.</span>checks<span class="token punctuation">.</span>cartesian<span class="token punctuation">.</span>product<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> u1<span class="token punctuation">,</span> u2<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="第-5-节-排序子句【重点】" tabindex="-1"><a class="header-anchor" href="#第-5-节-排序子句【重点】" aria-hidden="true">#</a> 第 5 节 排序子句【重点】</h3><h4 id="全局排序-order-by" tabindex="-1"><a class="header-anchor" href="#全局排序-order-by" aria-hidden="true">#</a> 全局排序(order by)</h4><p>ORDER BY 子句出现在 SELECT 语句的结尾;</p><p>ORDER BY 子句对最终的结果进行排序;</p><p>默认使用升序(ASC);可以使用DESC，跟在字段名之后表示降序;</p><p><em>ORDER BY 执行全局排序，只有一个 Reduce;</em>(因此如果数据量过大，就不适用)</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 普通排序</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> deptno<span class="token punctuation">;</span>

<span class="token comment">-- 按别名排序</span>
<span class="token keyword">SELECT</span> empno<span class="token punctuation">,</span> ename<span class="token punctuation">,</span> job<span class="token punctuation">,</span> mgr<span class="token punctuation">,</span> sal <span class="token operator">+</span> nvl<span class="token punctuation">(</span>comm<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> salcomm<span class="token punctuation">,</span> deptno
<span class="token keyword">FROM</span> emp
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salcomm <span class="token keyword">DESC</span><span class="token punctuation">;</span>

<span class="token comment">-- 多列排序</span>
<span class="token keyword">SELECT</span> empno<span class="token punctuation">,</span> ename<span class="token punctuation">,</span> job<span class="token punctuation">,</span> mgr<span class="token punctuation">,</span> sal <span class="token operator">+</span> nvl<span class="token punctuation">(</span>comm<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> salcomm<span class="token punctuation">,</span> deptno
<span class="token keyword">FROM</span> emp
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> deptno<span class="token punctuation">,</span> salcomm <span class="token keyword">DESC</span><span class="token punctuation">;</span>

<span class="token comment">-- 排序字段要出现在SELECT子句中。以下语句无法执行(因为SELECT子句中缺少deptno):</span>
<span class="token keyword">SELECT</span> empno<span class="token punctuation">,</span> ename<span class="token punctuation">,</span> job<span class="token punctuation">,</span> mgr<span class="token punctuation">,</span> sal <span class="token operator">+</span> nvl<span class="token punctuation">(</span>comm<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> salcomm
<span class="token keyword">FROM</span> emp
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> deptno<span class="token punctuation">,</span> salcomm <span class="token keyword">DESC</span><span class="token punctuation">;</span>
<span class="token comment">-- FAILED: SemanticException [Error 10004]: Line 3:9 Invalid table alias or column reference &#39;deptno&#39;: (possible column names are: empno, ename, job, mgr, salcomm)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="每个mr内部排序-sort-by" tabindex="-1"><a class="header-anchor" href="#每个mr内部排序-sort-by" aria-hidden="true">#</a> 每个MR内部排序(sort by)</h4><p>对于大规模数据而言 ORDER BY 效率低;</p><p>在很多业务场景，我们并不需要全局有序的数据，此时可以使用sort by;</p><p>sort by为每个reduce产生一个排序文件，在reduce内部进行排序，得到局部有序的结果;</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 设置reduce个数</span>
<span class="token keyword">set</span> mapreduce<span class="token punctuation">.</span>job<span class="token punctuation">.</span>reduces<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
<span class="token comment">-- 按照工资降序查看员工信息</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp SORT <span class="token keyword">BY</span> sal <span class="token keyword">DESC</span><span class="token punctuation">;</span>
<span class="token comment">-- 将查询结果导入到文件中(按照工资降序)。生成两个输出文件，每个文件内部数据 按工资降序排列</span>
<span class="token keyword">INSERT</span> overwrite <span class="token keyword">local</span> directory <span class="token string">&#39;/home/hadoop/output/sortsal&#39;</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp SORT <span class="token keyword">BY</span> sal <span class="token keyword">DESC</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>ORDER BY 全局排序; SORT BY 在Reduce内部局部排序。</p></blockquote><h4 id="分区排序-distribute-by" tabindex="-1"><a class="header-anchor" href="#分区排序-distribute-by" aria-hidden="true">#</a> 分区排序(distribute by)</h4><p>DISTRIBUTE BY 将特定的行发送到特定的reducer中，便于后继的聚合与排序操作;</p><p>DISTRIBUTE BY 类似于MR中的分区操作，可以结合sort by操作，使分区数据有序;</p><p>DISTRIBUTE BY 要写在 sort by 之前;</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 启动2个reducer task;</span>
<span class="token comment">-- 先按 deptno 分区，在分区内按 sal+comm 排序 </span>
<span class="token keyword">set</span> mapreduce<span class="token punctuation">.</span>job<span class="token punctuation">.</span>reduces<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
<span class="token comment">-- 将结果输出到文件，观察输出结果</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">local</span> directory <span class="token string">&#39;/home/hadoop/output/distBy&#39;</span> 
<span class="token keyword">SELECT</span> empno<span class="token punctuation">,</span> ename<span class="token punctuation">,</span> job<span class="token punctuation">,</span> deptno<span class="token punctuation">,</span> sal <span class="token operator">+</span> nvl<span class="token punctuation">(</span>comm<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> salcomm
<span class="token keyword">FROM</span> emp
DISTRIBUTE <span class="token keyword">BY</span> deptno
SORT <span class="token keyword">BY</span> salcomm <span class="token keyword">desc</span><span class="token punctuation">;</span>
<span class="token comment">-- 上例中，数据被分到了同一区，看不出分区的结果。</span>
<span class="token comment">-- 因为10,20,30 这几个值 % 2(分区数) 都等于0，所以数据都进入了 0 号分区</span>

<span class="token comment">-- 将数据分到3个区中，每个分区都有数据</span>
<span class="token keyword">set</span> mapreduce<span class="token punctuation">.</span>job<span class="token punctuation">.</span>reduces<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">local</span> directory <span class="token string">&#39;/home/hadoop/output/distBy1&#39;</span>
<span class="token keyword">SELECT</span> empno<span class="token punctuation">,</span> ename<span class="token punctuation">,</span> job<span class="token punctuation">,</span> deptno<span class="token punctuation">,</span> sal <span class="token operator">+</span> nvl<span class="token punctuation">(</span>comm<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> salcomm
<span class="token keyword">FROM</span> emp
DISTRIBUTE <span class="token keyword">BY</span> deptno
SORT <span class="token keyword">BY</span> salcomm <span class="token keyword">DESC</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><blockquote><p>DISTRIBUTE BY 相当于 MR 当中指定 Partitioner, SORT BY 相当于 MR 当中指定 GroupingComparator</p></blockquote><h4 id="cluster-by" tabindex="-1"><a class="header-anchor" href="#cluster-by" aria-hidden="true">#</a> Cluster By</h4><p>当 <code>DISTRIBUTE BY</code> 与 <code>SORT BY</code> 是同一个字段时，可使用 CLUSTER BY 简化语法;</p><blockquote><p>也就是根据同一字段分区并排序，排序规则只能是升序。</p></blockquote><p>限制：CLUSTER BY 只能是升序，不能指定排序规则;</p><blockquote><p>个人实测：此处的升序也不是业务意义上的升序，而是 <code>字段值 % 分区数</code> 的值得升序。这可能也是为什么只能升序的原因吧。</p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 语法上是等价的</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp DISTRIBUTE <span class="token keyword">BY</span> deptno SORT <span class="token keyword">BY</span> deptno<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp CLUSTER <span class="token keyword">BY</span> deptno<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>排序小结</strong></p><ul><li>ORDER BY 执行全局排序，效率低。<em>生产环境中慎用</em></li><li>SORT BY 使数据局部有序(在reduce内部有序)</li><li>DISTRIBUTE BY 按照指定的条件将数据分组，常与 SORT BY 联用，使数据局部有序</li><li>CLUSTER BY 当 DISTRIBUTE BY 与 SORT BY 是同一个字段时，可使用 CLUSTER BY 简化语法</li></ul><h2 id="第七部分-函数" tabindex="-1"><a class="header-anchor" href="#第七部分-函数" aria-hidden="true">#</a> 第七部分 函数</h2><blockquote><p>Hive内置函数: <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF#LanguageManualUDF-Built-inFunctions" target="_blank" rel="noopener noreferrer">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF#LanguageManualUDF-Built-inFunctions<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><h3 id="第-1-节-系统内置函数" tabindex="-1"><a class="header-anchor" href="#第-1-节-系统内置函数" aria-hidden="true">#</a> 第 1 节 系统内置函数</h3><h4 id="查看系统函数" tabindex="-1"><a class="header-anchor" href="#查看系统函数" aria-hidden="true">#</a> 查看系统函数</h4><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 查看系统自带函数 </span>
<span class="token keyword">show</span> functions<span class="token punctuation">;</span>

<span class="token comment">-- 显示自带函数的用法</span>
<span class="token keyword">desc</span> <span class="token keyword">function</span> upper<span class="token punctuation">;</span>
<span class="token keyword">desc</span> <span class="token keyword">function</span> <span class="token keyword">extended</span> upper<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="日期函数【重要】" tabindex="-1"><a class="header-anchor" href="#日期函数【重要】" aria-hidden="true">#</a> 日期函数【重要】</h4><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 当前日期</span>
<span class="token keyword">select</span> <span class="token keyword">current_date</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> unix_timestamp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- unix_timestamp(void) is deprecated. Use current_timestamp instead.</span>
<span class="token comment">-- 建议使用current_timestamp，有没有括号都可以 </span>
<span class="token keyword">select</span> <span class="token keyword">current_timestamp</span><span class="token punctuation">;</span>

<span class="token comment">-- 时间戳转日期</span>
<span class="token keyword">select</span> from_unixtime<span class="token punctuation">(</span><span class="token number">1645067197</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> from_unixtime<span class="token punctuation">(</span><span class="token number">1645067197</span><span class="token punctuation">,</span> <span class="token string">&#39;yyyyMMdd&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> from_unixtime<span class="token punctuation">(</span><span class="token number">1645067197</span><span class="token punctuation">,</span> <span class="token string">&#39;yyyy-MM-dd HH:mm:ss&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 日期转时间戳</span>
<span class="token keyword">select</span> unix_timestamp<span class="token punctuation">(</span><span class="token string">&#39;2022-02-17 11:06:37&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 计算时间差</span>
<span class="token comment">-- 149</span>
<span class="token keyword">select</span> datediff<span class="token punctuation">(</span><span class="token string">&#39;2020-04-18&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;2019-11-21&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- -149</span>
<span class="token keyword">select</span> datediff<span class="token punctuation">(</span><span class="token string">&#39;2019-11-21&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;2020-04-18&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询当月第几天</span>
<span class="token keyword">select</span> dayofmonth<span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 计算月末:</span>
<span class="token keyword">select</span> last_day<span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 当月第1天:</span>
<span class="token comment">-- date_sub(start_date, num_days) - Returns the date that is num_days before start_date.</span>
<span class="token keyword">select</span> date_sub<span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">,</span> dayofmonth<span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 下个月第1天:</span>
<span class="token comment">-- add_months(start_date, num_months) - Returns the date that is num_months after start_date.</span>
<span class="token keyword">select</span> add_months<span class="token punctuation">(</span>date_sub<span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">,</span> dayofmonth<span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 字符串转时间(字符串必须为:yyyy-MM-dd格式) </span>
<span class="token keyword">select</span> to_date<span class="token punctuation">(</span><span class="token string">&#39;2020-01-01&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> to_date<span class="token punctuation">(</span><span class="token string">&#39;2020-01-01 12:12:12&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 日期、时间戳、字符串类型格式化输出标准时间格式</span>
<span class="token keyword">select</span> date_format<span class="token punctuation">(</span><span class="token keyword">current_timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#39;yyyy-MM-dd HH:mm:ss&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> date_format<span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#39;yyyyMMdd&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> date_format<span class="token punctuation">(</span><span class="token string">&#39;2020-06-01&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;yyyy-MM-dd HH:mm:ss&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 计算emp表中，每个人的工龄</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token function">round</span><span class="token punctuation">(</span>datediff<span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">,</span> hiredate<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">365</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> workingyears <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><h4 id="字符串函数" tabindex="-1"><a class="header-anchor" href="#字符串函数" aria-hidden="true">#</a> 字符串函数</h4><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 转小写。lower</span>
<span class="token keyword">select</span> lower<span class="token punctuation">(</span><span class="token string">&quot;HELLO WORLD&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 转大写。upper</span>
<span class="token keyword">select</span> lower<span class="token punctuation">(</span>ename<span class="token punctuation">)</span><span class="token punctuation">,</span> ename <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- 求字符串长度。length</span>
<span class="token keyword">select</span> length<span class="token punctuation">(</span>ename<span class="token punctuation">)</span><span class="token punctuation">,</span> ename <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- 字符串拼接。 concat 或 ||</span>
<span class="token keyword">select</span> empno <span class="token operator">||</span> <span class="token string">&quot; &quot;</span> <span class="token operator">||</span>ename idname <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
<span class="token keyword">select</span> concat<span class="token punctuation">(</span>empno<span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span> <span class="token punctuation">,</span>ename<span class="token punctuation">)</span> idname <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- 指定分隔符。concat_ws(separator, [string | array(string)]+)</span>
<span class="token keyword">SELECT</span> concat_ws<span class="token punctuation">(</span><span class="token string">&#39;.&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;www&#39;</span><span class="token punctuation">,</span> array<span class="token punctuation">(</span><span class="token string">&#39;zmn&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;com&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> concat_ws<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> ename<span class="token punctuation">,</span> job<span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- 求子串。substr</span>
<span class="token keyword">SELECT</span> substr<span class="token punctuation">(</span><span class="token string">&#39;www.zmn.com&#39;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> substr<span class="token punctuation">(</span><span class="token string">&#39;www.zmn.com&#39;</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> substr<span class="token punctuation">(</span><span class="token string">&#39;www.zmn.com&#39;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 字符串切分。split，注意 &#39;.&#39; 要转义</span>
<span class="token keyword">select</span> split<span class="token punctuation">(</span><span class="token string">&quot;www.zmn.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\\.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h4 id="数学函数" tabindex="-1"><a class="header-anchor" href="#数学函数" aria-hidden="true">#</a> 数学函数</h4><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 四舍五入。round</span>
<span class="token keyword">select</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token number">314.15926</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">select</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token number">314.15926</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 314.16</span>
<span class="token keyword">select</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token number">314.15926</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 300</span>

<span class="token comment">-- 向上取整。ceil</span>
<span class="token keyword">select</span> ceil<span class="token punctuation">(</span><span class="token number">3.1415926</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 4</span>
<span class="token comment">-- 向下取整。floor</span>
<span class="token keyword">select</span> floor<span class="token punctuation">(</span><span class="token number">3.1415926</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 3</span>
<span class="token comment">-- 其他数学函数包括:绝对值、平方、开方、对数运算、三角运算等</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="条件函数【重要】" tabindex="-1"><a class="header-anchor" href="#条件函数【重要】" aria-hidden="true">#</a> 条件函数【重要】</h4><p>条件函数主要有：if, case when, coalesce, isnull/isnotnull, nvl, nullif 等等</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- if (boolean testCondition, T valueTrue, T valueFalseOrNull)</span>
<span class="token keyword">select</span> sal<span class="token punctuation">,</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sal<span class="token operator">&lt;</span><span class="token number">1500</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sal <span class="token operator">&lt;</span> <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- CASE WHEN a THEN b [WHEN c THEN d]* [ELSE e] END</span>
<span class="token comment">-- 将emp表的员工工资等级分类:0-1500、1500-3000、3000以上</span>
<span class="token keyword">select</span> sal<span class="token punctuation">,</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sal<span class="token operator">&lt;=</span><span class="token number">1500</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sal <span class="token operator">&lt;=</span> <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- CASE WHEN a THEN b [WHEN c THEN d]* [ELSE e] END </span>
<span class="token comment">-- 复杂条件用 case when 更直观</span>
<span class="token keyword">select</span> sal<span class="token punctuation">,</span> <span class="token keyword">case</span> <span class="token keyword">when</span> sal<span class="token operator">&lt;=</span><span class="token number">1500</span> <span class="token keyword">then</span> <span class="token number">1</span>
                 <span class="token keyword">when</span> sal<span class="token operator">&lt;=</span><span class="token number">3000</span> <span class="token keyword">then</span> <span class="token number">2</span>
                 <span class="token keyword">else</span> <span class="token number">3</span> <span class="token keyword">end</span> sallevel <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- 以下语句等价</span>
<span class="token keyword">select</span> ename<span class="token punctuation">,</span> deptno<span class="token punctuation">,</span>
       <span class="token keyword">case</span> deptno <span class="token keyword">when</span> <span class="token number">10</span> <span class="token keyword">then</span> <span class="token string">&#39;accounting&#39;</span>
                   <span class="token keyword">when</span> <span class="token number">20</span> <span class="token keyword">then</span> <span class="token string">&#39;research&#39;</span>
                   <span class="token keyword">when</span> <span class="token number">30</span> <span class="token keyword">then</span> <span class="token string">&#39;sales&#39;</span>
                   <span class="token keyword">else</span> <span class="token string">&#39;unknown&#39;</span> <span class="token keyword">end</span> deptname
<span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token keyword">select</span> ename<span class="token punctuation">,</span> deptno<span class="token punctuation">,</span>
       <span class="token keyword">case</span> <span class="token keyword">when</span> deptno<span class="token operator">=</span><span class="token number">10</span> <span class="token keyword">then</span> <span class="token string">&#39;accounting&#39;</span>
            <span class="token keyword">when</span> deptno<span class="token operator">=</span><span class="token number">20</span> <span class="token keyword">then</span> <span class="token string">&#39;research&#39;</span>
            <span class="token keyword">when</span> deptno<span class="token operator">=</span><span class="token number">30</span> <span class="token keyword">then</span> <span class="token string">&#39;sales&#39;</span>
            <span class="token keyword">else</span> <span class="token string">&#39;unknown&#39;</span> <span class="token keyword">end</span> deptname
<span class="token keyword">from</span> emp<span class="token punctuation">;</span>


<span class="token comment">-- COALESCE(T v1, T v2, ...)。</span>
<span class="token comment">-- 返回参数中的第一个非空值; 如果所有值都为NULL，那么返回NULL</span>
<span class="token keyword">select</span> sal<span class="token punctuation">,</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>comm<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- isnull(a) isnotnull(a)</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> isnull<span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> isnotnull<span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- nvl(T value, T default_value) 空值转换函数</span>
<span class="token keyword">select</span> empno<span class="token punctuation">,</span> ename<span class="token punctuation">,</span> job<span class="token punctuation">,</span> mgr<span class="token punctuation">,</span> hiredate<span class="token punctuation">,</span> deptno<span class="token punctuation">,</span> sal <span class="token operator">+</span> nvl<span class="token punctuation">(</span>comm<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> sumsal
<span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- nullif(x, y) 相等为空，否则为 x</span>
<span class="token comment">-- nullif(a1, a2) - shorthand for: case when a1 = a2 then null else a1</span>
<span class="token keyword">SELECT</span> <span class="token keyword">nullif</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">nullif</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h4 id="udtf函数【重要】" tabindex="-1"><a class="header-anchor" href="#udtf函数【重要】" aria-hidden="true">#</a> UDTF函数【重要】</h4><blockquote><p>UDTF : User Defined Table-Generating Functions。</p></blockquote><p>用户定义表生成函数，特点是：<em>&quot;一行输入，多行输出&quot;</em>。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># explode，炸裂函数</span>
<span class="token comment"># 就是将一行中复杂的 array 或者 map 结构拆分成多行 </span>
hive <span class="token punctuation">(</span>default<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> explode<span class="token punctuation">(</span>array<span class="token punctuation">(</span><span class="token string">&#39;A&#39;</span>,<span class="token string">&#39;B&#39;</span>,<span class="token string">&#39;C&#39;</span><span class="token punctuation">))</span> as col<span class="token punctuation">;</span>
OK
col
A
B
C
Time taken: <span class="token number">0.179</span> seconds, Fetched: <span class="token number">3</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

hive <span class="token punctuation">(</span>default<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> explode<span class="token punctuation">(</span>map<span class="token punctuation">(</span><span class="token string">&#39;a&#39;</span>, <span class="token number">8</span>, <span class="token string">&#39;b&#39;</span>, <span class="token number">88</span>, <span class="token string">&#39;c&#39;</span>, <span class="token number">888</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
OK
key     value
a       <span class="token number">8</span>
b       <span class="token number">88</span>
c       <span class="token number">888</span>
Time taken: <span class="token number">0.185</span> seconds, Fetched: <span class="token number">3</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>
<span class="token comment">-- UDTF&#39;s are not supported outside the SELECT clause, nor nested in expressions</span>
<span class="token comment">-- SELECT pageid, explode(adid_list) AS myCol... is not supported   -- 不能有其他列</span>
<span class="token comment">-- SELECT explode(explode(adid_list)) AS myCol... is not supported  -- 不支持嵌套</span>

<span class="token comment">-- lateral view 常与 表生成函数explode结合使用</span>

<span class="token comment">-- lateral view 语法:</span>
<span class="token comment">-- lateralView: LATERAL VIEW udtf(expression) tableAlias AS columnAlias (&#39;,&#39; columnAlias)*</span>
<span class="token comment">-- fromClause: FROM baseTable (lateralView)*</span>

<span class="token comment">-- lateral view 的基本使用 </span>
<span class="token keyword">with</span> t1 <span class="token keyword">as</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token string">&#39;OK&#39;</span> cola<span class="token punctuation">,</span> split<span class="token punctuation">(</span><span class="token string">&#39;www.zmn.cn&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;\\.&#39;</span><span class="token punctuation">)</span> colb
<span class="token punctuation">)</span>
<span class="token keyword">select</span> cola<span class="token punctuation">,</span> colc <span class="token keyword">from</span> t1 
    lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>colb<span class="token punctuation">)</span> t2 <span class="token keyword">as</span> colc<span class="token punctuation">;</span>

OK
cola    colc
OK      www
OK      zmn
OK      cn
<span class="token keyword">Time</span> taken: <span class="token number">0.176</span> seconds<span class="token punctuation">,</span> Fetched: <span class="token number">3</span> <span class="token keyword">row</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>炸裂函数测试案例：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># 数据
1   1,2,3
2   2,3
3   1,2

# 展示为如下形式
1   1
1   2
1   3
2   2
2   3
3   1
3   2
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 建表加载数据</span>
hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> create table tab1<span class="token punctuation">(</span>id int, tags string<span class="token punctuation">)</span> row <span class="token function">format</span> delimited fields terminated by <span class="token string">&#39;\t&#39;</span><span class="token punctuation">;</span>
OK
Time taken: <span class="token number">0.881</span> seconds

hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> load data <span class="token builtin class-name">local</span> inpath <span class="token string">&#39;/home/hadoop/data/tab1.dat&#39;</span> into table tab1<span class="token punctuation">;</span>
Loading data to table mydb.tab1
OK
Time taken: <span class="token number">0.774</span> seconds

hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> * from tab1<span class="token punctuation">;</span>
OK
tab1.id tab1.tags
<span class="token number">1</span>       <span class="token number">1,2</span>,3
<span class="token number">2</span>       <span class="token number">2,3</span>
<span class="token number">3</span>       <span class="token number">1,2</span>
Time taken: <span class="token number">2.228</span> seconds, Fetched: <span class="token number">3</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> id, tag from tab1 lateral view explode<span class="token punctuation">(</span>split<span class="token punctuation">(</span>tags, <span class="token string">&quot;,&quot;</span><span class="token punctuation">))</span> t1 as tag<span class="token punctuation">;</span>
OK
<span class="token function">id</span>      tag
<span class="token number">1</span>       <span class="token number">1</span>
<span class="token number">1</span>       <span class="token number">2</span>
<span class="token number">1</span>       <span class="token number">3</span>
<span class="token number">2</span>       <span class="token number">2</span>
<span class="token number">2</span>       <span class="token number">3</span>
<span class="token number">3</span>       <span class="token number">1</span>
<span class="token number">3</span>       <span class="token number">2</span>
Time taken: <span class="token number">0.102</span> seconds, Fetched: <span class="token number">7</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>测试案例2：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># 数据准备
lisi|Chinese:90,Math:80,English:70
wangwu|Chinese:88,Math:90,English:96
maliu|Chinese:99,Math:65,English:60
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 创建表</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> studscore<span class="token punctuation">(</span>
    name  string<span class="token punctuation">,</span>
    score map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>string<span class="token operator">&gt;</span>
<span class="token punctuation">)</span> <span class="token keyword">row</span> format delimited
<span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">&#39;|&#39;</span>
collection items <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">&#39;,&#39;</span>
map <span class="token keyword">keys</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">&#39;:&#39;</span><span class="token punctuation">;</span>

<span class="token comment">-- 加载数据</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">&#39;/home/hadoop/data/score.dat&#39;</span> overwrite <span class="token keyword">into</span> <span class="token keyword">table</span> studscore<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 需求：找到每个学员的最好成绩</span>
<span class="token comment"># 第一步，使用 explode 函数将map结构拆分为多行。(此处的 as 后面两个字段一定要加括号，否则 hive 认为 mark 是表中的字段)</span>
hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> explode<span class="token punctuation">(</span>score<span class="token punctuation">)</span> as <span class="token punctuation">(</span>subject, mark<span class="token punctuation">)</span> from studscore<span class="token punctuation">;</span>
OK
subject mark
Chinese <span class="token number">90</span>
Math    <span class="token number">80</span>
English <span class="token number">70</span>
Chinese <span class="token number">88</span>
Math    <span class="token number">90</span>
English <span class="token number">96</span>
Chinese <span class="token number">99</span>
Math    <span class="token number">65</span>
English <span class="token number">60</span>
Time taken: <span class="token number">0.641</span> seconds, Fetched: <span class="token number">9</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

<span class="token comment"># 但是这里缺少了学员姓名，加上学员姓名后出错。下面的语句有是错的</span>
hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> name, explode<span class="token punctuation">(</span>score<span class="token punctuation">)</span> as <span class="token punctuation">(</span>subject, mark<span class="token punctuation">)</span> from studscore<span class="token punctuation">;</span>
FAILED: SemanticException <span class="token number">1</span>:41 AS clause has an invalid number of aliases. Error encountered near token <span class="token string">&#39;mark&#39;</span>

<span class="token comment"># 第二步：explode常与 lateral view 函数联用，这两个函数结合在一起能关联其他字段</span>
hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> name, subject, mark from studscore lateral view explode<span class="token punctuation">(</span>score<span class="token punctuation">)</span> t1 as subject, mark<span class="token punctuation">;</span>
OK
name    subject mark
lisi    Chinese <span class="token number">90</span>
lisi    Math    <span class="token number">80</span>
lisi    English <span class="token number">70</span>
wangwu  Chinese <span class="token number">88</span>
wangwu  Math    <span class="token number">90</span>
wangwu  English <span class="token number">96</span>
maliu   Chinese <span class="token number">99</span>
maliu   Math    <span class="token number">65</span>
maliu   English <span class="token number">60</span>
Time taken: <span class="token number">0.092</span> seconds, Fetched: <span class="token number">9</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

<span class="token comment"># 第三步：找到每个学员的最好成绩</span>
<span class="token keyword">select</span> name, max<span class="token punctuation">(</span>mark<span class="token punctuation">)</span> maxScore from <span class="token punctuation">(</span>
  <span class="token keyword">select</span> name, subject, mark from studscore lateral view explode<span class="token punctuation">(</span>score<span class="token punctuation">)</span> t1 as subject, mark
<span class="token punctuation">)</span> t2 group by name<span class="token punctuation">;</span>

<span class="token comment"># 如下 SQL 功能和上面的相同</span>
with tmp as <span class="token punctuation">(</span>select name, subject, mark from studscore lateral view explode<span class="token punctuation">(</span>score<span class="token punctuation">)</span> t1 as subject, mark<span class="token punctuation">)</span>
<span class="token keyword">select</span> name, max<span class="token punctuation">(</span>mark<span class="token punctuation">)</span> maxScore from tmp group by name<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p><strong>小结</strong></p><ul><li>将一行数据转换成多行数据，可以用于转换array和map类型的数据;</li><li>lateral view 与 explode 联用，解决 UDTF 不能添加额外列的问题</li></ul><h3 id="第-2-节-窗口函数【重要】" tabindex="-1"><a class="header-anchor" href="#第-2-节-窗口函数【重要】" aria-hidden="true">#</a> 第 2 节 窗口函数【重要】</h3><p>窗口函数又名开窗函数，属于分析函数的一种。用于解决复杂报表统计需求的功能强大的函数，很多场景都需要用到。</p><p>窗口函数用于计算基于组的某种聚合值，它和聚合函数的不同之处是: <em>窗口函数每个组返回多行，而聚合函数每个组只返回一行</em>。</p><p>窗口函数指定了分析函数工作的数据窗口大小，这个数据窗口大小可能会随着行的变化而变化。</p><h4 id="over-关键字" tabindex="-1"><a class="header-anchor" href="#over-关键字" aria-hidden="true">#</a> over 关键字</h4><p>使用窗口函数之前一般要要通过 <code>over()</code> 进行开窗</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 查询emp表工资总和</span>
<span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- 不使用窗口函数，有语法错误</span>
<span class="token keyword">select</span> ename<span class="token punctuation">,</span> sal<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> salsum <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
<span class="token comment">-- FAILED: SemanticException [Error 10025]: Line 1:7 Expression not in GROUP BY key &#39;ename&#39;</span>

<span class="token comment">-- 使用窗口函数，查询员工姓名、薪水、薪水总和</span>
<span class="token keyword">select</span> ename<span class="token punctuation">,</span> sal<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">)</span> salsum  <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
<span class="token comment">-- 求每个人的薪水占总薪水的比例</span>
<span class="token keyword">select</span> ename<span class="token punctuation">,</span> sal<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">)</span> salsum<span class="token punctuation">,</span> concat<span class="token punctuation">(</span><span class="token function">round</span><span class="token punctuation">(</span>sal <span class="token operator">/</span> <span class="token function">sum</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&#39;%&#39;</span><span class="token punctuation">)</span> ratiosal <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><blockquote><p>注意: 窗口函数是针对每一行数据的; 如果over中没有参数，默认的是全部结果集;</p></blockquote><h4 id="partition-by-子句" tabindex="-1"><a class="header-anchor" href="#partition-by-子句" aria-hidden="true">#</a> partition by 子句</h4><p>在over窗口中进行分区，对某一列进行分区统计，窗口的大小就是分区的大小</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 查询员工姓名、薪水、部门薪水总和</span>
hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> ename, sal, sum<span class="token punctuation">(</span>sal<span class="token punctuation">)</span> over<span class="token punctuation">(</span>partition by deptno<span class="token punctuation">)</span> salsum from emp<span class="token punctuation">;</span>
OK
ename   sal     salsum
MILLER  <span class="token number">1300</span>    <span class="token number">8750</span>
KING    <span class="token number">5000</span>    <span class="token number">8750</span>
CLARK   <span class="token number">2450</span>    <span class="token number">8750</span>
ADAMS   <span class="token number">1100</span>    <span class="token number">10875</span>
SCOTT   <span class="token number">3000</span>    <span class="token number">10875</span>
SMITH   <span class="token number">800</span>     <span class="token number">10875</span>
JONES   <span class="token number">2975</span>    <span class="token number">10875</span>
FORD    <span class="token number">3000</span>    <span class="token number">10875</span>
TURNER  <span class="token number">1500</span>    <span class="token number">9400</span>
ALLEN   <span class="token number">1600</span>    <span class="token number">9400</span>
BLAKE   <span class="token number">2850</span>    <span class="token number">9400</span>
MARTIN  <span class="token number">1250</span>    <span class="token number">9400</span>
WARD    <span class="token number">1250</span>    <span class="token number">9400</span>
JAMES   <span class="token number">950</span>     <span class="token number">9400</span>
Time taken: <span class="token number">1.477</span> seconds, Fetched: <span class="token number">14</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="order-by-子句" tabindex="-1"><a class="header-anchor" href="#order-by-子句" aria-hidden="true">#</a> order by 子句</h4><p>order by 子句对输入的数据进行排序</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 增加了order by子句; 此处的 sum 计算的是：从分组的第一行到当前行求和(注意并列情况)</span>
hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> ename, sal, deptno, sum<span class="token punctuation">(</span>sal<span class="token punctuation">)</span> over<span class="token punctuation">(</span>partition by deptno order by sal<span class="token punctuation">)</span> salsum from emp<span class="token punctuation">;</span>
OK
ename   sal     deptno  salsum
MILLER  <span class="token number">1300</span>    <span class="token number">10</span>      <span class="token number">1300</span>
CLARK   <span class="token number">2450</span>    <span class="token number">10</span>      <span class="token number">3750</span>
KING    <span class="token number">5000</span>    <span class="token number">10</span>      <span class="token number">8750</span>
SMITH   <span class="token number">800</span>     <span class="token number">20</span>      <span class="token number">800</span>
ADAMS   <span class="token number">1100</span>    <span class="token number">20</span>      <span class="token number">1900</span>
JONES   <span class="token number">2975</span>    <span class="token number">20</span>      <span class="token number">4875</span>
SCOTT   <span class="token number">3000</span>    <span class="token number">20</span>      <span class="token number">10875</span>
FORD    <span class="token number">3000</span>    <span class="token number">20</span>      <span class="token number">10875</span>
JAMES   <span class="token number">950</span>     <span class="token number">30</span>      <span class="token number">950</span>
MARTIN  <span class="token number">1250</span>    <span class="token number">30</span>      <span class="token number">3450</span>
WARD    <span class="token number">1250</span>    <span class="token number">30</span>      <span class="token number">3450</span>
TURNER  <span class="token number">1500</span>    <span class="token number">30</span>      <span class="token number">4950</span>
ALLEN   <span class="token number">1600</span>    <span class="token number">30</span>      <span class="token number">6550</span>
BLAKE   <span class="token number">2850</span>    <span class="token number">30</span>      <span class="token number">9400</span>
Time taken: <span class="token number">1.454</span> seconds, Fetched: <span class="token number">14</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="window子句" tabindex="-1"><a class="header-anchor" href="#window子句" aria-hidden="true">#</a> Window子句</h4><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">and</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>如果要对窗口的结果做更细粒度的划分，使用window子句，有如下的几个选项:</p><ul><li>unbounded preceding: 组内第一行数据</li><li>n preceding: 组内当前行的前n行数据</li><li>current row: 当前行数据</li><li>n following: 组内当前行的后n行数据</li><li>unbounded following: 组内最后一行数据</li></ul><p><img src="/doc/assets/README-1642227655228.eba072bd.png" alt="参数图解"></p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- rows between ... and ... 子句 </span>
<span class="token comment">-- 下面两语句等价。</span>
<span class="token comment">-- 按照部门分组，按照姓名排序。组内，第一行到当前行的和 </span>
<span class="token keyword">select</span> ename<span class="token punctuation">,</span> sal<span class="token punctuation">,</span> deptno<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> deptno <span class="token keyword">order</span> <span class="token keyword">by</span> ename<span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token keyword">select</span> ename<span class="token punctuation">,</span> sal<span class="token punctuation">,</span> deptno<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> deptno <span class="token keyword">order</span> <span class="token keyword">by</span> ename
                     <span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token keyword">unbounded</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token keyword">current</span> <span class="token keyword">row</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- 组内，第一行到最后一行的和</span>
<span class="token keyword">select</span> ename<span class="token punctuation">,</span> sal<span class="token punctuation">,</span> deptno<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> deptno <span class="token keyword">order</span> <span class="token keyword">by</span> ename
           <span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token keyword">unbounded</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token keyword">unbounded</span> <span class="token keyword">following</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- 组内，前一行、当前行、后一行的和 (当前行及其前后，共三行)</span>
<span class="token keyword">select</span> ename<span class="token punctuation">,</span> sal<span class="token punctuation">,</span> deptno<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> deptno <span class="token keyword">order</span> <span class="token keyword">by</span> ename
                     <span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token number">1</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token number">1</span> <span class="token keyword">following</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> emp<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="排名函数" tabindex="-1"><a class="header-anchor" href="#排名函数" aria-hidden="true">#</a> 排名函数</h4><p>排名都是从1开始，生成数据项在分组中的排名。</p><blockquote><p>非常常用，通常用于求解 Top N 的问题。</p></blockquote><p>排名方式有三种：</p><ul><li><code>row_number()</code> 排名顺序增加不会重复; 如1、2、3、4、... ...</li><li><code>RANK()</code> 排名相等会在名次中留下空位; 如1、2、2、4、5、... ...</li><li><code>DENSE_RANK()</code> 排名相等会在名次中不会留下空位; 如1、2、2、3、4、... ...</li></ul><p>效果示例如下：</p><table><thead><tr><th>Val</th><th style="text-align:center;">row_number()</th><th style="text-align:center;">rank()</th><th style="text-align:center;">dense_rank()</th></tr></thead><tbody><tr><td>100</td><td style="text-align:center;">1</td><td style="text-align:center;">1</td><td style="text-align:center;">1</td></tr><tr><td>100</td><td style="text-align:center;">2</td><td style="text-align:center;">1</td><td style="text-align:center;">1</td></tr><tr><td>100</td><td style="text-align:center;">3</td><td style="text-align:center;">1</td><td style="text-align:center;">1</td></tr><tr><td>99</td><td style="text-align:center;">4</td><td style="text-align:center;">4</td><td style="text-align:center;">2</td></tr><tr><td>98</td><td style="text-align:center;">5</td><td style="text-align:center;">5</td><td style="text-align:center;">3</td></tr><tr><td>98</td><td style="text-align:center;">6</td><td style="text-align:center;">5</td><td style="text-align:center;">3</td></tr><tr><td>97</td><td style="text-align:center;">7</td><td style="text-align:center;">7</td><td style="text-align:center;">4</td></tr></tbody></table><p>测试案例：</p><p>准备数据</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>class1 s01 100
class1 s03 100
class1 s05 100
class1 s07 99
class1 s09 98
class1 s02 98
class1 s04 97
class2 s21 100
class2 s24 99
class2 s27 99
class2 s22 98
class2 s25 98
class2 s28 97
class2 s26 96
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 创建表加载数据</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> t2<span class="token punctuation">(</span>
  cname string<span class="token punctuation">,</span>
  sname string<span class="token punctuation">,</span>
  score <span class="token keyword">int</span>
<span class="token punctuation">)</span> <span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">;</span>

<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">&#39;/home/hadoop/data/t2.dat&#39;</span> <span class="token keyword">into</span> <span class="token keyword">table</span> t2<span class="token punctuation">;</span>

<span class="token comment">-- 按照班级，使用3种方式对成绩进行排名</span>
<span class="token keyword">select</span> cname<span class="token punctuation">,</span> sname<span class="token punctuation">,</span> score<span class="token punctuation">,</span> 
       row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> cname <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> rank1<span class="token punctuation">,</span>
       rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> cname <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> rank2<span class="token punctuation">,</span>
       dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> cname <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> rank3
       <span class="token keyword">from</span> t2<span class="token punctuation">;</span>

<span class="token comment">-- 求每个班级前3名的学员</span>
<span class="token comment">-- 前3名的定义是什么? (这其实是业务问题)</span>
<span class="token comment">-- 假设使用 dense_rank</span>
<span class="token keyword">select</span> cname<span class="token punctuation">,</span> sname<span class="token punctuation">,</span> score<span class="token punctuation">,</span> rank <span class="token keyword">from</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> cname<span class="token punctuation">,</span> sname<span class="token punctuation">,</span> score<span class="token punctuation">,</span>
                  dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> cname <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> rank
    <span class="token keyword">from</span> t2
<span class="token punctuation">)</span> tmp <span class="token keyword">where</span> rank <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h4 id="序列函数" tabindex="-1"><a class="header-anchor" href="#序列函数" aria-hidden="true">#</a> 序列函数</h4><ul><li><code>lag</code> 返回当前数据行的上一行数据</li><li><code>lead</code> 返回当前数据行的下一行数据</li><li><code>first_value</code> 数据分组内排序后，截止到当前行，第一个值</li><li><code>last_value</code> 数据分组内排序后，截止到当前行，最后一个值</li><li><code>ntile</code> 将分组排序后的数据按照顺序切分成n片，返回当前切片值(当前行所在的切片数)</li></ul><p>测试案例</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># 准备数据 userpv.dat
cookie1,2019-04-10,1
cookie1,2019-04-11,5
cookie1,2019-04-12,7
cookie1,2019-04-13,3
cookie1,2019-04-14,2
cookie1,2019-04-15,4
cookie1,2019-04-16,4
cookie2,2019-04-10,2
cookie2,2019-04-11,3
cookie2,2019-04-12,5
cookie2,2019-04-13,6
cookie2,2019-04-14,3
cookie2,2019-04-15,9
cookie2,2019-04-16,7
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 创建表并加载数据</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> userpv<span class="token punctuation">(</span>
  cid string<span class="token punctuation">,</span>
  ctime <span class="token keyword">date</span><span class="token punctuation">,</span>
  pv <span class="token keyword">int</span>
<span class="token punctuation">)</span>
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">&#39;/home/hadoop/data/userpv.dat&#39;</span> <span class="token keyword">into</span> <span class="token keyword">table</span> userpv<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># lag。返回当前数据行的上一行数据</span>
<span class="token comment"># lead。功能上与lag类似, 返回当前数据行的下一行数据</span>
<span class="token keyword">select</span> cid, ctime, pv, 
  lag<span class="token punctuation">(</span>pv<span class="token punctuation">)</span> over<span class="token punctuation">(</span>partition by cid order by ctime<span class="token punctuation">)</span> lagpv, 
  lead<span class="token punctuation">(</span>pv<span class="token punctuation">)</span> over<span class="token punctuation">(</span>partition by cid order by ctime<span class="token punctuation">)</span> leadgpv
from userpv<span class="token punctuation">;</span>
<span class="token comment"># lag/lead 第二个参数可以指定 下移/上移 的行数</span>

OK
cid     ctime   <span class="token function">pv</span>      lagpv   leadgpv
cookie1 <span class="token number">2019</span>-04-10      <span class="token number">1</span>       NULL    <span class="token number">5</span>
cookie1 <span class="token number">2019</span>-04-11      <span class="token number">5</span>       <span class="token number">1</span>       <span class="token number">7</span>
cookie1 <span class="token number">2019</span>-04-12      <span class="token number">7</span>       <span class="token number">5</span>       <span class="token number">3</span>
cookie1 <span class="token number">2019</span>-04-13      <span class="token number">3</span>       <span class="token number">7</span>       <span class="token number">2</span>
cookie1 <span class="token number">2019</span>-04-14      <span class="token number">2</span>       <span class="token number">3</span>       <span class="token number">4</span>
cookie1 <span class="token number">2019</span>-04-15      <span class="token number">4</span>       <span class="token number">2</span>       <span class="token number">4</span>
cookie1 <span class="token number">2019</span>-04-16      <span class="token number">4</span>       <span class="token number">4</span>       NULL
cookie2 <span class="token number">2019</span>-04-10      <span class="token number">2</span>       NULL    <span class="token number">3</span>
cookie2 <span class="token number">2019</span>-04-11      <span class="token number">3</span>       <span class="token number">2</span>       <span class="token number">5</span>
cookie2 <span class="token number">2019</span>-04-12      <span class="token number">5</span>       <span class="token number">3</span>       <span class="token number">6</span>
cookie2 <span class="token number">2019</span>-04-13      <span class="token number">6</span>       <span class="token number">5</span>       <span class="token number">3</span>
cookie2 <span class="token number">2019</span>-04-14      <span class="token number">3</span>       <span class="token number">6</span>       <span class="token number">9</span>
cookie2 <span class="token number">2019</span>-04-15      <span class="token number">9</span>       <span class="token number">3</span>       <span class="token number">7</span>
cookie2 <span class="token number">2019</span>-04-16      <span class="token number">7</span>       <span class="token number">9</span>       NULL


<span class="token comment"># first_value / last_value</span>
<span class="token keyword">select</span> cid, ctime, pv, 
  first_value<span class="token punctuation">(</span>pv<span class="token punctuation">)</span> over<span class="token punctuation">(</span>partition by cid order by ctime<span class="token punctuation">)</span> firstpv, 
  last_value<span class="token punctuation">(</span>pv<span class="token punctuation">)</span> over<span class="token punctuation">(</span>partition by cid order by ctime<span class="token punctuation">)</span> lastpv
from userpv<span class="token punctuation">;</span>

OK
cid     ctime   <span class="token function">pv</span>      firstpv lastpv
cookie1 <span class="token number">2019</span>-04-10      <span class="token number">1</span>       <span class="token number">1</span>       <span class="token number">1</span>
cookie1 <span class="token number">2019</span>-04-11      <span class="token number">5</span>       <span class="token number">1</span>       <span class="token number">5</span>
cookie1 <span class="token number">2019</span>-04-12      <span class="token number">7</span>       <span class="token number">1</span>       <span class="token number">7</span>
cookie1 <span class="token number">2019</span>-04-13      <span class="token number">3</span>       <span class="token number">1</span>       <span class="token number">3</span>
cookie1 <span class="token number">2019</span>-04-14      <span class="token number">2</span>       <span class="token number">1</span>       <span class="token number">2</span>
cookie1 <span class="token number">2019</span>-04-15      <span class="token number">4</span>       <span class="token number">1</span>       <span class="token number">4</span>
cookie1 <span class="token number">2019</span>-04-16      <span class="token number">4</span>       <span class="token number">1</span>       <span class="token number">4</span>
cookie2 <span class="token number">2019</span>-04-10      <span class="token number">2</span>       <span class="token number">2</span>       <span class="token number">2</span>
cookie2 <span class="token number">2019</span>-04-11      <span class="token number">3</span>       <span class="token number">2</span>       <span class="token number">3</span>
cookie2 <span class="token number">2019</span>-04-12      <span class="token number">5</span>       <span class="token number">2</span>       <span class="token number">5</span>
cookie2 <span class="token number">2019</span>-04-13      <span class="token number">6</span>       <span class="token number">2</span>       <span class="token number">6</span>
cookie2 <span class="token number">2019</span>-04-14      <span class="token number">3</span>       <span class="token number">2</span>       <span class="token number">3</span>
cookie2 <span class="token number">2019</span>-04-15      <span class="token number">9</span>       <span class="token number">2</span>       <span class="token number">9</span>
cookie2 <span class="token number">2019</span>-04-16      <span class="token number">7</span>       <span class="token number">2</span>       <span class="token number">7</span>


<span class="token comment"># ntile。按照cid进行分组，每组数据分成2份</span>
<span class="token keyword">select</span> cid, ctime, pv, 
  ntile<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> over<span class="token punctuation">(</span>partition by cid order by ctime<span class="token punctuation">)</span> ntile
from userpv<span class="token punctuation">;</span>

OK
cid     ctime   <span class="token function">pv</span>      ntile
cookie1 <span class="token number">2019</span>-04-10      <span class="token number">1</span>       <span class="token number">1</span>
cookie1 <span class="token number">2019</span>-04-11      <span class="token number">5</span>       <span class="token number">1</span>
cookie1 <span class="token number">2019</span>-04-12      <span class="token number">7</span>       <span class="token number">1</span>
cookie1 <span class="token number">2019</span>-04-13      <span class="token number">3</span>       <span class="token number">1</span>
cookie1 <span class="token number">2019</span>-04-14      <span class="token number">2</span>       <span class="token number">2</span>
cookie1 <span class="token number">2019</span>-04-15      <span class="token number">4</span>       <span class="token number">2</span>
cookie1 <span class="token number">2019</span>-04-16      <span class="token number">4</span>       <span class="token number">2</span>
cookie2 <span class="token number">2019</span>-04-10      <span class="token number">2</span>       <span class="token number">1</span>
cookie2 <span class="token number">2019</span>-04-11      <span class="token number">3</span>       <span class="token number">1</span>
cookie2 <span class="token number">2019</span>-04-12      <span class="token number">5</span>       <span class="token number">1</span>
cookie2 <span class="token number">2019</span>-04-13      <span class="token number">6</span>       <span class="token number">1</span>
cookie2 <span class="token number">2019</span>-04-14      <span class="token number">3</span>       <span class="token number">2</span>
cookie2 <span class="token number">2019</span>-04-15      <span class="token number">9</span>       <span class="token number">2</span>
cookie2 <span class="token number">2019</span>-04-16      <span class="token number">7</span>       <span class="token number">2</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><h4 id="sql面试题" tabindex="-1"><a class="header-anchor" href="#sql面试题" aria-hidden="true">#</a> SQL面试题</h4><ol><li>连续7天登录的用户</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># 数据准备
# 数据。uid dt status(1 正常登录，0 异常)
1 2019-07-11 1
1 2019-07-12 1
1 2019-07-13 1
1 2019-07-14 1
1 2019-07-15 1
1 2019-07-16 1
1 2019-07-17 1
1 2019-07-18 1
2 2019-07-11 1
2 2019-07-12 1
2 2019-07-13 0
2 2019-07-14 1
2 2019-07-15 1
2 2019-07-16 0
2 2019-07-17 1
2 2019-07-18 0
3 2019-07-11 1
3 2019-07-12 1
3 2019-07-13 1
3 2019-07-14 0
3 2019-07-15 1
3 2019-07-16 1
3 2019-07-17 1
3 2019-07-18 1
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 建表导入数据</span>
<span class="token comment">-- 建表语句</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> ulogin<span class="token punctuation">(</span>
  uid <span class="token keyword">int</span><span class="token punctuation">,</span>
  dt <span class="token keyword">date</span><span class="token punctuation">,</span>
  <span class="token keyword">status</span> <span class="token keyword">int</span>
<span class="token punctuation">)</span>
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">;</span>
<span class="token comment">-- 加载数据</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">&#39;/home/hadoop/data/ulogin.dat&#39;</span> <span class="token keyword">into</span> <span class="token keyword">table</span> ulogin<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><p>此处求解的核心思路是：利用 <code>row_number()</code> 的自增特性。</p><p>求解的是连续数据，<code>row_number()</code> 肯定是连续的，但是符合条件的原数据不一定是连续的。两相比较，就得出了连续的数据。</p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 连续值的求解，面试中常见的问题。这也是同一类，基本都可按照以下思路进行</span>
<span class="token comment">-- 1、使用 row_number 在组内给数据编号(rownum)</span>
<span class="token comment">-- 2、某个值 - rownum = gid，得到结果可以作为后面分组计算的依据</span>
<span class="token comment">-- 3、根据求得的gid，作为分组条件，求最终结果</span>

<span class="token keyword">select</span> uid<span class="token punctuation">,</span> dt<span class="token punctuation">,</span>
       date_sub<span class="token punctuation">(</span>dt<span class="token punctuation">,</span> row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> uid <span class="token keyword">order</span> <span class="token keyword">by</span> dt<span class="token punctuation">)</span><span class="token punctuation">)</span> gid
<span class="token keyword">from</span> ulogin <span class="token keyword">where</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">-- OK</span>
<span class="token comment">-- uid     dt      gid</span>
<span class="token comment">-- 1       2019-07-11      2019-07-10</span>
<span class="token comment">-- 1       2019-07-12      2019-07-10</span>
<span class="token comment">-- 1       2019-07-13      2019-07-10</span>
<span class="token comment">-- 1       2019-07-14      2019-07-10</span>
<span class="token comment">-- 1       2019-07-15      2019-07-10</span>
<span class="token comment">-- 1       2019-07-16      2019-07-10</span>
<span class="token comment">-- 1       2019-07-17      2019-07-10</span>
<span class="token comment">-- 1       2019-07-18      2019-07-10</span>
<span class="token comment">-- 2       2019-07-11      2019-07-10</span>
<span class="token comment">-- 2       2019-07-12      2019-07-10</span>
<span class="token comment">-- 2       2019-07-14      2019-07-11</span>
<span class="token comment">-- 2       2019-07-15      2019-07-11</span>
<span class="token comment">-- 2       2019-07-17      2019-07-12</span>

<span class="token keyword">select</span> uid<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> logincount
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> uid<span class="token punctuation">,</span> dt<span class="token punctuation">,</span>
             date_sub<span class="token punctuation">(</span>dt<span class="token punctuation">,</span> row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> uid <span class="token keyword">order</span> <span class="token keyword">by</span> dt<span class="token punctuation">)</span><span class="token punctuation">)</span> gid
      <span class="token keyword">from</span> ulogin <span class="token keyword">where</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">temp</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> uid<span class="token punctuation">,</span> gid
<span class="token keyword">having</span> logincount<span class="token operator">&gt;=</span><span class="token number">7</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><ol start="2"><li>编写sql语句实现每班前三名，分数一样并列，同时求出前三名按名次排序的分差</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># 数据。sid class score
1 1901 90
2 1901 90
3 1901 83
4 1901 60
5 1902 66
6 1902 23
7 1902 99
8 1902 67
9 1902 87
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 建表导入数据</span>
<span class="token comment">-- 建表语句</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> stu<span class="token punctuation">(</span>
  sno <span class="token keyword">int</span><span class="token punctuation">,</span>
  class string<span class="token punctuation">,</span>
  score <span class="token keyword">int</span>
<span class="token punctuation">)</span><span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">;</span>
<span class="token comment">-- 加载数据</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">&#39;/home/hadoop/data/stu.dat&#39;</span> <span class="token keyword">into</span> <span class="token keyword">table</span> stu<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p>核心思路：求 Top 使用 <code>rank()</code>, 求前后差值使用 <code>lag/lead</code></p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 求解思路：</span>
<span class="token comment">-- 1、上排名函数，分数一样并列，所以用 dense_rank</span>
<span class="token comment">-- 2、将上一行数据下移，相减即得到分数差</span>
<span class="token comment">-- 3、处理 NULL</span>

<span class="token comment">-- step1</span>
<span class="token keyword">select</span> sno<span class="token punctuation">,</span> class<span class="token punctuation">,</span> score<span class="token punctuation">,</span> dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> class <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> rank <span class="token keyword">from</span> stu<span class="token punctuation">;</span>
<span class="token comment">-- step2</span>
<span class="token keyword">select</span> sno<span class="token punctuation">,</span> class<span class="token punctuation">,</span> score<span class="token punctuation">,</span> dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> class <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> rank<span class="token punctuation">,</span>
        score <span class="token operator">-</span> lag<span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> class <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> lagscore
<span class="token keyword">from</span> stu<span class="token punctuation">;</span>
<span class="token comment">-- step3</span>
<span class="token keyword">select</span> class<span class="token punctuation">,</span> score<span class="token punctuation">,</span> dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> class <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> rank<span class="token punctuation">,</span>
        nvl<span class="token punctuation">(</span>score <span class="token operator">-</span> lag<span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> class <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> lagscore
<span class="token keyword">from</span> stu<span class="token punctuation">;</span>
<span class="token comment">-- step4</span>
<span class="token keyword">with</span> tmp <span class="token keyword">as</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> sno<span class="token punctuation">,</span> class<span class="token punctuation">,</span> score<span class="token punctuation">,</span>
           dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> class <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rank
    <span class="token keyword">from</span> stu
<span class="token punctuation">)</span>
<span class="token keyword">select</span> class<span class="token punctuation">,</span> score<span class="token punctuation">,</span> rank<span class="token punctuation">,</span>
       nvl<span class="token punctuation">(</span>score <span class="token operator">-</span> lag<span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> class <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> lagscore
<span class="token keyword">from</span> tmp
<span class="token keyword">where</span> rank<span class="token operator">&lt;=</span><span class="token number">3</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>3、行列互转</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># 数据：id course
1 java
1 hadoop
1 hive
1 hbase
2 java
2 hive
2 spark
2 flink
3 java
3 hadoop
3 hive
3 kafka

# 目标格式
id      java    hadoop  hive    hbase   spark   flink   kafka
1       1       1       1       1       0       0       0
2       1       0       1       0       1       1       0
3       1       1       1       0       0       0       1
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># 建表加载数据</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> rowline1<span class="token punctuation">(</span>
  id string<span class="token punctuation">,</span>
  course string
<span class="token punctuation">)</span><span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">;</span>

<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">&#39;/home/hadoop/data/data1.dat&#39;</span> <span class="token keyword">into</span> <span class="token keyword">table</span> rowline1<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 行转列</span>
<span class="token comment">-- 使用case when；group by + sum</span>
<span class="token keyword">select</span> id<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> course<span class="token operator">=</span><span class="token string">&quot;java&quot;</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> java<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> course<span class="token operator">=</span><span class="token string">&quot;hadoop&quot;</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> hadoop<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> course<span class="token operator">=</span><span class="token string">&quot;hive&quot;</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> hive<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> course<span class="token operator">=</span><span class="token string">&quot;hbase&quot;</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> hbase<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> course<span class="token operator">=</span><span class="token string">&quot;spark&quot;</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> spark<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> course<span class="token operator">=</span><span class="token string">&quot;flink&quot;</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> flink<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> course<span class="token operator">=</span><span class="token string">&quot;kafka&quot;</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> kafka
<span class="token keyword">from</span> rowline1
<span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># 数据。id1 id2 flag
a b 2
a b 1
a b 3
c d 6
c d 8
c d 8

# 目标数据格式
id1 id2 flag
a   b   2|1|3
c   d   6|8
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 创建表 &amp; 加载数据</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> row2line<span class="token punctuation">(</span>
    id string<span class="token punctuation">,</span>
    tag string<span class="token punctuation">,</span>
    flag <span class="token keyword">int</span>
<span class="token punctuation">)</span> <span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">;</span>

<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">&#39;/home/hadoop/data/data2.dat&#39;</span> <span class="token keyword">into</span> <span class="token keyword">table</span> row2line<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 1.分组将数据聚拢</span>
<span class="token comment">-- 2.将数据连接在一起</span>

<span class="token comment">-- step1</span>
<span class="token keyword">select</span> id<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token keyword">from</span> row2line <span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token punctuation">,</span> tag<span class="token punctuation">;</span>
<span class="token comment">-- collect_set 数据去重 (collect_list 数据不去重)</span>
<span class="token comment">-- id      tag     _c2</span>
<span class="token comment">-- a       b       [2,1,3]</span>
<span class="token comment">-- c       d       [6,8]</span>

<span class="token comment">-- step2</span>
<span class="token comment">-- 下面的语句会报错，因为 concat_ws 只能操作 string</span>
<span class="token keyword">select</span> id<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> concat_ws<span class="token punctuation">(</span><span class="token string">&quot;|&quot;</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">from</span> row2line <span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token punctuation">,</span> tag<span class="token punctuation">;</span>
<span class="token comment">-- FAILED: SemanticException [Error 10016]: Line 1:31 Argument type mismatch &#39;flag&#39;: Argument 2 of function CONCAT_WS must be &quot;string or array&lt;string&gt;&quot;, but &quot;array&lt;int&gt;&quot; was found.</span>

<span class="token keyword">select</span> id<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> concat_ws<span class="token punctuation">(</span><span class="token string">&quot;|&quot;</span><span class="token punctuation">,</span> collect_set<span class="token punctuation">(</span>cast<span class="token punctuation">(</span>flag <span class="token keyword">as</span> string<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">from</span> row2line <span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token punctuation">,</span> tag<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>小结：三类典型问题 —— 连续值求解、Top n问题、行列互转</p><h3 id="第-3-节-自定义函数" tabindex="-1"><a class="header-anchor" href="#第-3-节-自定义函数" aria-hidden="true">#</a> 第 3 节 自定义函数</h3><p>当 Hive 提供的内置函数无法满足实际的业务处理需要时，可以考虑使用用户自定义函数进行扩展。</p><p>用户自定义函数分为以下三类:</p><ul><li>UDF(User Defined Function) 用户自定义函数，一进一出; 类似于：<code>current_date</code> 等</li><li>UDAF(User Defined Aggregation Function) 用户自定义聚集函数，多进一出; 类似于: <code>count/max/min</code></li><li>UDTF(User Defined Table-Generating Functions) 用户自定义表生成函数，一进多出; 类似于: <code>explode</code></li></ul><p>UDF开发:</p><ul><li>继承 <code>org.apache.hadoop.hive.ql.exec.UDF</code></li><li>需要实现evaluate函数; evaluate函数支持重载</li><li>UDF必须要有返回类型，可以返回null，但是返回类型不能为void</li></ul><p>UDF开发步骤</p><ul><li>创建maven java 工程，添加依赖</li><li>开发java类继承UDF，实现evaluate方法</li><li>将项目打包上传服务器</li><li>添加开发的jar包</li><li>设置函数与自定义函数关联</li><li>使用自定义函数</li></ul><p><strong>测试案例</strong></p><p>需求: 扩展系统 nvl 函数功能, 如果 <code>nvl()</code> 函数的第一个参数是空串或者空白也返回第二个参数。</p><ol><li>创建maven java 工程，添加依赖</li></ol><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- pom.xml 文件 --&gt;</span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hive<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hive-exec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.3.7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol start="2"><li>开发java类继承UDF，实现evaluate 方法</li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> nvl <span class="token keyword">extends</span> <span class="token class-name">UDF</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Text</span> <span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Text</span> t<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Text</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> t<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> x<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> t<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol start="3"><li>将项目打包上传服务器</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">mv</span> hive-udf-test-1.0-SNAPSHOT.jar hiveudf.jar
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><ol start="4"><li>添加开发的jar包(在Hive命令行中)</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token function">add</span> jar /root/hiveudf.jar<span class="token punctuation">;</span>
Added <span class="token punctuation">[</span>/root/hiveudf.jar<span class="token punctuation">]</span> to class path
Added resources: <span class="token punctuation">[</span>/root/hiveudf.jar<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="5"><li>创建临时函数。指定类名一定要完整的路径，即包名加类名</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> create temporary <span class="token keyword">function</span> mynvl as <span class="token string">&quot;com.zmn.hive.Nvl&quot;</span><span class="token punctuation">;</span>
OK
Time taken: <span class="token number">0.016</span> seconds
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="6"><li>执行查询</li></ol><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 基本功能还有</span>
<span class="token keyword">select</span> mynvl<span class="token punctuation">(</span>comm<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">from</span> mydb<span class="token punctuation">.</span>emp<span class="token punctuation">;</span>
<span class="token comment">-- 测试扩充的功能</span>
<span class="token keyword">select</span> mynvl<span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> mynvl<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>7、退出Hive命令行，再进入Hive命令行。执行步骤6的测试，发现函数失效。</p><blockquote><p>备注: 创建临时函数每次进入Hive命令行时，都必须执行以下语句，很不方便</p></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">add</span> jar /root/hiveudf.jar<span class="token punctuation">;</span>

create temporary <span class="token keyword">function</span> mynvl as <span class="token string">&quot;com.zmn.hive.Nvl&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>创建永久函数:</p><p>1、将jar上传HDFS</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>hdfs dfs -mkdir jar/
hdfs dfs -put hiveudf.jar jar/
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>2、在Hive命令行中创建永久函数</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>hive <span class="token punctuation">(</span>mydb<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">create</span> <span class="token keyword">function</span> mynvl1 <span class="token keyword">as</span> <span class="token string">&#39;com.zmn.hive.Nvl&#39;</span> <span class="token keyword">using</span> jar <span class="token string">&#39;hdfs:/user/root/jar/hiveudf.jar&#39;</span><span class="token punctuation">;</span>
Added <span class="token punctuation">[</span><span class="token operator">/</span>tmp<span class="token operator">/</span>e46f2f98<span class="token operator">-</span><span class="token number">0820</span><span class="token operator">-</span><span class="token number">4</span>bb3<span class="token operator">-</span><span class="token number">98</span>ef<span class="token operator">-</span><span class="token number">49707</span>da29194_resources<span class="token operator">/</span>hiveudf<span class="token punctuation">.</span>jar<span class="token punctuation">]</span> <span class="token keyword">to</span> class path
Added resources: <span class="token punctuation">[</span>hdfs:<span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>root<span class="token operator">/</span>jar<span class="token operator">/</span>hiveudf<span class="token punctuation">.</span>jar<span class="token punctuation">]</span>
OK
<span class="token keyword">Time</span> taken: <span class="token number">0.467</span> seconds

<span class="token comment">-- 查询所有的函数，发现 mynvl1 在列表中 </span>
<span class="token keyword">show</span> functions<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>3、退出Hive，再进入，执行测试</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 基本功能还有</span>
<span class="token keyword">select</span> mynvl1<span class="token punctuation">(</span>comm<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
<span class="token comment">-- 测试扩充的功能</span>
<span class="token keyword">select</span> mynvl1<span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">select</span> mynvl1<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>4、删除永久函数，并检查</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">drop</span> <span class="token keyword">function</span> mynvl1<span class="token punctuation">;</span> 
<span class="token keyword">show</span> functions<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="第八部分-hql-dml命令" tabindex="-1"><a class="header-anchor" href="#第八部分-hql-dml命令" aria-hidden="true">#</a> 第八部分 HQL DML命令</h2><p>数据操纵语言DML(Data Manipulation Language)，DML主要有三种形式: 插入(INSERT)、删除(DELETE)、更新(UPDATE)。</p><p>事务(transaction)是一组单元化操作，这些操作要么都执行，要么都不执行，是一个不可分割的工作单元。</p><p>事务具有的四个要素:原子性(Atomicity)、一致性(Consistency)、隔离性(Isolation)、持久性(Durability)，这四个基本要素通常称为ACID特性。</p><ul><li>原子性：一个事务是一个不可再分割的工作单位，事务中的所有操作要么都发生，要么都不发生。</li><li>一致性：事务的一致性是指事务的执行不能破坏数据库数据的完整性和一致性，一个事务在执行之前和执行之后，数据库都必须处于一致性状态。</li><li>隔离性：在并发环境中，并发的事务是相互隔离的，一个事务的执行不能被其他事务干扰。即不同的事务并发操纵相同的数据时，每个事务都有各自完整的数据空间，即一个事务内部的操作及使用的数据对其他并发事务是隔离的，并发执行的各个事务之间不能互相干扰。</li><li>持久性：事务一旦提交，它对数据库中数据的改变就应该是永久性的。</li></ul><h3 id="第-1-节-hive事务" tabindex="-1"><a class="header-anchor" href="#第-1-节-hive事务" aria-hidden="true">#</a> 第 1 节 Hive事务</h3><p>Hive从 0.14 版本开始支持事务和行级更新，但缺省是不支持的，需要一些附加的配置。要想支持行级insert、update、delete，需要配置Hive支持事务。</p><p>Hive事务的限制:</p><ul><li>Hive提供行级别的ACID语义</li><li>BEGIN、COMMIT、ROLLBACK 暂时不支持，所有操作自动提交</li><li>目前只支持 ORC 的文件格式</li><li>默认事务是关闭的，需要设置开启</li><li>要是使用事务特性，表必须是分桶的</li><li>只能使用内部表</li><li>如果一个表用于ACID写入(INSERT、UPDATE、DELETE)，必须在表中设置表属性: <code>transactional=true</code></li><li>必须使用事务管理器 <code>org.apache.hadoop.hive.ql.lockmgr.DbTxnManager</code></li><li>目前支持快照级别的隔离。就是当一次数据查询时，会提供一个数据一致性的快照</li><li><code>LOAD DATA</code> 语句目前在事务表中暂时不支持</li></ul><p>HDFS 是不支持文件的修改;并且当有数据追加到文件，HDFS不对读数据的用户提供一致性保证。</p><p>为了在HDFS上支持数据的更新:</p><ul><li>表和分区的数据都被存在基本文件中(base files)</li><li>新的记录和更新，删除都存在增量文件中(delta files)</li><li>一个事务操作创建一系列的增量文件</li><li>在读取的时候，将基础文件和修改，删除合并，最后返回给查询</li></ul><h3 id="第-2-节-hive-事务操作示例" tabindex="-1"><a class="header-anchor" href="#第-2-节-hive-事务操作示例" aria-hidden="true">#</a> 第 2 节 Hive 事务操作示例</h3><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 开启事务</span>
<span class="token comment">-- 这些参数也可以设置在hive-site.xml中</span>
<span class="token keyword">SET</span> hive<span class="token punctuation">.</span>support<span class="token punctuation">.</span>concurrency <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token comment">-- Hive 0.x and 1.x only</span>
<span class="token keyword">SET</span> hive<span class="token punctuation">.</span>enforce<span class="token punctuation">.</span>bucketing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">-- 允许分桶. 2.x 默认允许分桶，这个参数已经没有了</span>
<span class="token keyword">SET</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span><span class="token keyword">partition</span><span class="token punctuation">.</span><span class="token keyword">mode</span> <span class="token operator">=</span> nonstrict<span class="token punctuation">;</span> <span class="token comment">-- 打开动态分区</span>
<span class="token keyword">SET</span> hive<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>manager <span class="token operator">=</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hive<span class="token punctuation">.</span>ql<span class="token punctuation">.</span>lockmgr<span class="token punctuation">.</span>DbTxnManager<span class="token punctuation">;</span> <span class="token comment">-- 设置事务管理器</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 创建表用于更新的事务表。满足条件：内部表、ORC格式、分桶、设置表属性</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> zxz_data<span class="token punctuation">(</span>
    name string<span class="token punctuation">,</span>
    nid <span class="token keyword">int</span><span class="token punctuation">,</span>
    phone string<span class="token punctuation">,</span>
    ntime <span class="token keyword">date</span>
<span class="token punctuation">)</span><span class="token keyword">clustered</span> <span class="token keyword">by</span><span class="token punctuation">(</span>nid<span class="token punctuation">)</span> <span class="token keyword">into</span> <span class="token number">5</span> buckets
stored <span class="token keyword">as</span> orc
tblproperties<span class="token punctuation">(</span><span class="token string">&#39;transactional&#39;</span><span class="token operator">=</span><span class="token string">&#39;true&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 创建临时表，用于向分桶表插入数据</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> temp1<span class="token punctuation">(</span>
    name string<span class="token punctuation">,</span>
    nid <span class="token keyword">int</span><span class="token punctuation">,</span>
    phone string<span class="token punctuation">,</span>
    ntime <span class="token keyword">date</span>
<span class="token punctuation">)</span> <span class="token keyword">row</span> format delimited
<span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># 数据
name1,1,010-83596208,2020-01-01
name2,2,027-63277201,2020-01-02
name3,3,010-83596208,2020-01-03
name4,4,010-83596208,2020-01-04
name5,5,010-83596208,2020-01-05
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 向临时表加载数据；向事务表中加载数据</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">&#39;/home/hadoop/data/zxz_data.txt&#39;</span> overwrite <span class="token keyword">into</span> <span class="token keyword">table</span> temp1<span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> zxz_data <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> temp1<span class="token punctuation">;</span>

<span class="token comment">-- 检查数据和文件</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> zxz_data<span class="token punctuation">;</span>

<span class="token comment">-- 查看数据文件</span>
dfs <span class="token operator">-</span>ls <span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>hive<span class="token operator">/</span>warehouse<span class="token operator">/</span>mydb<span class="token punctuation">.</span>db<span class="token operator">/</span>zxz_data<span class="token punctuation">;</span>
dfs <span class="token operator">-</span>ls <span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>hive<span class="token operator">/</span>warehouse<span class="token operator">/</span>mydb<span class="token punctuation">.</span>db<span class="token operator">/</span>zxz_data<span class="token operator">/</span>delta_0000001_0000001_0000<span class="token punctuation">;</span>

<span class="token comment">-- DML 操作</span>
<span class="token keyword">delete</span> <span class="token keyword">from</span> zxz_data <span class="token keyword">where</span> nid <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

<span class="token comment">-- 查看数据文件</span>
dfs <span class="token operator">-</span>ls <span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>hive<span class="token operator">/</span>warehouse<span class="token operator">/</span>mydb<span class="token punctuation">.</span>db<span class="token operator">/</span>zxz_data<span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> zxz_data <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">&quot;name3&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;010-83596208&quot;</span><span class="token punctuation">,</span> <span class="token keyword">current_date</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 不支持</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> zxz_data <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">&quot;name3&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;010-83596208&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2020-06-01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 执行</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> zxz_data <span class="token keyword">select</span> <span class="token string">&quot;name3&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;010-83596208&quot;</span><span class="token punctuation">,</span> <span class="token keyword">current_date</span><span class="token punctuation">;</span>

<span class="token comment">-- 查看数据文件</span>
dfs <span class="token operator">-</span>ls <span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>hive<span class="token operator">/</span>warehouse<span class="token operator">/</span>mydb<span class="token punctuation">.</span>db<span class="token operator">/</span>zxz_data<span class="token punctuation">;</span>
<span class="token comment">-- 可以发现增加了数据文件</span>

<span class="token comment">-- 批量插入</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> zxz_data <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token string">&quot;name6&quot;</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">&quot;010-83596208&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2020-06-02&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">&quot;name7&quot;</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">&quot;010-83596208&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2020-06-03&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">&quot;name8&quot;</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">&quot;010-83596208&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2020-06-05&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">&quot;name9&quot;</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">&quot;010-83596208&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2020-06-06&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 查看数据文件，可以发现又增加了一批数据文件</span>
dfs <span class="token operator">-</span>ls <span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>hive<span class="token operator">/</span>warehouse<span class="token operator">/</span>mydb<span class="token punctuation">.</span>db<span class="token operator">/</span>zxz_data<span class="token punctuation">;</span>

<span class="token comment">-- 修改数据</span>
<span class="token keyword">update</span> zxz_data <span class="token keyword">set</span> name<span class="token operator">=</span>concat<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">&quot;00&quot;</span><span class="token punctuation">)</span> <span class="token keyword">where</span> nid<span class="token operator">&gt;</span><span class="token number">3</span><span class="token punctuation">;</span>

<span class="token comment">-- 查看数据文件</span>
dfs <span class="token operator">-</span>ls <span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>hive<span class="token operator">/</span>warehouse<span class="token operator">/</span>mydb<span class="token punctuation">.</span>db<span class="token operator">/</span>zxz_data<span class="token punctuation">;</span>

<span class="token comment">-- 分桶字段不能修改，下面的语句不能执行</span>
<span class="token comment">-- FAILED: SemanticException [Error 10302]: Updating values of bucketing columns is not supported.  Column nid.</span>
<span class="token keyword">update</span> zxz_data <span class="token keyword">set</span> nid <span class="token operator">=</span> nid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>小结：Hive支持行级事务(意味着允许对数据进行修改,但是总的来说,条件严格。不建议在生产环境中使用)</p><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/faustine8/doc/edit/main/docs/bigdata/hadoop/hive/use/README.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑"><!--[--><!--]--> 在 GitHub 上编辑 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">更新时间: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">贡献者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: faustine923@icloud.com">mujunlin</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/doc/assets/app.40df414d.js" defer></script>
  </body>
</html>
